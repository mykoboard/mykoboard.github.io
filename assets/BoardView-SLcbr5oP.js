import{c as te,x as Fe,y as Q,z as ht,r as D,m as W,v as st,u as at,A as yt,i as C,s as xe,d as oe,a as h,h as E,f as l,b as s,e as m,j as G,F as ee,t as R,l as X,o as g,k as $e,q as O,T as ft,p as mt,n as ue,g as it,B as bt}from"./index-Can2nL4t.js";import{a as ot}from"./GameRegistry-DGojQGp9.js";import{i as re}from"./_virtual___federation_fn_import-DF_FD4Z-.js";import{v as De,_ as rt}from"./ReactComponentWrapper.vue_vue_type_script_setup_true_lang-MYGmGmjf.js";import{S as Re,C as Se,T as je}from"./sessions-GuEErqOX.js";import{d as pe}from"./db-DfQP2Aol.js";import{R as Be,A as Je,k as Ue,O as He,V as Ve,F as Ye,M as ze,N as We,T as Qe}from"./index-Bh7HboyR.js";import{_ as Xe}from"./Input.vue_vue_type_script_setup_true_lang-T75AFUk5.js";const vt=te("check",[["path",{d:"M20 6 9 17l-5-5",key:"1gmf2c"}]]);const Ze=te("clipboard",[["rect",{width:"8",height:"4",x:"8",y:"2",rx:"1",ry:"1",key:"tgr4d6"}],["path",{d:"M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2",key:"116196"}]]);const wt=te("copy",[["rect",{width:"14",height:"14",x:"8",y:"8",rx:"2",ry:"2",key:"17jyea"}],["path",{d:"M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2",key:"zix9uf"}]]);const xt=te("link",[["path",{d:"M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71",key:"1cjeqo"}],["path",{d:"M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71",key:"19qd67"}]]);const St=te("log-in",[["path",{d:"m10 17 5-5-5-5",key:"1bsop3"}],["path",{d:"M15 12H3",key:"6jk70r"}],["path",{d:"M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4",key:"u53s6r"}]]);const kt=te("user-minus",[["path",{d:"M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2",key:"1yyitq"}],["circle",{cx:"9",cy:"7",r:"4",key:"nufk8"}],["line",{x1:"22",x2:"16",y1:"11",y2:"11",key:"1shjgl"}]]);const ke=te("user-plus",[["path",{d:"M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2",key:"1yyitq"}],["circle",{cx:"9",cy:"7",r:"4",key:"nufk8"}],["line",{x1:"19",x2:"19",y1:"8",y2:"14",key:"1bvyxn"}],["line",{x1:"22",x2:"16",y1:"11",y2:"11",key:"1shjgl"}]]),{createActor:zs,toObserver:Ws}=await re("xstate");function Ct(e,t){return e===t}const qe=()=>{};function It(e,t,n=Ct){const r=ht(e)?e:Fe(e),o=Fe(t(r.value?.getSnapshot())),b=w=>{n(o.value,w)||(o.value=w)};return Q(r,(w,y,x)=>{if(o.value=t(w?.getSnapshot()),!w)return;const u=w.subscribe({next:P=>{b(t(P))},error:qe,complete:qe});x(()=>u.unsubscribe())},{immediate:!0}),o}const ie=!1,Et=()=>{const e={net:ie,state:ie,info:ie,error:!0,lobby:ie,sig:ie,webrtc:ie};try{const t=localStorage.getItem("debug_config");if(t)return{...e,...JSON.parse(t)}}catch{}return e},At=Et(),d={shouldLog:e=>At[e],netIn:(e,t)=>{if(!d.shouldLog("net"))return;let n=t;try{n=JSON.parse(t)}catch{}console.log("%c[NET-IN] %cfrom %s:","color: #22c55e; font-weight: bold;","color: #64748b;",e.slice(0,8),n)},netOut:(e,t)=>{if(!d.shouldLog("net"))return;let n=t;try{n=JSON.parse(t)}catch{}console.log("%c[NET-OUT] %cto %s:","color: #3b82f6; font-weight: bold;","color: #64748b;",e.slice(0,8),n)},state:(e,t,n,r="state")=>{if(!d.shouldLog(r))return;console.log("%c[%s-%s] %c%s",`color: ${e==="EVENT"?"#f59e0b":"#10b981"}; font-weight: bold;`,r.toUpperCase(),e,"color: inherit;",t,n||"")},lobby:(e,t,n)=>{d.state(e,t,n,"lobby")},sig:(e,...t)=>{d.shouldLog("sig")&&console.log("%c[SIG] %c%s","color: #ec4899; font-weight: bold;","color: inherit;",e,...t)},webrtc:(e,...t)=>{d.shouldLog("webrtc")&&console.log("%c[WEBRTC] %c%s","color: #06b6d4; font-weight: bold;","color: inherit;",e,...t)},info:(...e)=>{d.shouldLog("info")&&console.log("%c[INFO]","color: #8b5cf6; font-weight: bold;",...e)},error:(...e)=>{d.shouldLog("error")&&console.error("%c[ERROR]","color: #ef4444; font-weight: bold;",...e)}};var L=(e=>(e.new="new",e.started="started",e.readyToAccept="readyToAccept",e.accepted="accepted",e.answered="answered",e.connected="established",e.closed="closed",e))(L||{});class le{id;peerConnection;localPlayerName;remotePlayerName;remotePublicKey;dataChannel;iceCandidates;status;signal;messageListeners=[];onClose;updateView;constructor(t){this.id=De(),this.updateView=t,this.peerConnection=new RTCPeerConnection(_t),this.iceCandidates=[];let n=null;this.peerConnection.onicecandidate=r=>{r.candidate&&(this.iceCandidates.push(r.candidate),(this.status==="started"||this.status==="answered")&&(this.updateSignal(),n&&clearTimeout(n),n=setTimeout(()=>{this.updateView(this),n=null},200)))},this.peerConnection.onconnectionstatechange=r=>{const o=this.peerConnection.connectionState;d.webrtc(this.id+": Connection state changed to "+o),o==="connected"?(this.status="established",this.updateView(this)):(o==="disconnected"||o==="failed"||o==="closed")&&this.close()}}updateSignal(t){this.peerConnection.localDescription&&(this.signal=new Z(this.id,this.peerConnection.localDescription,t||this.localPlayerName,this.iceCandidates))}openDataChannel(){this.dataChannel=this.peerConnection.createDataChannel("gameData"),this.dataChannel.onopen=t=>d.webrtc(this.id+" Data channel state is: "+this.dataChannel.readyState),this.dataChannel.onclose=t=>d.webrtc(this.id+" Data channel state is: "+this.dataChannel.readyState),this.dataChannel.onerror=t=>d.error(this.id+" Error ",t),this.dataChannel.onmessage=t=>{d.netIn(this.id,t.data),this.messageListeners.forEach(n=>n(t.data))}}setDataChannelCallback(){this.peerConnection.ondatachannel=t=>{d.webrtc("Receive Channel Callback",t),this.dataChannel=t.channel,this.dataChannel.onmessage=n=>{d.netIn(this.id,n.data),this.messageListeners.forEach(r=>r(n.data))},this.dataChannel.onopen=n=>{const r=this.dataChannel.readyState;d.webrtc(this.id+": Data channel state is: "+r),r=="open"&&(d.webrtc(this.id+": Sending ping"),this.send("Ping"))},this.dataChannel.onclose=n=>{const r=this.dataChannel.readyState;d.webrtc(this.id+": Data channel state is: "+r)}}}async prepareOfferSignal(t){console.log("[WebRTC] prepareOfferSignal - playerName:",t),this.localPlayerName=t,this.status="new";try{const n=await this.peerConnection.createOffer();await this.peerConnection.setLocalDescription(n),this.status="started",this.updateSignal(),this.updateView(this)}catch(n){this.onCreateSessionDescriptionError(n)}}async send(t){this.dataChannel&&this.dataChannel.readyState==="open"&&(d.netOut(this.id,t),await this.dataChannel.send(t))}addMessageListener(t){this.messageListeners.push(t)}removeMessageListener(t){this.messageListeners=this.messageListeners.filter(n=>n!==t)}async acceptOffer(t,n){const r=typeof t=="string"?Z.fromString(t):t;console.log("[WebRTC] acceptOffer - acceptingPlayerName:",n),this.remotePlayerName=r.playerName,this.localPlayerName=n,await this.peerConnection.setRemoteDescription(r.session),r.iceCandidates.forEach(o=>{this.peerConnection.addIceCandidate(o)});try{const o=await this.peerConnection.createAnswer();await this.peerConnection.setLocalDescription(o),this.status="answered",this.updateSignal(),this.updateView(this),this.updateView(this)}catch(o){this.onCreateSessionDescriptionError(o)}}onCreateSessionDescriptionError(t){d.error("Failed to create session description: "+t.toString())}async acceptAnswer(t){const n=typeof t=="string"?Z.fromString(t):t;d.webrtc(this.id+": Accepting answer signal from "+n.playerName),console.log("[WebRTC] acceptAnswer - Guest name:",n.playerName);try{await this.peerConnection.setRemoteDescription(n.session),this.remotePlayerName=n.playerName,n.iceCandidates&&(d.webrtc(this.id+`: Adding ${n.iceCandidates.length} ICE candidates from answer`),n.iceCandidates.forEach(r=>{this.peerConnection.addIceCandidate(r).catch(o=>d.error("Error adding ICE candidate:",o))})),this.updateView(this)}catch(r){d.error(this.id+": Failed to set remote description from answer",r)}}close(){this.dataChannel&&this.dataChannel.close(),this.peerConnection.close(),this.status="closed",this.onClose?.(),this.updateView(this)}}class Z{connectionId;session;playerName;iceCandidates;constructor(t,n,r,o){this.session=n,this.connectionId=t,this.playerName=r,this.iceCandidates=o}toString(){return btoa(JSON.stringify(this))}static fromString(t){const n=JSON.parse(atob(t));return new Z(n.connectionId,n.session,n.playerName,n.iceCandidates)}}const _t={iceServers:[{urls:"stun:stun.l.google.com:19302"}]};class Nt{socket=null;onMessageCallback;gameId;boardId;peerName;publicKey=null;constructor(t,n,r,o){this.gameId=t,this.boardId=n||"",this.peerName=r,this.onMessageCallback=o}updateBoardId(t){d.sig(`Updating signaling boardId from ${this.boardId} to ${t}`),this.boardId=t}async connect(t,n,r){let o="wss://pebsg4v5yk.execute-api.eu-central-1.amazonaws.com/production";const b=new URLSearchParams;b.append("x-api-key",t),n&&(b.append("x-pubkey",n),this.publicKey=n),r&&b.append("x-sig",r);const w=`${o}?${b.toString()}`;return new Promise((y,x)=>{d.sig(`Connecting to signaling server: ${w}`),this.socket=new WebSocket(w),this.socket.onopen=()=>{d.sig("WebSocket Connection Open."),y()},this.socket.onmessage=u=>{d.sig("Raw message from server:",u.data);try{const P=JSON.parse(u.data);this.onMessageCallback(P)}catch(P){d.error("Failed to parse signaling message",P)}},this.socket.onclose=u=>{d.sig("Disconnected from signaling server",u.code,u.reason),this.socket=null},this.socket.onerror=u=>{d.error("Signaling WebSocket error:",u),x(u)}})}hostRegister(t,n,r,o){return d.sig("Registering as host for board:",t),this.send({type:"hostRegister",boardId:t,gameId:n,peerName:r,publicKey:o})}guestJoin(t,n,r,o){return d.sig("Joining as guest for board:",t),this.send({type:"guestJoin",boardId:t,peerName:n,publicKey:r,encryptionPublicKey:o})}hostOffer(t,n,r,o,b){return d.sig("Sending offer to guest:",t),this.send({type:"hostOffer",target:t,guestPublicKey:n,offer:r,peerName:this.peerName,publicKey:this.publicKey||void 0,encryptionPublicKey:o,iv:b,boardId:this.boardId})}guestAnswer(t,n,r,o){return d.sig("Sending answer to host:",t),this.send({type:"guestAnswer",target:t,publicKey:n,answer:r,peerName:this.peerName,iv:o,boardId:this.boardId})}deleteOffer(){if(!this.socket||this.socket.readyState!==WebSocket.OPEN){d.sig("Cannot delete offer: Signaling socket is not open.");return}d.sig("Deleting offer for game:",this.gameId,"board:",this.boardId),this.send({type:"deleteOffer",gameId:this.gameId,...this.boardId?{boardId:this.boardId}:{}})}send(t){if(!this.socket||this.socket.readyState!==WebSocket.OPEN)return d.error("Signaling socket not open. State:",this.socket?.readyState),!1;const n={action:"sendMessage",...t};return d.sig("Sending payload to AWS:",n),this.socket.send(JSON.stringify(n)),!0}disconnect(t=!1){t&&this.isConnected&&this.deleteOffer(),this.socket?.close(),this.socket=null}get isConnected(){return!!this.socket&&this.socket.readyState===WebSocket.OPEN}}const{createMachine:Pt,assign:Le}=await re("xstate"),Tt=Pt({types:{},id:"lobby",initial:"selection",context:({input:e})=>({playerName:e.playerName,signalingMode:null,playerCount:2}),states:{selection:{on:{SELECT_MODE:{target:"discovery",actions:Le({signalingMode:({event:e})=>e.mode})}}},discovery:{on:{GOTO_SELECTION:"selection",SET_PLAYER_COUNT:{actions:Le({playerCount:({event:e})=>e.count})},SELECT_MODE:{actions:Le({signalingMode:({event:e})=>e.mode})}}}}}),{createMachine:Gt,assign:K}=await re("xstate"),{createLobbyMessage:we}=await re("@mykoboard/integration"),Rt=Gt({types:{},id:"board",initial:"idle",context:({input:e})=>({connections:new Map,playerStatuses:new Map,isInitiator:e.isInitiator||!1,isGameStarted:!1,isGameFinished:!1,playerName:e.playerName,ledger:[],pendingGuest:null,externalParticipants:[],maxPlayers:e.maxPlayers||2,boardId:e.boardId||""}),states:{idle:{on:{HOST:{target:"hosting",actions:K({isInitiator:!0,maxPlayers:({event:e})=>e.maxPlayers||2,boardId:({event:e})=>e.boardId})},JOIN:{target:"joining",actions:K({isInitiator:!1,boardId:({event:e})=>e.boardId})}}},hosting:{on:{REQUEST_JOIN:{target:"approving",actions:K({pendingGuest:({event:e})=>({id:e.connectionId,name:e.peerName,answer:e.answer,connection:e.connection})})}},always:[{target:"preparation",guard:"hasConnections"}]},joining:{always:[{target:"preparation",guard:"hasConnections"}]},approving:{on:{ACCEPT_GUEST:{target:"preparation",actions:["acceptGuest","clearPendingGuest"]},REJECT_GUEST:{target:"hosting",actions:["rejectGuest","clearPendingGuest"]}}},preparation:{on:{START_GAME:{target:"playing",actions:["setGameStarted","broadcastStartGame"]},GAME_STARTED:{target:"playing",actions:"setGameStarted"},REQUEST_JOIN:{target:"approving",actions:K({pendingGuest:({event:e})=>({id:e.connectionId,name:e.peerName,answer:e.answer,connection:e.connection})})}}},playing:{on:{FINISH_GAME:{target:"finished",actions:K({isGameFinished:!0})}}},finished:{on:{RESET_GAME:{target:"preparation",actions:["resetGameStarted","broadcastResetGame"]}}}},on:{UPDATE_CONNECTION:{actions:["updateConnection","syncConnection"]},PEER_DISCONNECTED:{actions:["updateConnectionStatus","removeConnection"]},SET_PLAYER_STATUS:{actions:"setPlayerStatus"},REMOVE_PLAYER:{actions:"removePlayer"},SYNC_LEDGER:{actions:"syncLedger"},LOAD_LEDGER:{actions:K({ledger:({event:e})=>e.ledger})},SYNC_PARTICIPANTS:{actions:K({externalParticipants:({event:e})=>e.participants})},GAME_STARTED:{actions:"setGameStarted"},GAME_RESET:{actions:"resetGameStarted"},CLOSE_SESSION:{target:".idle",actions:["resetContext","closeAllConnections"]}}},{actions:{setGameStarted:K({isGameStarted:!0,isGameFinished:!1}),resetGameStarted:K({isGameStarted:!1,isGameFinished:!1,ledger:[]}),setPlayerStatus:K(({context:e,event:t})=>{if(t.type!=="SET_PLAYER_STATUS")return e;const n=new Map(e.playerStatuses);return n.set(t.playerId,t.status),{playerStatuses:n}}),updateConnectionStatus:K(({context:e,event:t})=>{if(t.type!=="PEER_DISCONNECTED")return e;const n=new Map(e.connections),r=n.get(t.connectionId);return r&&(r.status=L.closed),{connections:n}}),updateConnection:K(({context:e,event:t})=>{if(t.type!=="UPDATE_CONNECTION")return e;const n=t.connection;if(n.status===L.closed&&!e.connections.has(n.id))return e;const r=e.connections.get(n.id);if(r){const w=r._lastKnownStatus!==n.status,y=r._lastKnownSignal!==(n.signal?.toString()||"");if(!w&&!y)return e}n._lastKnownStatus=n.status,n._lastKnownSignal=n.signal?.toString()||"";const o=new Map(e.connections);o.set(n.id,n);const b=new Map(e.playerStatuses);return b.has(n.id)||b.set(n.id,"lobby"),{connections:o,playerStatuses:b}}),syncConnection:({context:e,event:t})=>{if(t.type!=="UPDATE_CONNECTION")return;const n=t.connection;if(e.isInitiator&&n.status===L.connected){if(n._synced)return;n._synced=!0,d.lobby("STATE",`Syncing new connection: ${n.id}`),n.send(JSON.stringify(we("SYNC_LEDGER",e.ledger))),e.isGameStarted&&n.send(JSON.stringify(we("GAME_STARTED")))}},removeConnection:K(({context:e,event:t})=>{if(t.type!=="PEER_DISCONNECTED")return e;const n=new Map(e.connections);return n.delete(t.connectionId),{connections:n}}),removePlayer:K(({context:e,event:t})=>{if(t.type!=="REMOVE_PLAYER")return e;const n=new Map(e.connections),r=n.get(t.playerId);r&&(r.close(),n.delete(t.playerId));const o=new Map(e.playerStatuses);return o.delete(t.playerId),{connections:n,playerStatuses:o}}),syncLedger:K(({context:e,event:t})=>t.type!=="SYNC_LEDGER"?e:{ledger:t.ledger}),broadcastStartGame:({context:e})=>{e.isInitiator&&e.connections.forEach(t=>{t.status===L.connected&&t.send(JSON.stringify(we("START_GAME")))})},broadcastResetGame:({context:e})=>{e.isInitiator&&e.connections.forEach(t=>{t.status===L.connected&&t.send(JSON.stringify(we("GAME_RESET")))})},closeAllConnections:({context:e})=>{e.connections.forEach(t=>t.close())},acceptGuest:({context:e})=>{e.pendingGuest&&(d.sig("Accepting guest:",e.pendingGuest.name),e.pendingGuest.connection.acceptAnswer(e.pendingGuest.answer))},rejectGuest:({context:e})=>{e.pendingGuest&&(d.sig("Rejecting guest:",e.pendingGuest.name),e.pendingGuest.connection.close())},resetContext:K(({context:e})=>({connections:new Map,playerStatuses:new Map,ledger:[],isGameStarted:!1,isGameFinished:!1,isInitiator:!1,maxPlayers:e.maxPlayers,pendingGuest:null,externalParticipants:[],boardId:""})),clearPendingGuest:K({pendingGuest:null})},guards:{hasConnections:({context:e})=>Array.from(e.connections.values()).some(t=>t.status===L.connected)}}),{createActor:ct}=await re("xstate"),H=D(null),lt=D(!0),et=D([]);ct(Tt,{input:{playerName:"Anonymous"}}).start();const Oe=new Map;function Ke(e,t,n=!1,r=2){if(!Oe.has(e)){d.lobby("STATE",`Creating new board actor for ${e}`);const o=ct(Rt,{input:{playerName:t,boardId:e,isInitiator:n,maxPlayers:r}});o.start(),Oe.set(e,o)}return Oe.get(e)}const Lt=async()=>{if(H.value)return;const e=W.getInstance();H.value=await e.getIdentity(),lt.value=!1};Lt();const{Ledger:Ot,createLobbyMessage:de,isLobbyMessage:tt}=await re("@mykoboard/integration");function Kt(){const e=st(),t=at(),n=D(null),r=D(!1),o=D(""),b=D(!1),w=D([]),y=D(new Map),x=C(()=>e.params.gameId),u=C(()=>e.params.boardId),P=C(()=>ot(x.value||"")),U=C(()=>!!u.value),I=C(()=>!u.value||u.value==="manual"?null:Ke(u.value,H.value?.name||"Anonymous",!1)),A=It(I,a=>a),v=C(()=>A.value?.context?.isInitiator||!1),p=C(()=>A.value?.context?.isGameStarted||!1),S=C(()=>A.value?.context?.connections||new Map),Y=C(()=>Array.from(S.value.values())),z=C(()=>Y.value.filter(a=>a.status===L.connected)),Ce=C(()=>Y.value.filter(a=>a.status!==L.connected&&a.status!==L.closed)),Ie=C(()=>U.value?"game":"lobby"),ne=C(()=>{if(!A.value)return[];const a=A.value.context,c=et.value.find(i=>i.boardId===u.value),f=c?.participants||[],_=a.externalParticipants||[],N=f.find(i=>i.isYou),J={id:H.value?.id||"local",name:a.playerName||H.value?.name||"Anonymous",status:p.value?"game":"lobby",isConnected:!0,isLocal:!0,isHost:N?N.isHost:v.value,publicKey:H.value?.publicKey},k=[],M=new Set;if(v.value)k.push(J),M.add(J.id);else if(_.length>0){const i=_.find(T=>T.isHost);if(i){const T=z.value.find($=>$.status===L.connected);k.push({id:i.id,name:i.name,status:(T?a.playerStatuses.get(T.id):null)||(p.value?"game":"lobby"),isConnected:!!T,isLocal:!1,isHost:!0,publicKey:T?.remotePublicKey||i.publicKey}),M.add(i.id)}k.push(J),M.add(J.id)}return v.value?Y.value.forEach(i=>{if(!M.has(i.id)){const T=f.find(F=>F.id===i.id),$=i.remotePublicKey||T?.publicKey;console.log("[playerInfos] Adding peer:",i.remotePlayerName,"remotePublicKey:",i.remotePublicKey?.substring(0,20),"publicKey:",$?.substring(0,20)),k.push({id:i.id,name:i.remotePlayerName||T?.name||"Anonymous",status:a.playerStatuses.get(i.id)||"lobby",isConnected:i.status===L.connected,isLocal:!1,isHost:!1,publicKey:$}),M.add(i.id)}}):_.length>0&&_.forEach(i=>{i.isHost||M.has(i.id)||i.id===J.id||i.id===H.value?.id||i.publicKey===H.value?.publicKey||(k.push({id:i.id,name:i.name,status:p.value?"game":"lobby",isConnected:!0,isLocal:!1,isHost:!1,publicKey:i.publicKey}),M.add(i.id))}),f.forEach(i=>{!i.isYou&&!M.has(i.id)&&k.push({id:i.id,name:i.name,status:c?.status==="finished"||p.value?"game":"lobby",isConnected:!1,isLocal:!1,isHost:i.isHost})}),k});yt(()=>{const a=A.value;a?.status==="active"&&u.value&&u.value!=="manual"&&Re.saveSession({gameId:x.value,boardId:u.value,playerName:a.context.playerName,gameName:P.value?.name||"Unknown Game",lastPlayed:Date.now(),status:a.matches("finished")?"finished":"active",ledger:a.context.ledger,participants:ne.value.map(c=>({id:c.id,name:c.name,isYou:c.isLocal,isHost:c.isHost}))})});const ge=new Map,he=new Map,se=a=>{const c=I.value;if(!c)return;const f=ge.get(a.id),_=a.signal?.toString()||"",N=he.get(a.id);f===a.status&&N===_||(ge.set(a.id,a.status),he.set(a.id,_),c.send({type:"UPDATE_CONNECTION",connection:a}),a._hasListener||(a.addMessageListener(J=>{try{const k=JSON.parse(J);if(!tt(k))return;if(k.type==="START_GAME"&&c.send({type:"START_GAME"}),k.type==="GAME_STARTED"&&c.send({type:"GAME_STARTED"}),k.type==="GAME_RESET"&&c.send({type:"GAME_RESET"}),k.type==="NEW_BOARD"&&t.replace(`/games/${x.value}/${k.payload}`),k.type==="SYNC_PLAYER_STATUS"&&c.send({type:"SET_PLAYER_STATUS",playerId:a.id,status:k.payload}),k.type==="SYNC_PARTICIPANTS"&&c.send({type:"SYNC_PARTICIPANTS",participants:k.payload}),k.type==="SYNC_LEDGER"){const M=k.payload;for(const i of M)i.signature&&i.signerPublicKey&&W.verify(i.action,i.signature,i.signerPublicKey).then(T=>{T||d.error("Invalid signature in ledger entry",i)});c.send({type:"SYNC_LEDGER",ledger:k.payload})}}catch{}}),a._hasListener=!0))},Ee=async(a,c)=>{const f=c||a;if(d.sig("setupSignaling called with gameId:",a,"boardId:",c,"resolved currentBoardId:",f),!!f&&(o.value!==f&&n.value?.isConnected&&(d.sig("Switching signaling board assignment from",o.value,"to",f),n.value.updateBoardId(f),o.value=f),(!n.value||!n.value.isConnected)&&!r.value)){r.value=!0;try{const _=W.getInstance(),N=await _.getIdentity();if(N){const J=new Nt(a||"default",f,N.name,async i=>{if(i.type==="error"&&(d.error("Signaling error:",i.message||i.code),xe.error(i.message||"Signaling error occurred"),i.code==="DUPLICATE_IDENTITY"&&t.replace(`/games/${a}`)),i.type==="peerJoined"&&(d.sig("Peer joined:",i.peerName,"publicKey:",i.publicKey),await ye(i.publicKey)?(d.sig("Auto-approving known identity:",i.peerName),await fe({connectionId:i.from,peerName:i.peerName||"Guest",publicKey:i.publicKey,encryptionPublicKey:i.encryptionPublicKey,timestamp:Date.now()})):w.value.push({connectionId:i.from,peerName:i.peerName||"Guest",publicKey:i.publicKey,encryptionPublicKey:i.encryptionPublicKey,timestamp:Date.now()})),i.type==="offer"){d.sig("Received offer from host:",i.from);const T=i.boardId||o.value;if(!T){d.error("No valid target board UUID for offer message");return}const $=Ke(T,N.name,!1),F=new le(q=>{$.send({type:"UPDATE_CONNECTION",connection:q})});F.addMessageListener(q=>{try{const j=JSON.parse(q);if(!tt(j))return;if(j.type==="START_GAME"&&$.send({type:"START_GAME"}),j.type==="GAME_STARTED"&&$.send({type:"GAME_STARTED"}),j.type==="GAME_RESET"&&$.send({type:"GAME_RESET"}),j.type==="NEW_BOARD"&&t.replace(`/games/${a.value}/${j.payload}`),j.type==="SYNC_PLAYER_STATUS"&&$.send({type:"SET_PLAYER_STATUS",playerId:F.id,status:j.payload}),j.type==="SYNC_PARTICIPANTS"&&$.send({type:"SYNC_PARTICIPANTS",participants:j.payload}),j.type==="SYNC_LEDGER"){const Me=j.payload;for(const ae of Me)ae.signature&&ae.signerPublicKey&&W.verify(ae.action,ae.signature,ae.signerPublicKey).then(gt=>{gt||d.error("Invalid signature in ledger entry",ae)});$.send({type:"SYNC_LEDGER",ledger:Me})}}catch(j){d.error("Failed to parse message:",j)}}),F.onClose=()=>{$.send({type:"PEER_DISCONNECTED",connectionId:F.id})},F.setDataChannelCallback(),i.publicKey&&(console.log("[useGameSession] Guest storing host publicKey from offer:",i.publicKey?.substring(0,20)),F.remotePublicKey=i.publicKey),i.peerName&&(console.log("[useGameSession] Guest storing host name from offer:",i.peerName),F.remotePlayerName=i.peerName),F.acceptOffer(i.offer,N.name).then(()=>{const q=setInterval(()=>{F.signal&&n.value&&(clearInterval(q),d.sig("Sending answer to host:",i.from),n.value.guestAnswer(i.from,N.publicKey,F.signal,void 0))},100)}).catch(q=>{d.error("Failed to accept offer and generate answer:",q)})}if(i.type==="answer"){d.sig("Received answer from guest:",i.from,"publicKey:",i.publicKey);const T=y.value.get(i.from);if(T&&i.answer){d.sig("Applying answer to connection:",i.from),console.log("[useGameSession] msg.answer type:",typeof i.answer),console.log("[useGameSession] msg.answer is Signal?:",i.answer instanceof Z),console.log("[useGameSession] msg.answer publicKey:",i.answer.publicKey?.substring(0,20));let $=i.answer;!(i.answer instanceof Z)&&typeof i.answer=="object"&&(console.log("[useGameSession] Converting plain object to Signal instance"),$=new Z(i.answer.connectionId,i.answer.session,i.answer.playerName,i.answer.iceCandidates||[]),console.log("[useGameSession] Signal created from plain object")),i.publicKey&&(console.log("[useGameSession] Setting remotePublicKey from msg.publicKey:",i.publicKey?.substring(0,20)),T.remotePublicKey=i.publicKey),i.peerName&&(console.log("[useGameSession] Setting remotePlayerName from msg.peerName:",i.peerName),T.remotePlayerName=i.peerName);try{T.acceptAnswer($),d.sig("WebRTC connection established with:",i.from),y.value.delete(i.from)}catch(F){d.error("Failed to accept answer:",F)}}else d.error("No pending connection found for:",i.from)}}),k=`SIGN_IN:${N.subscriptionToken}`,M=await _.sign(k);await J.connect(N.subscriptionToken,N.publicKey,M),n.value=J,o.value=f}}catch(_){d.error("Failed to connect to signaling server:",_)}finally{r.value=!1}}},Ae=async(a=2)=>{if(U.value)I.value&&u.value&&d.sig("Manual onHostAGame called (not used in new flow)");else{const c=De();t.push(`/games/${x.value}/${c}?maxPlayers=${a}`)}},_e=async()=>{if(!u.value||!n.value?.isConnected){d.error("Cannot join as guest: missing boardId or signaling not connected");return}const c=await W.getInstance().getIdentity();c&&(d.sig("Sending guestJoin for boardId:",u.value),n.value.guestJoin(u.value,c.name,c.publicKey,c.publicKey))},ye=async a=>(await pe.getAllKnownIdentities()).some(f=>f.publicKey===a),fe=async a=>{d.sig("Approving peer:",a.peerName,"publicKey:",a.publicKey);const c=new le(_=>{I.value?.send({type:"UPDATE_CONNECTION",connection:_})});c.onClose=()=>{I.value?.send({type:"PEER_DISCONNECTED",connectionId:c.id}),y.value.delete(a.connectionId)},c.remotePublicKey=a.publicKey,console.log("[useGameSession] Stored guest publicKey from join request:",a.publicKey?.substring(0,20)),c.openDataChannel(),await c.prepareOfferSignal(A.value?.context?.playerName||H.value?.name||"Anonymous"),y.value.set(a.connectionId,c);const f=setInterval(()=>{c.signal&&n.value&&(clearInterval(f),W.getInstance().getIdentity().then(N=>{N&&n.value&&n.value.hostOffer(a.connectionId,a.publicKey,c.signal,N.publicKey,void 0)}))},100)},Ne=async a=>{w.value=w.value.filter(c=>c.connectionId!==a.connectionId),await fe(a)},Pe=a=>{d.sig("Rejecting peer:",a.peerName),w.value=w.value.filter(c=>c.connectionId!==a.connectionId)},me=async a=>{try{const c={id:`identity-${Date.now()}`,name:a.peerName,publicKey:a.publicKey,addedAt:Date.now()};await pe.addKnownIdentity(c),xe.success("Identity Saved",{description:`${a.peerName} has been added to your known identities.`})}catch{xe.error("Failed to save identity")}},Te=()=>{n.value&&v.value&&n.value.deleteOffer(),I.value?.send({type:"START_GAME"})},be=()=>{if(!I.value)return;I.value.send({type:"JOIN",boardId:u.value});const a=new le(se);a.onClose=()=>I.value?.send({type:"PEER_DISCONNECTED",connectionId:a.id}),a.status=L.readyToAccept,a.setDataChannelCallback(),se(a)},Ge=async(a,c)=>{if(!(!(a instanceof le)||!c))try{await a.acceptOffer(c,H.value?.name||"Anonymous")}catch(f){d.error("Failed to accept offer",f)}},ve=(a,c)=>{if(!(!(a instanceof le)||!c))try{a.acceptAnswer(c),se(a)}catch(f){d.error("Failed to accept answer",f)}},B=()=>{I.value?.send({type:"FINISH_GAME"}),u.value&&Re.updateStatus(u.value,"finished")},V=async a=>{if(!v.value||!I.value)return;const c=W.getInstance(),f=await c.getIdentity();if(!f)return;const _=await c.sign(a),N=Ot.fromEntries(A.value?.context?.ledger||[]),J=await N.addEntry({...a});J.signature=_,J.signerPublicKey=f.publicKey;const k=N.getEntries();I.value.send({type:"SYNC_LEDGER",ledger:k}),z.value.forEach(M=>{M.send(JSON.stringify(de("SYNC_LEDGER",k)))})},ce=()=>{const a=De();z.value.forEach(c=>{c.status===L.connected&&c.send(JSON.stringify(de("NEW_BOARD",a)))}),n.value?.deleteOffer(),I.value?.send({type:"CLOSE_SESSION"}),t.push(`/games/${x.value}/${a}`)},dt=()=>{const a=A.value?.context?.pendingGuest;I.value?.send({type:"ACCEPT_GUEST"}),a&&se(a.connection)},ut=()=>I.value?.send({type:"REJECT_GUEST"}),pt=a=>{a.close(),I.value?.send({type:"PEER_DISCONNECTED",connectionId:a.id})};return Q([v,ne],()=>{if(!v.value)return;const a=ne.value.map(c=>({id:c.id,name:c.name,isHost:c.isHost,publicKey:c.publicKey}));z.value.forEach(c=>{if(c.status===L.connected)try{c.send(JSON.stringify(de("SYNC_PARTICIPANTS",a)))}catch(f){d.error("Failed to sync participants to peer",c.id,f)}})},{deep:!0,immediate:!0}),Q([u,U],async()=>{const a=U.value&&u.value;d.sig("[WATCH] Signaling Lifecycle update. shouldConnect:",a,"boardId:",u.value),a&&await Ee(x.value,u.value)},{immediate:!0}),Q([n,A,u],async()=>{if(!n.value?.isConnected||!u.value||b.value)return;const c=await W.getInstance().getIdentity();if(!c)return;const f=A.value;if(!f)return;const _=f.matches("hosting")||f.matches("preparation"),N=f.matches("joining");_&&f.context.isInitiator?(d.sig("Auto-registering as HOST for boardId:",u.value,"state:",f.value),n.value.hostRegister(u.value,x.value,c.name,c.publicKey),b.value=!0):(N||!f.context.isInitiator)&&(d.sig("Auto-joining as GUEST for boardId:",u.value,"state:",f.value),n.value.guestJoin(u.value,c.name,c.publicKey,c.publicKey),b.value=!0)}),Q(u,async a=>{if(a&&a!=="manual"&&U.value){const c=await Re.getSession(a),f=Ke(a,H.value?.name||"Anonymous",!1),_=f.getSnapshot().context;c&&c.ledger.length>0&&_.ledger.length===0&&(f.send({type:"LOAD_LEDGER",ledger:c.ledger}),f.send({type:"GAME_STARTED"}),c.status==="finished"&&setTimeout(()=>f.send({type:"FINISH_GAME"}),10))}},{immediate:!0}),Q(z,a=>{a.forEach(c=>{c._hasInitialSync||(c.send(JSON.stringify(de("SYNC_PLAYER_STATUS",Ie.value))),v.value&&u.value&&u.value!=="manual"&&c.send(JSON.stringify(de("NEW_BOARD",u.value))),c._hasInitialSync=!0)})}),{identity:H,isLoading:lt,snapshot:A,send:a=>I.value?.send(a),signalingClient:n,isServerConnecting:r,pendingJoinRequests:w,activeSessions:et,playerInfos:ne,connectedPeers:z,pendingSignaling:Ce,isInitiator:v,isGameStarted:p,onHostAGame:Ae,onJoinAsGuest:_e,isKnownIdentity:ye,onApprovePeer:Ne,onRejectPeer:Pe,saveIdentityOnApprove:me,startGame:Te,connectWithOffer:be,updateOffer:Ge,updateAnswer:ve,onFinishGame:B,onAddLedger:V,handlePlayAgain:ce,onAcceptGuest:dt,onRejectGuest:ut,onCancelSignaling:pt,onBackToGames:()=>t.push(`/games/${x.value}`),onBackToDiscovery:()=>t.push(`/games/${x.value}`)}}const $t={class:"space-y-4 animate-fade-in-up"},Dt={key:0,class:"glass-dark p-6 rounded-2xl border border-white/5 shadow-glass-dark flex items-center justify-center space-x-4"},Mt={key:1,class:"glass-dark p-6 rounded-2xl border border-white/5 shadow-glass-dark"},Ft={class:"text-sm font-black text-white uppercase tracking-[0.2em] mb-4 flex items-center gap-3"},jt={key:2,class:"glass-dark p-6 rounded-2xl border border-white/5 shadow-glass-dark group hover:border-primary/20 transition-all duration-500"},Bt={class:"text-[10px] font-black uppercase tracking-[0.2em] mb-4 flex items-center gap-2 text-primary"},Jt={class:"space-y-4"},Ut={class:"p-4 bg-white/5 rounded-xl border border-white/10 relative group min-h-[64px] flex items-center group-hover:neon-border transition-all duration-500"},Ht={class:"text-[10px] font-mono break-all line-clamp-2 text-white/40 pr-8"},Vt={key:1,class:"text-[10px] text-white/20 italic tracking-wider"},Yt={key:3,class:"glass-dark p-6 rounded-2xl border border-white/5 shadow-glass-dark group hover:border-primary/20 transition-all duration-500"},zt={class:"text-[10px] font-black uppercase tracking-[0.2em] mb-4 flex items-center gap-2 text-primary"},Wt={class:"space-y-3"},Qt={class:"p-4 bg-white/5 rounded-xl border border-white/10 relative group min-h-[64px] flex items-center group-hover:neon-border transition-all duration-500"},Xt={class:"text-[10px] font-mono break-all line-clamp-2 text-white/40 pr-8"},Zt={key:1,class:"text-[10px] text-white/20 italic tracking-wider"},qt={key:4,class:"flex justify-end"},nt=oe({__name:"SignalingStep",props:{connection:{},onOfferChange:{type:Function},onAnswerChange:{type:Function},onCancel:{type:Function}},setup(e){const t=D(!1),n=r=>{r&&(navigator.clipboard.writeText(r),t.value=!0,setTimeout(()=>t.value=!1,2e3))};return(r,o)=>(g(),h("div",$t,[e.connection.status===l(L).new?(g(),h("div",Dt,[...o[5]||(o[5]=[s("div",{class:"animate-spin rounded-full h-5 w-5 border-b-2 border-primary"},null,-1),s("p",{class:"text-sm text-white/50 font-bold uppercase tracking-widest"},"Generating invite signal...",-1)])])):E("",!0),e.connection.status===l(L).readyToAccept?(g(),h("div",Mt,[s("h3",Ft,[m(l(St),{class:"w-5 h-5 text-primary"}),o[6]||(o[6]=G(" Paste Join Offer ",-1))]),o[7]||(o[7]=s("p",{class:"text-[10px] text-white/30 uppercase tracking-widest mb-4"},"External node signal required for connection.",-1)),m(Xe,{placeholder:"Paste offer string here...",className:"h-12 bg-white/5 border-white/10 rounded-xl focus:ring-primary text-white font-mono text-xs placeholder:text-white/20","onUpdate:modelValue":o[0]||(o[0]=b=>e.onOfferChange(e.connection,b))})])):E("",!0),e.connection.status===l(L).started?(g(),h("div",jt,[s("h3",Bt,[m(l(ke),{class:"w-4 h-4"}),o[8]||(o[8]=G(" Active Invite Vector ",-1))]),s("div",Jt,[s("div",Ut,[e.connection.signal?(g(),h(ee,{key:0},[s("div",Ht,R(e.connection.signal.toString()),1),s("button",{class:"absolute top-2 right-2 h-8 w-8 flex items-center justify-center text-primary hover:bg-primary/10 transition-colors rounded-lg",onClick:o[1]||(o[1]=b=>n(e.connection.signal.toString()))},[t.value?(g(),X(l(Se),{key:0,class:"w-4 h-4"})):(g(),X(l(Ze),{key:1,class:"w-4 h-4"}))])],64)):(g(),h("div",Vt,"Gathering node connection details..."))]),o[9]||(o[9]=s("p",{class:"text-[10px] text-white/30 uppercase font-medium leading-relaxed tracking-wider"}," Transmit this vector to a peer node. Their response will be synthesized automatically. ",-1)),m(Xe,{placeholder:"Awaiting peer response vector...",className:"h-10 bg-white/5 border-white/10 rounded-xl focus:ring-primary text-white font-mono text-[10px] placeholder:text-white/20","onUpdate:modelValue":o[2]||(o[2]=b=>e.onAnswerChange(e.connection,b))})])])):E("",!0),e.connection.status===l(L).answered?(g(),h("div",Yt,[s("h3",zt,[m(l(Se),{class:"w-4 h-4"}),o[10]||(o[10]=G(" Signal Response Synthesized ",-1))]),s("div",Wt,[s("div",Qt,[e.connection.signal?(g(),h(ee,{key:0},[s("div",Xt,R(e.connection.signal.toString()),1),s("button",{class:"absolute top-2 right-2 h-8 w-8 flex items-center justify-center text-primary hover:bg-primary/10 transition-colors rounded-lg",onClick:o[3]||(o[3]=b=>n(e.connection.signal.toString()))},[t.value?(g(),X(l(Se),{key:0,class:"w-4 h-4"})):(g(),X(l(Ze),{key:1,class:"w-4 h-4"}))])],64)):(g(),h("div",Zt,"Finalizing response..."))]),o[11]||(o[11]=s("p",{class:"text-[10px] text-primary font-black uppercase tracking-widest"},"Transmit this payload back to peer to complete handshake.",-1))])])):E("",!0),e.onCancel?(g(),h("div",qt,[s("button",{onClick:o[4]||(o[4]=b=>e.onCancel(e.connection)),class:"text-[10px] font-black uppercase tracking-widest text-white/20 hover:text-rose-500 transition-colors p-2"}," De-initialize Link ")])):E("",!0)]))}}),en={class:"space-y-8"},tn={key:0,class:"fixed inset-0 z-[100] flex items-center justify-center bg-[#0A0A0A]/80 backdrop-blur-xl animate-fade-in p-6"},nn={class:"glass-dark p-10 w-full max-w-md shadow-2xl border border-white/10 rounded-[2.5rem] space-y-8 animate-zoom-in"},sn={class:"flex flex-col items-center text-center space-y-6"},an={class:"h-20 w-20 bg-primary/10 rounded-[1.5rem] flex items-center justify-center border border-primary/20 shadow-neon"},on={class:"space-y-2"},rn={class:"text-white/40 uppercase tracking-widest text-[10px] font-medium leading-relaxed"},cn={class:"font-black text-primary px-1"},ln={class:"grid grid-cols-2 gap-4"},dn={key:1,class:"glass-dark p-8 border border-primary/20 shadow-glass-dark rounded-[2.5rem] animate-zoom-in space-y-6"},un={class:"flex items-center gap-4"},pn={class:"w-12 h-12 rounded-2xl bg-primary/10 flex items-center justify-center border border-primary/20"},gn={class:"space-y-1"},hn={class:"text-white/40 uppercase tracking-widest text-[10px] font-medium"},yn={class:"space-y-4"},fn={class:"flex items-start justify-between"},mn={class:"space-y-2"},bn={class:"flex items-center gap-2"},vn={class:"text-lg font-black text-white"},wn={key:0,class:"px-2 py-0.5 bg-primary/10 text-primary border border-primary/20 rounded-full text-[9px] font-black uppercase tracking-wider"},xn={class:"text-xs text-white/40 font-mono"},Sn={key:0,class:"flex items-center justify-end gap-2 px-1 pb-2"},kn=["onClick","aria-checked"],Cn={class:"grid grid-cols-2 gap-3"},In=["onClick"],En=["onClick"],An={key:2,class:"glass-dark p-10 text-center space-y-8 border border-white/5 shadow-glass-dark rounded-[3rem] animate-zoom-in"},_n={class:"space-y-4"},Nn={class:"inline-flex items-center gap-2 px-4 py-1.5 bg-primary/10 text-primary border border-primary/20 rounded-full text-[10px] font-black uppercase tracking-[0.2em] shadow-neon transform -translate-y-2"},Pn={class:"text-4xl font-black text-white uppercase tracking-tighter"},Tn={class:"text-xs text-white/30 uppercase font-black tracking-widest leading-relaxed max-w-lg mx-auto"},Gn={key:0,class:"flex flex-col items-center gap-6"},Rn={class:"space-y-4"},Ln={class:"mx-auto h-16 w-16 bg-rose-500/10 rounded-2xl flex items-center justify-center border border-rose-500/20"},On={class:"grid grid-cols-2 gap-4 pt-6"},Kn={key:1,class:"flex flex-col items-center gap-8 py-6"},$n={key:0,class:"relative"},Dn={class:"space-y-3"},Mn={class:"text-xl font-black text-white uppercase tracking-tight"},Fn={class:"text-[10px] text-white/30 uppercase tracking-[0.2em] max-w-xs mx-auto font-medium leading-relaxed"},jn={class:"space-y-4"},Bn={class:"mx-auto h-16 w-16 bg-rose-500/10 rounded-2xl flex items-center justify-center border border-rose-500/20"},Jn={class:"grid grid-cols-2 gap-4 pt-6"},Un={key:2,class:"pt-8 border-t border-white/5 space-y-6"},Hn={key:0,class:"glass-dark p-8 rounded-[2rem] border border-white/10 shadow-glass-dark space-y-6 group hover:border-primary/30 transition-all duration-500"},Vn={class:"flex items-center justify-between"},Yn={class:"flex items-center gap-3"},zn={class:"p-2.5 bg-primary/10 rounded-xl border border-primary/20"},Wn={class:"relative flex items-center gap-3"},Qn={class:"flex-grow bg-black/40 border border-white/10 rounded-xl px-4 py-3.5 font-mono text-[11px] text-white/60 truncate transition-all group-hover:bg-black/60 group-hover:border-white/20"},Xn={key:"check",class:"flex items-center gap-2 animate-bounce-short"},Zn={key:"copy",class:"flex items-center gap-2"},qn={key:1,class:"space-y-4 text-left"},es={class:"grid grid-cols-1 gap-6"},ts={key:3,class:"pt-8 border-t border-white/5 text-left"},ns={key:3,class:"py-24 flex flex-col items-center justify-center space-y-6 border border-white/5 bg-white/5 rounded-[3rem] backdrop-blur-sm animate-fade-in"},ss=oe({__name:"PreparationPhase",props:{state:{},isInitiator:{type:Boolean},signalingMode:{},isServerConnecting:{type:Boolean},signalingClient:{},pendingSignaling:{},pendingJoinRequests:{},isKnownIdentity:{type:Function},onStartGame:{type:Function},onHostAGame:{type:Function},onUpdateOffer:{type:Function},onUpdateAnswer:{type:Function},onCloseSession:{type:Function},onBackToLobby:{type:Function},onAcceptGuest:{type:Function},onRejectGuest:{type:Function},onApprovePeer:{type:Function},onRejectPeer:{type:Function},onSaveIdentity:{type:Function},onCancelSignaling:{type:Function},onRemovePlayer:{type:Function},playerCount:{},maxPlayers:{},boardId:{},gameId:{}},setup(e){const t=e,n=D({}),r=D({}),o=async v=>{t.isKnownIdentity&&(n.value[v]=await t.isKnownIdentity(v))},b=v=>v.length<=20?v:`${v.substring(0,10)}...${v.substring(v.length-10)}`,w=D(!1),y=C(()=>`${window.location.origin}${window.location.pathname}#/games/${t.gameId}/${t.boardId}`),x=async()=>{try{await navigator.clipboard.writeText(y.value),w.value=!0,setTimeout(()=>{w.value=!1},2e3)}catch(v){console.error("Failed to copy link:",v)}};Q(()=>t.pendingJoinRequests,v=>{v&&v.forEach(p=>{p.publicKey in n.value||o(p.publicKey)})},{deep:!0,immediate:!0});const u=async v=>{r.value[v.connectionId]&&t.onSaveIdentity&&await t.onSaveIdentity(v),t.onApprovePeer&&t.onApprovePeer(v),delete r.value[v.connectionId]},P=C(()=>t.state.matches("preparation")),U=C(()=>t.state.matches("hosting")),I=C(()=>t.state.matches("joining")),A=C(()=>t.state.matches("approving"));return(v,p)=>(g(),h("div",en,[A.value&&e.state.context.pendingGuest?(g(),h("div",tn,[s("div",nn,[s("div",sn,[s("div",an,[m(l(ke),{class:"w-10 h-10 text-primary animate-pulse"})]),s("div",on,[p[6]||(p[6]=s("h2",{class:"text-2xl font-black text-white uppercase tracking-tight"},"Handshake Request",-1)),s("p",rn,[p[4]||(p[4]=G(" Entity ",-1)),s("span",cn,R(e.state.context.pendingGuest.name),1),p[5]||(p[5]=G(" attempts to bridge into session. ",-1))])])]),s("div",ln,[s("button",{onClick:p[0]||(p[0]=(...S)=>e.onRejectGuest&&e.onRejectGuest(...S)),class:"h-14 rounded-2xl border border-white/10 text-white/60 hover:text-rose-500 hover:bg-rose-500/10 hover:border-rose-500/30 font-black uppercase tracking-widest text-xs transition-all"}," De-authorize "),s("button",{onClick:p[1]||(p[1]=(...S)=>e.onAcceptGuest&&e.onAcceptGuest(...S)),class:"h-14 rounded-2xl bg-primary text-primary-foreground shadow-neon hover:shadow-[0_0_30px_rgba(16,185,129,0.4)] font-black uppercase tracking-widest text-xs transition-all"}," Grant Access ")])])])):E("",!0),e.isInitiator&&e.pendingJoinRequests&&e.pendingJoinRequests.length>0?(g(),h("div",dn,[s("div",un,[s("div",pn,[m(l(ke),{class:"w-6 h-6 text-primary"})]),s("div",gn,[p[7]||(p[7]=s("h2",{class:"text-2xl font-black text-white uppercase tracking-tight"},"Join Requests",-1)),s("p",hn,R(e.pendingJoinRequests.length)+" "+R(e.pendingJoinRequests.length===1?"peer":"peers")+" waiting for approval ",1)])]),s("div",yn,[(g(!0),h(ee,null,$e(e.pendingJoinRequests,S=>(g(),h("div",{key:S.connectionId,class:"glass-darker p-6 rounded-2xl border border-white/5 space-y-4"},[s("div",fn,[s("div",mn,[s("div",bn,[s("span",vn,R(S.peerName),1),n.value[S.publicKey]?(g(),h("span",wn," Known Identity ")):E("",!0)]),s("p",xn,R(b(S.publicKey)),1)])]),n.value[S.publicKey]?E("",!0):(g(),h("div",Sn,[p[8]||(p[8]=s("span",{class:"text-xs text-white/50 uppercase tracking-wider font-medium"},"Auto-approve next time",-1)),s("button",{onClick:Y=>r.value[S.connectionId]=!r.value[S.connectionId],class:ue(["relative inline-flex h-6 w-11 items-center rounded-full transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2 focus:ring-offset-gray-900",r.value[S.connectionId]?"bg-primary":"bg-white/10"]),role:"switch","aria-checked":r.value[S.connectionId]},[s("span",{class:ue(["inline-block h-4 w-4 transform rounded-full bg-white transition-transform duration-200",r.value[S.connectionId]?"translate-x-6":"translate-x-1"])},null,2)],10,kn)])),s("div",Cn,[s("button",{onClick:Y=>e.onRejectPeer&&e.onRejectPeer(S),class:"h-12 rounded-xl border border-white/10 text-white/60 hover:text-rose-500 hover:bg-rose-500/10 hover:border-rose-500/30 font-black uppercase tracking-widest text-xs transition-all"}," Reject ",8,In),s("button",{onClick:Y=>u(S),class:"h-12 rounded-xl bg-primary text-primary-foreground shadow-neon hover:shadow-[0_0_30px_rgba(16,185,129,0.4)] font-black uppercase tracking-widest text-xs transition-all"}," Approve ",8,En)])]))),128))])])):E("",!0),U.value||I.value||P.value||A.value?(g(),h("div",An,[s("div",_n,[s("div",Nn,R(U.value||A.value?"Broadcasting Session":I.value?"Initializing Node":"Command Lobby Active"),1),s("h2",Pn,R(P.value?"Game Room":U.value?"Link Establishment":"Connecting..."),1),s("p",Tn,[P.value?(g(),h(ee,{key:0},[G(R(e.isInitiator?`Authorize peer nodes or launch protocol when ready (${e.playerCount}/${e.maxPlayers}).`:"Waiting for initiator to launch protocol."),1)],64)):(g(),h(ee,{key:1},[G("Synthesizing direct P2P mesh link to session nodes.")],64))])]),e.isInitiator?(g(),h("div",Gn,[P.value?(g(),h("button",{key:0,onClick:p[2]||(p[2]=(...S)=>e.onStartGame&&e.onStartGame(...S)),class:"w-full max-w-sm h-16 text-sm font-black uppercase tracking-[0.5em] rounded-2xl bg-primary text-primary-foreground shadow-[0_0_30px_rgba(16,185,129,0.3)] hover:shadow-[0_0_50px_rgba(16,185,129,0.5)] transition-all active:scale-[0.98]"}," Launch Protocol ")):E("",!0),m(l(Qe),null,{default:O(()=>[m(l(Be),{asChild:""},{default:O(()=>[...p[9]||(p[9]=[s("button",{class:"px-4 h-12 rounded-xl text-white/20 hover:text-rose-500 font-black uppercase tracking-widest text-[10px] transition-colors"}," Terminate Session ",-1)])]),_:1}),m(l(Je),null,{default:O(()=>[m(l(Ue),{class:"bg-black/80 fixed inset-0 z-[100] backdrop-blur-sm"}),m(l(He),{class:"glass-dark border border-white/10 rounded-[2rem] p-8 max-w-sm fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 z-[101]"},{default:O(()=>[s("div",Rn,[s("div",Ln,[m(l(je),{class:"w-8 h-8 text-rose-500"})]),m(l(Ve),{class:"text-xl font-black text-center text-white uppercase tracking-tight"},{default:O(()=>[...p[10]||(p[10]=[G(" Terminate Session? ",-1)])]),_:1}),m(l(Ye),{class:"text-center text-white/40 text-xs font-medium uppercase tracking-widest leading-relaxed"},{default:O(()=>[...p[11]||(p[11]=[G(" Reloading or leaving will cause the game session to be lost. Peers will be disconnected and discovery mesh link terminated. ",-1)])]),_:1})]),s("div",On,[m(l(ze),{class:"h-12 rounded-xl bg-white/5 border border-white/5 text-white/60 hover:bg-white/10 font-bold uppercase tracking-widest text-[10px]"},{default:O(()=>[...p[12]||(p[12]=[G(" Abort ",-1)])]),_:1}),m(l(We),{onClick:e.onCloseSession,class:"h-12 rounded-xl bg-rose-500 text-white font-black uppercase tracking-widest text-[10px] hover:bg-rose-600 shadow-neon-sm"},{default:O(()=>[...p[13]||(p[13]=[G(" Confirm ",-1)])]),_:1},8,["onClick"])])]),_:1})]),_:1})]),_:1})])):(g(),h("div",Kn,[P.value?E("",!0):(g(),h("div",$n,[...p[14]||(p[14]=[s("div",{class:"animate-spin rounded-full h-20 w-20 border-4 border-primary/5 border-t-primary shadow-neon"},null,-1),s("div",{class:"absolute inset-0 flex items-center justify-center"},[s("div",{class:"h-3 w-3 bg-primary rounded-full animate-pulse shadow-neon"})],-1)])])),s("div",Dn,[s("h3",Mn,R(P.value?"Node Synced":"Bridging Connections"),1),s("p",Fn,R(P.value?"Identity verified. Awaiting initiator's launch command.":"Establishing secure encrypted tunnel to host node."),1)]),m(l(Qe),null,{default:O(()=>[m(l(Be),{asChild:""},{default:O(()=>[...p[15]||(p[15]=[s("button",{class:"h-10 text-white/20 hover:text-rose-500 font-black uppercase tracking-widest text-[10px] transition-colors"}," Sever Connection ",-1)])]),_:1}),m(l(Je),null,{default:O(()=>[m(l(Ue),{class:"bg-black/80 fixed inset-0 z-[100] backdrop-blur-sm"}),m(l(He),{class:"glass-dark border border-white/10 rounded-[2rem] p-8 max-w-sm fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 z-[101]"},{default:O(()=>[s("div",jn,[s("div",Bn,[m(l(je),{class:"w-8 h-8 text-rose-500"})]),m(l(Ve),{class:"text-xl font-black text-center text-white uppercase tracking-tight"},{default:O(()=>[...p[16]||(p[16]=[G(" Sever Connection? ",-1)])]),_:1}),m(l(Ye),{class:"text-center text-white/40 text-xs font-medium uppercase tracking-widest leading-relaxed"},{default:O(()=>[...p[17]||(p[17]=[G(" Leaving or reloading will sever your node link. The game session progress will be lost. ",-1)])]),_:1})]),s("div",Jn,[m(l(ze),{class:"h-12 rounded-xl bg-white/5 border border-white/5 text-white/60 hover:bg-white/10 font-bold uppercase tracking-widest text-[10px]"},{default:O(()=>[...p[18]||(p[18]=[G(" Abort ",-1)])]),_:1}),m(l(We),{onClick:e.onBackToLobby,class:"h-12 rounded-xl bg-rose-500 text-white font-black uppercase tracking-widest text-[10px] hover:bg-rose-600 shadow-neon-sm"},{default:O(()=>[...p[19]||(p[19]=[G(" Confirm ",-1)])]),_:1},8,["onClick"])])]),_:1})]),_:1})]),_:1})])),e.isInitiator?(g(),h("div",Un,[e.signalingMode==="server"?(g(),h("div",Hn,[s("div",Vn,[s("div",Yn,[s("div",zn,[m(l(xt),{class:"w-5 h-5 text-primary"})]),p[20]||(p[20]=s("div",{class:"text-left"},[s("h3",{class:"text-sm font-black text-white uppercase tracking-wider"},"Share Session Link"),s("p",{class:"text-[10px] text-white/30 uppercase tracking-widest font-medium"},"Link this node to the discovery mesh")],-1))]),p[21]||(p[21]=s("div",{class:"flex items-center gap-2 px-3 py-1 bg-primary/5 border border-primary/20 rounded-full"},[s("div",{class:"w-1.5 h-1.5 bg-primary rounded-full animate-pulse shadow-neon"}),s("span",{class:"text-[9px] font-black text-primary uppercase tracking-widest"},"Live Broadcast")],-1))]),s("div",Wn,[s("div",Qn,R(y.value),1),s("button",{onClick:x,class:"shrink-0 h-12 px-6 rounded-xl bg-primary text-primary-foreground font-black uppercase tracking-widest text-[10px] shadow-neon hover:shadow-[0_0_25px_rgba(16,185,129,0.4)] transition-all active:scale-95 flex items-center gap-2"},[m(ft,{mode:"out-in",name:"fade"},{default:O(()=>[w.value?(g(),h("div",Xn,[m(l(vt),{class:"w-4 h-4"}),p[22]||(p[22]=G(" COPIED ",-1))])):(g(),h("div",Zn,[m(l(wt),{class:"w-4 h-4"}),p[23]||(p[23]=G(" COPY LINK ",-1))]))]),_:1})])])])):E("",!0),e.signalingMode==="manual"&&e.pendingSignaling.length>0?(g(),h("div",qn,[p[24]||(p[24]=s("h3",{class:"text-[11px] font-black text-white/20 uppercase tracking-[0.3em] px-1"},"Pending Link Authentications",-1)),s("div",es,[(g(!0),h(ee,null,$e(e.pendingSignaling,S=>(g(),X(nt,{key:S.id,connection:S,onOfferChange:e.onUpdateOffer,onAnswerChange:e.onUpdateAnswer,onCancel:e.onCancelSignaling},null,8,["connection","onOfferChange","onAnswerChange","onCancel"]))),128))])])):E("",!0)])):E("",!0),!e.isInitiator&&I.value&&e.signalingMode==="manual"&&e.pendingSignaling.length>0?(g(),h("div",ts,[m(nt,{connection:e.pendingSignaling[0],onOfferChange:e.onUpdateOffer,onAnswerChange:e.onUpdateAnswer,onCancel:e.onCancelSignaling},null,8,["connection","onOfferChange","onAnswerChange","onCancel"])])):E("",!0)])):E("",!0),!U.value&&!I.value&&!P.value&&!A.value?(g(),h("div",ns,[p[25]||(p[25]=mt('<div class="relative"><div class="h-20 w-20 bg-white/5 rounded-full flex items-center justify-center transition-transform hover:scale-110 duration-500"><div class="h-4 w-4 bg-white/10 rounded-full animate-ping"></div></div></div><div class="text-center space-y-2"><div class="text-xs font-black uppercase tracking-[0.5em] text-white/30">Null Reference: No Active Session</div><p class="text-[10px] text-white/20 uppercase tracking-widest px-10 leading-relaxed font-medium">Session data not found on current node. Return to discovery mesh.</p></div>',2)),s("button",{onClick:p[3]||(p[3]=(...S)=>e.onBackToLobby&&e.onBackToLobby(...S)),class:"h-12 px-8 rounded-xl border border-white/10 text-white/70 hover:text-primary hover:border-primary/40 font-black uppercase tracking-widest text-[10px] transition-all"}," Return to Discovery ")])):E("",!0)]))}}),as={class:"animate-zoom-in"},is=oe({__name:"ActivePhase",props:{GameComponent:{},connectedPeers:{},playerInfos:{},isInitiator:{type:Boolean},ledger:{},onAddLedger:{type:Function},onFinishGame:{type:Function}},setup(e){const t=e,n=C(()=>({connections:t.connectedPeers,playerNames:t.playerInfos.map(r=>r.name),playerInfos:t.playerInfos,isInitiator:t.isInitiator,ledger:t.ledger,onAddLedger:t.onAddLedger,onFinishGame:t.onFinishGame}));return(r,o)=>(g(),h("div",as,[m(rt,{component:e.GameComponent,componentProps:n.value},null,8,["component","componentProps"])]))}}),os={class:"space-y-6"},rs={class:"opacity-80 pointer-events-none grayscale-[0.2]"},cs={class:"glass-dark p-8 border border-white/5 shadow-glass-dark rounded-[2.5rem] animate-fade-in-up"},ls={class:"flex flex-col md:flex-row items-center justify-between gap-6"},ds={class:"flex items-center gap-4"},us={class:"h-14 w-14 bg-primary/10 rounded-2xl flex items-center justify-center border border-primary/20 shadow-neon"},ps={class:"flex gap-4 w-full md:w-auto"},gs=oe({__name:"FinishedPhase",props:{GameComponent:{},connectedPeers:{},playerInfos:{},isInitiator:{type:Boolean},ledger:{},onBackToLobby:{type:Function}},setup(e){const t=e,n=C(()=>({connections:t.connectedPeers,playerNames:t.playerInfos.map(r=>r.name),playerInfos:t.playerInfos,isInitiator:t.isInitiator,ledger:t.ledger,onAddLedger:()=>{},onFinishGame:()=>{}}));return(r,o)=>(g(),h("div",os,[s("div",rs,[m(rt,{component:e.GameComponent,componentProps:n.value},null,8,["component","componentProps"])]),s("div",cs,[s("div",ls,[s("div",ds,[s("div",us,[m(l(Se),{class:"w-8 h-8 text-primary"})]),o[1]||(o[1]=s("div",{class:"space-y-1"},[s("h3",{class:"text-xl font-black text-white uppercase tracking-tight"},"Match Finalized"),s("p",{class:"text-[10px] text-white/30 uppercase tracking-widest font-black"},"All cycles complete. Handshake terminated.")],-1))]),s("div",ps,[s("button",{onClick:o[0]||(o[0]=(...b)=>e.onBackToLobby&&e.onBackToLobby(...b)),class:"w-full md:w-56 h-14 rounded-2xl bg-primary text-primary-foreground shadow-neon hover:shadow-[0_0_30px_rgba(16,185,129,0.4)] font-black uppercase tracking-[0.3em] text-xs transition-all"}," Return to Discovery ")])])]),o[2]||(o[2]=s("div",{class:"text-center text-white/10 text-[9px] font-black uppercase tracking-[0.4em] italic pt-4"}," Node state captured. Verification record locked inside vault. ",-1))]))}}),hs={class:"glass-dark p-8 rounded-[2rem] border border-white/5 shadow-glass-dark"},ys={class:"text-xs font-black uppercase tracking-[0.3em] text-white/40 mb-6 flex items-center gap-3"},fs={class:"space-y-4"},ms={class:"relative"},bs={key:0,class:"absolute inset-0 h-3 w-3 bg-primary rounded-full animate-ping opacity-50"},vs={class:"flex flex-col flex-1"},ws={class:"flex items-center gap-2"},xs={class:"text-sm font-black text-white uppercase tracking-tight"},Ss={key:0,class:"text-primary font-black ml-1"},ks={key:0,class:"px-2 py-0.5 bg-primary/10 text-primary border border-primary/20 rounded-full text-[9px] font-black uppercase tracking-wider"},Cs={key:0,class:"flex items-center gap-2 mt-2"},Is=["onClick","aria-checked"],Es={class:"text-[9px] text-white/40 uppercase tracking-wider font-medium"},As={class:"text-[8px] text-white/30"},_s={key:0,class:"ml-auto flex items-center gap-3"},Ns=["onClick"],Ps={key:0,class:"text-[10px] text-white/20 uppercase font-black tracking-[0.3em] text-center py-6 animate-pulse"},Ts=oe({__name:"Players",props:{players:{},onRemove:{type:Function},onSaveIdentity:{type:Function},isKnownIdentity:{type:Function}},setup(e){const t=e,n=D({}),r=D({}),o=async()=>{for(const y of t.players)y.publicKey&&!y.isLocal&&t.isKnownIdentity&&(n.value[y.id]=await t.isKnownIdentity(y.publicKey))},b=async y=>{const x=r.value[y.id],u=!x;console.log("[Players] Toggle save for:",y.name,"from",x,"to",u),u?await w(y):r.value[y.id]=!1},w=async y=>{if(console.log("[Players] Attempting to save identity for:",y.name,"publicKey:",y.publicKey,"isLocal:",y.isLocal),!y.publicKey){console.warn("[Players] Cannot save identity - no public key for:",y.name);return}if(!t.onSaveIdentity){console.warn("[Players] Cannot save identity - onSaveIdentity prop not provided");return}try{r.value[y.id]=!0,await t.onSaveIdentity(y),n.value[y.id]=!0,console.log("[Players] Successfully saved identity for:",y.name)}catch(x){console.error("[Players] Error saving identity:",x),r.value[y.id]=!1}};return it(()=>{o()}),Q(()=>t.players,()=>{o()},{deep:!0}),(y,x)=>(g(),h("div",hs,[s("h3",ys,[m(l(ke),{class:"w-5 h-5 text-primary"}),G(" Dwellers In Lobby ("+R(e.players.length)+") ",1)]),s("div",fs,[(g(!0),h(ee,null,$e(e.players,u=>(g(),h("div",{key:u.id,class:"flex items-center gap-4 p-4 rounded-2xl bg-white/5 border border-white/10 group hover:neon-border transition-all duration-500 animate-fade-in-left"},[s("div",ms,[s("div",{class:ue(["h-3 w-3 rounded-full",u.isConnected?"bg-primary shadow-neon":"bg-rose-500 shadow-[0_0_15px_rgba(244,63,94,0.4)]"])},null,2),u.isConnected?(g(),h("div",bs)):E("",!0)]),s("div",vs,[s("div",ws,[s("span",xs,[G(R(u.name)+" ",1),u.isLocal?(g(),h("span",Ss,"(LOCAL)")):E("",!0)]),!u.isLocal&&n.value[u.id]?(g(),h("span",ks," Known Identity ")):E("",!0)]),!u.isLocal&&u.isConnected&&!n.value[u.id]?(g(),h("div",Cs,[s("button",{onClick:P=>b(u),class:ue(["relative inline-flex h-5 w-9 items-center rounded-full transition-colors duration-200",r.value[u.id]?"bg-primary":"bg-white/10"]),role:"switch","aria-checked":r.value[u.id]},[s("span",{class:ue(["inline-block h-3 w-3 transform rounded-full bg-white transition-transform duration-200",r.value[u.id]?"translate-x-5":"translate-x-1"])},null,2)],10,Is),s("span",Es,R(r.value[u.id]?"Saved for auto-approve":"Auto-approve next time"),1),s("span",As,R(u.isLocal?"(Local)":"(Remote)")+" "+R(u.publicKey?"PK":"PK"),1)])):E("",!0)]),u.isConnected?E("",!0):(g(),h("div",_s,[x[0]||(x[0]=s("span",{class:"text-[9px] text-rose-500 font-black uppercase tracking-widest"},"Node Disconnected",-1)),e.onRemove&&!u.isLocal?(g(),h("button",{key:0,class:"h-8 w-8 flex items-center justify-center text-rose-500 hover:text-rose-400 hover:bg-rose-500/10 transition-colors border border-transparent hover:border-rose-500/30 rounded-xl",onClick:P=>e.onRemove(u.id),title:"Sever entry"},[m(l(kt),{class:"w-4 h-4"})],8,Ns)):E("",!0)]))]))),128)),e.players.length===0?(g(),h("p",Ps," Scanning for incoming nodes... ")):E("",!0)])]))}}),Gs={class:"min-h-screen bg-background"},Rs={key:0,class:"max-w-7xl mx-auto p-6 space-y-12"},Ls={class:"text-3xl font-black tracking-tighter uppercase text-white"},Os={class:"text-gradient"},Ks={class:"animate-fade-in-up"},$s={class:"mt-12 max-w-2xl"},Ds={key:1,class:"p-10 text-center text-white/50 uppercase font-black tracking-widest"},Ms="server",Qs=oe({__name:"BoardView",setup(e){const t=st(),n=at(),r=C(()=>t.params.gameId),o=C(()=>t.params.boardId),b=C(()=>ot(r.value||"")),w=()=>n.push("/games"),{snapshot:y,send:x,playerInfos:u,connectedPeers:P,pendingSignaling:U,pendingJoinRequests:I,isInitiator:A,isGameStarted:v,onHostAGame:p,isKnownIdentity:S,onApprovePeer:Y,onRejectPeer:z,saveIdentityOnApprove:Ce,updateOffer:Ie,updateAnswer:ne,startGame:ge,onFinishGame:he,onAddLedger:se,onAcceptGuest:Ee,onRejectGuest:Ae,onCancelSignaling:_e,onBackToGames:ye,signalingClient:fe,isServerConnecting:Ne}=Kt(),Pe=async B=>{if(console.log("[BoardView] handleSavePlayerIdentity called for:",B.name,"publicKey:",B.publicKey),!B.publicKey){console.warn("[BoardView] Cannot save - no public key");return}const V={id:`identity-${Date.now()}`,name:B.name,publicKey:B.publicKey,addedAt:Date.now()};console.log("[BoardView] Saving identity to DB:",V),await pe.addKnownIdentity(V),console.log("[BoardView] Identity saved successfully"),xe.success("Identity Saved",{description:`${B.name} has been added to your known identities.`})},me=C(()=>P.value),Te=()=>{ye(),w()},be=C(()=>y.value?.matches("finished")||!1),Ge=C(()=>!v.value&&!be.value),ve=B=>{Ge.value&&(B.preventDefault(),B.returnValue="")};return it(async()=>{if(await pe.cleanupOldHostedSessions(),o.value&&y.value?.matches("idle"))if(await pe.isHosting(o.value)){const V=parseInt(t.query.maxPlayers)||2;console.log("[BOARDVIEW] Initializing HOST state for boardId:",o.value,"maxPlayers:",V),x({type:"HOST",maxPlayers:V,boardId:o.value})}else console.log("[BOARDVIEW] Initializing GUEST state for boardId:",o.value),x({type:"JOIN",boardId:o.value});window.addEventListener("beforeunload",ve)}),bt(()=>{window.removeEventListener("beforeunload",ve)}),(B,V)=>(g(),h("div",Gs,[b.value?(g(),h("div",Rs,[s("h1",Ls,[V[0]||(V[0]=G(" Lobby: ",-1)),s("span",Os,R(b.value.name),1)]),s("div",Ks,[be.value?(g(),X(gs,{key:0,GameComponent:b.value.component,connectedPeers:me.value,playerInfos:l(u),isInitiator:l(A),ledger:l(y)?.context?.ledger||[],onBackToLobby:w},null,8,["GameComponent","connectedPeers","playerInfos","isInitiator","ledger"])):l(v)?(g(),X(is,{key:1,GameComponent:b.value.component,connectedPeers:me.value,playerInfos:l(u),isInitiator:l(A),ledger:l(y)?.context?.ledger||[],onAddLedger:l(se),onFinishGame:l(he)},null,8,["GameComponent","connectedPeers","playerInfos","isInitiator","ledger","onAddLedger","onFinishGame"])):(g(),X(ss,{key:2,state:l(y),isInitiator:l(A),signalingMode:Ms,isServerConnecting:l(Ne),signalingClient:l(fe),pendingSignaling:l(U),pendingJoinRequests:l(I),isKnownIdentity:l(S),onStartGame:l(ge),onHostAGame:l(p),onUpdateOffer:l(Ie),onUpdateAnswer:l(ne),onCloseSession:Te,onBackToLobby:w,onAcceptGuest:l(Ee),onRejectGuest:l(Ae),onApprovePeer:l(Y),onRejectPeer:l(z),onSaveIdentity:l(Ce),onCancelSignaling:l(_e),onRemovePlayer:ce=>l(x)({type:"REMOVE_PLAYER",playerId:ce}),playerCount:l(u).length,maxPlayers:l(y)?.context?.maxPlayers||2,boardId:o.value,gameId:r.value},null,8,["state","isInitiator","isServerConnecting","signalingClient","pendingSignaling","pendingJoinRequests","isKnownIdentity","onStartGame","onHostAGame","onUpdateOffer","onUpdateAnswer","onAcceptGuest","onRejectGuest","onApprovePeer","onRejectPeer","onSaveIdentity","onCancelSignaling","onRemovePlayer","playerCount","maxPlayers","boardId","gameId"])),s("div",$s,[m(Ts,{players:l(u),onRemove:l(A)?ce=>l(x)({type:"REMOVE_PLAYER",playerId:ce}):void 0,onSaveIdentity:Pe,isKnownIdentity:l(S)},null,8,["players","onRemove","isKnownIdentity"])])])])):(g(),h("div",Ds," Game not found in grid. "))]))}});export{Qs as default};
