import{c as te,v as De,x as Y,y as ft,r as D,m as X,z as at,u as ot,A as mt,i as C,s as Se,d as ne,a as h,h as E,f as l,b as s,e as m,j as G,F as ee,t as R,l as W,o as g,_ as se,k as Me,q as O,T as vt,p as bt,n as pe,B as wt,C as xt,D as it,E as St,G as kt,H as Ct,g as rt}from"./index-DVPCjXsa.js";import{v as Fe,a as ct}from"./GameRegistry-DJuJOaKc.js";import{i as ce}from"./_virtual___federation_fn_import-PdSsH34n.js";import{S as Le,C as ke,T as Be}from"./sessions-BxwkG9K-.js";import{d as ge,_ as Je,R as Ue,A as He,k as Ve,O as Ye,V as We,F as ze,M as Qe,N as Xe,T as Ze}from"./db-B1sE8bw5.js";const It=te("check",[["path",{d:"M20 6 9 17l-5-5",key:"1gmf2c"}]]);const qe=te("clipboard",[["rect",{width:"8",height:"4",x:"8",y:"2",rx:"1",ry:"1",key:"tgr4d6"}],["path",{d:"M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2",key:"116196"}]]);const Et=te("copy",[["rect",{width:"14",height:"14",x:"8",y:"8",rx:"2",ry:"2",key:"17jyea"}],["path",{d:"M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2",key:"zix9uf"}]]);const At=te("link",[["path",{d:"M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71",key:"1cjeqo"}],["path",{d:"M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71",key:"19qd67"}]]);const _t=te("log-in",[["path",{d:"m10 17 5-5-5-5",key:"1bsop3"}],["path",{d:"M15 12H3",key:"6jk70r"}],["path",{d:"M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4",key:"u53s6r"}]]);const Pt=te("user-minus",[["path",{d:"M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2",key:"1yyitq"}],["circle",{cx:"9",cy:"7",r:"4",key:"nufk8"}],["line",{x1:"22",x2:"16",y1:"11",y2:"11",key:"1shjgl"}]]);const Ce=te("user-plus",[["path",{d:"M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2",key:"1yyitq"}],["circle",{cx:"9",cy:"7",r:"4",key:"nufk8"}],["line",{x1:"19",x2:"19",y1:"8",y2:"14",key:"1bvyxn"}],["line",{x1:"22",x2:"16",y1:"11",y2:"11",key:"1shjgl"}]]),{createActor:ia,toObserver:ra}=await ce("xstate");function Nt(e,t){return e===t}const et=()=>{};function Tt(e,t,n=Nt){const r=ft(e)?e:De(e),o=De(t(r.value?.getSnapshot())),v=w=>{n(o.value,w)||(o.value=w)};return Y(r,(w,y,x)=>{if(o.value=t(w?.getSnapshot()),!w)return;const u=w.subscribe({next:N=>{v(t(N))},error:et,complete:et});x(()=>u.unsubscribe())},{immediate:!0}),o}const re=!1,Gt=()=>{const e={net:re,state:re,info:re,error:!0,lobby:re,sig:re,webrtc:re};try{const t=localStorage.getItem("debug_config");if(t)return{...e,...JSON.parse(t)}}catch{}return e},Rt=Gt(),d={shouldLog:e=>Rt[e],netIn:(e,t)=>{if(!d.shouldLog("net"))return;let n=t;try{n=JSON.parse(t)}catch{}console.log("%c[NET-IN] %cfrom %s:","color: #22c55e; font-weight: bold;","color: #64748b;",e.slice(0,8),n)},netOut:(e,t)=>{if(!d.shouldLog("net"))return;let n=t;try{n=JSON.parse(t)}catch{}console.log("%c[NET-OUT] %cto %s:","color: #3b82f6; font-weight: bold;","color: #64748b;",e.slice(0,8),n)},state:(e,t,n,r="state")=>{if(!d.shouldLog(r))return;console.log("%c[%s-%s] %c%s",`color: ${e==="EVENT"?"#f59e0b":"#10b981"}; font-weight: bold;`,r.toUpperCase(),e,"color: inherit;",t,n||"")},lobby:(e,t,n)=>{d.state(e,t,n,"lobby")},sig:(e,...t)=>{d.shouldLog("sig")&&console.log("%c[SIG] %c%s","color: #ec4899; font-weight: bold;","color: inherit;",e,...t)},webrtc:(e,...t)=>{d.shouldLog("webrtc")&&console.log("%c[WEBRTC] %c%s","color: #06b6d4; font-weight: bold;","color: inherit;",e,...t)},info:(...e)=>{d.shouldLog("info")&&console.log("%c[INFO]","color: #8b5cf6; font-weight: bold;",...e)},error:(...e)=>{d.shouldLog("error")&&console.error("%c[ERROR]","color: #ef4444; font-weight: bold;",...e)}};var L=(e=>(e.new="new",e.started="started",e.readyToAccept="readyToAccept",e.accepted="accepted",e.answered="answered",e.connected="established",e.closed="closed",e))(L||{});class de{id;peerConnection;localPlayerName;remotePlayerName;remotePublicKey;dataChannel;iceCandidates;status;signal;messageListeners=[];onClose;updateView;constructor(t){this.id=Fe(),this.updateView=t,this.peerConnection=new RTCPeerConnection(Lt),this.iceCandidates=[];let n=null;this.peerConnection.onicecandidate=r=>{r.candidate&&(this.iceCandidates.push(r.candidate),(this.status==="started"||this.status==="answered")&&(this.updateSignal(),n&&clearTimeout(n),n=setTimeout(()=>{this.updateView(this),n=null},200)))},this.peerConnection.onconnectionstatechange=r=>{const o=this.peerConnection.connectionState;d.webrtc(this.id+": Connection state changed to "+o),o==="connected"?(this.status="established",this.updateView(this)):(o==="disconnected"||o==="failed"||o==="closed")&&this.close()}}updateSignal(t){this.peerConnection.localDescription&&(this.signal=new Z(this.id,this.peerConnection.localDescription,t||this.localPlayerName,this.iceCandidates))}openDataChannel(){this.dataChannel=this.peerConnection.createDataChannel("gameData"),this.dataChannel.onopen=t=>d.webrtc(this.id+" Data channel state is: "+this.dataChannel.readyState),this.dataChannel.onclose=t=>d.webrtc(this.id+" Data channel state is: "+this.dataChannel.readyState),this.dataChannel.onerror=t=>d.error(this.id+" Error ",t),this.dataChannel.onmessage=t=>{d.netIn(this.id,t.data),this.messageListeners.forEach(n=>n(t.data))}}setDataChannelCallback(){this.peerConnection.ondatachannel=t=>{d.webrtc("Receive Channel Callback",t),this.dataChannel=t.channel,this.dataChannel.onmessage=n=>{d.netIn(this.id,n.data),this.messageListeners.forEach(r=>r(n.data))},this.dataChannel.onopen=n=>{const r=this.dataChannel.readyState;d.webrtc(this.id+": Data channel state is: "+r),r=="open"&&(d.webrtc(this.id+": Sending ping"),this.send("Ping"))},this.dataChannel.onclose=n=>{const r=this.dataChannel.readyState;d.webrtc(this.id+": Data channel state is: "+r)}}}async prepareOfferSignal(t){console.log("[WebRTC] prepareOfferSignal - playerName:",t),this.localPlayerName=t,this.status="new";try{const n=await this.peerConnection.createOffer();await this.peerConnection.setLocalDescription(n),this.status="started",this.updateSignal(),this.updateView(this)}catch(n){this.onCreateSessionDescriptionError(n)}}async send(t){this.dataChannel&&this.dataChannel.readyState==="open"&&(d.netOut(this.id,t),await this.dataChannel.send(t))}addMessageListener(t){this.messageListeners.push(t)}removeMessageListener(t){this.messageListeners=this.messageListeners.filter(n=>n!==t)}async acceptOffer(t,n){const r=typeof t=="string"?Z.fromString(t):t;console.log("[WebRTC] acceptOffer - acceptingPlayerName:",n),this.remotePlayerName=r.playerName,this.localPlayerName=n,await this.peerConnection.setRemoteDescription(r.session),r.iceCandidates.forEach(o=>{this.peerConnection.addIceCandidate(o)});try{const o=await this.peerConnection.createAnswer();await this.peerConnection.setLocalDescription(o),this.status="answered",this.updateSignal(),this.updateView(this),this.updateView(this)}catch(o){this.onCreateSessionDescriptionError(o)}}onCreateSessionDescriptionError(t){d.error("Failed to create session description: "+t.toString())}async acceptAnswer(t){const n=typeof t=="string"?Z.fromString(t):t;d.webrtc(this.id+": Accepting answer signal from "+n.playerName),console.log("[WebRTC] acceptAnswer - Guest name:",n.playerName);try{await this.peerConnection.setRemoteDescription(n.session),this.remotePlayerName=n.playerName,n.iceCandidates&&(d.webrtc(this.id+`: Adding ${n.iceCandidates.length} ICE candidates from answer`),n.iceCandidates.forEach(r=>{this.peerConnection.addIceCandidate(r).catch(o=>d.error("Error adding ICE candidate:",o))})),this.updateView(this)}catch(r){d.error(this.id+": Failed to set remote description from answer",r)}}close(){this.dataChannel&&this.dataChannel.close(),this.peerConnection.close(),this.status="closed",this.onClose?.(),this.updateView(this)}}class Z{connectionId;session;playerName;iceCandidates;constructor(t,n,r,o){this.session=n,this.connectionId=t,this.playerName=r,this.iceCandidates=o}toString(){return btoa(JSON.stringify(this))}static fromString(t){const n=JSON.parse(atob(t));return new Z(n.connectionId,n.session,n.playerName,n.iceCandidates)}}const Lt={iceServers:[{urls:"stun:stun.l.google.com:19302"}]};class Ot{socket=null;onMessageCallback;gameId;boardId;peerName;publicKey=null;constructor(t,n,r,o){this.gameId=t,this.boardId=n||"",this.peerName=r,this.onMessageCallback=o}updateBoardId(t){d.sig(`Updating signaling boardId from ${this.boardId} to ${t}`),this.boardId=t}async connect(t,n,r){let o="wss://pebsg4v5yk.execute-api.eu-central-1.amazonaws.com/production";const v=new URLSearchParams;v.append("x-api-key",t),n&&(v.append("x-pubkey",n),this.publicKey=n),r&&v.append("x-sig",r);const w=`${o}?${v.toString()}`;return new Promise((y,x)=>{d.sig(`Connecting to signaling server: ${w}`),this.socket=new WebSocket(w),this.socket.onopen=()=>{d.sig("WebSocket Connection Open."),y()},this.socket.onmessage=u=>{d.sig("Raw message from server:",u.data);try{const N=JSON.parse(u.data);this.onMessageCallback(N)}catch(N){d.error("Failed to parse signaling message",N)}},this.socket.onclose=u=>{d.sig("Disconnected from signaling server",u.code,u.reason),this.socket=null},this.socket.onerror=u=>{d.error("Signaling WebSocket error:",u),x(u)}})}hostRegister(t,n,r,o){return d.sig("Registering as host for board:",t),this.send({type:"hostRegister",boardId:t,gameId:n,peerName:r,publicKey:o})}guestJoin(t,n,r,o){return d.sig("Joining as guest for board:",t),this.send({type:"guestJoin",boardId:t,peerName:n,publicKey:r,encryptionPublicKey:o})}hostOffer(t,n,r,o,v){return d.sig("Sending offer to guest:",t),this.send({type:"hostOffer",target:t,guestPublicKey:n,offer:r,peerName:this.peerName,publicKey:this.publicKey||void 0,encryptionPublicKey:o,iv:v,boardId:this.boardId})}guestAnswer(t,n,r,o){return d.sig("Sending answer to host:",t),this.send({type:"guestAnswer",target:t,publicKey:n,answer:r,peerName:this.peerName,iv:o,boardId:this.boardId})}deleteOffer(){if(!this.socket||this.socket.readyState!==WebSocket.OPEN){d.sig("Cannot delete offer: Signaling socket is not open.");return}d.sig("Deleting offer for game:",this.gameId,"board:",this.boardId),this.send({type:"deleteOffer",gameId:this.gameId,...this.boardId?{boardId:this.boardId}:{}})}send(t){if(!this.socket||this.socket.readyState!==WebSocket.OPEN)return d.error("Signaling socket not open. State:",this.socket?.readyState),!1;const n={action:"sendMessage",...t};return d.sig("Sending payload to AWS:",n),this.socket.send(JSON.stringify(n)),!0}disconnect(t=!1){t&&this.isConnected&&this.deleteOffer(),this.socket?.close(),this.socket=null}get isConnected(){return!!this.socket&&this.socket.readyState===WebSocket.OPEN}}const{createMachine:Kt,assign:Oe}=await ce("xstate"),$t=Kt({types:{},id:"lobby",initial:"selection",context:({input:e})=>({playerName:e.playerName,signalingMode:null,playerCount:2}),states:{selection:{on:{SELECT_MODE:{target:"discovery",actions:Oe({signalingMode:({event:e})=>e.mode})}}},discovery:{on:{GOTO_SELECTION:"selection",SET_PLAYER_COUNT:{actions:Oe({playerCount:({event:e})=>e.count})},SELECT_MODE:{actions:Oe({signalingMode:({event:e})=>e.mode})}}}}}),{createMachine:Dt,assign:K}=await ce("xstate"),{createLobbyMessage:xe}=await ce("@mykoboard/integration"),Mt=Dt({types:{},id:"board",initial:"idle",context:({input:e})=>({connections:new Map,playerStatuses:new Map,isInitiator:e.isInitiator||!1,isGameStarted:!1,isGameFinished:!1,playerName:e.playerName,ledger:[],pendingGuest:null,externalParticipants:[],maxPlayers:e.maxPlayers||2,boardId:e.boardId||""}),states:{idle:{on:{HOST:{target:"hosting",actions:K({isInitiator:!0,maxPlayers:({event:e})=>e.maxPlayers||2,boardId:({event:e})=>e.boardId})},JOIN:{target:"joining",actions:K({isInitiator:!1,boardId:({event:e})=>e.boardId})}}},hosting:{on:{REQUEST_JOIN:{target:"approving",actions:K({pendingGuest:({event:e})=>({id:e.connectionId,name:e.peerName,answer:e.answer,connection:e.connection})})}},always:[{target:"preparation",guard:"hasConnections"}]},joining:{always:[{target:"preparation",guard:"hasConnections"}]},approving:{on:{ACCEPT_GUEST:{target:"preparation",actions:["acceptGuest","clearPendingGuest"]},REJECT_GUEST:{target:"hosting",actions:["rejectGuest","clearPendingGuest"]}}},preparation:{on:{START_GAME:{target:"playing",actions:["setGameStarted","broadcastStartGame"]},GAME_STARTED:{target:"playing",actions:"setGameStarted"},REQUEST_JOIN:{target:"approving",actions:K({pendingGuest:({event:e})=>({id:e.connectionId,name:e.peerName,answer:e.answer,connection:e.connection})})}}},playing:{on:{FINISH_GAME:{target:"finished",actions:K({isGameFinished:!0})}}},finished:{on:{RESET_GAME:{target:"preparation",actions:["resetGameStarted","broadcastResetGame"]}}}},on:{UPDATE_CONNECTION:{actions:["updateConnection","syncConnection"]},PEER_DISCONNECTED:{actions:["updateConnectionStatus","removeConnection"]},SET_PLAYER_STATUS:{actions:"setPlayerStatus"},REMOVE_PLAYER:{actions:"removePlayer"},SYNC_LEDGER:{actions:"syncLedger"},LOAD_LEDGER:{actions:K({ledger:({event:e})=>e.ledger})},SYNC_PARTICIPANTS:{actions:K({externalParticipants:({event:e})=>e.participants})},GAME_STARTED:{actions:"setGameStarted"},GAME_RESET:{actions:"resetGameStarted"},CLOSE_SESSION:{target:".idle",actions:["resetContext","closeAllConnections"]}}},{actions:{setGameStarted:K({isGameStarted:!0,isGameFinished:!1}),resetGameStarted:K({isGameStarted:!1,isGameFinished:!1,ledger:[]}),setPlayerStatus:K(({context:e,event:t})=>{if(t.type!=="SET_PLAYER_STATUS")return e;const n=new Map(e.playerStatuses);return n.set(t.playerId,t.status),{playerStatuses:n}}),updateConnectionStatus:K(({context:e,event:t})=>{if(t.type!=="PEER_DISCONNECTED")return e;const n=new Map(e.connections),r=n.get(t.connectionId);return r&&(r.status=L.closed),{connections:n}}),updateConnection:K(({context:e,event:t})=>{if(t.type!=="UPDATE_CONNECTION")return e;const n=t.connection;if(n.status===L.closed&&!e.connections.has(n.id))return e;const r=e.connections.get(n.id);if(r){const w=r._lastKnownStatus!==n.status,y=r._lastKnownSignal!==(n.signal?.toString()||"");if(!w&&!y)return e}n._lastKnownStatus=n.status,n._lastKnownSignal=n.signal?.toString()||"";const o=new Map(e.connections);o.set(n.id,n);const v=new Map(e.playerStatuses);return v.has(n.id)||v.set(n.id,"lobby"),{connections:o,playerStatuses:v}}),syncConnection:({context:e,event:t})=>{if(t.type!=="UPDATE_CONNECTION")return;const n=t.connection;if(e.isInitiator&&n.status===L.connected){if(n._synced)return;n._synced=!0,d.lobby("STATE",`Syncing new connection: ${n.id}`),n.send(JSON.stringify(xe("SYNC_LEDGER",e.ledger))),e.isGameStarted&&n.send(JSON.stringify(xe("GAME_STARTED")))}},removeConnection:K(({context:e,event:t})=>{if(t.type!=="PEER_DISCONNECTED")return e;const n=new Map(e.connections);return n.delete(t.connectionId),{connections:n}}),removePlayer:K(({context:e,event:t})=>{if(t.type!=="REMOVE_PLAYER")return e;const n=new Map(e.connections),r=n.get(t.playerId);r&&(r.close(),n.delete(t.playerId));const o=new Map(e.playerStatuses);return o.delete(t.playerId),{connections:n,playerStatuses:o}}),syncLedger:K(({context:e,event:t})=>t.type!=="SYNC_LEDGER"?e:{ledger:t.ledger}),broadcastStartGame:({context:e})=>{e.isInitiator&&e.connections.forEach(t=>{t.status===L.connected&&t.send(JSON.stringify(xe("START_GAME")))})},broadcastResetGame:({context:e})=>{e.isInitiator&&e.connections.forEach(t=>{t.status===L.connected&&t.send(JSON.stringify(xe("GAME_RESET")))})},closeAllConnections:({context:e})=>{e.connections.forEach(t=>t.close())},acceptGuest:({context:e})=>{e.pendingGuest&&(d.sig("Accepting guest:",e.pendingGuest.name),e.pendingGuest.connection.acceptAnswer(e.pendingGuest.answer))},rejectGuest:({context:e})=>{e.pendingGuest&&(d.sig("Rejecting guest:",e.pendingGuest.name),e.pendingGuest.connection.close())},resetContext:K(({context:e})=>({connections:new Map,playerStatuses:new Map,ledger:[],isGameStarted:!1,isGameFinished:!1,isInitiator:!1,maxPlayers:e.maxPlayers,pendingGuest:null,externalParticipants:[],boardId:""})),clearPendingGuest:K({pendingGuest:null})},guards:{hasConnections:({context:e})=>Array.from(e.connections.values()).some(t=>t.status===L.connected)}}),{createActor:lt}=await ce("xstate"),V=D(null),dt=D(!0),tt=D([]);lt($t,{input:{playerName:"Anonymous"}}).start();const Ke=new Map;function $e(e,t,n=!1,r=2){if(!Ke.has(e)){d.lobby("STATE",`Creating new board actor for ${e}`);const o=lt(Mt,{input:{playerName:t,boardId:e,isInitiator:n,maxPlayers:r}});o.start(),Ke.set(e,o)}return Ke.get(e)}const Ft=async()=>{if(V.value)return;const e=X.getInstance();V.value=await e.getIdentity(),dt.value=!1};Ft();const{Ledger:jt,createLobbyMessage:ue,isLobbyMessage:nt}=await ce("@mykoboard/integration");function Bt(){const e=at(),t=ot(),n=D(null),r=D(!1),o=D(""),v=D(!1),w=D([]),y=D(new Map),x=C(()=>e.params.gameId),u=C(()=>e.params.boardId),N=C(()=>ct(x.value||"")),J=C(()=>!!u.value),I=C(()=>!u.value||u.value==="manual"?null:$e(u.value,V.value?.name||"Anonymous",!1)),A=Tt(I,i=>i),b=C(()=>A.value?.context?.isInitiator||!1),p=C(()=>A.value?.context?.isGameStarted||!1),S=C(()=>A.value?.context?.connections||new Map),z=C(()=>Array.from(S.value.values())),Q=C(()=>z.value.filter(i=>i.status===L.connected)),Ie=C(()=>z.value.filter(i=>i.status!==L.connected&&i.status!==L.closed)),Ee=C(()=>J.value?"game":"lobby"),ae=C(()=>{if(!A.value)return[];const i=A.value.context,c=tt.value.find(a=>a.boardId===u.value),f=c?.participants||[],_=i.externalParticipants||[],P=f.find(a=>a.isYou),U={id:V.value?.id||"local",name:i.playerName,status:p.value?"game":"lobby",isConnected:!0,isLocal:!0,isHost:P?P.isHost:b.value,publicKey:V.value?.publicKey},k=[],M=new Set;if(b.value)k.push(U),M.add(U.id);else if(_.length>0){const a=_.find(T=>T.isHost);if(a){const T=Q.value.find($=>$.status===L.connected);k.push({id:a.id,name:a.name,status:(T?i.playerStatuses.get(T.id):null)||(p.value?"game":"lobby"),isConnected:!!T,isLocal:!1,isHost:!0,publicKey:T?.remotePublicKey||a.publicKey}),M.add(a.id)}}return b.value?z.value.forEach(a=>{if(!M.has(a.id)){const T=f.find(F=>F.id===a.id),$=a.remotePublicKey||T?.publicKey;console.log("[playerInfos] Adding peer:",a.remotePlayerName,"remotePublicKey:",a.remotePublicKey?.substring(0,20),"publicKey:",$?.substring(0,20)),k.push({id:a.id,name:a.remotePlayerName||T?.name||"Anonymous",status:i.playerStatuses.get(a.id)||"lobby",isConnected:a.status===L.connected,isLocal:!1,isHost:!1,publicKey:$}),M.add(a.id)}}):_.length>0&&_.forEach(a=>{a.isHost||a.id==="local"||(a.name===U.name&&!M.has(a.id)?(k.push({...U,id:a.id}),M.add(a.id)):(k.push({id:a.id,name:a.name,status:p.value?"game":"lobby",isConnected:!0,isLocal:!1,isHost:!1,publicKey:a.publicKey}),M.add(a.id)))}),f.forEach(a=>{!a.isYou&&!M.has(a.id)&&k.push({id:a.id,name:a.name,status:c?.status==="finished"||p.value?"game":"lobby",isConnected:!1,isLocal:!1,isHost:a.isHost})}),k});mt(()=>{const i=A.value;i?.status==="active"&&u.value&&u.value!=="manual"&&Le.saveSession({gameId:x.value,boardId:u.value,playerName:i.context.playerName,gameName:N.value?.name||"Unknown Game",lastPlayed:Date.now(),status:i.matches("finished")?"finished":"active",ledger:i.context.ledger,participants:ae.value.map(c=>({id:c.id,name:c.name,isYou:c.isLocal,isHost:c.isHost}))})});const he=new Map,ye=new Map,oe=i=>{const c=I.value;if(!c)return;const f=he.get(i.id),_=i.signal?.toString()||"",P=ye.get(i.id);f===i.status&&P===_||(he.set(i.id,i.status),ye.set(i.id,_),c.send({type:"UPDATE_CONNECTION",connection:i}),i._hasListener||(i.addMessageListener(U=>{try{const k=JSON.parse(U);if(!nt(k))return;if(k.type==="START_GAME"&&c.send({type:"START_GAME"}),k.type==="GAME_STARTED"&&c.send({type:"GAME_STARTED"}),k.type==="GAME_RESET"&&c.send({type:"GAME_RESET"}),k.type==="NEW_BOARD"&&t.replace(`/games/${x.value}/${k.payload}`),k.type==="SYNC_PLAYER_STATUS"&&c.send({type:"SET_PLAYER_STATUS",playerId:i.id,status:k.payload}),k.type==="SYNC_PARTICIPANTS"&&c.send({type:"SYNC_PARTICIPANTS",participants:k.payload}),k.type==="SYNC_LEDGER"){const M=k.payload;for(const a of M)a.signature&&a.signerPublicKey&&X.verify(a.action,a.signature,a.signerPublicKey).then(T=>{T||d.error("Invalid signature in ledger entry",a)});c.send({type:"SYNC_LEDGER",ledger:k.payload})}}catch{}}),i._hasListener=!0))},Ae=async(i,c)=>{const f=c||i;if(d.sig("setupSignaling called with gameId:",i,"boardId:",c,"resolved currentBoardId:",f),!!f&&(o.value!==f&&n.value?.isConnected&&(d.sig("Switching signaling board assignment from",o.value,"to",f),n.value.updateBoardId(f),o.value=f),(!n.value||!n.value.isConnected)&&!r.value)){r.value=!0;try{const _=X.getInstance(),P=await _.getIdentity();if(P){const U=new Ot(i||"default",f,P.name,async a=>{if(a.type==="error"&&(d.error("Signaling error:",a.message||a.code),Se.error(a.message||"Signaling error occurred"),a.code==="DUPLICATE_IDENTITY"&&t.replace(`/games/${i}`)),a.type==="peerJoined"&&(d.sig("Peer joined:",a.peerName,"publicKey:",a.publicKey),await fe(a.publicKey)?(d.sig("Auto-approving known identity:",a.peerName),await me({connectionId:a.from,peerName:a.peerName||"Guest",publicKey:a.publicKey,encryptionPublicKey:a.encryptionPublicKey,timestamp:Date.now()})):w.value.push({connectionId:a.from,peerName:a.peerName||"Guest",publicKey:a.publicKey,encryptionPublicKey:a.encryptionPublicKey,timestamp:Date.now()})),a.type==="offer"){d.sig("Received offer from host:",a.from);const T=a.boardId||o.value;if(!T){d.error("No valid target board UUID for offer message");return}const $=$e(T,P.name,!1),F=new de(q=>{$.send({type:"UPDATE_CONNECTION",connection:q})});F.addMessageListener(q=>{try{const j=JSON.parse(q);if(!nt(j))return;if(j.type==="START_GAME"&&$.send({type:"START_GAME"}),j.type==="GAME_STARTED"&&$.send({type:"GAME_STARTED"}),j.type==="GAME_RESET"&&$.send({type:"GAME_RESET"}),j.type==="NEW_BOARD"&&t.replace(`/games/${i.value}/${j.payload}`),j.type==="SYNC_PLAYER_STATUS"&&$.send({type:"SET_PLAYER_STATUS",playerId:F.id,status:j.payload}),j.type==="SYNC_PARTICIPANTS"&&$.send({type:"SYNC_PARTICIPANTS",participants:j.payload}),j.type==="SYNC_LEDGER"){const je=j.payload;for(const ie of je)ie.signature&&ie.signerPublicKey&&X.verify(ie.action,ie.signature,ie.signerPublicKey).then(yt=>{yt||d.error("Invalid signature in ledger entry",ie)});$.send({type:"SYNC_LEDGER",ledger:je})}}catch(j){d.error("Failed to parse message:",j)}}),F.onClose=()=>{$.send({type:"PEER_DISCONNECTED",connectionId:F.id})},F.setDataChannelCallback(),a.publicKey&&(console.log("[useGameSession] Guest storing host publicKey from offer:",a.publicKey?.substring(0,20)),F.remotePublicKey=a.publicKey),a.peerName&&(console.log("[useGameSession] Guest storing host name from offer:",a.peerName),F.remotePlayerName=a.peerName),F.acceptOffer(a.offer,P.name).then(()=>{const q=setInterval(()=>{F.signal&&n.value&&(clearInterval(q),d.sig("Sending answer to host:",a.from),n.value.guestAnswer(a.from,P.publicKey,F.signal,void 0))},100)}).catch(q=>{d.error("Failed to accept offer and generate answer:",q)})}if(a.type==="answer"){d.sig("Received answer from guest:",a.from,"publicKey:",a.publicKey);const T=y.value.get(a.from);if(T&&a.answer){d.sig("Applying answer to connection:",a.from),console.log("[useGameSession] msg.answer type:",typeof a.answer),console.log("[useGameSession] msg.answer is Signal?:",a.answer instanceof Z),console.log("[useGameSession] msg.answer publicKey:",a.answer.publicKey?.substring(0,20));let $=a.answer;!(a.answer instanceof Z)&&typeof a.answer=="object"&&(console.log("[useGameSession] Converting plain object to Signal instance"),$=new Z(a.answer.connectionId,a.answer.session,a.answer.playerName,a.answer.iceCandidates||[]),console.log("[useGameSession] Signal created from plain object")),a.publicKey&&(console.log("[useGameSession] Setting remotePublicKey from msg.publicKey:",a.publicKey?.substring(0,20)),T.remotePublicKey=a.publicKey),a.peerName&&(console.log("[useGameSession] Setting remotePlayerName from msg.peerName:",a.peerName),T.remotePlayerName=a.peerName);try{T.acceptAnswer($),d.sig("WebRTC connection established with:",a.from),y.value.delete(a.from)}catch(F){d.error("Failed to accept answer:",F)}}else d.error("No pending connection found for:",a.from)}}),k=`SIGN_IN:${P.subscriptionToken}`,M=await _.sign(k);await U.connect(P.subscriptionToken,P.publicKey,M),n.value=U,o.value=f}}catch(_){d.error("Failed to connect to signaling server:",_)}finally{r.value=!1}}},_e=async(i=2)=>{if(J.value)I.value&&u.value&&d.sig("Manual onHostAGame called (not used in new flow)");else{const c=Fe();t.push(`/games/${x.value}/${c}?maxPlayers=${i}`)}},Pe=async()=>{if(!u.value||!n.value?.isConnected){d.error("Cannot join as guest: missing boardId or signaling not connected");return}const c=await X.getInstance().getIdentity();c&&(d.sig("Sending guestJoin for boardId:",u.value),n.value.guestJoin(u.value,c.name,c.publicKey,c.publicKey))},fe=async i=>(await ge.getAllKnownIdentities()).some(f=>f.publicKey===i),me=async i=>{d.sig("Approving peer:",i.peerName,"publicKey:",i.publicKey);const c=new de(_=>{I.value?.send({type:"UPDATE_CONNECTION",connection:_})});c.onClose=()=>{I.value?.send({type:"PEER_DISCONNECTED",connectionId:c.id}),y.value.delete(i.connectionId)},c.remotePublicKey=i.publicKey,console.log("[useGameSession] Stored guest publicKey from join request:",i.publicKey?.substring(0,20)),c.openDataChannel(),await c.prepareOfferSignal(A.value?.context?.playerName||V.value?.name||"Anonymous"),y.value.set(i.connectionId,c);const f=setInterval(()=>{c.signal&&n.value&&(clearInterval(f),X.getInstance().getIdentity().then(P=>{P&&n.value&&n.value.hostOffer(i.connectionId,i.publicKey,c.signal,P.publicKey,void 0)}))},100)},Ne=async i=>{w.value=w.value.filter(c=>c.connectionId!==i.connectionId),await me(i)},Te=i=>{d.sig("Rejecting peer:",i.peerName),w.value=w.value.filter(c=>c.connectionId!==i.connectionId)},ve=async i=>{try{const c={id:`identity-${Date.now()}`,name:i.peerName,publicKey:i.publicKey,addedAt:Date.now()};await ge.addKnownIdentity(c),Se.success("Identity Saved",{description:`${i.peerName} has been added to your known identities.`})}catch{Se.error("Failed to save identity")}},Ge=()=>{n.value&&b.value&&n.value.deleteOffer(),I.value?.send({type:"START_GAME"})},be=()=>{if(!I.value)return;I.value.send({type:"JOIN",boardId:u.value});const i=new de(oe);i.onClose=()=>I.value?.send({type:"PEER_DISCONNECTED",connectionId:i.id}),i.status=L.readyToAccept,i.setDataChannelCallback(),oe(i)},Re=async(i,c)=>{if(!(!(i instanceof de)||!c))try{await i.acceptOffer(c,V.value?.name||"Anonymous")}catch(f){d.error("Failed to accept offer",f)}},we=(i,c)=>{if(!(!(i instanceof de)||!c))try{i.acceptAnswer(c),oe(i)}catch(f){d.error("Failed to accept answer",f)}},B=()=>{I.value?.send({type:"FINISH_GAME"}),u.value&&Le.updateStatus(u.value,"finished")},H=async i=>{if(!b.value||!I.value)return;const c=X.getInstance(),f=await c.getIdentity();if(!f)return;const _=await c.sign(i),P=jt.fromEntries(A.value?.context?.ledger||[]),U=await P.addEntry({...i});U.signature=_,U.signerPublicKey=f.publicKey;const k=P.getEntries();I.value.send({type:"SYNC_LEDGER",ledger:k}),Q.value.forEach(M=>{M.send(JSON.stringify(ue("SYNC_LEDGER",k)))})},le=()=>{const i=Fe();Q.value.forEach(c=>{c.status===L.connected&&c.send(JSON.stringify(ue("NEW_BOARD",i)))}),n.value?.deleteOffer(),I.value?.send({type:"CLOSE_SESSION"}),t.push(`/games/${x.value}/${i}`)},pt=()=>{const i=A.value?.context?.pendingGuest;I.value?.send({type:"ACCEPT_GUEST"}),i&&oe(i.connection)},gt=()=>I.value?.send({type:"REJECT_GUEST"}),ht=i=>{i.close(),I.value?.send({type:"PEER_DISCONNECTED",connectionId:i.id})};return Y([b,ae],()=>{if(!b.value)return;const i=ae.value.map(c=>({id:c.id,name:c.name,isHost:c.isHost}));Q.value.forEach(c=>{if(c.status===L.connected)try{c.send(JSON.stringify(ue("SYNC_PARTICIPANTS",i)))}catch(f){d.error("Failed to sync participants to peer",c.id,f)}})},{deep:!0,immediate:!0}),Y([u,J],async()=>{const i=J.value&&u.value;d.sig("[WATCH] Signaling Lifecycle update. shouldConnect:",i,"boardId:",u.value),i&&await Ae(x.value,u.value)},{immediate:!0}),Y([n,A,u],async()=>{if(!n.value?.isConnected||!u.value||v.value)return;const c=await X.getInstance().getIdentity();if(!c)return;const f=A.value;if(!f)return;const _=f.matches("hosting")||f.matches("preparation"),P=f.matches("joining");_&&f.context.isInitiator?(d.sig("Auto-registering as HOST for boardId:",u.value,"state:",f.value),n.value.hostRegister(u.value,x.value,c.name,c.publicKey),v.value=!0):(P||!f.context.isInitiator)&&(d.sig("Auto-joining as GUEST for boardId:",u.value,"state:",f.value),n.value.guestJoin(u.value,c.name,c.publicKey,c.publicKey),v.value=!0)}),Y(u,async i=>{if(i&&i!=="manual"&&J.value){const c=await Le.getSession(i),f=$e(i,V.value?.name||"Anonymous",!1),_=f.getSnapshot().context;c&&c.ledger.length>0&&_.ledger.length===0&&(f.send({type:"LOAD_LEDGER",ledger:c.ledger}),f.send({type:"GAME_STARTED"}),c.status==="finished"&&setTimeout(()=>f.send({type:"FINISH_GAME"}),10))}},{immediate:!0}),Y(Q,i=>{i.forEach(c=>{c._hasInitialSync||(c.send(JSON.stringify(ue("SYNC_PLAYER_STATUS",Ee.value))),b.value&&u.value&&u.value!=="manual"&&c.send(JSON.stringify(ue("NEW_BOARD",u.value))),c._hasInitialSync=!0)})}),{identity:V,isLoading:dt,snapshot:A,send:i=>I.value?.send(i),signalingClient:n,isServerConnecting:r,pendingJoinRequests:w,activeSessions:tt,playerInfos:ae,connectedPeers:Q,pendingSignaling:Ie,isInitiator:b,isGameStarted:p,onHostAGame:_e,onJoinAsGuest:Pe,isKnownIdentity:fe,onApprovePeer:Ne,onRejectPeer:Te,saveIdentityOnApprove:ve,startGame:Ge,connectWithOffer:be,updateOffer:Re,updateAnswer:we,onFinishGame:B,onAddLedger:H,handlePlayAgain:le,onAcceptGuest:pt,onRejectGuest:gt,onCancelSignaling:ht,onBackToGames:()=>t.push(`/games/${x.value}`),onBackToDiscovery:()=>t.push(`/games/${x.value}`)}}const Jt={class:"space-y-4 animate-fade-in-up"},Ut={key:0,class:"glass-dark p-6 rounded-2xl border border-white/5 shadow-glass-dark flex items-center justify-center space-x-4"},Ht={key:1,class:"glass-dark p-6 rounded-2xl border border-white/5 shadow-glass-dark"},Vt={class:"text-sm font-black text-white uppercase tracking-[0.2em] mb-4 flex items-center gap-3"},Yt={key:2,class:"glass-dark p-6 rounded-2xl border border-white/5 shadow-glass-dark group hover:border-primary/20 transition-all duration-500"},Wt={class:"text-[10px] font-black uppercase tracking-[0.2em] mb-4 flex items-center gap-2 text-primary"},zt={class:"space-y-4"},Qt={class:"p-4 bg-white/5 rounded-xl border border-white/10 relative group min-h-[64px] flex items-center group-hover:neon-border transition-all duration-500"},Xt={class:"text-[10px] font-mono break-all line-clamp-2 text-white/40 pr-8"},Zt={key:1,class:"text-[10px] text-white/20 italic tracking-wider"},qt={key:3,class:"glass-dark p-6 rounded-2xl border border-white/5 shadow-glass-dark group hover:border-primary/20 transition-all duration-500"},en={class:"text-[10px] font-black uppercase tracking-[0.2em] mb-4 flex items-center gap-2 text-primary"},tn={class:"space-y-3"},nn={class:"p-4 bg-white/5 rounded-xl border border-white/10 relative group min-h-[64px] flex items-center group-hover:neon-border transition-all duration-500"},sn={class:"text-[10px] font-mono break-all line-clamp-2 text-white/40 pr-8"},an={key:1,class:"text-[10px] text-white/20 italic tracking-wider"},on={key:4,class:"flex justify-end"},rn=ne({__name:"SignalingStep",props:{connection:{},onOfferChange:{type:Function},onAnswerChange:{type:Function},onCancel:{type:Function}},setup(e){const t=D(!1),n=r=>{r&&(navigator.clipboard.writeText(r),t.value=!0,setTimeout(()=>t.value=!1,2e3))};return(r,o)=>(g(),h("div",Jt,[e.connection.status===l(L).new?(g(),h("div",Ut,[...o[5]||(o[5]=[s("div",{class:"animate-spin rounded-full h-5 w-5 border-b-2 border-primary"},null,-1),s("p",{class:"text-sm text-white/50 font-bold uppercase tracking-widest"},"Generating invite signal...",-1)])])):E("",!0),e.connection.status===l(L).readyToAccept?(g(),h("div",Ht,[s("h3",Vt,[m(l(_t),{class:"w-5 h-5 text-primary"}),o[6]||(o[6]=G(" Paste Join Offer ",-1))]),o[7]||(o[7]=s("p",{class:"text-[10px] text-white/30 uppercase tracking-widest mb-4"},"External node signal required for connection.",-1)),m(Je,{placeholder:"Paste offer string here...",className:"h-12 bg-white/5 border-white/10 rounded-xl focus:ring-primary text-white font-mono text-xs placeholder:text-white/20","onUpdate:modelValue":o[0]||(o[0]=v=>e.onOfferChange(e.connection,v))})])):E("",!0),e.connection.status===l(L).started?(g(),h("div",Yt,[s("h3",Wt,[m(l(Ce),{class:"w-4 h-4"}),o[8]||(o[8]=G(" Active Invite Vector ",-1))]),s("div",zt,[s("div",Qt,[e.connection.signal?(g(),h(ee,{key:0},[s("div",Xt,R(e.connection.signal.toString()),1),s("button",{class:"absolute top-2 right-2 h-8 w-8 flex items-center justify-center text-primary hover:bg-primary/10 transition-colors rounded-lg",onClick:o[1]||(o[1]=v=>n(e.connection.signal.toString()))},[t.value?(g(),W(l(ke),{key:0,class:"w-4 h-4"})):(g(),W(l(qe),{key:1,class:"w-4 h-4"}))])],64)):(g(),h("div",Zt,"Gathering node connection details..."))]),o[9]||(o[9]=s("p",{class:"text-[10px] text-white/30 uppercase font-medium leading-relaxed tracking-wider"}," Transmit this vector to a peer node. Their response will be synthesized automatically. ",-1)),m(Je,{placeholder:"Awaiting peer response vector...",className:"h-10 bg-white/5 border-white/10 rounded-xl focus:ring-primary text-white font-mono text-[10px] placeholder:text-white/20","onUpdate:modelValue":o[2]||(o[2]=v=>e.onAnswerChange(e.connection,v))})])])):E("",!0),e.connection.status===l(L).answered?(g(),h("div",qt,[s("h3",en,[m(l(ke),{class:"w-4 h-4"}),o[10]||(o[10]=G(" Signal Response Synthesized ",-1))]),s("div",tn,[s("div",nn,[e.connection.signal?(g(),h(ee,{key:0},[s("div",sn,R(e.connection.signal.toString()),1),s("button",{class:"absolute top-2 right-2 h-8 w-8 flex items-center justify-center text-primary hover:bg-primary/10 transition-colors rounded-lg",onClick:o[3]||(o[3]=v=>n(e.connection.signal.toString()))},[t.value?(g(),W(l(ke),{key:0,class:"w-4 h-4"})):(g(),W(l(qe),{key:1,class:"w-4 h-4"}))])],64)):(g(),h("div",an,"Finalizing response..."))]),o[11]||(o[11]=s("p",{class:"text-[10px] text-primary font-black uppercase tracking-widest"},"Transmit this payload back to peer to complete handshake.",-1))])])):E("",!0),e.onCancel?(g(),h("div",on,[s("button",{onClick:o[4]||(o[4]=v=>e.onCancel(e.connection)),class:"text-[10px] font-black uppercase tracking-widest text-white/20 hover:text-rose-500 transition-colors p-2"}," De-initialize Link ")])):E("",!0)]))}}),st=se(rn,[["__scopeId","data-v-77356793"]]),cn={class:"space-y-8"},ln={key:0,class:"fixed inset-0 z-[100] flex items-center justify-center bg-[#0A0A0A]/80 backdrop-blur-xl animate-fade-in p-6"},dn={class:"glass-dark p-10 w-full max-w-md shadow-2xl border border-white/10 rounded-[2.5rem] space-y-8 animate-zoom-in"},un={class:"flex flex-col items-center text-center space-y-6"},pn={class:"h-20 w-20 bg-primary/10 rounded-[1.5rem] flex items-center justify-center border border-primary/20 shadow-neon"},gn={class:"space-y-2"},hn={class:"text-white/40 uppercase tracking-widest text-[10px] font-medium leading-relaxed"},yn={class:"font-black text-primary px-1"},fn={class:"grid grid-cols-2 gap-4"},mn={key:1,class:"glass-dark p-8 border border-primary/20 shadow-glass-dark rounded-[2.5rem] animate-zoom-in space-y-6"},vn={class:"flex items-center gap-4"},bn={class:"w-12 h-12 rounded-2xl bg-primary/10 flex items-center justify-center border border-primary/20"},wn={class:"space-y-1"},xn={class:"text-white/40 uppercase tracking-widest text-[10px] font-medium"},Sn={class:"space-y-4"},kn={class:"flex items-start justify-between"},Cn={class:"space-y-2"},In={class:"flex items-center gap-2"},En={class:"text-lg font-black text-white"},An={key:0,class:"px-2 py-0.5 bg-primary/10 text-primary border border-primary/20 rounded-full text-[9px] font-black uppercase tracking-wider"},_n={class:"text-xs text-white/40 font-mono"},Pn={key:0,class:"flex items-center justify-end gap-2 px-1 pb-2"},Nn=["onClick","aria-checked"],Tn={class:"grid grid-cols-2 gap-3"},Gn=["onClick"],Rn=["onClick"],Ln={key:2,class:"glass-dark p-10 text-center space-y-8 border border-white/5 shadow-glass-dark rounded-[3rem] animate-zoom-in"},On={class:"space-y-4"},Kn={class:"inline-flex items-center gap-2 px-4 py-1.5 bg-primary/10 text-primary border border-primary/20 rounded-full text-[10px] font-black uppercase tracking-[0.2em] shadow-neon transform -translate-y-2"},$n={class:"text-4xl font-black text-white uppercase tracking-tighter"},Dn={class:"text-xs text-white/30 uppercase font-black tracking-widest leading-relaxed max-w-lg mx-auto"},Mn={key:0,class:"flex flex-col items-center gap-6"},Fn={class:"space-y-4"},jn={class:"mx-auto h-16 w-16 bg-rose-500/10 rounded-2xl flex items-center justify-center border border-rose-500/20"},Bn={class:"grid grid-cols-2 gap-4 pt-6"},Jn={key:1,class:"flex flex-col items-center gap-8 py-6"},Un={key:0,class:"relative"},Hn={class:"space-y-3"},Vn={class:"text-xl font-black text-white uppercase tracking-tight"},Yn={class:"text-[10px] text-white/30 uppercase tracking-[0.2em] max-w-xs mx-auto font-medium leading-relaxed"},Wn={class:"space-y-4"},zn={class:"mx-auto h-16 w-16 bg-rose-500/10 rounded-2xl flex items-center justify-center border border-rose-500/20"},Qn={class:"grid grid-cols-2 gap-4 pt-6"},Xn={key:2,class:"pt-8 border-t border-white/5 space-y-6"},Zn={key:0,class:"glass-dark p-8 rounded-[2rem] border border-white/10 shadow-glass-dark space-y-6 group hover:border-primary/30 transition-all duration-500"},qn={class:"flex items-center justify-between"},es={class:"flex items-center gap-3"},ts={class:"p-2.5 bg-primary/10 rounded-xl border border-primary/20"},ns={class:"relative flex items-center gap-3"},ss={class:"flex-grow bg-black/40 border border-white/10 rounded-xl px-4 py-3.5 font-mono text-[11px] text-white/60 truncate transition-all group-hover:bg-black/60 group-hover:border-white/20"},as={key:"check",class:"flex items-center gap-2 animate-bounce-short"},os={key:"copy",class:"flex items-center gap-2"},is={key:1,class:"space-y-4 text-left"},rs={class:"grid grid-cols-1 gap-6"},cs={key:3,class:"pt-8 border-t border-white/5 text-left"},ls={key:3,class:"py-24 flex flex-col items-center justify-center space-y-6 border border-white/5 bg-white/5 rounded-[3rem] backdrop-blur-sm animate-fade-in"},ds=ne({__name:"PreparationPhase",props:{state:{},isInitiator:{type:Boolean},signalingMode:{},isServerConnecting:{type:Boolean},signalingClient:{},pendingSignaling:{},pendingJoinRequests:{},isKnownIdentity:{type:Function},onStartGame:{type:Function},onHostAGame:{type:Function},onUpdateOffer:{type:Function},onUpdateAnswer:{type:Function},onCloseSession:{type:Function},onBackToLobby:{type:Function},onAcceptGuest:{type:Function},onRejectGuest:{type:Function},onApprovePeer:{type:Function},onRejectPeer:{type:Function},onSaveIdentity:{type:Function},onCancelSignaling:{type:Function},onRemovePlayer:{type:Function},playerCount:{},maxPlayers:{},boardId:{},gameId:{}},setup(e){const t=e,n=D({}),r=D({}),o=async b=>{t.isKnownIdentity&&(n.value[b]=await t.isKnownIdentity(b))},v=b=>b.length<=20?b:`${b.substring(0,10)}...${b.substring(b.length-10)}`,w=D(!1),y=C(()=>`${window.location.origin}${window.location.pathname}#/games/${t.gameId}/${t.boardId}`),x=async()=>{try{await navigator.clipboard.writeText(y.value),w.value=!0,setTimeout(()=>{w.value=!1},2e3)}catch(b){console.error("Failed to copy link:",b)}};Y(()=>t.pendingJoinRequests,b=>{b&&b.forEach(p=>{p.publicKey in n.value||o(p.publicKey)})},{deep:!0,immediate:!0});const u=async b=>{r.value[b.connectionId]&&t.onSaveIdentity&&await t.onSaveIdentity(b),t.onApprovePeer&&t.onApprovePeer(b),delete r.value[b.connectionId]},N=C(()=>t.state.matches("preparation")),J=C(()=>t.state.matches("hosting")),I=C(()=>t.state.matches("joining")),A=C(()=>t.state.matches("approving"));return(b,p)=>(g(),h("div",cn,[A.value&&e.state.context.pendingGuest?(g(),h("div",ln,[s("div",dn,[s("div",un,[s("div",pn,[m(l(Ce),{class:"w-10 h-10 text-primary animate-pulse"})]),s("div",gn,[p[6]||(p[6]=s("h2",{class:"text-2xl font-black text-white uppercase tracking-tight"},"Handshake Request",-1)),s("p",hn,[p[4]||(p[4]=G(" Entity ",-1)),s("span",yn,R(e.state.context.pendingGuest.name),1),p[5]||(p[5]=G(" attempts to bridge into session. ",-1))])])]),s("div",fn,[s("button",{onClick:p[0]||(p[0]=(...S)=>e.onRejectGuest&&e.onRejectGuest(...S)),class:"h-14 rounded-2xl border border-white/10 text-white/60 hover:text-rose-500 hover:bg-rose-500/10 hover:border-rose-500/30 font-black uppercase tracking-widest text-xs transition-all"}," De-authorize "),s("button",{onClick:p[1]||(p[1]=(...S)=>e.onAcceptGuest&&e.onAcceptGuest(...S)),class:"h-14 rounded-2xl bg-primary text-primary-foreground shadow-neon hover:shadow-[0_0_30px_rgba(16,185,129,0.4)] font-black uppercase tracking-widest text-xs transition-all"}," Grant Access ")])])])):E("",!0),e.isInitiator&&e.pendingJoinRequests&&e.pendingJoinRequests.length>0?(g(),h("div",mn,[s("div",vn,[s("div",bn,[m(l(Ce),{class:"w-6 h-6 text-primary"})]),s("div",wn,[p[7]||(p[7]=s("h2",{class:"text-2xl font-black text-white uppercase tracking-tight"},"Join Requests",-1)),s("p",xn,R(e.pendingJoinRequests.length)+" "+R(e.pendingJoinRequests.length===1?"peer":"peers")+" waiting for approval ",1)])]),s("div",Sn,[(g(!0),h(ee,null,Me(e.pendingJoinRequests,S=>(g(),h("div",{key:S.connectionId,class:"glass-darker p-6 rounded-2xl border border-white/5 space-y-4"},[s("div",kn,[s("div",Cn,[s("div",In,[s("span",En,R(S.peerName),1),n.value[S.publicKey]?(g(),h("span",An," Known Identity ")):E("",!0)]),s("p",_n,R(v(S.publicKey)),1)])]),n.value[S.publicKey]?E("",!0):(g(),h("div",Pn,[p[8]||(p[8]=s("span",{class:"text-xs text-white/50 uppercase tracking-wider font-medium"},"Auto-approve next time",-1)),s("button",{onClick:z=>r.value[S.connectionId]=!r.value[S.connectionId],class:pe(["relative inline-flex h-6 w-11 items-center rounded-full transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2 focus:ring-offset-gray-900",r.value[S.connectionId]?"bg-primary":"bg-white/10"]),role:"switch","aria-checked":r.value[S.connectionId]},[s("span",{class:pe(["inline-block h-4 w-4 transform rounded-full bg-white transition-transform duration-200",r.value[S.connectionId]?"translate-x-6":"translate-x-1"])},null,2)],10,Nn)])),s("div",Tn,[s("button",{onClick:z=>e.onRejectPeer&&e.onRejectPeer(S),class:"h-12 rounded-xl border border-white/10 text-white/60 hover:text-rose-500 hover:bg-rose-500/10 hover:border-rose-500/30 font-black uppercase tracking-widest text-xs transition-all"}," Reject ",8,Gn),s("button",{onClick:z=>u(S),class:"h-12 rounded-xl bg-primary text-primary-foreground shadow-neon hover:shadow-[0_0_30px_rgba(16,185,129,0.4)] font-black uppercase tracking-widest text-xs transition-all"}," Approve ",8,Rn)])]))),128))])])):E("",!0),J.value||I.value||N.value||A.value?(g(),h("div",Ln,[s("div",On,[s("div",Kn,R(J.value||A.value?"Broadcasting Session":I.value?"Initializing Node":"Command Lobby Active"),1),s("h2",$n,R(N.value?"Game Room":J.value?"Link Establishment":"Connecting..."),1),s("p",Dn,[N.value?(g(),h(ee,{key:0},[G(R(e.isInitiator?`Authorize peer nodes or launch protocol when ready (${e.playerCount}/${e.maxPlayers}).`:"Waiting for initiator to launch protocol."),1)],64)):(g(),h(ee,{key:1},[G("Synthesizing direct P2P mesh link to session nodes.")],64))])]),e.isInitiator?(g(),h("div",Mn,[N.value?(g(),h("button",{key:0,onClick:p[2]||(p[2]=(...S)=>e.onStartGame&&e.onStartGame(...S)),class:"w-full max-w-sm h-16 text-sm font-black uppercase tracking-[0.5em] rounded-2xl bg-primary text-primary-foreground shadow-[0_0_30px_rgba(16,185,129,0.3)] hover:shadow-[0_0_50px_rgba(16,185,129,0.5)] transition-all active:scale-[0.98]"}," Launch Protocol ")):E("",!0),m(l(Ze),null,{default:O(()=>[m(l(Ue),{asChild:""},{default:O(()=>[...p[9]||(p[9]=[s("button",{class:"px-4 h-12 rounded-xl text-white/20 hover:text-rose-500 font-black uppercase tracking-widest text-[10px] transition-colors"}," Terminate Session ",-1)])]),_:1}),m(l(He),null,{default:O(()=>[m(l(Ve),{class:"bg-black/80 fixed inset-0 z-[100] backdrop-blur-sm"}),m(l(Ye),{class:"glass-dark border border-white/10 rounded-[2rem] p-8 max-w-sm fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 z-[101]"},{default:O(()=>[s("div",Fn,[s("div",jn,[m(l(Be),{class:"w-8 h-8 text-rose-500"})]),m(l(We),{class:"text-xl font-black text-center text-white uppercase tracking-tight"},{default:O(()=>[...p[10]||(p[10]=[G(" Terminate Session? ",-1)])]),_:1}),m(l(ze),{class:"text-center text-white/40 text-xs font-medium uppercase tracking-widest leading-relaxed"},{default:O(()=>[...p[11]||(p[11]=[G(" Reloading or leaving will cause the game session to be lost. Peers will be disconnected and discovery mesh link terminated. ",-1)])]),_:1})]),s("div",Bn,[m(l(Qe),{class:"h-12 rounded-xl bg-white/5 border border-white/5 text-white/60 hover:bg-white/10 font-bold uppercase tracking-widest text-[10px]"},{default:O(()=>[...p[12]||(p[12]=[G(" Abort ",-1)])]),_:1}),m(l(Xe),{onClick:e.onCloseSession,class:"h-12 rounded-xl bg-rose-500 text-white font-black uppercase tracking-widest text-[10px] hover:bg-rose-600 shadow-neon-sm"},{default:O(()=>[...p[13]||(p[13]=[G(" Confirm ",-1)])]),_:1},8,["onClick"])])]),_:1})]),_:1})]),_:1})])):(g(),h("div",Jn,[N.value?E("",!0):(g(),h("div",Un,[...p[14]||(p[14]=[s("div",{class:"animate-spin rounded-full h-20 w-20 border-4 border-primary/5 border-t-primary shadow-neon"},null,-1),s("div",{class:"absolute inset-0 flex items-center justify-center"},[s("div",{class:"h-3 w-3 bg-primary rounded-full animate-pulse shadow-neon"})],-1)])])),s("div",Hn,[s("h3",Vn,R(N.value?"Node Synced":"Bridging Connections"),1),s("p",Yn,R(N.value?"Identity verified. Awaiting initiator's launch command.":"Establishing secure encrypted tunnel to host node."),1)]),m(l(Ze),null,{default:O(()=>[m(l(Ue),{asChild:""},{default:O(()=>[...p[15]||(p[15]=[s("button",{class:"h-10 text-white/20 hover:text-rose-500 font-black uppercase tracking-widest text-[10px] transition-colors"}," Sever Connection ",-1)])]),_:1}),m(l(He),null,{default:O(()=>[m(l(Ve),{class:"bg-black/80 fixed inset-0 z-[100] backdrop-blur-sm"}),m(l(Ye),{class:"glass-dark border border-white/10 rounded-[2rem] p-8 max-w-sm fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 z-[101]"},{default:O(()=>[s("div",Wn,[s("div",zn,[m(l(Be),{class:"w-8 h-8 text-rose-500"})]),m(l(We),{class:"text-xl font-black text-center text-white uppercase tracking-tight"},{default:O(()=>[...p[16]||(p[16]=[G(" Sever Connection? ",-1)])]),_:1}),m(l(ze),{class:"text-center text-white/40 text-xs font-medium uppercase tracking-widest leading-relaxed"},{default:O(()=>[...p[17]||(p[17]=[G(" Leaving or reloading will sever your node link. The game session progress will be lost. ",-1)])]),_:1})]),s("div",Qn,[m(l(Qe),{class:"h-12 rounded-xl bg-white/5 border border-white/5 text-white/60 hover:bg-white/10 font-bold uppercase tracking-widest text-[10px]"},{default:O(()=>[...p[18]||(p[18]=[G(" Abort ",-1)])]),_:1}),m(l(Xe),{onClick:e.onBackToLobby,class:"h-12 rounded-xl bg-rose-500 text-white font-black uppercase tracking-widest text-[10px] hover:bg-rose-600 shadow-neon-sm"},{default:O(()=>[...p[19]||(p[19]=[G(" Confirm ",-1)])]),_:1},8,["onClick"])])]),_:1})]),_:1})]),_:1})])),e.isInitiator?(g(),h("div",Xn,[e.signalingMode==="server"?(g(),h("div",Zn,[s("div",qn,[s("div",es,[s("div",ts,[m(l(At),{class:"w-5 h-5 text-primary"})]),p[20]||(p[20]=s("div",{class:"text-left"},[s("h3",{class:"text-sm font-black text-white uppercase tracking-wider"},"Share Session Link"),s("p",{class:"text-[10px] text-white/30 uppercase tracking-widest font-medium"},"Link this node to the discovery mesh")],-1))]),p[21]||(p[21]=s("div",{class:"flex items-center gap-2 px-3 py-1 bg-primary/5 border border-primary/20 rounded-full"},[s("div",{class:"w-1.5 h-1.5 bg-primary rounded-full animate-pulse shadow-neon"}),s("span",{class:"text-[9px] font-black text-primary uppercase tracking-widest"},"Live Broadcast")],-1))]),s("div",ns,[s("div",ss,R(y.value),1),s("button",{onClick:x,class:"shrink-0 h-12 px-6 rounded-xl bg-primary text-primary-foreground font-black uppercase tracking-widest text-[10px] shadow-neon hover:shadow-[0_0_25px_rgba(16,185,129,0.4)] transition-all active:scale-95 flex items-center gap-2"},[m(vt,{mode:"out-in",name:"fade"},{default:O(()=>[w.value?(g(),h("div",as,[m(l(It),{class:"w-4 h-4"}),p[22]||(p[22]=G(" COPIED ",-1))])):(g(),h("div",os,[m(l(Et),{class:"w-4 h-4"}),p[23]||(p[23]=G(" COPY LINK ",-1))]))]),_:1})])])])):E("",!0),e.signalingMode==="manual"&&e.pendingSignaling.length>0?(g(),h("div",is,[p[24]||(p[24]=s("h3",{class:"text-[11px] font-black text-white/20 uppercase tracking-[0.3em] px-1"},"Pending Link Authentications",-1)),s("div",rs,[(g(!0),h(ee,null,Me(e.pendingSignaling,S=>(g(),W(st,{key:S.id,connection:S,onOfferChange:e.onUpdateOffer,onAnswerChange:e.onUpdateAnswer,onCancel:e.onCancelSignaling},null,8,["connection","onOfferChange","onAnswerChange","onCancel"]))),128))])])):E("",!0)])):E("",!0),!e.isInitiator&&I.value&&e.signalingMode==="manual"&&e.pendingSignaling.length>0?(g(),h("div",cs,[m(st,{connection:e.pendingSignaling[0],onOfferChange:e.onUpdateOffer,onAnswerChange:e.onUpdateAnswer,onCancel:e.onCancelSignaling},null,8,["connection","onOfferChange","onAnswerChange","onCancel"])])):E("",!0)])):E("",!0),!J.value&&!I.value&&!N.value&&!A.value?(g(),h("div",ls,[p[25]||(p[25]=bt('<div class="relative" data-v-af7f985e><div class="h-20 w-20 bg-white/5 rounded-full flex items-center justify-center transition-transform hover:scale-110 duration-500" data-v-af7f985e><div class="h-4 w-4 bg-white/10 rounded-full animate-ping" data-v-af7f985e></div></div></div><div class="text-center space-y-2" data-v-af7f985e><div class="text-xs font-black uppercase tracking-[0.5em] text-white/30" data-v-af7f985e>Null Reference: No Active Session</div><p class="text-[10px] text-white/20 uppercase tracking-widest px-10 leading-relaxed font-medium" data-v-af7f985e>Session data not found on current node. Return to discovery mesh.</p></div>',2)),s("button",{onClick:p[3]||(p[3]=(...S)=>e.onBackToLobby&&e.onBackToLobby(...S)),class:"h-12 px-8 rounded-xl border border-white/10 text-white/70 hover:text-primary hover:border-primary/40 font-black uppercase tracking-widest text-[10px] transition-all"}," Return to Discovery ")])):E("",!0)]))}}),us=se(ds,[["__scopeId","data-v-af7f985e"]]),ps={class:"react-wrapper-root"},gs={key:1,class:"p-20 text-center text-white/10 uppercase font-black tracking-[0.5em] animate-pulse"},hs=ne({__name:"ReactComponentWrapper",props:{component:{},componentProps:{}},setup(e){const t=e,n=De(null);return Y(()=>t.component,r=>{if(r)try{const o=wt(r);n.value=xt(o)}catch(o){console.error("[ReactComponentWrapper] Failed to apply React in Vue:",o),n.value=null}else n.value=null},{immediate:!0}),it(()=>{n.value=null}),(r,o)=>(g(),h("div",ps,[n.value?(g(),W(St(n.value),kt(Ct({key:0},e.componentProps)),null,16)):(g(),h("div",gs," Initialising Game... "))]))}}),ut=se(hs,[["__scopeId","data-v-941e587e"]]),ys={class:"animate-zoom-in"},fs=ne({__name:"ActivePhase",props:{GameComponent:{},connectedPeers:{},playerInfos:{},isInitiator:{type:Boolean},ledger:{},onAddLedger:{type:Function},onFinishGame:{type:Function}},setup(e){const t=e,n=C(()=>({connections:t.connectedPeers,playerNames:t.playerInfos.map(r=>r.name),playerInfos:t.playerInfos,isInitiator:t.isInitiator,ledger:t.ledger,onAddLedger:t.onAddLedger,onFinishGame:t.onFinishGame}));return(r,o)=>(g(),h("div",ys,[m(ut,{component:e.GameComponent,componentProps:n.value},null,8,["component","componentProps"])]))}}),ms=se(fs,[["__scopeId","data-v-ba34ac07"]]),vs={class:"space-y-6"},bs={class:"opacity-80 pointer-events-none grayscale-[0.2]"},ws={class:"glass-dark p-8 border border-white/5 shadow-glass-dark rounded-[2.5rem] animate-fade-in-up"},xs={class:"flex flex-col md:flex-row items-center justify-between gap-6"},Ss={class:"flex items-center gap-4"},ks={class:"h-14 w-14 bg-primary/10 rounded-2xl flex items-center justify-center border border-primary/20 shadow-neon"},Cs={class:"flex gap-4 w-full md:w-auto"},Is=ne({__name:"FinishedPhase",props:{GameComponent:{},connectedPeers:{},playerInfos:{},isInitiator:{type:Boolean},ledger:{},onBackToLobby:{type:Function}},setup(e){const t=e,n=C(()=>({connections:t.connectedPeers,playerNames:t.playerInfos.map(r=>r.name),playerInfos:t.playerInfos,isInitiator:t.isInitiator,ledger:t.ledger,onAddLedger:()=>{},onFinishGame:()=>{}}));return(r,o)=>(g(),h("div",vs,[s("div",bs,[m(ut,{component:e.GameComponent,componentProps:n.value},null,8,["component","componentProps"])]),s("div",ws,[s("div",xs,[s("div",Ss,[s("div",ks,[m(l(ke),{class:"w-8 h-8 text-primary"})]),o[1]||(o[1]=s("div",{class:"space-y-1"},[s("h3",{class:"text-xl font-black text-white uppercase tracking-tight"},"Match Finalized"),s("p",{class:"text-[10px] text-white/30 uppercase tracking-widest font-black"},"All cycles complete. Handshake terminated.")],-1))]),s("div",Cs,[s("button",{onClick:o[0]||(o[0]=(...v)=>e.onBackToLobby&&e.onBackToLobby(...v)),class:"w-full md:w-56 h-14 rounded-2xl bg-primary text-primary-foreground shadow-neon hover:shadow-[0_0_30px_rgba(16,185,129,0.4)] font-black uppercase tracking-[0.3em] text-xs transition-all"}," Return to Discovery ")])])]),o[2]||(o[2]=s("div",{class:"text-center text-white/10 text-[9px] font-black uppercase tracking-[0.4em] italic pt-4"}," Node state captured. Verification record locked inside vault. ",-1))]))}}),Es=se(Is,[["__scopeId","data-v-5868591e"]]),As={class:"glass-dark p-8 rounded-[2rem] border border-white/5 shadow-glass-dark"},_s={class:"text-xs font-black uppercase tracking-[0.3em] text-white/40 mb-6 flex items-center gap-3"},Ps={class:"space-y-4"},Ns={class:"relative"},Ts={key:0,class:"absolute inset-0 h-3 w-3 bg-primary rounded-full animate-ping opacity-50"},Gs={class:"flex flex-col flex-1"},Rs={class:"flex items-center gap-2"},Ls={class:"text-sm font-black text-white uppercase tracking-tight"},Os={key:0,class:"text-primary font-black ml-1"},Ks={key:0,class:"px-2 py-0.5 bg-primary/10 text-primary border border-primary/20 rounded-full text-[9px] font-black uppercase tracking-wider"},$s={key:0,class:"flex items-center gap-2 mt-2"},Ds=["onClick","aria-checked"],Ms={class:"text-[9px] text-white/40 uppercase tracking-wider font-medium"},Fs={class:"text-[8px] text-white/30"},js={key:0,class:"ml-auto flex items-center gap-3"},Bs=["onClick"],Js={key:0,class:"text-[10px] text-white/20 uppercase font-black tracking-[0.3em] text-center py-6 animate-pulse"},Us=ne({__name:"Players",props:{players:{},onRemove:{type:Function},onSaveIdentity:{type:Function},isKnownIdentity:{type:Function}},setup(e){const t=e,n=D({}),r=D({}),o=async()=>{for(const y of t.players)y.publicKey&&!y.isLocal&&t.isKnownIdentity&&(n.value[y.id]=await t.isKnownIdentity(y.publicKey))},v=async y=>{const x=r.value[y.id],u=!x;console.log("[Players] Toggle save for:",y.name,"from",x,"to",u),u?await w(y):r.value[y.id]=!1},w=async y=>{if(console.log("[Players] Attempting to save identity for:",y.name,"publicKey:",y.publicKey,"isLocal:",y.isLocal),!y.publicKey){console.warn("[Players] Cannot save identity - no public key for:",y.name);return}if(!t.onSaveIdentity){console.warn("[Players] Cannot save identity - onSaveIdentity prop not provided");return}try{r.value[y.id]=!0,await t.onSaveIdentity(y),n.value[y.id]=!0,console.log("[Players] Successfully saved identity for:",y.name)}catch(x){console.error("[Players] Error saving identity:",x),r.value[y.id]=!1}};return rt(()=>{o()}),Y(()=>t.players,()=>{o()},{deep:!0}),(y,x)=>(g(),h("div",As,[s("h3",_s,[m(l(Ce),{class:"w-5 h-5 text-primary"}),G(" Dwellers In Lobby ("+R(e.players.length)+") ",1)]),s("div",Ps,[(g(!0),h(ee,null,Me(e.players,u=>(g(),h("div",{key:u.id,class:"flex items-center gap-4 p-4 rounded-2xl bg-white/5 border border-white/10 group hover:neon-border transition-all duration-500 animate-fade-in-left"},[s("div",Ns,[s("div",{class:pe(["h-3 w-3 rounded-full",u.isConnected?"bg-primary shadow-neon":"bg-rose-500 shadow-[0_0_15px_rgba(244,63,94,0.4)]"])},null,2),u.isConnected?(g(),h("div",Ts)):E("",!0)]),s("div",Gs,[s("div",Rs,[s("span",Ls,[G(R(u.name)+" ",1),u.isLocal?(g(),h("span",Os,"(LOCAL)")):E("",!0)]),!u.isLocal&&n.value[u.id]?(g(),h("span",Ks," Known Identity ")):E("",!0)]),!u.isLocal&&u.isConnected&&!n.value[u.id]?(g(),h("div",$s,[s("button",{onClick:N=>v(u),class:pe(["relative inline-flex h-5 w-9 items-center rounded-full transition-colors duration-200",r.value[u.id]?"bg-primary":"bg-white/10"]),role:"switch","aria-checked":r.value[u.id]},[s("span",{class:pe(["inline-block h-3 w-3 transform rounded-full bg-white transition-transform duration-200",r.value[u.id]?"translate-x-5":"translate-x-1"])},null,2)],10,Ds),s("span",Ms,R(r.value[u.id]?"Saved for auto-approve":"Auto-approve next time"),1),s("span",Fs,R(u.isLocal?"(Local)":"(Remote)")+" "+R(u.publicKey?"PK":"PK"),1)])):E("",!0)]),u.isConnected?E("",!0):(g(),h("div",js,[x[0]||(x[0]=s("span",{class:"text-[9px] text-rose-500 font-black uppercase tracking-widest"},"Node Disconnected",-1)),e.onRemove&&!u.isLocal?(g(),h("button",{key:0,class:"h-8 w-8 flex items-center justify-center text-rose-500 hover:text-rose-400 hover:bg-rose-500/10 transition-colors border border-transparent hover:border-rose-500/30 rounded-xl",onClick:N=>e.onRemove(u.id),title:"Sever entry"},[m(l(Pt),{class:"w-4 h-4"})],8,Bs)):E("",!0)]))]))),128)),e.players.length===0?(g(),h("p",Js," Scanning for incoming nodes... ")):E("",!0)])]))}}),Hs=se(Us,[["__scopeId","data-v-eab5f1b8"]]),Vs={class:"min-h-screen bg-background"},Ys={key:0,class:"max-w-7xl mx-auto p-6 space-y-12"},Ws={class:"text-3xl font-black tracking-tighter uppercase text-white"},zs={class:"text-gradient"},Qs={class:"animate-fade-in-up"},Xs={class:"mt-12 max-w-2xl"},Zs={key:1,class:"p-10 text-center text-white/50 uppercase font-black tracking-widest"},qs="server",ea=ne({__name:"BoardView",setup(e){const t=at(),n=ot(),r=C(()=>t.params.gameId),o=C(()=>t.params.boardId),v=C(()=>ct(r.value||"")),w=()=>n.push("/games"),{snapshot:y,send:x,playerInfos:u,connectedPeers:N,pendingSignaling:J,pendingJoinRequests:I,isInitiator:A,isGameStarted:b,onHostAGame:p,isKnownIdentity:S,onApprovePeer:z,onRejectPeer:Q,saveIdentityOnApprove:Ie,updateOffer:Ee,updateAnswer:ae,startGame:he,onFinishGame:ye,onAddLedger:oe,onAcceptGuest:Ae,onRejectGuest:_e,onCancelSignaling:Pe,onBackToGames:fe,signalingClient:me,isServerConnecting:Ne}=Bt(),Te=async B=>{if(console.log("[BoardView] handleSavePlayerIdentity called for:",B.name,"publicKey:",B.publicKey),!B.publicKey){console.warn("[BoardView] Cannot save - no public key");return}const H={id:`identity-${Date.now()}`,name:B.name,publicKey:B.publicKey,addedAt:Date.now()};console.log("[BoardView] Saving identity to DB:",H),await ge.addKnownIdentity(H),console.log("[BoardView] Identity saved successfully"),Se.success("Identity Saved",{description:`${B.name} has been added to your known identities.`})},ve=C(()=>N.value),Ge=()=>{fe(),w()},be=C(()=>y.value?.matches("finished")||!1),Re=C(()=>!b.value&&!be.value),we=B=>{Re.value&&(B.preventDefault(),B.returnValue="")};return rt(async()=>{if(await ge.cleanupOldHostedSessions(),o.value&&y.value?.matches("idle"))if(await ge.isHosting(o.value)){const H=parseInt(t.query.maxPlayers)||2;console.log("[BOARDVIEW] Initializing HOST state for boardId:",o.value,"maxPlayers:",H),x({type:"HOST",maxPlayers:H,boardId:o.value})}else console.log("[BOARDVIEW] Initializing GUEST state for boardId:",o.value),x({type:"JOIN",boardId:o.value});window.addEventListener("beforeunload",we)}),it(()=>{window.removeEventListener("beforeunload",we)}),(B,H)=>(g(),h("div",Vs,[v.value?(g(),h("div",Ys,[s("h1",Ws,[H[0]||(H[0]=G(" Lobby: ",-1)),s("span",zs,R(v.value.name),1)]),s("div",Qs,[be.value?(g(),W(Es,{key:0,GameComponent:v.value.component,connectedPeers:ve.value,playerInfos:l(u),isInitiator:l(A),ledger:l(y)?.context?.ledger||[],onBackToLobby:w},null,8,["GameComponent","connectedPeers","playerInfos","isInitiator","ledger"])):l(b)?(g(),W(ms,{key:1,GameComponent:v.value.component,connectedPeers:ve.value,playerInfos:l(u),isInitiator:l(A),ledger:l(y)?.context?.ledger||[],onAddLedger:l(oe),onFinishGame:l(ye)},null,8,["GameComponent","connectedPeers","playerInfos","isInitiator","ledger","onAddLedger","onFinishGame"])):(g(),W(us,{key:2,state:l(y),isInitiator:l(A),signalingMode:qs,isServerConnecting:l(Ne),signalingClient:l(me),pendingSignaling:l(J),pendingJoinRequests:l(I),isKnownIdentity:l(S),onStartGame:l(he),onHostAGame:l(p),onUpdateOffer:l(Ee),onUpdateAnswer:l(ae),onCloseSession:Ge,onBackToLobby:w,onAcceptGuest:l(Ae),onRejectGuest:l(_e),onApprovePeer:l(z),onRejectPeer:l(Q),onSaveIdentity:l(Ie),onCancelSignaling:l(Pe),onRemovePlayer:le=>l(x)({type:"REMOVE_PLAYER",playerId:le}),playerCount:l(u).length,maxPlayers:l(y)?.context?.maxPlayers||2,boardId:o.value,gameId:r.value},null,8,["state","isInitiator","isServerConnecting","signalingClient","pendingSignaling","pendingJoinRequests","isKnownIdentity","onStartGame","onHostAGame","onUpdateOffer","onUpdateAnswer","onAcceptGuest","onRejectGuest","onApprovePeer","onRejectPeer","onSaveIdentity","onCancelSignaling","onRemovePlayer","playerCount","maxPlayers","boardId","gameId"])),s("div",Xs,[m(Hs,{players:l(u),onRemove:l(A)?le=>l(x)({type:"REMOVE_PLAYER",playerId:le}):void 0,onSaveIdentity:Te,isKnownIdentity:l(S)},null,8,["players","onRemove","isKnownIdentity"])])])])):(g(),h("div",Zs," Game not found in grid. "))]))}}),ca=se(ea,[["__scopeId","data-v-cede8068"]]);export{ca as default};
