import{c as ge,G as Le,x as fe,y as H,u as ve,h as C,r as $,m as ne,s as De,v as Pe,H as Me}from"./index-BKBOO3Kl.js";import{i as F}from"./_virtual___federation_fn_import-KFlDF37F.js";import{a as ke}from"./GameRegistry-DkpiLfwP.js";import{S as K}from"./sessions-oMnIzMip.js";const st=ge("globe",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M12 2a14.5 14.5 0 0 0 0 20 14.5 14.5 0 0 0 0-20",key:"13o1zl"}],["path",{d:"M2 12h20",key:"9i4pu4"}]]);const it=ge("log-in",[["path",{d:"m10 17 5-5-5-5",key:"1bsop3"}],["path",{d:"M15 12H3",key:"6jk70r"}],["path",{d:"M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4",key:"u53s6r"}]]);const ot=ge("user-plus",[["path",{d:"M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2",key:"1yyitq"}],["circle",{cx:"9",cy:"7",r:"4",key:"nufk8"}],["line",{x1:"19",x2:"19",y1:"8",y2:"14",key:"1bvyxn"}],["line",{x1:"22",x2:"16",y1:"11",y2:"11",key:"1shjgl"}]]),{createMachine:Ue,assign:re}=await F("xstate"),xe=Ue({types:{},id:"lobby",initial:"selection",context:({input:e})=>({playerName:e.playerName,signalingMode:null,playerCount:2}),states:{selection:{on:{SELECT_MODE:{target:"discovery",actions:re({signalingMode:({event:e})=>e.mode})}}},discovery:{on:{GOTO_SELECTION:"selection",SET_PLAYER_COUNT:{actions:re({playerCount:({event:e})=>e.count})},SELECT_MODE:{actions:re({signalingMode:({event:e})=>e.mode})}}}}}),V=!1,Ye=()=>{const e={net:V,state:V,info:V,error:!0,lobby:V,sig:V,webrtc:V};try{const t=localStorage.getItem("debug_config");if(t)return{...e,...JSON.parse(t)}}catch{}return e},$e=Ye(),o={shouldLog:e=>$e[e],netIn:(e,t)=>{if(!o.shouldLog("net"))return;let n=t;try{n=JSON.parse(t)}catch{}console.log("%c[NET-IN] %cfrom %s:","color: #22c55e; font-weight: bold;","color: #64748b;",e.slice(0,8),n)},netOut:(e,t)=>{if(!o.shouldLog("net"))return;let n=t;try{n=JSON.parse(t)}catch{}console.log("%c[NET-OUT] %cto %s:","color: #3b82f6; font-weight: bold;","color: #64748b;",e.slice(0,8),n)},state:(e,t,n,i="state")=>{if(!o.shouldLog(i))return;console.log("%c[%s-%s] %c%s",`color: ${e==="EVENT"?"#f59e0b":"#10b981"}; font-weight: bold;`,i.toUpperCase(),e,"color: inherit;",t,n||"")},lobby:(e,t,n)=>{o.state(e,t,n,"lobby")},sig:(e,...t)=>{o.shouldLog("sig")&&console.log("%c[SIG] %c%s","color: #ec4899; font-weight: bold;","color: inherit;",e,...t)},webrtc:(e,...t)=>{o.shouldLog("webrtc")&&console.log("%c[WEBRTC] %c%s","color: #06b6d4; font-weight: bold;","color: inherit;",e,...t)},info:(...e)=>{o.shouldLog("info")&&console.log("%c[INFO]","color: #8b5cf6; font-weight: bold;",...e)},error:(...e)=>{o.shouldLog("error")&&console.error("%c[ERROR]","color: #ef4444; font-weight: bold;",...e)}};class Je{socket=null;onMessageCallback;gameId;boardId;peerName;publicKey=null;constructor(t,n,i,r){this.gameId=t,this.boardId=n||"",this.peerName=i,this.onMessageCallback=r}updateBoardId(t){o.sig(`Updating signaling boardId from ${this.boardId} to ${t}`),this.boardId=t}async connect(t,n,i){let r="wss://pebsg4v5yk.execute-api.eu-central-1.amazonaws.com/production";const N=new URLSearchParams;N.append("x-api-key",t),n&&(N.append("x-pubkey",n),this.publicKey=n),i&&N.append("x-sig",i);const I=`${r}?${N.toString()}`;return new Promise((w,d)=>{o.sig(`Connecting to signaling server: ${I}`),this.socket=new WebSocket(I),this.socket.onopen=()=>{o.sig("WebSocket Connection Open."),w()},this.socket.onmessage=T=>{o.sig("Raw message from server:",T.data);try{const A=JSON.parse(T.data);this.onMessageCallback(A)}catch(A){o.error("Failed to parse signaling message",A)}},this.socket.onclose=T=>{o.sig("Disconnected from signaling server",T.code,T.reason),this.socket=null},this.socket.onerror=T=>{o.error("Signaling WebSocket error:",T),d(T)}})}sendOffer(t,n,i,r){return o.sig("Broadcasting combined offer for game:",this.gameId,"board:",i,"slots:",t.length),this.send({type:"offer",slots:t,gameId:this.gameId,boardId:i,peerName:r,publicKey:this.publicKey||void 0})}requestOffers(){return o.sig("Requesting active offers for game:",this.gameId),this.send({type:"listOffers",gameId:this.gameId})}sendAnswer(t,n,i,r){return o.sig("Sending answer to host:",t,"for P2P slot:",n),this.send({type:"answer",target:t,to:n,answer:i,peerName:this.peerName,boardId:r||this.boardId,publicKey:this.publicKey||void 0})}deleteOffer(){if(!this.socket||this.socket.readyState!==WebSocket.OPEN){o.sig("Cannot delete offer: Signaling socket is not open.");return}o.sig("Deleting offer for game:",this.gameId,"board:",this.boardId),this.send({type:"deleteOffer",gameId:this.gameId,...this.boardId?{boardId:this.boardId}:{}})}send(t){if(!this.socket||this.socket.readyState!==WebSocket.OPEN)return o.error("Signaling socket not open. State:",this.socket?.readyState),!1;const n={action:"sendMessage",...t};return o.sig("Sending payload to AWS:",n),this.socket.send(JSON.stringify(n)),!0}disconnect(t=!1){t&&this.isConnected&&this.deleteOffer(),this.socket?.close(),this.socket=null}get isConnected(){return!!this.socket&&this.socket.readyState===WebSocket.OPEN}}const{createActor:rt,toObserver:ct}=await F("xstate");function Be(e,t){return e===t}const he=()=>{};function Ce(e,t,n=Be){const i=Le(e)?e:fe(e),r=fe(t(i.value?.getSnapshot())),N=I=>{n(r.value,I)||(r.value=I)};return H(i,(I,w,d)=>{if(r.value=t(I?.getSnapshot()),!I)return;const T=I.subscribe({next:A=>{N(t(A))},error:he,complete:he});d(()=>T.unsubscribe())},{immediate:!0}),r}const E=[];for(let e=0;e<256;++e)E.push((e+256).toString(16).slice(1));function He(e,t=0){return(E[e[t+0]]+E[e[t+1]]+E[e[t+2]]+E[e[t+3]]+"-"+E[e[t+4]]+E[e[t+5]]+"-"+E[e[t+6]]+E[e[t+7]]+"-"+E[e[t+8]]+E[e[t+9]]+"-"+E[e[t+10]]+E[e[t+11]]+E[e[t+12]]+E[e[t+13]]+E[e[t+14]]+E[e[t+15]]).toLowerCase()}let ce;const Fe=new Uint8Array(16);function Ve(){if(!ce){if(typeof crypto>"u"||!crypto.getRandomValues)throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");ce=crypto.getRandomValues.bind(crypto)}return ce(Fe)}const Ke=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto),ye={randomUUID:Ke};function We(e,t,n){e=e||{};const i=e.random??e.rng?.()??Ve();if(i.length<16)throw new Error("Random bytes length must be >= 16");return i[6]=i[6]&15|64,i[8]=i[8]&63|128,He(i)}function de(e,t,n){return ye.randomUUID&&!e?ye.randomUUID():We(e)}var b=(e=>(e.new="new",e.started="started",e.readyToAccept="readyToAccept",e.accepted="accepted",e.answered="answered",e.connected="established",e.closed="closed",e))(b||{});class q{id;peerConnection;localPlayerName;remotePlayerName;dataChannel;iceCandidates;status;signal;messageListeners=[];onClose;updateView;constructor(t){this.id=de(),this.updateView=t,this.peerConnection=new RTCPeerConnection(je),this.iceCandidates=[];let n=null;this.peerConnection.onicecandidate=i=>{i.candidate&&(this.iceCandidates.push(i.candidate),(this.status==="started"||this.status==="answered")&&(this.updateSignal(),n&&clearTimeout(n),n=setTimeout(()=>{this.updateView(this),n=null},200)))},this.peerConnection.onconnectionstatechange=i=>{const r=this.peerConnection.connectionState;o.webrtc(this.id+": Connection state changed to "+r),r==="connected"?(this.status="established",this.updateView(this)):(r==="disconnected"||r==="failed"||r==="closed")&&this.close()}}updateSignal(t){this.peerConnection.localDescription&&(this.signal=new z(this.id,this.peerConnection.localDescription,t||this.localPlayerName,this.iceCandidates))}openDataChannel(){this.dataChannel=this.peerConnection.createDataChannel("gameData"),this.dataChannel.onopen=t=>o.webrtc(this.id+" Data channel state is: "+this.dataChannel.readyState),this.dataChannel.onclose=t=>o.webrtc(this.id+" Data channel state is: "+this.dataChannel.readyState),this.dataChannel.onerror=t=>o.error(this.id+" Error ",t),this.dataChannel.onmessage=t=>{o.netIn(this.id,t.data),this.messageListeners.forEach(n=>n(t.data))}}setDataChannelCallback(){this.peerConnection.ondatachannel=t=>{o.webrtc("Receive Channel Callback",t),this.dataChannel=t.channel,this.dataChannel.onmessage=n=>{o.netIn(this.id,n.data),this.messageListeners.forEach(i=>i(n.data))},this.dataChannel.onopen=n=>{const i=this.dataChannel.readyState;o.webrtc(this.id+": Data channel state is: "+i),i=="open"&&(o.webrtc(this.id+": Sending ping"),this.send("Ping"))},this.dataChannel.onclose=n=>{const i=this.dataChannel.readyState;o.webrtc(this.id+": Data channel state is: "+i)}}}async prepareOfferSignal(t){this.localPlayerName=t,this.status="new";try{const n=await this.peerConnection.createOffer();await this.peerConnection.setLocalDescription(n),this.status="started",this.updateSignal(),this.updateView(this)}catch(n){this.onCreateSessionDescriptionError(n)}}async send(t){this.dataChannel&&this.dataChannel.readyState==="open"&&(o.netOut(this.id,t),await this.dataChannel.send(t))}addMessageListener(t){this.messageListeners.push(t)}removeMessageListener(t){this.messageListeners=this.messageListeners.filter(n=>n!==t)}async acceptOffer(t,n){const i=typeof t=="string"?z.fromString(t):t;this.remotePlayerName=i.playerName,this.localPlayerName=n,await this.peerConnection.setRemoteDescription(i.session),i.iceCandidates.forEach(r=>{this.peerConnection.addIceCandidate(r)});try{const r=await this.peerConnection.createAnswer();await this.peerConnection.setLocalDescription(r),this.status="answered",this.updateSignal(),this.updateView(this),this.updateView(this)}catch(r){this.onCreateSessionDescriptionError(r)}}onCreateSessionDescriptionError(t){o.error("Failed to create session description: "+t.toString())}async acceptAnswer(t){const n=typeof t=="string"?z.fromString(t):t;o.webrtc(this.id+": Accepting answer signal from "+n.playerName);try{await this.peerConnection.setRemoteDescription(n.session),this.remotePlayerName=n.playerName,n.iceCandidates&&(o.webrtc(this.id+`: Adding ${n.iceCandidates.length} ICE candidates from answer`),n.iceCandidates.forEach(i=>{this.peerConnection.addIceCandidate(i).catch(r=>o.error("Error adding ICE candidate:",r))})),this.updateView(this)}catch(i){o.error(this.id+": Failed to set remote description from answer",i)}}close(){this.dataChannel&&this.dataChannel.close(),this.peerConnection.close(),this.status="closed",this.onClose?.(),this.updateView(this)}}class z{session;connectionId;playerName;iceCandidates;constructor(t,n,i,r){this.session=n,this.connectionId=t,this.playerName=i,this.iceCandidates=r}toString(){return btoa(JSON.stringify(this))}static fromString(t){const n=JSON.parse(atob(t));return new z(n.connectionId,n.session,n.playerName,n.iceCandidates)}}const je={iceServers:[{urls:"stun:stun.l.google.com:19302"}]},{createMachine:qe,assign:m}=await F("xstate"),{createLobbyMessage:ee}=await F("@mykoboard/integration"),ze=qe({types:{},id:"board",initial:"idle",context:({input:e})=>({connections:new Map,playerStatuses:new Map,isInitiator:e.isInitiator||!1,isGameStarted:!1,isGameFinished:!1,playerName:e.playerName,ledger:[],pendingGuest:null,externalParticipants:[],maxPlayers:e.maxPlayers||2,boardId:e.boardId||""}),states:{idle:{on:{HOST:{target:"hosting",actions:m({isInitiator:!0,maxPlayers:({event:e})=>e.maxPlayers||2,boardId:({event:e})=>e.boardId})},JOIN:{target:"joining",actions:m({isInitiator:!1,boardId:({event:e})=>e.boardId})}}},hosting:{on:{REQUEST_JOIN:{target:"approving",actions:m({pendingGuest:({event:e})=>({id:e.connectionId,name:e.peerName,answer:e.answer,connection:e.connection})})}},always:[{target:"preparation",guard:"hasConnections"}]},joining:{always:[{target:"preparation",guard:"hasConnections"}]},approving:{on:{ACCEPT_GUEST:{target:"preparation",actions:["acceptGuest","clearPendingGuest"]},REJECT_GUEST:{target:"hosting",actions:["rejectGuest","clearPendingGuest"]}}},preparation:{on:{START_GAME:{target:"playing",actions:["setGameStarted","broadcastStartGame"]},GAME_STARTED:{target:"playing",actions:"setGameStarted"},REQUEST_JOIN:{target:"approving",actions:m({pendingGuest:({event:e})=>({id:e.connectionId,name:e.peerName,answer:e.answer,connection:e.connection})})}}},playing:{on:{FINISH_GAME:{target:"finished",actions:m({isGameFinished:!0})}}},finished:{on:{RESET_GAME:{target:"preparation",actions:["resetGameStarted","broadcastResetGame"]}}}},on:{UPDATE_CONNECTION:{actions:["updateConnection","syncConnection"]},PEER_DISCONNECTED:{actions:["updateConnectionStatus","removeConnection"]},SET_PLAYER_STATUS:{actions:"setPlayerStatus"},REMOVE_PLAYER:{actions:"removePlayer"},SYNC_LEDGER:{actions:"syncLedger"},LOAD_LEDGER:{actions:m({ledger:({event:e})=>e.ledger})},SYNC_PARTICIPANTS:{actions:m({externalParticipants:({event:e})=>e.participants})},GAME_STARTED:{actions:"setGameStarted"},GAME_RESET:{actions:"resetGameStarted"},CLOSE_SESSION:{target:".idle",actions:["resetContext","closeAllConnections"]}}},{actions:{setGameStarted:m({isGameStarted:!0,isGameFinished:!1}),resetGameStarted:m({isGameStarted:!1,isGameFinished:!1,ledger:[]}),setPlayerStatus:m(({context:e,event:t})=>{if(t.type!=="SET_PLAYER_STATUS")return e;const n=new Map(e.playerStatuses);return n.set(t.playerId,t.status),{playerStatuses:n}}),updateConnectionStatus:m(({context:e,event:t})=>{if(t.type!=="PEER_DISCONNECTED")return e;const n=new Map(e.connections),i=n.get(t.connectionId);return i&&(i.status=b.closed),{connections:n}}),updateConnection:m(({context:e,event:t})=>{if(t.type!=="UPDATE_CONNECTION")return e;const n=t.connection;if(n.status===b.closed&&!e.connections.has(n.id))return e;const i=e.connections.get(n.id);if(i){const I=i._lastKnownStatus!==n.status,w=i._lastKnownSignal!==(n.signal?.toString()||"");if(!I&&!w)return e}n._lastKnownStatus=n.status,n._lastKnownSignal=n.signal?.toString()||"";const r=new Map(e.connections);r.set(n.id,n);const N=new Map(e.playerStatuses);return N.has(n.id)||N.set(n.id,"lobby"),{connections:r,playerStatuses:N}}),syncConnection:({context:e,event:t})=>{if(t.type!=="UPDATE_CONNECTION")return;const n=t.connection;if(e.isInitiator&&n.status===b.connected){if(n._synced)return;n._synced=!0,o.lobby("STATE",`Syncing new connection: ${n.id}`),n.send(JSON.stringify(ee("SYNC_LEDGER",e.ledger))),e.isGameStarted&&n.send(JSON.stringify(ee("GAME_STARTED")))}},removeConnection:m(({context:e,event:t})=>{if(t.type!=="PEER_DISCONNECTED")return e;const n=new Map(e.connections);return n.delete(t.connectionId),{connections:n}}),removePlayer:m(({context:e,event:t})=>{if(t.type!=="REMOVE_PLAYER")return e;const n=new Map(e.connections),i=n.get(t.playerId);i&&(i.close(),n.delete(t.playerId));const r=new Map(e.playerStatuses);return r.delete(t.playerId),{connections:n,playerStatuses:r}}),syncLedger:m(({context:e,event:t})=>t.type!=="SYNC_LEDGER"?e:{ledger:t.ledger}),broadcastStartGame:({context:e})=>{e.isInitiator&&e.connections.forEach(t=>{t.status===b.connected&&t.send(JSON.stringify(ee("START_GAME")))})},broadcastResetGame:({context:e})=>{e.isInitiator&&e.connections.forEach(t=>{t.status===b.connected&&t.send(JSON.stringify(ee("GAME_RESET")))})},closeAllConnections:({context:e})=>{e.connections.forEach(t=>t.close())},acceptGuest:({context:e})=>{e.pendingGuest&&(o.sig("Accepting guest:",e.pendingGuest.name),e.pendingGuest.connection.acceptAnswer(e.pendingGuest.answer))},rejectGuest:({context:e})=>{e.pendingGuest&&(o.sig("Rejecting guest:",e.pendingGuest.name),e.pendingGuest.connection.close())},resetContext:m(({context:e})=>({connections:new Map,playerStatuses:new Map,ledger:[],isGameStarted:!1,isGameFinished:!1,isInitiator:!1,maxPlayers:e.maxPlayers,pendingGuest:null,externalParticipants:[],boardId:""})),clearPendingGuest:m({pendingGuest:null})},guards:{hasConnections:({context:e})=>Array.from(e.connections.values()).some(t=>t.status===b.connected)}}),{createActor:be}=await F("xstate"),{isLobbyMessage:Qe}=await F("@mykoboard/integration"),O=$(null),ue=$(!0),S=$(null),Se=$([]),Q=$([]),te=$(!1),Y=$(),me=be(xe,{input:{playerName:"Anonymous"}}).start(),le=new Map;function ae(e,t,n=!1,i=2){if(!le.has(e)){o.lobby("STATE",`Creating new board actor for ${e}`);const r=be(ze,{input:{playerName:t,boardId:e,isInitiator:n,maxPlayers:i}});r.start(),le.set(e,r)}return le.get(e)}function Ee(){const e=ve(),t=Ce(me,l=>l),n=l=>me.send(l),i=C(()=>t.value?.context?.signalingMode),r=l=>{n({type:"SELECT_MODE",mode:l})};(async()=>{if(O.value)return;const l=ne.getInstance();O.value=await l.getIdentity(),ue.value=!1,O.value?.name})();const I=async l=>{await K.removeSession(l),Q.value=await K.getSessions()};(async()=>Q.value=await K.getSessions())();const d=async(l,R,G)=>{const v=R.sessionBoardId||R.boardId;if(!v)return;const u=ae(v,O.value?.name||"Anonymous",!1);u.send({type:"JOIN",boardId:v});const M=new q(L=>{u.send({type:"UPDATE_CONNECTION",connection:L}),L._hasListener||(L.addMessageListener(h=>{try{const y=JSON.parse(h);if(!Qe(y))return;y.type==="START_GAME"&&u.send({type:"START_GAME"}),y.type==="GAME_STARTED"&&u.send({type:"GAME_STARTED"}),y.type==="GAME_RESET"&&u.send({type:"GAME_RESET"}),y.type==="NEW_BOARD"&&e.replace(`/games/${l}/${y.payload}`),y.type==="SYNC_PLAYER_STATUS"&&u.send({type:"SET_PLAYER_STATUS",playerId:L.id,status:y.payload}),y.type==="SYNC_PARTICIPANTS"&&u.send({type:"SYNC_PARTICIPANTS",participants:y.payload}),y.type==="SYNC_LEDGER"&&u.send({type:"SYNC_LEDGER",ledger:y.payload})}catch{}}),L._hasListener=!0)});M.setDataChannelCallback(),await M.acceptOffer(G.offer,O.value?.name||"Anonymous");const J=setInterval(()=>{M.signal&&(v&&S.value?.updateBoardId(v),S.value?.sendAnswer(R.connectionId,G.connectionId,M.signal,v),clearInterval(J),e.replace(`/games/${l}/${v}`))},500)},T=async(l,R)=>{const G=R||l;if(o.sig("setupSignaling called with gameId:",l,"boardId:",R,"resolved currentBoardId:",G),!!G&&(Y.value!==G&&S.value?.isConnected&&(o.sig("Switching signaling board assignment from",Y.value,"to",G),S.value.updateBoardId(G),Y.value=G),(!S.value||!S.value.isConnected)&&!te.value)){te.value=!0;try{const v=ne.getInstance(),u=await v.getIdentity();if(u){const M=new Je(l||"default",G,u.name,h=>{if(h.type==="offerList"&&(Se.value=h.offers||[]),h.type==="error"&&(o.error("Signaling error:",h.message||h.code),De.error(h.message||"Signaling error occurred"),h.code==="DUPLICATE_IDENTITY"&&e.replace(`/games/${l}`)),h.type==="answer"){o.sig("Received answer message from Guest. msg.boardId:",h.boardId,"connectionBoardId:",Y.value);const y=h.boardId||Y.value;if((!y||y===l)&&(o.error("No valid target board UUID for answer message. Falling back to connectionBoardId:",Y.value),Y.value===l)){o.error("Abort routing: targetId matches gameId exactly. This would create a zombie actor.");return}o.sig("Routing answer to actor:",y);const x=ae(y,u.name,!1),se=x.getSnapshot().context,X=Array.from(se.connections.values()),Z=h.to?X.find(W=>W.id===h.to):X.find(W=>W.status===b.started);Z&&x.send({type:"REQUEST_JOIN",connectionId:h.from,peerName:h.peerName||"Anonymous Guest",answer:h.answer,connection:Z})}}),J=`SIGN_IN:${u.subscriptionToken}`,L=await v.sign(J);await M.connect(u.subscriptionToken,u.publicKey,L),S.value=M,Y.value=G}}catch(v){o.error("Signaling connection failed",v)}finally{te.value=!1}}},A=()=>{i.value==="server"&&S.value&&S.value.requestOffers()},f=l=>{e.push(`/games/${l}`)};return{identity:O,isLoading:ue,lobbySnapshot:t,lobbySend:n,signalingMode:i,setSignalingMode:r,signalingClient:S,availableOffers:Se,activeSessions:Q,onDeleteSession:I,isServerConnecting:te,onJoinFromList:d,setupSignaling:T,requestOffers:A,onBackToDiscovery:f,onBackToGames:f}}const{Ledger:Xe,createLobbyMessage:j,isLobbyMessage:Ze}=await F("@mykoboard/integration");function lt(){const e=Pe(),t=ve(),{setupSignaling:n,requestOffers:i,signalingMode:r,lobbySend:N,lobbySnapshot:I}=Ee(),w=C(()=>e.params.gameId),d=C(()=>e.params.boardId),T=C(()=>ke(w.value||"")),A=C(()=>!!d.value),f=C(()=>!d.value||d.value==="manual"?null:ae(d.value,O.value?.name||"Anonymous",!1)),_=Ce(f,a=>a),l=C(()=>_.value?.context?.isInitiator||!1),R=C(()=>_.value?.context?.isGameStarted||!1),G=C(()=>_.value?.context?.connections||new Map),v=C(()=>Array.from(G.value.values())),u=C(()=>v.value.filter(a=>a.status===b.connected)),M=C(()=>v.value.filter(a=>a.status!==b.connected&&a.status!==b.closed));C(()=>!!_.value&&_.value.status!=="idle");const J=C(()=>A.value?"game":"lobby"),L=C(()=>{if(!_.value)return[];const a=_.value.context,s=Q.value.find(c=>c.boardId===d.value),p=s?.participants||[],D=a.externalParticipants||[],B=p.find(c=>c.isYou),k={id:O.value?.id||"local",name:a.playerName,status:R.value?"game":"lobby",isConnected:!0,isLocal:!0,isHost:B?B.isHost:l.value},g=[],P=new Set;if(l.value)g.push(k),P.add(k.id);else if(D.length>0){const c=D.find(U=>U.isHost);if(c){const U=u.value.find(oe=>oe.status===b.connected);g.push({id:c.id,name:c.name,status:(U?a.playerStatuses.get(U.id):null)||(R.value?"game":"lobby"),isConnected:!!U,isLocal:!1,isHost:!0}),P.add(c.id)}}return l.value?v.value.forEach(c=>{if(!P.has(c.id)){const U=p.find(oe=>oe.id===c.id);g.push({id:c.id,name:c.remotePlayerName||U?.name||"Anonymous",status:a.playerStatuses.get(c.id)||"lobby",isConnected:c.status===b.connected,isLocal:!1,isHost:!1}),P.add(c.id)}}):D.length>0&&D.forEach(c=>{c.isHost||c.id==="local"||(c.name===k.name&&!P.has(c.id)?(g.push({...k,id:c.id}),P.add(c.id)):(g.push({id:c.id,name:c.name,status:R.value?"game":"lobby",isConnected:!0,isLocal:!1,isHost:!1}),P.add(c.id)))}),p.forEach(c=>{!c.isYou&&!P.has(c.id)&&g.push({id:c.id,name:c.name,status:s?.status==="finished"||R.value?"game":"lobby",isConnected:!1,isLocal:!1,isHost:c.isHost})}),g});Me(()=>{const a=_.value;a?.status==="active"&&d.value&&d.value!=="manual"&&K.saveSession({gameId:w.value,boardId:d.value,playerName:a.context.playerName,gameName:T.value?.name||"Unknown Game",lastPlayed:Date.now(),status:a.matches("finished")?"finished":"active",ledger:a.context.ledger,participants:L.value.map(s=>({id:s.id,name:s.name,isYou:s.isLocal,isHost:s.isHost}))})});const h=new Map,y=new Map,x=a=>{const s=f.value;if(!s)return;const p=h.get(a.id),D=a.signal?.toString()||"",B=y.get(a.id);p===a.status&&B===D||(h.set(a.id,a.status),y.set(a.id,D),s.send({type:"UPDATE_CONNECTION",connection:a}),a._hasListener||(a.addMessageListener(k=>{try{const g=JSON.parse(k);if(!Ze(g))return;if(g.type==="START_GAME"&&s.send({type:"START_GAME"}),g.type==="GAME_STARTED"&&s.send({type:"GAME_STARTED"}),g.type==="GAME_RESET"&&s.send({type:"GAME_RESET"}),g.type==="NEW_BOARD"&&t.replace(`/games/${w.value}/${g.payload}`),g.type==="SYNC_PLAYER_STATUS"&&s.send({type:"SET_PLAYER_STATUS",playerId:a.id,status:g.payload}),g.type==="SYNC_PARTICIPANTS"&&s.send({type:"SYNC_PARTICIPANTS",participants:g.payload}),g.type==="SYNC_LEDGER"){const P=g.payload;for(const c of P)c.signature&&c.signerPublicKey&&ne.verify(c.action,c.signature,c.signerPublicKey).then(U=>{U||o.error("Invalid signature in ledger entry",c)});s.send({type:"SYNC_LEDGER",ledger:g.payload})}}catch{}}),a._hasListener=!0))},se=(a=2)=>{if(A.value){if(f.value){const s=new q(x);s.onClose=()=>f.value?.send({type:"PEER_DISCONNECTED",connectionId:s.id}),s.openDataChannel(),s.prepareOfferSignal(_.value?.context?.playerName||O.value?.name||"Anonymous")}}else{const s=de();t.push(`/games/${w.value}/${s}?maxPlayers=${a}`)}},X=()=>{r.value==="server"&&S.value&&l.value&&S.value.deleteOffer(),f.value?.send({type:"START_GAME"})},Z=()=>{if(!f.value)return;f.value.send({type:"JOIN",boardId:d.value});const a=new q(x);a.onClose=()=>f.value?.send({type:"PEER_DISCONNECTED",connectionId:a.id}),a.status=b.readyToAccept,a.setDataChannelCallback(),x(a)},W=async(a,s)=>{if(!(!(a instanceof q)||!s))try{await a.acceptOffer(s,O.value?.name||"Anonymous")}catch(p){o.error("Failed to accept offer",p)}},Ie=(a,s)=>{if(!(!(a instanceof q)||!s))try{a.acceptAnswer(s),x(a)}catch(p){o.error("Failed to accept answer",p)}},we=()=>{f.value?.send({type:"FINISH_GAME"}),d.value&&K.updateStatus(d.value,"finished")},Ne=async a=>{if(!l.value||!f.value)return;const s=ne.getInstance(),p=await s.getIdentity();if(!p)return;const D=await s.sign(a),B=Xe.fromEntries(_.value?.context?.ledger||[]),k=await B.addEntry({...a});k.signature=D,k.signerPublicKey=p.publicKey;const g=B.getEntries();f.value.send({type:"SYNC_LEDGER",ledger:g}),u.value.forEach(P=>{P.send(JSON.stringify(j("SYNC_LEDGER",g)))})},Te=()=>{const a=de();u.value.forEach(s=>{s.status===b.connected&&s.send(JSON.stringify(j("NEW_BOARD",a)))}),S.value?.deleteOffer(),f.value?.send({type:"CLOSE_SESSION"}),t.push(`/games/${w.value}/${a}`)},Ae=()=>{const a=_.value?.context?.pendingGuest;f.value?.send({type:"ACCEPT_GUEST"}),a&&x(a.connection)},_e=()=>f.value?.send({type:"REJECT_GUEST"}),Ge=a=>{a.close(),f.value?.send({type:"PEER_DISCONNECTED",connectionId:a.id})},Oe=()=>{S.value?.deleteOffer(),f.value?.send({type:"CLOSE_SESSION"}),t.push(`/games/${w.value}`)},Re=()=>{t.push(`/games/${w.value}`)};let ie=null;const pe=$("");return H([l,r,S,d,u,M],()=>{!l.value||r.value!=="server"||!S.value||!d.value||(ie&&clearTimeout(ie),ie=setTimeout(()=>{const a=[...u.value.map(s=>({connectionId:s.id,offer:s.signal,status:"taken",peerName:s.remotePlayerName})),...M.value.filter(s=>s.signal).map(s=>({connectionId:s.id,offer:s.signal,status:"open"}))];if(a.length>0){const s=JSON.stringify(a),p=`${d.value}:${s}`;p!==pe.value&&S.value?.sendOffer(a,w.value,d.value,O.value?.name||"Anonymous")&&(pe.value=p)}},500))}),H([l,L],()=>{if(!l.value)return;const a=L.value.map(s=>({id:s.id,name:s.name,isHost:s.isHost}));u.value.forEach(s=>{if(s.status===b.connected)try{s.send(JSON.stringify(j("SYNC_PARTICIPANTS",a)))}catch(p){o.error("Failed to sync participants to peer",s.id,p)}})},{deep:!0,immediate:!0}),H([r,d,A],async()=>{const a=r.value==="server"&&(A.value||!d.value);o.sig("[WATCH] Signaling Lifecycle update. shouldConnect:",a,"mode:",r.value,"boardId:",d.value),a&&await n(w.value,d.value)},{immediate:!0}),H(d,async a=>{if(a&&a!=="manual"&&A.value){const s=await K.getSession(a),p=ae(a,O.value?.name||"Anonymous",!1),D=p.getSnapshot().context;s&&s.ledger.length>0&&D.ledger.length===0&&(p.send({type:"LOAD_LEDGER",ledger:s.ledger}),p.send({type:"GAME_STARTED"}),s.status==="finished"&&setTimeout(()=>p.send({type:"FINISH_GAME"}),10))}},{immediate:!0}),H([J,r,S],()=>{J.value==="lobby"&&r.value==="server"&&S.value&&i()}),H(u,a=>{a.forEach(s=>{s._hasInitialSync||(s.send(JSON.stringify(j("SYNC_PLAYER_STATUS",J.value))),l.value&&d.value&&d.value!=="manual"&&s.send(JSON.stringify(j("NEW_BOARD",d.value))),s._hasInitialSync=!0)})}),{identity:O,isLoading:ue,lobbySnapshot:I,snapshot:_,send:a=>f.value?.send(a),lobbySend:N,signalingMode:r,setSignalingMode:a=>N({type:"SELECT_MODE",mode:a}),signalingClient:S,availableOffers:C(()=>Ee().availableOffers.value),activeSessions:Q,playerInfos:L,connectedPeers:u,pendingSignaling:M,isInitiator:l,isGameStarted:R,onHostAGame:se,startGame:X,connectWithOffer:Z,updateOffer:W,updateAnswer:Ie,onFinishGame:we,onAddLedger:Ne,handlePlayAgain:Te,onAcceptGuest:Ae,onRejectGuest:_e,onCancelSignaling:Ge,onBackToGames:Oe,onBackToDiscovery:Re}}export{b as C,st as G,it as L,ot as U,lt as a,Ee as u};
