const w="MykoboardDB",c="games",d="knownIdentities",u="hostedSessions";class S{db=null;async getDB(){return this.db?this.db:new Promise((r,o)=>{const e=indexedDB.open(w,5);e.onupgradeneeded=s=>{const a=s.target.result;a.objectStoreNames.contains(c)||a.createObjectStore(c,{keyPath:"boardId"}),a.objectStoreNames.contains(d)||a.createObjectStore(d,{keyPath:"id"}),a.objectStoreNames.contains(u)||a.createObjectStore(u,{keyPath:"boardId"})},e.onsuccess=s=>{this.db=s.target.result,r(this.db)},e.onerror=s=>{o(s.target.error)}})}async saveGame(r){const o=await this.getDB();return new Promise((e,s)=>{const t=o.transaction(c,"readwrite").objectStore(c).put(r);t.onsuccess=()=>e(),t.onerror=()=>s(t.error)})}async getGame(r){const o=await this.getDB();return new Promise((e,s)=>{const t=o.transaction(c,"readonly").objectStore(c).get(r);t.onsuccess=()=>e(t.result||null),t.onerror=()=>s(t.error)})}async getAllGames(){const r=await this.getDB();return new Promise((o,e)=>{const n=r.transaction(c,"readonly").objectStore(c).getAll();n.onsuccess=()=>{const t=n.result;o(t.sort((l,i)=>i.lastPlayed-l.lastPlayed))},n.onerror=()=>e(n.error)})}async deleteGame(r){const o=await this.getDB();return new Promise((e,s)=>{const t=o.transaction(c,"readwrite").objectStore(c).delete(r);t.onsuccess=()=>e(),t.onerror=()=>s(t.error)})}async clearAllGames(){const r=await this.getDB();return new Promise((o,e)=>{const n=r.transaction(c,"readwrite").objectStore(c).clear();n.onsuccess=()=>o(),n.onerror=()=>e(n.error)})}async addKnownIdentity(r){const o=await this.getDB();return new Promise((e,s)=>{const t=o.transaction(d,"readwrite").objectStore(d).put(r);t.onsuccess=()=>e(),t.onerror=()=>s(t.error)})}async getAllKnownIdentities(){const r=await this.getDB();return new Promise((o,e)=>{const n=r.transaction(d,"readonly").objectStore(d).getAll();n.onsuccess=()=>o(n.result),n.onerror=()=>e(n.error)})}async deleteKnownIdentity(r){const o=await this.getDB();return new Promise((e,s)=>{const t=o.transaction(d,"readwrite").objectStore(d).delete(r);t.onsuccess=()=>e(),t.onerror=()=>s(t.error)})}async markAsHosting(r,o,e){const s=await this.getDB();return new Promise((a,n)=>{const l=s.transaction(u,"readwrite").objectStore(u),i={boardId:r,gameId:o,createdAt:Date.now(),maxPlayers:e},b=l.put(i);b.onsuccess=()=>a(),b.onerror=()=>n(b.error)})}async isHosting(r){const o=await this.getDB();return new Promise((e,s)=>{const t=o.transaction(u,"readonly").objectStore(u).get(r);t.onsuccess=()=>e(!!t.result),t.onerror=()=>s(t.error)})}async cleanupOldHostedSessions(){const r=await this.getDB(),o=Date.now()-1440*60*1e3;return new Promise((e,s)=>{const t=r.transaction(u,"readwrite").objectStore(u).openCursor();t.onsuccess=l=>{const i=l.target.result;i?(i.value.createdAt<o&&i.delete(),i.continue()):e()},t.onerror=()=>s(t.error)})}}const y=new S;export{y as d};
