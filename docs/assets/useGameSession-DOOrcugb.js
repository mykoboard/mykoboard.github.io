import{c as Q,g as be,H as we,I as Ne,J as te,K as L,h as w,v as Te,r as O,G as Ge,L as Oe,m as x,f as Ae,s as _e}from"./index-D06-buoC.js";import{i as B}from"./_virtual___federation_fn_import-Cc3udCkk.js";import{a as Re}from"./GameRegistry-C1BmYkwo.js";import{S as P}from"./sessions-oMnIzMip.js";const at=Q("globe",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M12 2a14.5 14.5 0 0 0 0 20 14.5 14.5 0 0 0 0-20",key:"13o1zl"}],["path",{d:"M2 12h20",key:"9i4pu4"}]]);const st=Q("log-in",[["path",{d:"m10 17 5-5-5-5",key:"1bsop3"}],["path",{d:"M15 12H3",key:"6jk70r"}],["path",{d:"M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4",key:"u53s6r"}]]);const it=Q("user-plus",[["path",{d:"M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2",key:"1yyitq"}],["circle",{cx:"9",cy:"7",r:"4",key:"nufk8"}],["line",{x1:"19",x2:"19",y1:"8",y2:"14",key:"1bvyxn"}],["line",{x1:"22",x2:"16",y1:"11",y2:"11",key:"1shjgl"}]]),v=[];for(let e=0;e<256;++e)v.push((e+256).toString(16).slice(1));function Le(e,t=0){return(v[e[t+0]]+v[e[t+1]]+v[e[t+2]]+v[e[t+3]]+"-"+v[e[t+4]]+v[e[t+5]]+"-"+v[e[t+6]]+v[e[t+7]]+"-"+v[e[t+8]]+v[e[t+9]]+"-"+v[e[t+10]]+v[e[t+11]]+v[e[t+12]]+v[e[t+13]]+v[e[t+14]]+v[e[t+15]]).toLowerCase()}let j;const Pe=new Uint8Array(16);function De(){if(!j){if(typeof crypto>"u"||!crypto.getRandomValues)throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");j=crypto.getRandomValues.bind(crypto)}return j(Pe)}const Me=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto),ne={randomUUID:Me};function ke(e,t,n){e=e||{};const a=e.random??e.rng?.()??De();if(a.length<16)throw new Error("Random bytes length must be >= 16");return a[6]=a[6]&15|64,a[8]=a[8]&63|128,Le(a)}function q(e,t,n){return ne.randomUUID&&!e?ne.randomUUID():ke(e)}const{createActor:Ue,toObserver:xe}=await B("xstate");function Je(e,...[t,n]){const a=Ue(e,t);let c;return be(()=>{n&&(c=a.subscribe(xe(n))),a.start()}),we(()=>{a.stop(),c?.unsubscribe()}),a}function He(e,t){return e===t}const ae=()=>{};function Ye(e,t,n=He){const a=Ne(e)?e:te(e),c=te(t(a.value?.getSnapshot())),i=d=>{n(c.value,d)||(c.value=d)};return L(a,(d,y,G)=>{if(c.value=t(d?.getSnapshot()),!d)return;const I=d.subscribe({next:b=>{i(t(b))},error:ae,complete:ae});G(()=>I.unsubscribe())},{immediate:!0}),c}function Be(e,t={}){function n(i){c.value=i}const a=Je(e,t,n),c=Ye(a,i=>i);return{snapshot:c,send:a.send,actorRef:a}}function $e(e,...[t]){return Be(e,t)}const R=!1,Ve=()=>{const e={net:R,state:R,info:R,error:!0,lobby:R,sig:R,webrtc:R};try{const t=localStorage.getItem("debug_config");if(t)return{...e,...JSON.parse(t)}}catch{}return e},Fe=Ve(),r={shouldLog:e=>Fe[e],netIn:(e,t)=>{if(!r.shouldLog("net"))return;let n=t;try{n=JSON.parse(t)}catch{}console.log("%c[NET-IN] %cfrom %s:","color: #22c55e; font-weight: bold;","color: #64748b;",e.slice(0,8),n)},netOut:(e,t)=>{if(!r.shouldLog("net"))return;let n=t;try{n=JSON.parse(t)}catch{}console.log("%c[NET-OUT] %cto %s:","color: #3b82f6; font-weight: bold;","color: #64748b;",e.slice(0,8),n)},state:(e,t,n,a="state")=>{if(!r.shouldLog(a))return;console.log("%c[%s-%s] %c%s",`color: ${e==="EVENT"?"#f59e0b":"#10b981"}; font-weight: bold;`,a.toUpperCase(),e,"color: inherit;",t,n||"")},lobby:(e,t,n)=>{r.state(e,t,n,"lobby")},sig:(e,...t)=>{r.shouldLog("sig")&&console.log("%c[SIG] %c%s","color: #ec4899; font-weight: bold;","color: inherit;",e,...t)},webrtc:(e,...t)=>{r.shouldLog("webrtc")&&console.log("%c[WEBRTC] %c%s","color: #06b6d4; font-weight: bold;","color: inherit;",e,...t)},info:(...e)=>{r.shouldLog("info")&&console.log("%c[INFO]","color: #8b5cf6; font-weight: bold;",...e)},error:(...e)=>{r.shouldLog("error")&&console.error("%c[ERROR]","color: #ef4444; font-weight: bold;",...e)}};var E=(e=>(e.new="new",e.started="started",e.readyToAccept="readyToAccept",e.accepted="accepted",e.answered="answered",e.connected="established",e.closed="closed",e))(E||{});class D{id;peerConnection;localPlayerName;remotePlayerName;dataChannel;iceCandidates;status;signal;messageListeners=[];onClose;updateView;constructor(t){this.id=q(),this.updateView=t,this.peerConnection=new RTCPeerConnection(Ke),this.iceCandidates=[];let n=null;this.peerConnection.onicecandidate=a=>{a.candidate&&(this.iceCandidates.push(a.candidate),(this.status==="started"||this.status==="answered")&&(this.updateSignal(),n&&clearTimeout(n),n=setTimeout(()=>{this.updateView(this),n=null},200)))},this.peerConnection.onconnectionstatechange=a=>{const c=this.peerConnection.connectionState;r.webrtc(this.id+": Connection state changed to "+c),c==="connected"?(this.status="established",this.updateView(this)):(c==="disconnected"||c==="failed"||c==="closed")&&this.close()}}updateSignal(t){this.peerConnection.localDescription&&(this.signal=new k(this.id,this.peerConnection.localDescription,t||this.localPlayerName,this.iceCandidates))}openDataChannel(){this.dataChannel=this.peerConnection.createDataChannel("gameData"),this.dataChannel.onopen=t=>r.webrtc(this.id+" Data channel state is: "+this.dataChannel.readyState),this.dataChannel.onclose=t=>r.webrtc(this.id+" Data channel state is: "+this.dataChannel.readyState),this.dataChannel.onerror=t=>r.error(this.id+" Error ",t),this.dataChannel.onmessage=t=>{r.netIn(this.id,t.data),this.messageListeners.forEach(n=>n(t.data))}}setDataChannelCallback(){this.peerConnection.ondatachannel=t=>{r.webrtc("Receive Channel Callback",t),this.dataChannel=t.channel,this.dataChannel.onmessage=n=>{r.netIn(this.id,n.data),this.messageListeners.forEach(a=>a(n.data))},this.dataChannel.onopen=n=>{const a=this.dataChannel.readyState;r.webrtc(this.id+": Data channel state is: "+a),a=="open"&&(r.webrtc(this.id+": Sending ping"),this.send("Ping"))},this.dataChannel.onclose=n=>{const a=this.dataChannel.readyState;r.webrtc(this.id+": Data channel state is: "+a)}}}async prepareOfferSignal(t){this.localPlayerName=t,this.status="new";try{const n=await this.peerConnection.createOffer();await this.peerConnection.setLocalDescription(n),this.status="started",this.updateSignal(),this.updateView(this)}catch(n){this.onCreateSessionDescriptionError(n)}}async send(t){this.dataChannel&&this.dataChannel.readyState==="open"&&(r.netOut(this.id,t),await this.dataChannel.send(t))}addMessageListener(t){this.messageListeners.push(t)}removeMessageListener(t){this.messageListeners=this.messageListeners.filter(n=>n!==t)}async acceptOffer(t,n){const a=typeof t=="string"?k.fromString(t):t;this.remotePlayerName=a.playerName,this.localPlayerName=n,await this.peerConnection.setRemoteDescription(a.session),a.iceCandidates.forEach(c=>{this.peerConnection.addIceCandidate(c)});try{const c=await this.peerConnection.createAnswer();await this.peerConnection.setLocalDescription(c),this.status="answered",this.updateSignal(),this.updateView(this),this.updateView(this)}catch(c){this.onCreateSessionDescriptionError(c)}}onCreateSessionDescriptionError(t){r.error("Failed to create session description: "+t.toString())}async acceptAnswer(t){const n=typeof t=="string"?k.fromString(t):t;r.webrtc(this.id+": Accepting answer signal from "+n.playerName);try{await this.peerConnection.setRemoteDescription(n.session),this.remotePlayerName=n.playerName,n.iceCandidates&&(r.webrtc(this.id+`: Adding ${n.iceCandidates.length} ICE candidates from answer`),n.iceCandidates.forEach(a=>{this.peerConnection.addIceCandidate(a).catch(c=>r.error("Error adding ICE candidate:",c))})),this.updateView(this)}catch(a){r.error(this.id+": Failed to set remote description from answer",a)}}close(){this.dataChannel&&this.dataChannel.close(),this.peerConnection.close(),this.status="closed",this.onClose?.(),this.updateView(this)}}class k{session;connectionId;playerName;iceCandidates;constructor(t,n,a,c){this.session=n,this.connectionId=t,this.playerName=a,this.iceCandidates=c}toString(){return btoa(JSON.stringify(this))}static fromString(t){const n=JSON.parse(atob(t));return new k(n.connectionId,n.session,n.playerName,n.iceCandidates)}}const Ke={iceServers:[{urls:"stun:stun.l.google.com:19302"}]},{createMachine:je,assign:S}=await B("xstate"),{createLobbyMessage:J}=await B("@mykoboard/integration"),We=je({types:{},id:"lobby",initial:"selection",context:({input:e})=>({connections:new Map,playerStatuses:new Map,isInitiator:!1,isGameStarted:!1,isGameFinished:!1,playerName:e.playerName,ledger:[],pendingGuest:null,externalParticipants:[],maxPlayers:2,boardId:void 0}),on:{UPDATE_CONNECTION:{actions:["updateConnection","syncConnection"]},PEER_DISCONNECTED:{actions:["updateConnectionStatus","removeConnection"]},SET_PLAYER_STATUS:{actions:"setPlayerStatus"},REMOVE_PLAYER:{actions:"removePlayer"},SYNC_LEDGER:{actions:"syncLedger"},LOAD_LEDGER:{actions:S({ledger:({event:e})=>e.ledger})},SYNC_PARTICIPANTS:{actions:S({externalParticipants:({event:e})=>e.participants})},BACK_TO_LOBBY:{target:"#discovery",actions:["resetContext","clearPendingGuest"]},CLOSE_SESSION:{target:"#selection",actions:["resetContext","closeAllConnections","resetGameStarted","clearPendingGuest"]},CANCEL_SIGNALING:{actions:"removeConnection"}},states:{selection:{id:"selection",on:{HOST:{target:"#hosting",actions:["resetContext",S({isInitiator:!0,isGameFinished:!1,maxPlayers:({event:e})=>e.type==="HOST"&&e.maxPlayers||2,boardId:({event:e})=>e.type==="HOST"?e.boardId:void 0})]},JOIN:{target:"#joining",actions:["resetContext"]},GOTO_LOBBY:"#discovery",RESUME:{target:"#room",actions:"setGameStarted"}}},discovery:{id:"discovery",on:{HOST:{target:"#hosting",actions:["resetContext",S({isInitiator:!0,isGameFinished:!1,maxPlayers:({event:e})=>e.type==="HOST"&&e.maxPlayers||2,boardId:({event:e})=>e.type==="HOST"?e.boardId:void 0})]},JOIN:{target:"#joining",actions:["resetContext"]},RESUME:{target:"#room",actions:"setGameStarted"}}},hosting:{id:"hosting",on:{CLOSE_SESSION:"#selection",REQUEST_JOIN:{target:"#approving",actions:S({pendingGuest:({event:e})=>({id:e.connectionId,name:e.peerName,answer:e.answer,connection:e.connection})})}},always:[{target:"#room",guard:"hasConnections"}]},approving:{id:"approving",on:{ACCEPT_GUEST:{target:"#room",actions:["acceptGuest","clearPendingGuest"]},REJECT_GUEST:{target:"#hosting",actions:["rejectGuest","clearPendingGuest"]},CLOSE_SESSION:"#selection"}},joining:{id:"joining",on:{CLOSE_SESSION:"#selection"},always:[{target:"#room",guard:"hasConnections"}]},room:{id:"room",initial:"waiting",states:{waiting:{always:[{target:"game",guard:({context:e})=>e.isGameStarted}],on:{START_GAME:{target:"game",actions:["setGameStarted","broadcastStartGame"]},GAME_STARTED:{target:"game",actions:"setGameStarted"}}},game:{on:{FINISH_GAME:{target:"finished",actions:S({isGameFinished:!0})}}},finished:{on:{}}},on:{CLOSE_SESSION:{target:"#selection",actions:"closeAllConnections"},REQUEST_JOIN:{target:"#approving",actions:[S({pendingGuest:({event:e})=>({id:e.connectionId,name:e.peerName,answer:e.answer,connection:e.connection})})]},GAME_STARTED:{target:".game",actions:"setGameStarted"},GAME_RESET:{target:".waiting",actions:"resetGameStarted"},RESET_GAME:{target:".waiting",actions:["resetGameStarted","broadcastResetGame"]},CANCEL_SIGNALING:{actions:"removeConnection"}}}}},{actions:{setGameStarted:S({isGameStarted:!0,isGameFinished:!1}),resetGameStarted:S({isGameStarted:!1,isGameFinished:!1,ledger:[]}),setPlayerStatus:S(({context:e,event:t})=>{if(t.type!=="SET_PLAYER_STATUS")return e;const n=new Map(e.playerStatuses);return n.set(t.playerId,t.status),{playerStatuses:n}}),updateConnectionStatus:S(({context:e,event:t})=>{if(t.type!=="PEER_DISCONNECTED")return e;const n=new Map(e.connections),a=n.get(t.connectionId);return a&&(a.status=E.closed),{connections:n}}),updateConnection:S(({context:e,event:t})=>{if(t.type!=="UPDATE_CONNECTION")return e;const n=t.connection;if(n.status===E.closed&&!e.connections.has(n.id))return e;const a=e.connections.get(n.id);if(a){const d=a._lastKnownStatus!==n.status,y=a._lastKnownSignal!==(n.signal?.toString()||"");if(!d&&!y)return e}n._lastKnownStatus=n.status,n._lastKnownSignal=n.signal?.toString()||"";const c=new Map(e.connections);c.set(n.id,n);const i=new Map(e.playerStatuses);return i.has(n.id)||i.set(n.id,"lobby"),{connections:c,playerStatuses:i}}),syncConnection:({context:e,event:t})=>{if(t.type!=="UPDATE_CONNECTION")return;const n=t.connection;if(e.isInitiator&&n.status===E.connected){if(n._synced)return;n._synced=!0,r.lobby("STATE",`Syncing new connection: ${n.id}`),n.send(JSON.stringify(J("SYNC_LEDGER",e.ledger))),e.isGameStarted&&n.send(JSON.stringify(J("GAME_STARTED")))}},removeConnection:S(({context:e,event:t})=>{if(t.type!=="PEER_DISCONNECTED")return e;const n=new Map(e.connections);return n.delete(t.connectionId),{connections:n}}),removePlayer:S(({context:e,event:t})=>{if(t.type!=="REMOVE_PLAYER")return e;const n=new Map(e.connections),a=n.get(t.playerId);a&&(a.close(),n.delete(t.playerId));const c=new Map(e.playerStatuses);return c.delete(t.playerId),{connections:n,playerStatuses:c}}),syncLedger:S(({context:e,event:t})=>t.type!=="SYNC_LEDGER"?e:{ledger:t.ledger}),broadcastStartGame:({context:e})=>{e.isInitiator&&e.connections.forEach(t=>{t.status===E.connected&&t.send(JSON.stringify(J("START_GAME")))})},broadcastResetGame:({context:e})=>{e.isInitiator&&e.connections.forEach(t=>{t.status===E.connected&&t.send(JSON.stringify(J("GAME_RESET")))})},closeAllConnections:({context:e})=>{e.connections.forEach(t=>t.close())},acceptGuest:({context:e})=>{e.pendingGuest&&(r.sig("Accepting guest:",e.pendingGuest.name),e.pendingGuest.connection.acceptAnswer(e.pendingGuest.answer))},rejectGuest:({context:e})=>{e.pendingGuest&&(r.sig("Rejecting guest:",e.pendingGuest.name),e.pendingGuest.connection.close())},resetContext:S({connections:new Map,playerStatuses:new Map,ledger:[],isGameStarted:!1,isGameFinished:!1,isInitiator:!1,maxPlayers:2,pendingGuest:null,externalParticipants:[],boardId:void 0}),clearPendingGuest:S({pendingGuest:null})},guards:{hasConnections:({context:e})=>Array.from(e.connections.values()).some(t=>t.status===E.connected)}});class qe{socket=null;onMessageCallback;gameId;boardId;peerName;publicKey=null;constructor(t,n,a,c){this.gameId=t,this.boardId=n||"",this.peerName=a,this.onMessageCallback=c}updateBoardId(t){r.sig(`Updating signaling boardId from ${this.boardId} to ${t}`),this.boardId=t}async connect(t,n,a){let c="wss://pebsg4v5yk.execute-api.eu-central-1.amazonaws.com/production";const i=new URLSearchParams;i.append("x-api-key",t),n&&(i.append("x-pubkey",n),this.publicKey=n),a&&i.append("x-sig",a);const d=`${c}?${i.toString()}`;return new Promise((y,G)=>{r.sig(`Connecting to signaling server: ${d}`),this.socket=new WebSocket(d),this.socket.onopen=()=>{r.sig("WebSocket Connection Open."),y()},this.socket.onmessage=I=>{r.sig("Raw message from server:",I.data);try{const b=JSON.parse(I.data);this.onMessageCallback(b)}catch(b){r.error("Failed to parse signaling message",b)}},this.socket.onclose=I=>{r.sig("Disconnected from signaling server",I.code,I.reason),this.socket=null},this.socket.onerror=I=>{r.error("Signaling WebSocket error:",I),G(I)}})}sendOffer(t,n,a,c){return r.sig("Broadcasting combined offer for game:",this.gameId,"board:",a,"slots:",t.length),this.send({type:"offer",slots:t,gameId:this.gameId,boardId:a,peerName:c,publicKey:this.publicKey||void 0})}requestOffers(){return r.sig("Requesting active offers for game:",this.gameId),this.send({type:"listOffers",gameId:this.gameId})}sendAnswer(t,n,a,c){return r.sig("Sending answer to host:",t,"for P2P slot:",n),this.send({type:"answer",target:t,to:n,answer:a,peerName:this.peerName,publicKey:this.publicKey||void 0,boardId:c||this.boardId})}deleteOffer(){if(!this.socket||this.socket.readyState!==WebSocket.OPEN){r.sig("Cannot delete offer: Signaling socket is not open.");return}r.sig("Deleting offer for game:",this.gameId,"board:",this.boardId),this.send({type:"deleteOffer",gameId:this.gameId,...this.boardId?{boardId:this.boardId}:{}})}send(t){if(!this.socket||this.socket.readyState!==WebSocket.OPEN)return r.error("Signaling socket not open. State:",this.socket?.readyState),!1;const n={action:"sendMessage",...t};return r.sig("Sending payload to AWS:",n),this.socket.send(JSON.stringify(n)),!0}disconnect(t=!1){t&&this.isConnected&&this.deleteOffer(),this.socket?.close(),this.socket=null}get isConnected(){return!!this.socket&&this.socket.readyState===WebSocket.OPEN}}const{Ledger:Qe,createLobbyMessage:H,isLobbyMessage:ze}=await B("@mykoboard/integration"),M=O(null),se=O(!0),T=O(null),Y=O(!1),p=O(null),ie=O([]),W=O([]);function ot(){const e=Te(),t=Ae(),n=w(()=>e.params.gameId),a=w(()=>e.params.boardId),c=w(()=>Re(n.value||"")),{snapshot:i,send:d}=$e(We,{input:{playerName:M.value?.name||"Anonymous"},inspect:s=>{if(s.type==="@xstate.event"&&r.lobby("EVENT",s.event.type,s.event),s.type==="@xstate.snapshot"&&s.snapshot.status==="active"){const o=s.snapshot.value;r.lobby("STATE",JSON.stringify(o))}}}),y=w(()=>i.value.context.isInitiator),G=w(()=>i.value.context.isGameStarted),I=w(()=>i.value.context.connections),b=w(()=>Array.from(I.value.values())),_=w(()=>b.value.filter(s=>s.status===E.connected)),$=w(()=>b.value.filter(s=>s.status!==E.connected&&s.status!==E.closed)),oe=w(()=>i.value.matches("room")),re=w(()=>i.value.matches("selection")||i.value.matches("discovery")?"lobby":"game");(async()=>{if(M.value)return;const s=x.getInstance();M.value=await s.getIdentity(),se.value=!1})();const z=new Map,X=new Map,A=s=>{const o=z.get(s.id),g=s.signal?.toString()||"",h=X.get(s.id);o===s.status&&h===g||(z.set(s.id,s.status),X.set(s.id,g),d({type:"UPDATE_CONNECTION",connection:s}),s._hasListener||(s.addMessageListener(f=>{try{const u=JSON.parse(f);if(!ze(u))return;if(u.type==="START_GAME"&&d({type:"START_GAME"}),u.type==="GAME_STARTED"&&d({type:"GAME_STARTED"}),u.type==="GAME_RESET"&&d({type:"GAME_RESET"}),u.type==="NEW_BOARD"&&t.replace(`/games/${n.value}/${u.payload}`),u.type==="SYNC_PLAYER_STATUS"&&d({type:"SET_PLAYER_STATUS",playerId:s.id,status:u.payload}),u.type==="SYNC_PARTICIPANTS"&&d({type:"SYNC_PARTICIPANTS",participants:u.payload}),u.type==="SYNC_LEDGER"){const C=u.payload;for(const l of C)l.signature&&l.signerPublicKey&&x.verify(l.action,l.signature,l.signerPublicKey).then(N=>{N||r.error("Invalid signature in ledger entry",l)});d({type:"SYNC_LEDGER",ledger:u.payload})}}catch{}}),s._hasListener=!0))};Ge(()=>{y.value&&p.value&&p.value.deleteOffer()}),window.addEventListener("beforeunload",()=>{y.value&&p.value&&a.value&&p.value.deleteOffer()});const ce=(s=2)=>{const o=i.value.matches("selection")||i.value.matches("discovery");if(o){const h=q();t.replace(`/games/${n.value}/${h}`),d({type:"HOST",maxPlayers:s,boardId:h})}const g=()=>{const h=new D(A);h.onClose=()=>d({type:"PEER_DISCONNECTED",connectionId:h.id}),h.openDataChannel(),h.prepareOfferSignal(i.value.context.playerName)};if(o)for(let h=0;h<s-1;h++)g();else g()},le=()=>{T.value==="server"&&p.value&&y.value&&p.value.deleteOffer(),d({type:"START_GAME"})},Z=w(()=>{const s=W.value.find(l=>l.boardId===a.value),o=s?.participants||[],g=i.value.context.externalParticipants||[],h=o.find(l=>l.isYou),f={id:M.value?.id||"local",name:i.value.context.playerName,status:G.value?"game":"lobby",isConnected:!0,isLocal:!0,isHost:h?h.isHost:y.value},u=[],C=new Set;if(y.value)u.push(f),C.add(f.id);else if(g.length>0){const l=g.find(N=>N.isHost);if(l){const N=b.value.find(m=>m.status===E.connected);u.push({id:l.id,name:l.name,status:(N?i.value.context.playerStatuses.get(N.id):null)||(G.value?"game":"lobby"),isConnected:!!N,isLocal:!1,isHost:!0}),C.add(l.id)}}return y.value?b.value.forEach(l=>{if(!C.has(l.id)){const N=o.find(m=>m.id===l.id);u.push({id:l.id,name:l.remotePlayerName||N?.name||"Anonymous",status:i.value.context.playerStatuses.get(l.id)||"lobby",isConnected:l.status===E.connected,isLocal:!1,isHost:!1}),C.add(l.id)}}):g.length>0&&g.forEach(l=>{l.isHost||l.id==="local"||(l.name===f.name&&!C.has(l.id)?(u.push({...f,id:l.id}),C.add(l.id)):(u.push({id:l.id,name:l.name,status:G.value?"game":"lobby",isConnected:!0,isLocal:!1,isHost:!1}),C.add(l.id)))}),o.forEach(l=>{!l.isYou&&!C.has(l.id)&&u.push({id:l.id,name:l.name,status:s?.status==="finished"||G.value?"game":"lobby",isConnected:!1,isLocal:!1,isHost:l.isHost})}),u}),de=()=>{d({type:"JOIN"});const s=new D(A);s.onClose=()=>d({type:"PEER_DISCONNECTED",connectionId:s.id}),s.status=E.readyToAccept,s.setDataChannelCallback(),A(s)},ue=async(s,o)=>{if(!(!(s instanceof D)||!o))try{await s.acceptOffer(o,i.value.context.playerName)}catch(g){r.error("Failed to accept offer",g)}},ge=(s,o)=>{if(!(!(s instanceof D)||!o))try{s.acceptAnswer(o),A(s)}catch(g){r.error("Failed to accept answer",g)}},he=()=>{d({type:"FINISH_GAME"}),a.value&&P.updateStatus(a.value,"finished")},pe=async s=>{if(!y.value)return;const o=x.getInstance(),g=await o.getIdentity();if(!g)return;const h=await o.sign(s),f=Qe.fromEntries(i.value.context.ledger),u=await f.addEntry({...s});u.signature=h,u.signerPublicKey=g.publicKey;const C=f.getEntries();d({type:"SYNC_LEDGER",ledger:C}),_.value.forEach(l=>{l.send(JSON.stringify(H("SYNC_LEDGER",C)))})},fe=async(s,o)=>{d({type:"JOIN"});const g=new D(A);g.setDataChannelCallback(),await g.acceptOffer(o.offer,i.value.context.playerName);const h=setInterval(()=>{if(g.signal){const f=s.sessionBoardId||s.boardId||a.value;f&&p.value?.updateBoardId(f),p.value?.sendAnswer(s.connectionId,o.connectionId,g.signal,f),clearInterval(h),!a.value&&f&&t.replace(`/games/${n.value}/${f}`)}},500)},ye=()=>{const s=q();_.value.forEach(o=>{o.status===E.connected&&o.send(JSON.stringify(H("NEW_BOARD",s)))}),p.value?.deleteOffer(),d({type:"CLOSE_SESSION"}),d({type:"HOST"}),t.push(`/games/${n.value}/${s}`)},me=async s=>{await P.removeSession(s),W.value=await P.getSessions()},Se=()=>{const s=i.value.context.pendingGuest;d({type:"ACCEPT_GUEST"}),s&&A(s.connection)},ve=()=>d({type:"REJECT_GUEST"}),Ce=s=>{s.close(),d({type:"CANCEL_SIGNALING",connectionId:s.id})},Ee=()=>{p.value?.deleteOffer(),d({type:"CLOSE_SESSION"}),t.push(`/games/${n.value}`)},Ie=()=>{d({type:"BACK_TO_LOBBY"}),T.value==="server"&&p.value?.requestOffers(),t.push(`/games/${n.value}`)};let V=null;const ee=O("");L([y,T,p,a,_,$],()=>{!y.value||T.value!=="server"||!p.value||!a.value||(V&&clearTimeout(V),V=setTimeout(()=>{const s=[..._.value.map(o=>({connectionId:o.id,offer:o.signal,status:"taken",peerName:o.remotePlayerName})),...$.value.filter(o=>o.signal).map(o=>({connectionId:o.id,offer:o.signal,status:"open"}))];if(s.length>0){const o=JSON.stringify(s),g=`${a.value}:${o}`;g!==ee.value&&p.value?.sendOffer(s,n.value,a.value,i.value.context.playerName)&&(ee.value=g)}},500))}),Oe(()=>{oe.value&&n.value&&a.value&&a.value!=="manual"&&P.saveSession({gameId:n.value,boardId:a.value,playerName:i.value.context.playerName,gameName:c.value?.name||"Unknown Game",lastPlayed:Date.now(),status:i.value.matches("room.finished")?"finished":"active",ledger:i.value.context.ledger,participants:Z.value.map(s=>({id:s.id,name:s.name,isYou:s.isLocal,isHost:s.isHost}))})});const F=O();return L([T,i,a],async()=>{const s=i.value.matches("hosting")||i.value.matches("discovery")||i.value.matches("joining")||i.value.matches("approving"),o=i.value.matches("room")&&y.value,g=T.value==="server"&&(s||o),h=a.value||n.value||"";if(g){if(F.value!==h&&p.value?.isConnected&&(p.value.updateBoardId(h),F.value=h),(!p.value||!p.value.isConnected)&&!Y.value){Y.value=!0;try{const f=x.getInstance(),u=await f.getIdentity();if(u){const C=new qe(n.value||"default",h,u.name,m=>{if(m.type==="offerList"&&(ie.value=m.offers||[]),m.type==="error"&&(r.error("Signaling error:",m.message),_e.error(m.message||"Signaling error occurred",{description:m.code==="DUPLICATE_IDENTITY"?"You are already in this game session.":void 0})),m.type==="answer"){const U=m.to?b.value.find(K=>K.id===m.to):b.value.find(K=>K.status===E.started);U&&(T.value==="server"?d({type:"REQUEST_JOIN",connectionId:m.from,peerName:m.peerName||"Anonymous Guest",answer:m.answer,connection:U}):(U.acceptAnswer(m.answer),A(U)))}}),l=`SIGN_IN:${u.subscriptionToken}`,N=await f.sign(l);await C.connect(u.subscriptionToken,u.publicKey,N),p.value=C,F.value=h}}catch(f){r.error("Signaling connection failed",f)}finally{Y.value=!1}}}else p.value&&(p.value.disconnect(y.value),p.value=null)}),L(a,async s=>{if(s&&s!=="manual"&&(i.value.matches("selection")||i.value.matches("discovery"))){const o=await P.getSession(s);o&&o.ledger.length>0&&i.value.context.ledger.length===0&&(d({type:"LOAD_LEDGER",ledger:o.ledger}),d({type:"RESUME"}),o.status==="finished"&&setTimeout(()=>d({type:"FINISH_GAME"}),10))}},{immediate:!0}),L([i,T,p],()=>{T.value==="server"&&p.value&&(i.value.matches("discovery")||i.value.matches("selection"))&&p.value.requestOffers()}),L(_,s=>{s.forEach(o=>{o._hasInitialSync||(o.send(JSON.stringify(H("SYNC_PLAYER_STATUS",re.value))),y.value&&a.value&&a.value!=="manual"&&o.send(JSON.stringify(H("NEW_BOARD",a.value))),o._hasInitialSync=!0)})}),{identity:M,isLoading:se,snapshot:i,send:d,signalingMode:T,isServerConnecting:Y,signalingClient:p,availableOffers:ie,activeSessions:W,playerInfos:Z,connectedPeers:_,pendingSignaling:$,isInitiator:y,isGameStarted:G,onHostAGame:ce,startGame:le,connectWithOffer:de,updateOffer:ue,updateAnswer:ge,onFinishGame:he,onAddLedger:pe,onJoinFromList:fe,handlePlayAgain:ye,onDeleteSession:me,onAcceptGuest:Se,onRejectGuest:ve,onCancelSignaling:Ce,onBackToGames:Ee,onBackToDiscovery:Ie}}export{E as C,at as G,st as L,it as U,ot as u};
