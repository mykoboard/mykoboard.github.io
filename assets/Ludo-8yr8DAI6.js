import{i as N}from"./_virtual___federation_fn_import-Dj-Htcye.js";import{j as l,C as B,B as W,e as D,f as O}from"./network-BBmbdp0D.js";const{createMachine:Y,assign:b}=await N("xstate"),T={yellow:40,green:1,blue:27,red:14},C=e=>{const r=[];return e.forEach(n=>{for(let t=0;t<4;t++)r.push({id:`${n.color}-${t}`,color:n.color,status:"base",position:0})}),r},R=e=>{const r={...e},n=[1,9,14,22,27,35,40,48],t=T[r.color];if(r.status==="track"){const s=(t+51)%52;if(r.position===s)r.status="homePath",r.position=0;else{let a=(r.position+1)%52;for(;n.includes(a)&&a!==t;)a=(a+1)%52;r.position=a}}else if(r.status==="homePath"){const s=r.position+1;s<5?r.position=s:(r.status="finished",r.position=0)}return r},F=(e,r)=>{let n={...r};for(;n.status!=="finished"&&e.some(s=>s.id!==n.id&&s.color===n.color&&s.status===n.status&&s.position===n.position);)n=R(n);return n},V=(e,r,n)=>{let t=[...e];const s=t.findIndex(c=>c.id===r);if(s===-1)return e;let a={...t[s]};if(a.status==="base")n===6&&(a.status="track",a.position=T[a.color]);else{const c=n;for(let o=0;o<c&&(a=R(a),a.status!=="finished");o++);}if(a.status!=="finished"&&a.status!=="base"&&(a=F(t,a)),a.status==="track"){const c=a.position;[1,9,14,22,27,35,40,48].includes(c)||(t=t.map(i=>i.color!==a.color&&i.status==="track"&&i.position===c?{...i,status:"base",position:0}:i))}return t[s]=a,t},G=Y({types:{},id:"ludo",initial:"waitingForPlayers",context:{players:[],currentPlayerIndex:0,pieces:[],diceValue:null,isInitiator:!1,winners:[],rollsInTurn:0,lastRoll:null},states:{waitingForPlayers:{on:{SYNC_STATE:{target:"rolling",actions:"syncState"}}},rolling:{always:[{target:"moving",guard:({context:e})=>e.diceValue!==null}],on:{ROLL_DICE:{target:"moving",actions:b({diceValue:({event:e})=>e.value,lastRoll:({event:e})=>e.value,rollsInTurn:({context:e})=>e.rollsInTurn+1})}}},moving:{always:[{target:"rolling",guard:({context:e})=>e.diceValue===null},{target:"rolling",guard:({context:e})=>{const r=e.players[e.currentPlayerIndex],t=e.pieces.filter(a=>a.color===r.color).every(a=>a.status==="base"||a.status==="finished");return E(e.pieces,r.color,e.diceValue).length===0&&t&&e.rollsInTurn<2&&e.diceValue!==6},actions:b({diceValue:()=>null})},{target:"nextTurn",guard:({context:e})=>e.diceValue===null?!1:E(e.pieces,e.players[e.currentPlayerIndex].color,e.diceValue).length===0}],on:{MOVE_PIECE:{target:"checkingResult",actions:"movePiece"}}},checkingResult:{always:[{target:"won",guard:"checkWin"},{target:"rolling",guard:"isRollSix",actions:b({diceValue:()=>null})},{target:"nextTurn"}]},nextTurn:{always:{target:"rolling",actions:"incrementTurn"}},won:{on:{RESET:{target:"rolling",actions:"resetGame"}}}},on:{SYNC_STATE:{actions:"syncState"}}},{actions:{syncState:b(({event:e})=>e.type!=="SYNC_STATE"?{}:e.context),movePiece:b(({context:e,event:r})=>{if(r.type!=="MOVE_PIECE")return{};const{pieceId:n}=r,t=e.diceValue;return{pieces:V(e.pieces,n,t)}}),incrementTurn:b(({context:e})=>{let r=(e.currentPlayerIndex+1)%e.players.length;for(let n=0;n<e.players.length;n++){const t=e.players[r];if(e.pieces.filter(a=>a.color===t.color).every(a=>a.status==="finished"))r=(r+1)%e.players.length;else break}return{currentPlayerIndex:r,diceValue:null,rollsInTurn:0}}),resetGame:b(({context:e})=>({pieces:C(e.players),currentPlayerIndex:0,diceValue:null,winners:[],rollsInTurn:0,lastRoll:null})),resetDice:b({diceValue:()=>null})},guards:{checkWin:({context:e})=>{const r=e.players[e.currentPlayerIndex].color;return e.pieces.filter(t=>t.color===r).every(t=>t.status==="finished")},isRollSix:({context:e})=>e.diceValue===6}});function Q(e,r){let n=C(e),t=0,s=null,a=null,c=0;return r.forEach(o=>{const{type:i,payload:g}=o.action;if(i==="ROLL_DICE"){s=g.value,a=g.value,c++;const f=e[t],p=n.filter(d=>d.color===f.color).every(d=>d.status==="base"||d.status==="finished"),m=E(n,f.color,s);if(m.length===0&&p&&c<2&&s!==6)s=null;else if(m.length===0){t=(t+1)%e.length;for(let d=0;d<e.length;d++){const h=e[t];if(n.filter(j=>j.color===h.color).every(j=>j.status==="finished"))t=(t+1)%e.length;else break}s=null,c=0}}else if(i==="MOVE_PIECE"){const f=g.pieceId;if(n.findIndex(p=>p.id===f)!==-1&&s!==null){if(n=V(n,f,s),s!==6){t=(t+1)%e.length;for(let p=0;p<e.length;p++){const m=e[t];if(n.filter(h=>h.color===m.color).every(h=>h.status==="finished"))t=(t+1)%e.length;else break}c=0}s=null}}}),{pieces:n,currentPlayerIndex:t,diceValue:s,players:e,rollsInTurn:c,lastRoll:a}}const E=(e,r,n)=>e.filter(t=>{if(t.color!==r||t.status==="finished")return!1;if(t.status==="base"){const s=T[r],a=e.some(c=>c.color===r&&c.status==="track"&&c.position===s);return n===6&&!a}return t.status==="homePath"?t.position+n<=5:!0}),{useEffect:_,useMemo:L}=await N("react"),{useMachine:U}=await N("@xstate/react"),y={yellow:"#facc15",green:"#22c55e",blue:"#3b82f6",red:"#ef4444"};function K({connections:e,playerNames:r,playerInfos:n,isInitiator:t,ledger:s,onAddLedger:a,onFinishGame:c}){const o=L(()=>n.slice(0,4).map((x,u)=>({id:x.isLocal?"local":x.id,name:x.name,color:["yellow","green","red","blue"][u]})),[n]),[i,g]=U(G,{input:{isInitiator:t}}),{pieces:f,currentPlayerIndex:k,diceValue:p,lastRoll:m}=i.context,d=o[k],h=d?.id==="local";_(()=>{i.matches("waitingForPlayers")&&o.length>=2&&g({type:"SYNC_STATE",context:{players:o,pieces:C(o),currentPlayerIndex:0}})},[o,g,i.value]),_(()=>{const x=u=>{try{const P=JSON.parse(u);if(!D(P))return;if(t)if(P.type==="ROLL_DICE_REQUEST"){const w=Math.floor(Math.random()*6)+1;a?.({type:"ROLL_DICE",payload:{value:w}})}else P.type==="MOVE_PIECE_REQUEST"&&a?.({type:"MOVE_PIECE",payload:{pieceId:P.payload.pieceId}})}catch{}};return e.forEach(u=>u.addMessageListener(x)),()=>e.forEach(u=>u.removeMessageListener(x))},[e,t,a]),_(()=>{if(!s||o.length<2)return;const x=Q(o,s);g({type:"SYNC_STATE",context:x})},[s,o,g]);const $=()=>{if(!(!h||!i.matches("rolling")||p!==null))if(t){const x=Math.floor(Math.random()*6)+1;a?.({type:"ROLL_DICE",payload:{value:x}})}else e.forEach(x=>x.send(JSON.stringify(O("ROLL_DICE_REQUEST"))))},j=x=>{if(!h||!i.matches("moving"))return;const u=f.find(w=>w.id===x);!u||u.color!==d.color||!E(f,u.color,p).find(w=>w.id===x)||(t?a?.({type:"MOVE_PIECE",payload:{pieceId:x}}):e.forEach(w=>w.send(JSON.stringify(O("MOVE_PIECE_REQUEST",{pieceId:x})))))},v=600,M=v/15;return l.jsxs(B,{className:"p-8 flex flex-col items-center space-y-6 bg-slate-50 border-0 shadow-none rounded-[40px] max-w-4xl mx-auto overflow-hidden",children:[l.jsxs("div",{className:"flex justify-between w-full items-center mb-4",children:[l.jsxs("div",{className:"flex flex-col",children:[l.jsx("h2",{className:"text-4xl font-black text-slate-800 tracking-tight",children:"Ludo"}),l.jsx("p",{className:"text-xs font-bold text-slate-400 uppercase tracking-widest mt-1",children:"Multiplayer Board Engine"})]}),l.jsx("div",{className:"flex items-center gap-3",children:o.map((x,u)=>l.jsxs("div",{className:`flex items-center space-x-2 px-4 py-2 rounded-2xl transition-all duration-500 ${u===k?"bg-white shadow-[0_8px_30px_rgb(0,0,0,0.04)] ring-2 ring-primary/10":"opacity-40 grayscale"}`,children:[l.jsx("div",{className:"w-4 h-4 rounded-full",style:{backgroundColor:y[x.color]}}),l.jsxs("span",{className:"text-sm font-black text-slate-700",children:[x.name," ",x.id==="local"&&"(You)"]})]},x.id))})]}),l.jsxs("div",{className:"relative p-6 bg-white rounded-[48px] shadow-[0_20px_50px_rgba(0,0,0,0.05)] ring-1 ring-slate-100",children:[l.jsxs("svg",{width:v,height:v,viewBox:`0 0 ${v} ${v}`,className:"rounded-2xl transition-all duration-500",children:[l.jsx(J,{cellSize:M}),f.map(x=>l.jsx(X,{piece:x,cellSize:M,onClick:()=>j(x.id),isMovable:h&&i.matches("moving")&&x.color===d?.color&&E(f,x.color,p).some(u=>u.id===x.id)},x.id))]}),l.jsx("div",{className:"absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2",children:m&&l.jsx("div",{className:"bg-white rounded-3xl p-6 shadow-2xl border-4 border-slate-50 animate-in zoom-in duration-300",children:l.jsx("span",{className:"text-6xl font-black text-slate-800 tabular-nums",children:m})})})]}),l.jsxs("div",{className:"w-full flex justify-between items-center bg-white p-6 rounded-[32px] shadow-[0_10px_30px_rgba(0,0,0,0.03)]",children:[l.jsxs("div",{className:"flex flex-col",children:[l.jsx("p",{className:"text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1",children:"Current Move"}),l.jsx("p",{className:"font-black text-xl text-slate-800",children:i.matches("rolling")?h?"Roll the dice":`${d?.name}'s turn`:i.matches("moving")?h?"Move your piece":`${d?.name} is moving...`:"Game Finished"})]}),l.jsxs("div",{className:"flex items-center gap-6",children:[l.jsxs("div",{className:"flex flex-col items-end",children:[l.jsx("p",{className:"text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1",children:"Result"}),l.jsx("div",{className:"w-12 h-12 rounded-2xl bg-slate-50 flex items-center justify-center font-black text-2xl text-slate-800",children:m||"-"})]}),l.jsx(W,{size:"lg",onClick:$,disabled:!h||!i.matches("rolling"),className:"h-16 px-12 text-xl font-black rounded-2xl shadow-xl hover:shadow-2xl transition-all duration-300 enabled:hover:scale-[1.02] active:scale-95 bg-slate-900 text-white border-0",children:"Roll Dice ðŸŽ²"})]})]})]})}const q=({cx:e,cy:r,r:n,fill:t,stroke:s})=>{const a=[];for(let c=0;c<10;c++){const o=c%2===0?n:n*.45,i=(c*36-90)*(Math.PI/180);a.push(`${e+o*Math.cos(i)},${r+o*Math.sin(i)}`)}return l.jsx("polygon",{points:a.join(" "),fill:t,stroke:s,strokeWidth:"1"})};function J({cellSize:e}){const r=(t,s,a,c)=>l.jsxs("g",{children:[l.jsx("rect",{x:t*e,y:s*e,width:e,height:e,fill:a?y[a]:"white",stroke:"#f1f5f9",strokeWidth:"1"}),c&&l.jsx(q,{cx:t*e+e/2,cy:s*e+e/2,r:e*.35,fill:"white"})]},`${t}-${s}`),n=[];for(let t=0;t<15;t++)for(let s=0;s<15;s++){const a=t<6&&s<6||t>8&&s<6||t>8&&s>8||t<6&&s>8,c=t>=6&&t<=8&&s>=6&&s<=8;if(!a&&!c){let o,i=!1;t===1&&s===7&&(o="yellow"),t===7&&s===1&&(o="green"),t===13&&s===7&&(o="red"),t===7&&s===13&&(o="blue"),t>0&&t<6&&s===7&&(o="yellow"),t===7&&s>0&&s<6&&(o="green"),t>8&&t<14&&s===7&&(o="red"),t===7&&s>8&&s<14&&(o="blue"),t===1&&s===6&&(o="yellow"),t===8&&s===1&&(o="green"),t===13&&s===8&&(o="red"),t===6&&s===13&&(o="blue"),(t===1&&s===6||t===8&&s===1||t===13&&s===8||t===6&&s===13)&&(i=!0),n.push(r(t,s,o,i))}}return l.jsxs("g",{children:[l.jsx("rect",{width:e*15,height:e*15,fill:"#f8fafc"}),l.jsx(I,{x:0,y:0,color:"yellow",size:6*e}),l.jsx(I,{x:9*e,y:0,color:"green",size:6*e}),l.jsx(I,{x:9*e,y:9*e,color:"red",size:6*e}),l.jsx(I,{x:0,y:9*e,color:"blue",size:6*e}),n,l.jsxs("g",{transform:`translate(${6*e}, ${6*e})`,children:[l.jsx("polygon",{points:`0,0 ${3*e},0 ${1.5*e},1.5*cellSize`,fill:y.green}),l.jsx("polygon",{points:`${3*e},0 ${3*e},${3*e} ${1.5*e},1.5*cellSize`,fill:y.red}),l.jsx("polygon",{points:`${3*e},${3*e} 0,${3*e} ${1.5*e},1.5*cellSize`,fill:y.blue}),l.jsx("polygon",{points:`0,${3*e} 0,0 ${1.5*e},1.5*cellSize`,fill:y.yellow})]})]})}function I({x:e,y:r,color:n,size:t}){const s=t*.18;return l.jsxs("g",{transform:`translate(${e}, ${r})`,children:[l.jsx("rect",{width:t,height:t,fill:y[n],opacity:"0.1",rx:"24"}),l.jsx("rect",{x:t*.1,y:t*.1,width:t*.8,height:t*.8,fill:"white",rx:"16"}),l.jsx("circle",{cx:t*.3,cy:t*.3,r:s,fill:y[n],opacity:"0.2"}),l.jsx("circle",{cx:t*.7,cy:t*.3,r:s,fill:y[n],opacity:"0.2"}),l.jsx("circle",{cx:t*.3,cy:t*.7,r:s,fill:y[n],opacity:"0.2"}),l.jsx("circle",{cx:t*.7,cy:t*.7,r:s,fill:y[n],opacity:"0.2"})]})}function X({piece:e,cellSize:r,onClick:n,isMovable:t}){const s=L(()=>{if(e.status==="base"){const o=e.color==="yellow"||e.color==="blue"?0:9,i=e.color==="yellow"||e.color==="green"?0:9,g=e.id.endsWith("0")||e.id.endsWith("2")?1.8:4.2,f=e.id.endsWith("0")||e.id.endsWith("1")?1.8:4.2;return{x:(o+g)*r,y:(i+f)*r}}if(e.status==="track"){const i=[{x:8,y:0},{x:8,y:1},{x:8,y:2},{x:8,y:3},{x:8,y:4},{x:8,y:5},{x:9,y:6},{x:10,y:6},{x:11,y:6},{x:12,y:6},{x:13,y:6},{x:14,y:6},{x:14,y:7},{x:14,y:8},{x:13,y:8},{x:12,y:8},{x:11,y:8},{x:10,y:8},{x:9,y:8},{x:8,y:9},{x:8,y:10},{x:8,y:11},{x:8,y:12},{x:8,y:13},{x:8,y:14},{x:7,y:14},{x:6,y:14},{x:6,y:13},{x:6,y:12},{x:6,y:11},{x:6,y:10},{x:6,y:9},{x:5,y:8},{x:4,y:8},{x:3,y:8},{x:2,y:8},{x:1,y:8},{x:0,y:8},{x:0,y:7},{x:0,y:6},{x:1,y:6},{x:2,y:6},{x:3,y:6},{x:4,y:6},{x:5,y:6},{x:6,y:5},{x:6,y:4},{x:6,y:3},{x:6,y:2},{x:6,y:1},{x:6,y:0},{x:7,y:0}][e.position%52];return{x:(i.x+.5)*r,y:(i.y+.5)*r}}if(e.status==="homePath"){const i={green:[{x:7,y:1},{x:7,y:2},{x:7,y:3},{x:7,y:4},{x:7,y:5}],red:[{x:13,y:7},{x:12,y:7},{x:11,y:7},{x:10,y:7},{x:9,y:7}],blue:[{x:7,y:13},{x:7,y:12},{x:7,y:11},{x:7,y:10},{x:7,y:9}],yellow:[{x:1,y:7},{x:2,y:7},{x:3,y:7},{x:4,y:7},{x:5,y:7}]}[e.color][e.position];return{x:(i.x+.5)*r,y:(i.y+.5)*r}}const c={green:{x:7.5,y:6.8},red:{x:8.2,y:7.5},blue:{x:7.5,y:8.2},yellow:{x:6.8,y:7.5}}[e.color]||{x:7.5,y:7.5};return{x:c.x*r,y:c.y*r}},[e,r]);return l.jsxs("g",{onClick:n,transform:`translate(${s.x}, ${s.y})`,className:`cursor-pointer transition-all duration-500 ${t?"filter drop-shadow-[0_15px_15px_rgba(0,0,0,0.2)]":""}`,children:[l.jsx("circle",{r:r*.4,fill:y[e.color],stroke:"white",strokeWidth:"2.5"}),l.jsx("circle",{r:r*.18,fill:"white",fillOpacity:"0.4"}),t&&l.jsx("circle",{r:r*.48,fill:"none",stroke:y[e.color],strokeWidth:"2.5",strokeDasharray:"6 3",className:"animate-spin-slow",style:{transformOrigin:"center",transformBox:"fill-box"}})]})}export{K as default};
