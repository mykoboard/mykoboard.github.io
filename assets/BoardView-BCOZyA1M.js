import{c as te,v as $e,x as Y,y as yt,r as D,m as X,z as st,u as at,A as ft,i as C,s as xe,d as ne,a as h,h as E,f as l,b as s,e as m,j as G,F as ee,t as R,l as z,o as g,k as De,q as O,T as mt,p as bt,n as ue,B as vt,C as wt,D as it,E as xt,G as St,H as kt,g as ot}from"./index-BA_VjZQg.js";import{v as Me,a as rt}from"./GameRegistry-DJuJOaKc.js";import{i as re}from"./_virtual___federation_fn_import-PdSsH34n.js";import{S as Re,C as Se,T as je}from"./sessions-EXKGHhYn.js";import{d as pe,_ as Be,R as Je,A as Ue,k as He,O as Ve,V as Ye,F as ze,M as We,N as Qe,T as Xe}from"./db-CddmcO_S.js";const Ct=te("check",[["path",{d:"M20 6 9 17l-5-5",key:"1gmf2c"}]]);const Ze=te("clipboard",[["rect",{width:"8",height:"4",x:"8",y:"2",rx:"1",ry:"1",key:"tgr4d6"}],["path",{d:"M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2",key:"116196"}]]);const It=te("copy",[["rect",{width:"14",height:"14",x:"8",y:"8",rx:"2",ry:"2",key:"17jyea"}],["path",{d:"M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2",key:"zix9uf"}]]);const Et=te("link",[["path",{d:"M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71",key:"1cjeqo"}],["path",{d:"M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71",key:"19qd67"}]]);const At=te("log-in",[["path",{d:"m10 17 5-5-5-5",key:"1bsop3"}],["path",{d:"M15 12H3",key:"6jk70r"}],["path",{d:"M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4",key:"u53s6r"}]]);const _t=te("user-minus",[["path",{d:"M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2",key:"1yyitq"}],["circle",{cx:"9",cy:"7",r:"4",key:"nufk8"}],["line",{x1:"22",x2:"16",y1:"11",y2:"11",key:"1shjgl"}]]);const ke=te("user-plus",[["path",{d:"M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2",key:"1yyitq"}],["circle",{cx:"9",cy:"7",r:"4",key:"nufk8"}],["line",{x1:"19",x2:"19",y1:"8",y2:"14",key:"1bvyxn"}],["line",{x1:"22",x2:"16",y1:"11",y2:"11",key:"1shjgl"}]]),{createActor:Zs,toObserver:qs}=await re("xstate");function Nt(e,t){return e===t}const qe=()=>{};function Pt(e,t,n=Nt){const r=yt(e)?e:$e(e),a=$e(t(r.value?.getSnapshot())),b=w=>{n(a.value,w)||(a.value=w)};return Y(r,(w,y,x)=>{if(a.value=t(w?.getSnapshot()),!w)return;const u=w.subscribe({next:P=>{b(t(P))},error:qe,complete:qe});x(()=>u.unsubscribe())},{immediate:!0}),a}const oe=!1,Tt=()=>{const e={net:oe,state:oe,info:oe,error:!0,lobby:oe,sig:oe,webrtc:oe};try{const t=localStorage.getItem("debug_config");if(t)return{...e,...JSON.parse(t)}}catch{}return e},Gt=Tt(),d={shouldLog:e=>Gt[e],netIn:(e,t)=>{if(!d.shouldLog("net"))return;let n=t;try{n=JSON.parse(t)}catch{}console.log("%c[NET-IN] %cfrom %s:","color: #22c55e; font-weight: bold;","color: #64748b;",e.slice(0,8),n)},netOut:(e,t)=>{if(!d.shouldLog("net"))return;let n=t;try{n=JSON.parse(t)}catch{}console.log("%c[NET-OUT] %cto %s:","color: #3b82f6; font-weight: bold;","color: #64748b;",e.slice(0,8),n)},state:(e,t,n,r="state")=>{if(!d.shouldLog(r))return;console.log("%c[%s-%s] %c%s",`color: ${e==="EVENT"?"#f59e0b":"#10b981"}; font-weight: bold;`,r.toUpperCase(),e,"color: inherit;",t,n||"")},lobby:(e,t,n)=>{d.state(e,t,n,"lobby")},sig:(e,...t)=>{d.shouldLog("sig")&&console.log("%c[SIG] %c%s","color: #ec4899; font-weight: bold;","color: inherit;",e,...t)},webrtc:(e,...t)=>{d.shouldLog("webrtc")&&console.log("%c[WEBRTC] %c%s","color: #06b6d4; font-weight: bold;","color: inherit;",e,...t)},info:(...e)=>{d.shouldLog("info")&&console.log("%c[INFO]","color: #8b5cf6; font-weight: bold;",...e)},error:(...e)=>{d.shouldLog("error")&&console.error("%c[ERROR]","color: #ef4444; font-weight: bold;",...e)}};var L=(e=>(e.new="new",e.started="started",e.readyToAccept="readyToAccept",e.accepted="accepted",e.answered="answered",e.connected="established",e.closed="closed",e))(L||{});class le{id;peerConnection;localPlayerName;remotePlayerName;remotePublicKey;dataChannel;iceCandidates;status;signal;messageListeners=[];onClose;updateView;constructor(t){this.id=Me(),this.updateView=t,this.peerConnection=new RTCPeerConnection(Rt),this.iceCandidates=[];let n=null;this.peerConnection.onicecandidate=r=>{r.candidate&&(this.iceCandidates.push(r.candidate),(this.status==="started"||this.status==="answered")&&(this.updateSignal(),n&&clearTimeout(n),n=setTimeout(()=>{this.updateView(this),n=null},200)))},this.peerConnection.onconnectionstatechange=r=>{const a=this.peerConnection.connectionState;d.webrtc(this.id+": Connection state changed to "+a),a==="connected"?(this.status="established",this.updateView(this)):(a==="disconnected"||a==="failed"||a==="closed")&&this.close()}}updateSignal(t){this.peerConnection.localDescription&&(this.signal=new Z(this.id,this.peerConnection.localDescription,t||this.localPlayerName,this.iceCandidates))}openDataChannel(){this.dataChannel=this.peerConnection.createDataChannel("gameData"),this.dataChannel.onopen=t=>d.webrtc(this.id+" Data channel state is: "+this.dataChannel.readyState),this.dataChannel.onclose=t=>d.webrtc(this.id+" Data channel state is: "+this.dataChannel.readyState),this.dataChannel.onerror=t=>d.error(this.id+" Error ",t),this.dataChannel.onmessage=t=>{d.netIn(this.id,t.data),this.messageListeners.forEach(n=>n(t.data))}}setDataChannelCallback(){this.peerConnection.ondatachannel=t=>{d.webrtc("Receive Channel Callback",t),this.dataChannel=t.channel,this.dataChannel.onmessage=n=>{d.netIn(this.id,n.data),this.messageListeners.forEach(r=>r(n.data))},this.dataChannel.onopen=n=>{const r=this.dataChannel.readyState;d.webrtc(this.id+": Data channel state is: "+r),r=="open"&&(d.webrtc(this.id+": Sending ping"),this.send("Ping"))},this.dataChannel.onclose=n=>{const r=this.dataChannel.readyState;d.webrtc(this.id+": Data channel state is: "+r)}}}async prepareOfferSignal(t){console.log("[WebRTC] prepareOfferSignal - playerName:",t),this.localPlayerName=t,this.status="new";try{const n=await this.peerConnection.createOffer();await this.peerConnection.setLocalDescription(n),this.status="started",this.updateSignal(),this.updateView(this)}catch(n){this.onCreateSessionDescriptionError(n)}}async send(t){this.dataChannel&&this.dataChannel.readyState==="open"&&(d.netOut(this.id,t),await this.dataChannel.send(t))}addMessageListener(t){this.messageListeners.push(t)}removeMessageListener(t){this.messageListeners=this.messageListeners.filter(n=>n!==t)}async acceptOffer(t,n){const r=typeof t=="string"?Z.fromString(t):t;console.log("[WebRTC] acceptOffer - acceptingPlayerName:",n),this.remotePlayerName=r.playerName,this.localPlayerName=n,await this.peerConnection.setRemoteDescription(r.session),r.iceCandidates.forEach(a=>{this.peerConnection.addIceCandidate(a)});try{const a=await this.peerConnection.createAnswer();await this.peerConnection.setLocalDescription(a),this.status="answered",this.updateSignal(),this.updateView(this),this.updateView(this)}catch(a){this.onCreateSessionDescriptionError(a)}}onCreateSessionDescriptionError(t){d.error("Failed to create session description: "+t.toString())}async acceptAnswer(t){const n=typeof t=="string"?Z.fromString(t):t;d.webrtc(this.id+": Accepting answer signal from "+n.playerName),console.log("[WebRTC] acceptAnswer - Guest name:",n.playerName);try{await this.peerConnection.setRemoteDescription(n.session),this.remotePlayerName=n.playerName,n.iceCandidates&&(d.webrtc(this.id+`: Adding ${n.iceCandidates.length} ICE candidates from answer`),n.iceCandidates.forEach(r=>{this.peerConnection.addIceCandidate(r).catch(a=>d.error("Error adding ICE candidate:",a))})),this.updateView(this)}catch(r){d.error(this.id+": Failed to set remote description from answer",r)}}close(){this.dataChannel&&this.dataChannel.close(),this.peerConnection.close(),this.status="closed",this.onClose?.(),this.updateView(this)}}class Z{connectionId;session;playerName;iceCandidates;constructor(t,n,r,a){this.session=n,this.connectionId=t,this.playerName=r,this.iceCandidates=a}toString(){return btoa(JSON.stringify(this))}static fromString(t){const n=JSON.parse(atob(t));return new Z(n.connectionId,n.session,n.playerName,n.iceCandidates)}}const Rt={iceServers:[{urls:"stun:stun.l.google.com:19302"}]};class Lt{socket=null;onMessageCallback;gameId;boardId;peerName;publicKey=null;constructor(t,n,r,a){this.gameId=t,this.boardId=n||"",this.peerName=r,this.onMessageCallback=a}updateBoardId(t){d.sig(`Updating signaling boardId from ${this.boardId} to ${t}`),this.boardId=t}async connect(t,n,r){let a="wss://pebsg4v5yk.execute-api.eu-central-1.amazonaws.com/production";const b=new URLSearchParams;b.append("x-api-key",t),n&&(b.append("x-pubkey",n),this.publicKey=n),r&&b.append("x-sig",r);const w=`${a}?${b.toString()}`;return new Promise((y,x)=>{d.sig(`Connecting to signaling server: ${w}`),this.socket=new WebSocket(w),this.socket.onopen=()=>{d.sig("WebSocket Connection Open."),y()},this.socket.onmessage=u=>{d.sig("Raw message from server:",u.data);try{const P=JSON.parse(u.data);this.onMessageCallback(P)}catch(P){d.error("Failed to parse signaling message",P)}},this.socket.onclose=u=>{d.sig("Disconnected from signaling server",u.code,u.reason),this.socket=null},this.socket.onerror=u=>{d.error("Signaling WebSocket error:",u),x(u)}})}hostRegister(t,n,r,a){return d.sig("Registering as host for board:",t),this.send({type:"hostRegister",boardId:t,gameId:n,peerName:r,publicKey:a})}guestJoin(t,n,r,a){return d.sig("Joining as guest for board:",t),this.send({type:"guestJoin",boardId:t,peerName:n,publicKey:r,encryptionPublicKey:a})}hostOffer(t,n,r,a,b){return d.sig("Sending offer to guest:",t),this.send({type:"hostOffer",target:t,guestPublicKey:n,offer:r,peerName:this.peerName,publicKey:this.publicKey||void 0,encryptionPublicKey:a,iv:b,boardId:this.boardId})}guestAnswer(t,n,r,a){return d.sig("Sending answer to host:",t),this.send({type:"guestAnswer",target:t,publicKey:n,answer:r,peerName:this.peerName,iv:a,boardId:this.boardId})}deleteOffer(){if(!this.socket||this.socket.readyState!==WebSocket.OPEN){d.sig("Cannot delete offer: Signaling socket is not open.");return}d.sig("Deleting offer for game:",this.gameId,"board:",this.boardId),this.send({type:"deleteOffer",gameId:this.gameId,...this.boardId?{boardId:this.boardId}:{}})}send(t){if(!this.socket||this.socket.readyState!==WebSocket.OPEN)return d.error("Signaling socket not open. State:",this.socket?.readyState),!1;const n={action:"sendMessage",...t};return d.sig("Sending payload to AWS:",n),this.socket.send(JSON.stringify(n)),!0}disconnect(t=!1){t&&this.isConnected&&this.deleteOffer(),this.socket?.close(),this.socket=null}get isConnected(){return!!this.socket&&this.socket.readyState===WebSocket.OPEN}}const{createMachine:Ot,assign:Le}=await re("xstate"),Kt=Ot({types:{},id:"lobby",initial:"selection",context:({input:e})=>({playerName:e.playerName,signalingMode:null,playerCount:2}),states:{selection:{on:{SELECT_MODE:{target:"discovery",actions:Le({signalingMode:({event:e})=>e.mode})}}},discovery:{on:{GOTO_SELECTION:"selection",SET_PLAYER_COUNT:{actions:Le({playerCount:({event:e})=>e.count})},SELECT_MODE:{actions:Le({signalingMode:({event:e})=>e.mode})}}}}}),{createMachine:$t,assign:K}=await re("xstate"),{createLobbyMessage:we}=await re("@mykoboard/integration"),Dt=$t({types:{},id:"board",initial:"idle",context:({input:e})=>({connections:new Map,playerStatuses:new Map,isInitiator:e.isInitiator||!1,isGameStarted:!1,isGameFinished:!1,playerName:e.playerName,ledger:[],pendingGuest:null,externalParticipants:[],maxPlayers:e.maxPlayers||2,boardId:e.boardId||""}),states:{idle:{on:{HOST:{target:"hosting",actions:K({isInitiator:!0,maxPlayers:({event:e})=>e.maxPlayers||2,boardId:({event:e})=>e.boardId})},JOIN:{target:"joining",actions:K({isInitiator:!1,boardId:({event:e})=>e.boardId})}}},hosting:{on:{REQUEST_JOIN:{target:"approving",actions:K({pendingGuest:({event:e})=>({id:e.connectionId,name:e.peerName,answer:e.answer,connection:e.connection})})}},always:[{target:"preparation",guard:"hasConnections"}]},joining:{always:[{target:"preparation",guard:"hasConnections"}]},approving:{on:{ACCEPT_GUEST:{target:"preparation",actions:["acceptGuest","clearPendingGuest"]},REJECT_GUEST:{target:"hosting",actions:["rejectGuest","clearPendingGuest"]}}},preparation:{on:{START_GAME:{target:"playing",actions:["setGameStarted","broadcastStartGame"]},GAME_STARTED:{target:"playing",actions:"setGameStarted"},REQUEST_JOIN:{target:"approving",actions:K({pendingGuest:({event:e})=>({id:e.connectionId,name:e.peerName,answer:e.answer,connection:e.connection})})}}},playing:{on:{FINISH_GAME:{target:"finished",actions:K({isGameFinished:!0})}}},finished:{on:{RESET_GAME:{target:"preparation",actions:["resetGameStarted","broadcastResetGame"]}}}},on:{UPDATE_CONNECTION:{actions:["updateConnection","syncConnection"]},PEER_DISCONNECTED:{actions:["updateConnectionStatus","removeConnection"]},SET_PLAYER_STATUS:{actions:"setPlayerStatus"},REMOVE_PLAYER:{actions:"removePlayer"},SYNC_LEDGER:{actions:"syncLedger"},LOAD_LEDGER:{actions:K({ledger:({event:e})=>e.ledger})},SYNC_PARTICIPANTS:{actions:K({externalParticipants:({event:e})=>e.participants})},GAME_STARTED:{actions:"setGameStarted"},GAME_RESET:{actions:"resetGameStarted"},CLOSE_SESSION:{target:".idle",actions:["resetContext","closeAllConnections"]}}},{actions:{setGameStarted:K({isGameStarted:!0,isGameFinished:!1}),resetGameStarted:K({isGameStarted:!1,isGameFinished:!1,ledger:[]}),setPlayerStatus:K(({context:e,event:t})=>{if(t.type!=="SET_PLAYER_STATUS")return e;const n=new Map(e.playerStatuses);return n.set(t.playerId,t.status),{playerStatuses:n}}),updateConnectionStatus:K(({context:e,event:t})=>{if(t.type!=="PEER_DISCONNECTED")return e;const n=new Map(e.connections),r=n.get(t.connectionId);return r&&(r.status=L.closed),{connections:n}}),updateConnection:K(({context:e,event:t})=>{if(t.type!=="UPDATE_CONNECTION")return e;const n=t.connection;if(n.status===L.closed&&!e.connections.has(n.id))return e;const r=e.connections.get(n.id);if(r){const w=r._lastKnownStatus!==n.status,y=r._lastKnownSignal!==(n.signal?.toString()||"");if(!w&&!y)return e}n._lastKnownStatus=n.status,n._lastKnownSignal=n.signal?.toString()||"";const a=new Map(e.connections);a.set(n.id,n);const b=new Map(e.playerStatuses);return b.has(n.id)||b.set(n.id,"lobby"),{connections:a,playerStatuses:b}}),syncConnection:({context:e,event:t})=>{if(t.type!=="UPDATE_CONNECTION")return;const n=t.connection;if(e.isInitiator&&n.status===L.connected){if(n._synced)return;n._synced=!0,d.lobby("STATE",`Syncing new connection: ${n.id}`),n.send(JSON.stringify(we("SYNC_LEDGER",e.ledger))),e.isGameStarted&&n.send(JSON.stringify(we("GAME_STARTED")))}},removeConnection:K(({context:e,event:t})=>{if(t.type!=="PEER_DISCONNECTED")return e;const n=new Map(e.connections);return n.delete(t.connectionId),{connections:n}}),removePlayer:K(({context:e,event:t})=>{if(t.type!=="REMOVE_PLAYER")return e;const n=new Map(e.connections),r=n.get(t.playerId);r&&(r.close(),n.delete(t.playerId));const a=new Map(e.playerStatuses);return a.delete(t.playerId),{connections:n,playerStatuses:a}}),syncLedger:K(({context:e,event:t})=>t.type!=="SYNC_LEDGER"?e:{ledger:t.ledger}),broadcastStartGame:({context:e})=>{e.isInitiator&&e.connections.forEach(t=>{t.status===L.connected&&t.send(JSON.stringify(we("START_GAME")))})},broadcastResetGame:({context:e})=>{e.isInitiator&&e.connections.forEach(t=>{t.status===L.connected&&t.send(JSON.stringify(we("GAME_RESET")))})},closeAllConnections:({context:e})=>{e.connections.forEach(t=>t.close())},acceptGuest:({context:e})=>{e.pendingGuest&&(d.sig("Accepting guest:",e.pendingGuest.name),e.pendingGuest.connection.acceptAnswer(e.pendingGuest.answer))},rejectGuest:({context:e})=>{e.pendingGuest&&(d.sig("Rejecting guest:",e.pendingGuest.name),e.pendingGuest.connection.close())},resetContext:K(({context:e})=>({connections:new Map,playerStatuses:new Map,ledger:[],isGameStarted:!1,isGameFinished:!1,isInitiator:!1,maxPlayers:e.maxPlayers,pendingGuest:null,externalParticipants:[],boardId:""})),clearPendingGuest:K({pendingGuest:null})},guards:{hasConnections:({context:e})=>Array.from(e.connections.values()).some(t=>t.status===L.connected)}}),{createActor:ct}=await re("xstate"),H=D(null),lt=D(!0),et=D([]);ct(Kt,{input:{playerName:"Anonymous"}}).start();const Oe=new Map;function Ke(e,t,n=!1,r=2){if(!Oe.has(e)){d.lobby("STATE",`Creating new board actor for ${e}`);const a=ct(Dt,{input:{playerName:t,boardId:e,isInitiator:n,maxPlayers:r}});a.start(),Oe.set(e,a)}return Oe.get(e)}const Mt=async()=>{if(H.value)return;const e=X.getInstance();H.value=await e.getIdentity(),lt.value=!1};Mt();const{Ledger:Ft,createLobbyMessage:de,isLobbyMessage:tt}=await re("@mykoboard/integration");function jt(){const e=st(),t=at(),n=D(null),r=D(!1),a=D(""),b=D(!1),w=D([]),y=D(new Map),x=C(()=>e.params.gameId),u=C(()=>e.params.boardId),P=C(()=>rt(x.value||"")),U=C(()=>!!u.value),I=C(()=>!u.value||u.value==="manual"?null:Ke(u.value,H.value?.name||"Anonymous",!1)),A=Pt(I,i=>i),v=C(()=>A.value?.context?.isInitiator||!1),p=C(()=>A.value?.context?.isGameStarted||!1),S=C(()=>A.value?.context?.connections||new Map),W=C(()=>Array.from(S.value.values())),Q=C(()=>W.value.filter(i=>i.status===L.connected)),Ce=C(()=>W.value.filter(i=>i.status!==L.connected&&i.status!==L.closed)),Ie=C(()=>U.value?"game":"lobby"),se=C(()=>{if(!A.value)return[];const i=A.value.context,c=et.value.find(o=>o.boardId===u.value),f=c?.participants||[],_=i.externalParticipants||[],N=f.find(o=>o.isYou),J={id:H.value?.id||"local",name:i.playerName||H.value?.name||"Anonymous",status:p.value?"game":"lobby",isConnected:!0,isLocal:!0,isHost:N?N.isHost:v.value,publicKey:H.value?.publicKey},k=[],M=new Set;if(v.value)k.push(J),M.add(J.id);else if(_.length>0){const o=_.find(T=>T.isHost);if(o){const T=Q.value.find($=>$.status===L.connected);k.push({id:o.id,name:o.name,status:(T?i.playerStatuses.get(T.id):null)||(p.value?"game":"lobby"),isConnected:!!T,isLocal:!1,isHost:!0,publicKey:T?.remotePublicKey||o.publicKey}),M.add(o.id)}k.push(J),M.add(J.id)}return v.value?W.value.forEach(o=>{if(!M.has(o.id)){const T=f.find(F=>F.id===o.id),$=o.remotePublicKey||T?.publicKey;console.log("[playerInfos] Adding peer:",o.remotePlayerName,"remotePublicKey:",o.remotePublicKey?.substring(0,20),"publicKey:",$?.substring(0,20)),k.push({id:o.id,name:o.remotePlayerName||T?.name||"Anonymous",status:i.playerStatuses.get(o.id)||"lobby",isConnected:o.status===L.connected,isLocal:!1,isHost:!1,publicKey:$}),M.add(o.id)}}):_.length>0&&_.forEach(o=>{o.isHost||M.has(o.id)||o.id===J.id||o.id===H.value?.id||o.publicKey===H.value?.publicKey||(k.push({id:o.id,name:o.name,status:p.value?"game":"lobby",isConnected:!0,isLocal:!1,isHost:!1,publicKey:o.publicKey}),M.add(o.id))}),f.forEach(o=>{!o.isYou&&!M.has(o.id)&&k.push({id:o.id,name:o.name,status:c?.status==="finished"||p.value?"game":"lobby",isConnected:!1,isLocal:!1,isHost:o.isHost})}),k});ft(()=>{const i=A.value;i?.status==="active"&&u.value&&u.value!=="manual"&&Re.saveSession({gameId:x.value,boardId:u.value,playerName:i.context.playerName,gameName:P.value?.name||"Unknown Game",lastPlayed:Date.now(),status:i.matches("finished")?"finished":"active",ledger:i.context.ledger,participants:se.value.map(c=>({id:c.id,name:c.name,isYou:c.isLocal,isHost:c.isHost}))})});const ge=new Map,he=new Map,ae=i=>{const c=I.value;if(!c)return;const f=ge.get(i.id),_=i.signal?.toString()||"",N=he.get(i.id);f===i.status&&N===_||(ge.set(i.id,i.status),he.set(i.id,_),c.send({type:"UPDATE_CONNECTION",connection:i}),i._hasListener||(i.addMessageListener(J=>{try{const k=JSON.parse(J);if(!tt(k))return;if(k.type==="START_GAME"&&c.send({type:"START_GAME"}),k.type==="GAME_STARTED"&&c.send({type:"GAME_STARTED"}),k.type==="GAME_RESET"&&c.send({type:"GAME_RESET"}),k.type==="NEW_BOARD"&&t.replace(`/games/${x.value}/${k.payload}`),k.type==="SYNC_PLAYER_STATUS"&&c.send({type:"SET_PLAYER_STATUS",playerId:i.id,status:k.payload}),k.type==="SYNC_PARTICIPANTS"&&c.send({type:"SYNC_PARTICIPANTS",participants:k.payload}),k.type==="SYNC_LEDGER"){const M=k.payload;for(const o of M)o.signature&&o.signerPublicKey&&X.verify(o.action,o.signature,o.signerPublicKey).then(T=>{T||d.error("Invalid signature in ledger entry",o)});c.send({type:"SYNC_LEDGER",ledger:k.payload})}}catch{}}),i._hasListener=!0))},Ee=async(i,c)=>{const f=c||i;if(d.sig("setupSignaling called with gameId:",i,"boardId:",c,"resolved currentBoardId:",f),!!f&&(a.value!==f&&n.value?.isConnected&&(d.sig("Switching signaling board assignment from",a.value,"to",f),n.value.updateBoardId(f),a.value=f),(!n.value||!n.value.isConnected)&&!r.value)){r.value=!0;try{const _=X.getInstance(),N=await _.getIdentity();if(N){const J=new Lt(i||"default",f,N.name,async o=>{if(o.type==="error"&&(d.error("Signaling error:",o.message||o.code),xe.error(o.message||"Signaling error occurred"),o.code==="DUPLICATE_IDENTITY"&&t.replace(`/games/${i}`)),o.type==="peerJoined"&&(d.sig("Peer joined:",o.peerName,"publicKey:",o.publicKey),await ye(o.publicKey)?(d.sig("Auto-approving known identity:",o.peerName),await fe({connectionId:o.from,peerName:o.peerName||"Guest",publicKey:o.publicKey,encryptionPublicKey:o.encryptionPublicKey,timestamp:Date.now()})):w.value.push({connectionId:o.from,peerName:o.peerName||"Guest",publicKey:o.publicKey,encryptionPublicKey:o.encryptionPublicKey,timestamp:Date.now()})),o.type==="offer"){d.sig("Received offer from host:",o.from);const T=o.boardId||a.value;if(!T){d.error("No valid target board UUID for offer message");return}const $=Ke(T,N.name,!1),F=new le(q=>{$.send({type:"UPDATE_CONNECTION",connection:q})});F.addMessageListener(q=>{try{const j=JSON.parse(q);if(!tt(j))return;if(j.type==="START_GAME"&&$.send({type:"START_GAME"}),j.type==="GAME_STARTED"&&$.send({type:"GAME_STARTED"}),j.type==="GAME_RESET"&&$.send({type:"GAME_RESET"}),j.type==="NEW_BOARD"&&t.replace(`/games/${i.value}/${j.payload}`),j.type==="SYNC_PLAYER_STATUS"&&$.send({type:"SET_PLAYER_STATUS",playerId:F.id,status:j.payload}),j.type==="SYNC_PARTICIPANTS"&&$.send({type:"SYNC_PARTICIPANTS",participants:j.payload}),j.type==="SYNC_LEDGER"){const Fe=j.payload;for(const ie of Fe)ie.signature&&ie.signerPublicKey&&X.verify(ie.action,ie.signature,ie.signerPublicKey).then(ht=>{ht||d.error("Invalid signature in ledger entry",ie)});$.send({type:"SYNC_LEDGER",ledger:Fe})}}catch(j){d.error("Failed to parse message:",j)}}),F.onClose=()=>{$.send({type:"PEER_DISCONNECTED",connectionId:F.id})},F.setDataChannelCallback(),o.publicKey&&(console.log("[useGameSession] Guest storing host publicKey from offer:",o.publicKey?.substring(0,20)),F.remotePublicKey=o.publicKey),o.peerName&&(console.log("[useGameSession] Guest storing host name from offer:",o.peerName),F.remotePlayerName=o.peerName),F.acceptOffer(o.offer,N.name).then(()=>{const q=setInterval(()=>{F.signal&&n.value&&(clearInterval(q),d.sig("Sending answer to host:",o.from),n.value.guestAnswer(o.from,N.publicKey,F.signal,void 0))},100)}).catch(q=>{d.error("Failed to accept offer and generate answer:",q)})}if(o.type==="answer"){d.sig("Received answer from guest:",o.from,"publicKey:",o.publicKey);const T=y.value.get(o.from);if(T&&o.answer){d.sig("Applying answer to connection:",o.from),console.log("[useGameSession] msg.answer type:",typeof o.answer),console.log("[useGameSession] msg.answer is Signal?:",o.answer instanceof Z),console.log("[useGameSession] msg.answer publicKey:",o.answer.publicKey?.substring(0,20));let $=o.answer;!(o.answer instanceof Z)&&typeof o.answer=="object"&&(console.log("[useGameSession] Converting plain object to Signal instance"),$=new Z(o.answer.connectionId,o.answer.session,o.answer.playerName,o.answer.iceCandidates||[]),console.log("[useGameSession] Signal created from plain object")),o.publicKey&&(console.log("[useGameSession] Setting remotePublicKey from msg.publicKey:",o.publicKey?.substring(0,20)),T.remotePublicKey=o.publicKey),o.peerName&&(console.log("[useGameSession] Setting remotePlayerName from msg.peerName:",o.peerName),T.remotePlayerName=o.peerName);try{T.acceptAnswer($),d.sig("WebRTC connection established with:",o.from),y.value.delete(o.from)}catch(F){d.error("Failed to accept answer:",F)}}else d.error("No pending connection found for:",o.from)}}),k=`SIGN_IN:${N.subscriptionToken}`,M=await _.sign(k);await J.connect(N.subscriptionToken,N.publicKey,M),n.value=J,a.value=f}}catch(_){d.error("Failed to connect to signaling server:",_)}finally{r.value=!1}}},Ae=async(i=2)=>{if(U.value)I.value&&u.value&&d.sig("Manual onHostAGame called (not used in new flow)");else{const c=Me();t.push(`/games/${x.value}/${c}?maxPlayers=${i}`)}},_e=async()=>{if(!u.value||!n.value?.isConnected){d.error("Cannot join as guest: missing boardId or signaling not connected");return}const c=await X.getInstance().getIdentity();c&&(d.sig("Sending guestJoin for boardId:",u.value),n.value.guestJoin(u.value,c.name,c.publicKey,c.publicKey))},ye=async i=>(await pe.getAllKnownIdentities()).some(f=>f.publicKey===i),fe=async i=>{d.sig("Approving peer:",i.peerName,"publicKey:",i.publicKey);const c=new le(_=>{I.value?.send({type:"UPDATE_CONNECTION",connection:_})});c.onClose=()=>{I.value?.send({type:"PEER_DISCONNECTED",connectionId:c.id}),y.value.delete(i.connectionId)},c.remotePublicKey=i.publicKey,console.log("[useGameSession] Stored guest publicKey from join request:",i.publicKey?.substring(0,20)),c.openDataChannel(),await c.prepareOfferSignal(A.value?.context?.playerName||H.value?.name||"Anonymous"),y.value.set(i.connectionId,c);const f=setInterval(()=>{c.signal&&n.value&&(clearInterval(f),X.getInstance().getIdentity().then(N=>{N&&n.value&&n.value.hostOffer(i.connectionId,i.publicKey,c.signal,N.publicKey,void 0)}))},100)},Ne=async i=>{w.value=w.value.filter(c=>c.connectionId!==i.connectionId),await fe(i)},Pe=i=>{d.sig("Rejecting peer:",i.peerName),w.value=w.value.filter(c=>c.connectionId!==i.connectionId)},me=async i=>{try{const c={id:`identity-${Date.now()}`,name:i.peerName,publicKey:i.publicKey,addedAt:Date.now()};await pe.addKnownIdentity(c),xe.success("Identity Saved",{description:`${i.peerName} has been added to your known identities.`})}catch{xe.error("Failed to save identity")}},Te=()=>{n.value&&v.value&&n.value.deleteOffer(),I.value?.send({type:"START_GAME"})},be=()=>{if(!I.value)return;I.value.send({type:"JOIN",boardId:u.value});const i=new le(ae);i.onClose=()=>I.value?.send({type:"PEER_DISCONNECTED",connectionId:i.id}),i.status=L.readyToAccept,i.setDataChannelCallback(),ae(i)},Ge=async(i,c)=>{if(!(!(i instanceof le)||!c))try{await i.acceptOffer(c,H.value?.name||"Anonymous")}catch(f){d.error("Failed to accept offer",f)}},ve=(i,c)=>{if(!(!(i instanceof le)||!c))try{i.acceptAnswer(c),ae(i)}catch(f){d.error("Failed to accept answer",f)}},B=()=>{I.value?.send({type:"FINISH_GAME"}),u.value&&Re.updateStatus(u.value,"finished")},V=async i=>{if(!v.value||!I.value)return;const c=X.getInstance(),f=await c.getIdentity();if(!f)return;const _=await c.sign(i),N=Ft.fromEntries(A.value?.context?.ledger||[]),J=await N.addEntry({...i});J.signature=_,J.signerPublicKey=f.publicKey;const k=N.getEntries();I.value.send({type:"SYNC_LEDGER",ledger:k}),Q.value.forEach(M=>{M.send(JSON.stringify(de("SYNC_LEDGER",k)))})},ce=()=>{const i=Me();Q.value.forEach(c=>{c.status===L.connected&&c.send(JSON.stringify(de("NEW_BOARD",i)))}),n.value?.deleteOffer(),I.value?.send({type:"CLOSE_SESSION"}),t.push(`/games/${x.value}/${i}`)},ut=()=>{const i=A.value?.context?.pendingGuest;I.value?.send({type:"ACCEPT_GUEST"}),i&&ae(i.connection)},pt=()=>I.value?.send({type:"REJECT_GUEST"}),gt=i=>{i.close(),I.value?.send({type:"PEER_DISCONNECTED",connectionId:i.id})};return Y([v,se],()=>{if(!v.value)return;const i=se.value.map(c=>({id:c.id,name:c.name,isHost:c.isHost,publicKey:c.publicKey}));Q.value.forEach(c=>{if(c.status===L.connected)try{c.send(JSON.stringify(de("SYNC_PARTICIPANTS",i)))}catch(f){d.error("Failed to sync participants to peer",c.id,f)}})},{deep:!0,immediate:!0}),Y([u,U],async()=>{const i=U.value&&u.value;d.sig("[WATCH] Signaling Lifecycle update. shouldConnect:",i,"boardId:",u.value),i&&await Ee(x.value,u.value)},{immediate:!0}),Y([n,A,u],async()=>{if(!n.value?.isConnected||!u.value||b.value)return;const c=await X.getInstance().getIdentity();if(!c)return;const f=A.value;if(!f)return;const _=f.matches("hosting")||f.matches("preparation"),N=f.matches("joining");_&&f.context.isInitiator?(d.sig("Auto-registering as HOST for boardId:",u.value,"state:",f.value),n.value.hostRegister(u.value,x.value,c.name,c.publicKey),b.value=!0):(N||!f.context.isInitiator)&&(d.sig("Auto-joining as GUEST for boardId:",u.value,"state:",f.value),n.value.guestJoin(u.value,c.name,c.publicKey,c.publicKey),b.value=!0)}),Y(u,async i=>{if(i&&i!=="manual"&&U.value){const c=await Re.getSession(i),f=Ke(i,H.value?.name||"Anonymous",!1),_=f.getSnapshot().context;c&&c.ledger.length>0&&_.ledger.length===0&&(f.send({type:"LOAD_LEDGER",ledger:c.ledger}),f.send({type:"GAME_STARTED"}),c.status==="finished"&&setTimeout(()=>f.send({type:"FINISH_GAME"}),10))}},{immediate:!0}),Y(Q,i=>{i.forEach(c=>{c._hasInitialSync||(c.send(JSON.stringify(de("SYNC_PLAYER_STATUS",Ie.value))),v.value&&u.value&&u.value!=="manual"&&c.send(JSON.stringify(de("NEW_BOARD",u.value))),c._hasInitialSync=!0)})}),{identity:H,isLoading:lt,snapshot:A,send:i=>I.value?.send(i),signalingClient:n,isServerConnecting:r,pendingJoinRequests:w,activeSessions:et,playerInfos:se,connectedPeers:Q,pendingSignaling:Ce,isInitiator:v,isGameStarted:p,onHostAGame:Ae,onJoinAsGuest:_e,isKnownIdentity:ye,onApprovePeer:Ne,onRejectPeer:Pe,saveIdentityOnApprove:me,startGame:Te,connectWithOffer:be,updateOffer:Ge,updateAnswer:ve,onFinishGame:B,onAddLedger:V,handlePlayAgain:ce,onAcceptGuest:ut,onRejectGuest:pt,onCancelSignaling:gt,onBackToGames:()=>t.push(`/games/${x.value}`),onBackToDiscovery:()=>t.push(`/games/${x.value}`)}}const Bt={class:"space-y-4 animate-fade-in-up"},Jt={key:0,class:"glass-dark p-6 rounded-2xl border border-white/5 shadow-glass-dark flex items-center justify-center space-x-4"},Ut={key:1,class:"glass-dark p-6 rounded-2xl border border-white/5 shadow-glass-dark"},Ht={class:"text-sm font-black text-white uppercase tracking-[0.2em] mb-4 flex items-center gap-3"},Vt={key:2,class:"glass-dark p-6 rounded-2xl border border-white/5 shadow-glass-dark group hover:border-primary/20 transition-all duration-500"},Yt={class:"text-[10px] font-black uppercase tracking-[0.2em] mb-4 flex items-center gap-2 text-primary"},zt={class:"space-y-4"},Wt={class:"p-4 bg-white/5 rounded-xl border border-white/10 relative group min-h-[64px] flex items-center group-hover:neon-border transition-all duration-500"},Qt={class:"text-[10px] font-mono break-all line-clamp-2 text-white/40 pr-8"},Xt={key:1,class:"text-[10px] text-white/20 italic tracking-wider"},Zt={key:3,class:"glass-dark p-6 rounded-2xl border border-white/5 shadow-glass-dark group hover:border-primary/20 transition-all duration-500"},qt={class:"text-[10px] font-black uppercase tracking-[0.2em] mb-4 flex items-center gap-2 text-primary"},en={class:"space-y-3"},tn={class:"p-4 bg-white/5 rounded-xl border border-white/10 relative group min-h-[64px] flex items-center group-hover:neon-border transition-all duration-500"},nn={class:"text-[10px] font-mono break-all line-clamp-2 text-white/40 pr-8"},sn={key:1,class:"text-[10px] text-white/20 italic tracking-wider"},an={key:4,class:"flex justify-end"},nt=ne({__name:"SignalingStep",props:{connection:{},onOfferChange:{type:Function},onAnswerChange:{type:Function},onCancel:{type:Function}},setup(e){const t=D(!1),n=r=>{r&&(navigator.clipboard.writeText(r),t.value=!0,setTimeout(()=>t.value=!1,2e3))};return(r,a)=>(g(),h("div",Bt,[e.connection.status===l(L).new?(g(),h("div",Jt,[...a[5]||(a[5]=[s("div",{class:"animate-spin rounded-full h-5 w-5 border-b-2 border-primary"},null,-1),s("p",{class:"text-sm text-white/50 font-bold uppercase tracking-widest"},"Generating invite signal...",-1)])])):E("",!0),e.connection.status===l(L).readyToAccept?(g(),h("div",Ut,[s("h3",Ht,[m(l(At),{class:"w-5 h-5 text-primary"}),a[6]||(a[6]=G(" Paste Join Offer ",-1))]),a[7]||(a[7]=s("p",{class:"text-[10px] text-white/30 uppercase tracking-widest mb-4"},"External node signal required for connection.",-1)),m(Be,{placeholder:"Paste offer string here...",className:"h-12 bg-white/5 border-white/10 rounded-xl focus:ring-primary text-white font-mono text-xs placeholder:text-white/20","onUpdate:modelValue":a[0]||(a[0]=b=>e.onOfferChange(e.connection,b))})])):E("",!0),e.connection.status===l(L).started?(g(),h("div",Vt,[s("h3",Yt,[m(l(ke),{class:"w-4 h-4"}),a[8]||(a[8]=G(" Active Invite Vector ",-1))]),s("div",zt,[s("div",Wt,[e.connection.signal?(g(),h(ee,{key:0},[s("div",Qt,R(e.connection.signal.toString()),1),s("button",{class:"absolute top-2 right-2 h-8 w-8 flex items-center justify-center text-primary hover:bg-primary/10 transition-colors rounded-lg",onClick:a[1]||(a[1]=b=>n(e.connection.signal.toString()))},[t.value?(g(),z(l(Se),{key:0,class:"w-4 h-4"})):(g(),z(l(Ze),{key:1,class:"w-4 h-4"}))])],64)):(g(),h("div",Xt,"Gathering node connection details..."))]),a[9]||(a[9]=s("p",{class:"text-[10px] text-white/30 uppercase font-medium leading-relaxed tracking-wider"}," Transmit this vector to a peer node. Their response will be synthesized automatically. ",-1)),m(Be,{placeholder:"Awaiting peer response vector...",className:"h-10 bg-white/5 border-white/10 rounded-xl focus:ring-primary text-white font-mono text-[10px] placeholder:text-white/20","onUpdate:modelValue":a[2]||(a[2]=b=>e.onAnswerChange(e.connection,b))})])])):E("",!0),e.connection.status===l(L).answered?(g(),h("div",Zt,[s("h3",qt,[m(l(Se),{class:"w-4 h-4"}),a[10]||(a[10]=G(" Signal Response Synthesized ",-1))]),s("div",en,[s("div",tn,[e.connection.signal?(g(),h(ee,{key:0},[s("div",nn,R(e.connection.signal.toString()),1),s("button",{class:"absolute top-2 right-2 h-8 w-8 flex items-center justify-center text-primary hover:bg-primary/10 transition-colors rounded-lg",onClick:a[3]||(a[3]=b=>n(e.connection.signal.toString()))},[t.value?(g(),z(l(Se),{key:0,class:"w-4 h-4"})):(g(),z(l(Ze),{key:1,class:"w-4 h-4"}))])],64)):(g(),h("div",sn,"Finalizing response..."))]),a[11]||(a[11]=s("p",{class:"text-[10px] text-primary font-black uppercase tracking-widest"},"Transmit this payload back to peer to complete handshake.",-1))])])):E("",!0),e.onCancel?(g(),h("div",an,[s("button",{onClick:a[4]||(a[4]=b=>e.onCancel(e.connection)),class:"text-[10px] font-black uppercase tracking-widest text-white/20 hover:text-rose-500 transition-colors p-2"}," De-initialize Link ")])):E("",!0)]))}}),on={class:"space-y-8"},rn={key:0,class:"fixed inset-0 z-[100] flex items-center justify-center bg-[#0A0A0A]/80 backdrop-blur-xl animate-fade-in p-6"},cn={class:"glass-dark p-10 w-full max-w-md shadow-2xl border border-white/10 rounded-[2.5rem] space-y-8 animate-zoom-in"},ln={class:"flex flex-col items-center text-center space-y-6"},dn={class:"h-20 w-20 bg-primary/10 rounded-[1.5rem] flex items-center justify-center border border-primary/20 shadow-neon"},un={class:"space-y-2"},pn={class:"text-white/40 uppercase tracking-widest text-[10px] font-medium leading-relaxed"},gn={class:"font-black text-primary px-1"},hn={class:"grid grid-cols-2 gap-4"},yn={key:1,class:"glass-dark p-8 border border-primary/20 shadow-glass-dark rounded-[2.5rem] animate-zoom-in space-y-6"},fn={class:"flex items-center gap-4"},mn={class:"w-12 h-12 rounded-2xl bg-primary/10 flex items-center justify-center border border-primary/20"},bn={class:"space-y-1"},vn={class:"text-white/40 uppercase tracking-widest text-[10px] font-medium"},wn={class:"space-y-4"},xn={class:"flex items-start justify-between"},Sn={class:"space-y-2"},kn={class:"flex items-center gap-2"},Cn={class:"text-lg font-black text-white"},In={key:0,class:"px-2 py-0.5 bg-primary/10 text-primary border border-primary/20 rounded-full text-[9px] font-black uppercase tracking-wider"},En={class:"text-xs text-white/40 font-mono"},An={key:0,class:"flex items-center justify-end gap-2 px-1 pb-2"},_n=["onClick","aria-checked"],Nn={class:"grid grid-cols-2 gap-3"},Pn=["onClick"],Tn=["onClick"],Gn={key:2,class:"glass-dark p-10 text-center space-y-8 border border-white/5 shadow-glass-dark rounded-[3rem] animate-zoom-in"},Rn={class:"space-y-4"},Ln={class:"inline-flex items-center gap-2 px-4 py-1.5 bg-primary/10 text-primary border border-primary/20 rounded-full text-[10px] font-black uppercase tracking-[0.2em] shadow-neon transform -translate-y-2"},On={class:"text-4xl font-black text-white uppercase tracking-tighter"},Kn={class:"text-xs text-white/30 uppercase font-black tracking-widest leading-relaxed max-w-lg mx-auto"},$n={key:0,class:"flex flex-col items-center gap-6"},Dn={class:"space-y-4"},Mn={class:"mx-auto h-16 w-16 bg-rose-500/10 rounded-2xl flex items-center justify-center border border-rose-500/20"},Fn={class:"grid grid-cols-2 gap-4 pt-6"},jn={key:1,class:"flex flex-col items-center gap-8 py-6"},Bn={key:0,class:"relative"},Jn={class:"space-y-3"},Un={class:"text-xl font-black text-white uppercase tracking-tight"},Hn={class:"text-[10px] text-white/30 uppercase tracking-[0.2em] max-w-xs mx-auto font-medium leading-relaxed"},Vn={class:"space-y-4"},Yn={class:"mx-auto h-16 w-16 bg-rose-500/10 rounded-2xl flex items-center justify-center border border-rose-500/20"},zn={class:"grid grid-cols-2 gap-4 pt-6"},Wn={key:2,class:"pt-8 border-t border-white/5 space-y-6"},Qn={key:0,class:"glass-dark p-8 rounded-[2rem] border border-white/10 shadow-glass-dark space-y-6 group hover:border-primary/30 transition-all duration-500"},Xn={class:"flex items-center justify-between"},Zn={class:"flex items-center gap-3"},qn={class:"p-2.5 bg-primary/10 rounded-xl border border-primary/20"},es={class:"relative flex items-center gap-3"},ts={class:"flex-grow bg-black/40 border border-white/10 rounded-xl px-4 py-3.5 font-mono text-[11px] text-white/60 truncate transition-all group-hover:bg-black/60 group-hover:border-white/20"},ns={key:"check",class:"flex items-center gap-2 animate-bounce-short"},ss={key:"copy",class:"flex items-center gap-2"},as={key:1,class:"space-y-4 text-left"},is={class:"grid grid-cols-1 gap-6"},os={key:3,class:"pt-8 border-t border-white/5 text-left"},rs={key:3,class:"py-24 flex flex-col items-center justify-center space-y-6 border border-white/5 bg-white/5 rounded-[3rem] backdrop-blur-sm animate-fade-in"},cs=ne({__name:"PreparationPhase",props:{state:{},isInitiator:{type:Boolean},signalingMode:{},isServerConnecting:{type:Boolean},signalingClient:{},pendingSignaling:{},pendingJoinRequests:{},isKnownIdentity:{type:Function},onStartGame:{type:Function},onHostAGame:{type:Function},onUpdateOffer:{type:Function},onUpdateAnswer:{type:Function},onCloseSession:{type:Function},onBackToLobby:{type:Function},onAcceptGuest:{type:Function},onRejectGuest:{type:Function},onApprovePeer:{type:Function},onRejectPeer:{type:Function},onSaveIdentity:{type:Function},onCancelSignaling:{type:Function},onRemovePlayer:{type:Function},playerCount:{},maxPlayers:{},boardId:{},gameId:{}},setup(e){const t=e,n=D({}),r=D({}),a=async v=>{t.isKnownIdentity&&(n.value[v]=await t.isKnownIdentity(v))},b=v=>v.length<=20?v:`${v.substring(0,10)}...${v.substring(v.length-10)}`,w=D(!1),y=C(()=>`${window.location.origin}${window.location.pathname}#/games/${t.gameId}/${t.boardId}`),x=async()=>{try{await navigator.clipboard.writeText(y.value),w.value=!0,setTimeout(()=>{w.value=!1},2e3)}catch(v){console.error("Failed to copy link:",v)}};Y(()=>t.pendingJoinRequests,v=>{v&&v.forEach(p=>{p.publicKey in n.value||a(p.publicKey)})},{deep:!0,immediate:!0});const u=async v=>{r.value[v.connectionId]&&t.onSaveIdentity&&await t.onSaveIdentity(v),t.onApprovePeer&&t.onApprovePeer(v),delete r.value[v.connectionId]},P=C(()=>t.state.matches("preparation")),U=C(()=>t.state.matches("hosting")),I=C(()=>t.state.matches("joining")),A=C(()=>t.state.matches("approving"));return(v,p)=>(g(),h("div",on,[A.value&&e.state.context.pendingGuest?(g(),h("div",rn,[s("div",cn,[s("div",ln,[s("div",dn,[m(l(ke),{class:"w-10 h-10 text-primary animate-pulse"})]),s("div",un,[p[6]||(p[6]=s("h2",{class:"text-2xl font-black text-white uppercase tracking-tight"},"Handshake Request",-1)),s("p",pn,[p[4]||(p[4]=G(" Entity ",-1)),s("span",gn,R(e.state.context.pendingGuest.name),1),p[5]||(p[5]=G(" attempts to bridge into session. ",-1))])])]),s("div",hn,[s("button",{onClick:p[0]||(p[0]=(...S)=>e.onRejectGuest&&e.onRejectGuest(...S)),class:"h-14 rounded-2xl border border-white/10 text-white/60 hover:text-rose-500 hover:bg-rose-500/10 hover:border-rose-500/30 font-black uppercase tracking-widest text-xs transition-all"}," De-authorize "),s("button",{onClick:p[1]||(p[1]=(...S)=>e.onAcceptGuest&&e.onAcceptGuest(...S)),class:"h-14 rounded-2xl bg-primary text-primary-foreground shadow-neon hover:shadow-[0_0_30px_rgba(16,185,129,0.4)] font-black uppercase tracking-widest text-xs transition-all"}," Grant Access ")])])])):E("",!0),e.isInitiator&&e.pendingJoinRequests&&e.pendingJoinRequests.length>0?(g(),h("div",yn,[s("div",fn,[s("div",mn,[m(l(ke),{class:"w-6 h-6 text-primary"})]),s("div",bn,[p[7]||(p[7]=s("h2",{class:"text-2xl font-black text-white uppercase tracking-tight"},"Join Requests",-1)),s("p",vn,R(e.pendingJoinRequests.length)+" "+R(e.pendingJoinRequests.length===1?"peer":"peers")+" waiting for approval ",1)])]),s("div",wn,[(g(!0),h(ee,null,De(e.pendingJoinRequests,S=>(g(),h("div",{key:S.connectionId,class:"glass-darker p-6 rounded-2xl border border-white/5 space-y-4"},[s("div",xn,[s("div",Sn,[s("div",kn,[s("span",Cn,R(S.peerName),1),n.value[S.publicKey]?(g(),h("span",In," Known Identity ")):E("",!0)]),s("p",En,R(b(S.publicKey)),1)])]),n.value[S.publicKey]?E("",!0):(g(),h("div",An,[p[8]||(p[8]=s("span",{class:"text-xs text-white/50 uppercase tracking-wider font-medium"},"Auto-approve next time",-1)),s("button",{onClick:W=>r.value[S.connectionId]=!r.value[S.connectionId],class:ue(["relative inline-flex h-6 w-11 items-center rounded-full transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2 focus:ring-offset-gray-900",r.value[S.connectionId]?"bg-primary":"bg-white/10"]),role:"switch","aria-checked":r.value[S.connectionId]},[s("span",{class:ue(["inline-block h-4 w-4 transform rounded-full bg-white transition-transform duration-200",r.value[S.connectionId]?"translate-x-6":"translate-x-1"])},null,2)],10,_n)])),s("div",Nn,[s("button",{onClick:W=>e.onRejectPeer&&e.onRejectPeer(S),class:"h-12 rounded-xl border border-white/10 text-white/60 hover:text-rose-500 hover:bg-rose-500/10 hover:border-rose-500/30 font-black uppercase tracking-widest text-xs transition-all"}," Reject ",8,Pn),s("button",{onClick:W=>u(S),class:"h-12 rounded-xl bg-primary text-primary-foreground shadow-neon hover:shadow-[0_0_30px_rgba(16,185,129,0.4)] font-black uppercase tracking-widest text-xs transition-all"}," Approve ",8,Tn)])]))),128))])])):E("",!0),U.value||I.value||P.value||A.value?(g(),h("div",Gn,[s("div",Rn,[s("div",Ln,R(U.value||A.value?"Broadcasting Session":I.value?"Initializing Node":"Command Lobby Active"),1),s("h2",On,R(P.value?"Game Room":U.value?"Link Establishment":"Connecting..."),1),s("p",Kn,[P.value?(g(),h(ee,{key:0},[G(R(e.isInitiator?`Authorize peer nodes or launch protocol when ready (${e.playerCount}/${e.maxPlayers}).`:"Waiting for initiator to launch protocol."),1)],64)):(g(),h(ee,{key:1},[G("Synthesizing direct P2P mesh link to session nodes.")],64))])]),e.isInitiator?(g(),h("div",$n,[P.value?(g(),h("button",{key:0,onClick:p[2]||(p[2]=(...S)=>e.onStartGame&&e.onStartGame(...S)),class:"w-full max-w-sm h-16 text-sm font-black uppercase tracking-[0.5em] rounded-2xl bg-primary text-primary-foreground shadow-[0_0_30px_rgba(16,185,129,0.3)] hover:shadow-[0_0_50px_rgba(16,185,129,0.5)] transition-all active:scale-[0.98]"}," Launch Protocol ")):E("",!0),m(l(Xe),null,{default:O(()=>[m(l(Je),{asChild:""},{default:O(()=>[...p[9]||(p[9]=[s("button",{class:"px-4 h-12 rounded-xl text-white/20 hover:text-rose-500 font-black uppercase tracking-widest text-[10px] transition-colors"}," Terminate Session ",-1)])]),_:1}),m(l(Ue),null,{default:O(()=>[m(l(He),{class:"bg-black/80 fixed inset-0 z-[100] backdrop-blur-sm"}),m(l(Ve),{class:"glass-dark border border-white/10 rounded-[2rem] p-8 max-w-sm fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 z-[101]"},{default:O(()=>[s("div",Dn,[s("div",Mn,[m(l(je),{class:"w-8 h-8 text-rose-500"})]),m(l(Ye),{class:"text-xl font-black text-center text-white uppercase tracking-tight"},{default:O(()=>[...p[10]||(p[10]=[G(" Terminate Session? ",-1)])]),_:1}),m(l(ze),{class:"text-center text-white/40 text-xs font-medium uppercase tracking-widest leading-relaxed"},{default:O(()=>[...p[11]||(p[11]=[G(" Reloading or leaving will cause the game session to be lost. Peers will be disconnected and discovery mesh link terminated. ",-1)])]),_:1})]),s("div",Fn,[m(l(We),{class:"h-12 rounded-xl bg-white/5 border border-white/5 text-white/60 hover:bg-white/10 font-bold uppercase tracking-widest text-[10px]"},{default:O(()=>[...p[12]||(p[12]=[G(" Abort ",-1)])]),_:1}),m(l(Qe),{onClick:e.onCloseSession,class:"h-12 rounded-xl bg-rose-500 text-white font-black uppercase tracking-widest text-[10px] hover:bg-rose-600 shadow-neon-sm"},{default:O(()=>[...p[13]||(p[13]=[G(" Confirm ",-1)])]),_:1},8,["onClick"])])]),_:1})]),_:1})]),_:1})])):(g(),h("div",jn,[P.value?E("",!0):(g(),h("div",Bn,[...p[14]||(p[14]=[s("div",{class:"animate-spin rounded-full h-20 w-20 border-4 border-primary/5 border-t-primary shadow-neon"},null,-1),s("div",{class:"absolute inset-0 flex items-center justify-center"},[s("div",{class:"h-3 w-3 bg-primary rounded-full animate-pulse shadow-neon"})],-1)])])),s("div",Jn,[s("h3",Un,R(P.value?"Node Synced":"Bridging Connections"),1),s("p",Hn,R(P.value?"Identity verified. Awaiting initiator's launch command.":"Establishing secure encrypted tunnel to host node."),1)]),m(l(Xe),null,{default:O(()=>[m(l(Je),{asChild:""},{default:O(()=>[...p[15]||(p[15]=[s("button",{class:"h-10 text-white/20 hover:text-rose-500 font-black uppercase tracking-widest text-[10px] transition-colors"}," Sever Connection ",-1)])]),_:1}),m(l(Ue),null,{default:O(()=>[m(l(He),{class:"bg-black/80 fixed inset-0 z-[100] backdrop-blur-sm"}),m(l(Ve),{class:"glass-dark border border-white/10 rounded-[2rem] p-8 max-w-sm fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 z-[101]"},{default:O(()=>[s("div",Vn,[s("div",Yn,[m(l(je),{class:"w-8 h-8 text-rose-500"})]),m(l(Ye),{class:"text-xl font-black text-center text-white uppercase tracking-tight"},{default:O(()=>[...p[16]||(p[16]=[G(" Sever Connection? ",-1)])]),_:1}),m(l(ze),{class:"text-center text-white/40 text-xs font-medium uppercase tracking-widest leading-relaxed"},{default:O(()=>[...p[17]||(p[17]=[G(" Leaving or reloading will sever your node link. The game session progress will be lost. ",-1)])]),_:1})]),s("div",zn,[m(l(We),{class:"h-12 rounded-xl bg-white/5 border border-white/5 text-white/60 hover:bg-white/10 font-bold uppercase tracking-widest text-[10px]"},{default:O(()=>[...p[18]||(p[18]=[G(" Abort ",-1)])]),_:1}),m(l(Qe),{onClick:e.onBackToLobby,class:"h-12 rounded-xl bg-rose-500 text-white font-black uppercase tracking-widest text-[10px] hover:bg-rose-600 shadow-neon-sm"},{default:O(()=>[...p[19]||(p[19]=[G(" Confirm ",-1)])]),_:1},8,["onClick"])])]),_:1})]),_:1})]),_:1})])),e.isInitiator?(g(),h("div",Wn,[e.signalingMode==="server"?(g(),h("div",Qn,[s("div",Xn,[s("div",Zn,[s("div",qn,[m(l(Et),{class:"w-5 h-5 text-primary"})]),p[20]||(p[20]=s("div",{class:"text-left"},[s("h3",{class:"text-sm font-black text-white uppercase tracking-wider"},"Share Session Link"),s("p",{class:"text-[10px] text-white/30 uppercase tracking-widest font-medium"},"Link this node to the discovery mesh")],-1))]),p[21]||(p[21]=s("div",{class:"flex items-center gap-2 px-3 py-1 bg-primary/5 border border-primary/20 rounded-full"},[s("div",{class:"w-1.5 h-1.5 bg-primary rounded-full animate-pulse shadow-neon"}),s("span",{class:"text-[9px] font-black text-primary uppercase tracking-widest"},"Live Broadcast")],-1))]),s("div",es,[s("div",ts,R(y.value),1),s("button",{onClick:x,class:"shrink-0 h-12 px-6 rounded-xl bg-primary text-primary-foreground font-black uppercase tracking-widest text-[10px] shadow-neon hover:shadow-[0_0_25px_rgba(16,185,129,0.4)] transition-all active:scale-95 flex items-center gap-2"},[m(mt,{mode:"out-in",name:"fade"},{default:O(()=>[w.value?(g(),h("div",ns,[m(l(Ct),{class:"w-4 h-4"}),p[22]||(p[22]=G(" COPIED ",-1))])):(g(),h("div",ss,[m(l(It),{class:"w-4 h-4"}),p[23]||(p[23]=G(" COPY LINK ",-1))]))]),_:1})])])])):E("",!0),e.signalingMode==="manual"&&e.pendingSignaling.length>0?(g(),h("div",as,[p[24]||(p[24]=s("h3",{class:"text-[11px] font-black text-white/20 uppercase tracking-[0.3em] px-1"},"Pending Link Authentications",-1)),s("div",is,[(g(!0),h(ee,null,De(e.pendingSignaling,S=>(g(),z(nt,{key:S.id,connection:S,onOfferChange:e.onUpdateOffer,onAnswerChange:e.onUpdateAnswer,onCancel:e.onCancelSignaling},null,8,["connection","onOfferChange","onAnswerChange","onCancel"]))),128))])])):E("",!0)])):E("",!0),!e.isInitiator&&I.value&&e.signalingMode==="manual"&&e.pendingSignaling.length>0?(g(),h("div",os,[m(nt,{connection:e.pendingSignaling[0],onOfferChange:e.onUpdateOffer,onAnswerChange:e.onUpdateAnswer,onCancel:e.onCancelSignaling},null,8,["connection","onOfferChange","onAnswerChange","onCancel"])])):E("",!0)])):E("",!0),!U.value&&!I.value&&!P.value&&!A.value?(g(),h("div",rs,[p[25]||(p[25]=bt('<div class="relative"><div class="h-20 w-20 bg-white/5 rounded-full flex items-center justify-center transition-transform hover:scale-110 duration-500"><div class="h-4 w-4 bg-white/10 rounded-full animate-ping"></div></div></div><div class="text-center space-y-2"><div class="text-xs font-black uppercase tracking-[0.5em] text-white/30">Null Reference: No Active Session</div><p class="text-[10px] text-white/20 uppercase tracking-widest px-10 leading-relaxed font-medium">Session data not found on current node. Return to discovery mesh.</p></div>',2)),s("button",{onClick:p[3]||(p[3]=(...S)=>e.onBackToLobby&&e.onBackToLobby(...S)),class:"h-12 px-8 rounded-xl border border-white/10 text-white/70 hover:text-primary hover:border-primary/40 font-black uppercase tracking-widest text-[10px] transition-all"}," Return to Discovery ")])):E("",!0)]))}}),ls={class:"w-full h-full"},ds={key:1,class:"p-20 text-center text-white/10 uppercase font-black tracking-[0.5em] animate-pulse"},dt=ne({__name:"ReactComponentWrapper",props:{component:{},componentProps:{}},setup(e){const t=e,n=$e(null);return Y(()=>t.component,r=>{if(r)try{const a=vt(r);n.value=wt(a)}catch(a){console.error("[ReactComponentWrapper] Failed to apply React in Vue:",a),n.value=null}else n.value=null},{immediate:!0}),it(()=>{n.value=null}),(r,a)=>(g(),h("div",ls,[n.value?(g(),z(xt(n.value),St(kt({key:0},e.componentProps)),null,16)):(g(),h("div",ds," Initialising Game... "))]))}}),us={class:"animate-zoom-in"},ps=ne({__name:"ActivePhase",props:{GameComponent:{},connectedPeers:{},playerInfos:{},isInitiator:{type:Boolean},ledger:{},onAddLedger:{type:Function},onFinishGame:{type:Function}},setup(e){const t=e,n=C(()=>({connections:t.connectedPeers,playerNames:t.playerInfos.map(r=>r.name),playerInfos:t.playerInfos,isInitiator:t.isInitiator,ledger:t.ledger,onAddLedger:t.onAddLedger,onFinishGame:t.onFinishGame}));return(r,a)=>(g(),h("div",us,[m(dt,{component:e.GameComponent,componentProps:n.value},null,8,["component","componentProps"])]))}}),gs={class:"space-y-6"},hs={class:"opacity-80 pointer-events-none grayscale-[0.2]"},ys={class:"glass-dark p-8 border border-white/5 shadow-glass-dark rounded-[2.5rem] animate-fade-in-up"},fs={class:"flex flex-col md:flex-row items-center justify-between gap-6"},ms={class:"flex items-center gap-4"},bs={class:"h-14 w-14 bg-primary/10 rounded-2xl flex items-center justify-center border border-primary/20 shadow-neon"},vs={class:"flex gap-4 w-full md:w-auto"},ws=ne({__name:"FinishedPhase",props:{GameComponent:{},connectedPeers:{},playerInfos:{},isInitiator:{type:Boolean},ledger:{},onBackToLobby:{type:Function}},setup(e){const t=e,n=C(()=>({connections:t.connectedPeers,playerNames:t.playerInfos.map(r=>r.name),playerInfos:t.playerInfos,isInitiator:t.isInitiator,ledger:t.ledger,onAddLedger:()=>{},onFinishGame:()=>{}}));return(r,a)=>(g(),h("div",gs,[s("div",hs,[m(dt,{component:e.GameComponent,componentProps:n.value},null,8,["component","componentProps"])]),s("div",ys,[s("div",fs,[s("div",ms,[s("div",bs,[m(l(Se),{class:"w-8 h-8 text-primary"})]),a[1]||(a[1]=s("div",{class:"space-y-1"},[s("h3",{class:"text-xl font-black text-white uppercase tracking-tight"},"Match Finalized"),s("p",{class:"text-[10px] text-white/30 uppercase tracking-widest font-black"},"All cycles complete. Handshake terminated.")],-1))]),s("div",vs,[s("button",{onClick:a[0]||(a[0]=(...b)=>e.onBackToLobby&&e.onBackToLobby(...b)),class:"w-full md:w-56 h-14 rounded-2xl bg-primary text-primary-foreground shadow-neon hover:shadow-[0_0_30px_rgba(16,185,129,0.4)] font-black uppercase tracking-[0.3em] text-xs transition-all"}," Return to Discovery ")])])]),a[2]||(a[2]=s("div",{class:"text-center text-white/10 text-[9px] font-black uppercase tracking-[0.4em] italic pt-4"}," Node state captured. Verification record locked inside vault. ",-1))]))}}),xs={class:"glass-dark p-8 rounded-[2rem] border border-white/5 shadow-glass-dark"},Ss={class:"text-xs font-black uppercase tracking-[0.3em] text-white/40 mb-6 flex items-center gap-3"},ks={class:"space-y-4"},Cs={class:"relative"},Is={key:0,class:"absolute inset-0 h-3 w-3 bg-primary rounded-full animate-ping opacity-50"},Es={class:"flex flex-col flex-1"},As={class:"flex items-center gap-2"},_s={class:"text-sm font-black text-white uppercase tracking-tight"},Ns={key:0,class:"text-primary font-black ml-1"},Ps={key:0,class:"px-2 py-0.5 bg-primary/10 text-primary border border-primary/20 rounded-full text-[9px] font-black uppercase tracking-wider"},Ts={key:0,class:"flex items-center gap-2 mt-2"},Gs=["onClick","aria-checked"],Rs={class:"text-[9px] text-white/40 uppercase tracking-wider font-medium"},Ls={class:"text-[8px] text-white/30"},Os={key:0,class:"ml-auto flex items-center gap-3"},Ks=["onClick"],$s={key:0,class:"text-[10px] text-white/20 uppercase font-black tracking-[0.3em] text-center py-6 animate-pulse"},Ds=ne({__name:"Players",props:{players:{},onRemove:{type:Function},onSaveIdentity:{type:Function},isKnownIdentity:{type:Function}},setup(e){const t=e,n=D({}),r=D({}),a=async()=>{for(const y of t.players)y.publicKey&&!y.isLocal&&t.isKnownIdentity&&(n.value[y.id]=await t.isKnownIdentity(y.publicKey))},b=async y=>{const x=r.value[y.id],u=!x;console.log("[Players] Toggle save for:",y.name,"from",x,"to",u),u?await w(y):r.value[y.id]=!1},w=async y=>{if(console.log("[Players] Attempting to save identity for:",y.name,"publicKey:",y.publicKey,"isLocal:",y.isLocal),!y.publicKey){console.warn("[Players] Cannot save identity - no public key for:",y.name);return}if(!t.onSaveIdentity){console.warn("[Players] Cannot save identity - onSaveIdentity prop not provided");return}try{r.value[y.id]=!0,await t.onSaveIdentity(y),n.value[y.id]=!0,console.log("[Players] Successfully saved identity for:",y.name)}catch(x){console.error("[Players] Error saving identity:",x),r.value[y.id]=!1}};return ot(()=>{a()}),Y(()=>t.players,()=>{a()},{deep:!0}),(y,x)=>(g(),h("div",xs,[s("h3",Ss,[m(l(ke),{class:"w-5 h-5 text-primary"}),G(" Dwellers In Lobby ("+R(e.players.length)+") ",1)]),s("div",ks,[(g(!0),h(ee,null,De(e.players,u=>(g(),h("div",{key:u.id,class:"flex items-center gap-4 p-4 rounded-2xl bg-white/5 border border-white/10 group hover:neon-border transition-all duration-500 animate-fade-in-left"},[s("div",Cs,[s("div",{class:ue(["h-3 w-3 rounded-full",u.isConnected?"bg-primary shadow-neon":"bg-rose-500 shadow-[0_0_15px_rgba(244,63,94,0.4)]"])},null,2),u.isConnected?(g(),h("div",Is)):E("",!0)]),s("div",Es,[s("div",As,[s("span",_s,[G(R(u.name)+" ",1),u.isLocal?(g(),h("span",Ns,"(LOCAL)")):E("",!0)]),!u.isLocal&&n.value[u.id]?(g(),h("span",Ps," Known Identity ")):E("",!0)]),!u.isLocal&&u.isConnected&&!n.value[u.id]?(g(),h("div",Ts,[s("button",{onClick:P=>b(u),class:ue(["relative inline-flex h-5 w-9 items-center rounded-full transition-colors duration-200",r.value[u.id]?"bg-primary":"bg-white/10"]),role:"switch","aria-checked":r.value[u.id]},[s("span",{class:ue(["inline-block h-3 w-3 transform rounded-full bg-white transition-transform duration-200",r.value[u.id]?"translate-x-5":"translate-x-1"])},null,2)],10,Gs),s("span",Rs,R(r.value[u.id]?"Saved for auto-approve":"Auto-approve next time"),1),s("span",Ls,R(u.isLocal?"(Local)":"(Remote)")+" "+R(u.publicKey?"PK":"PK"),1)])):E("",!0)]),u.isConnected?E("",!0):(g(),h("div",Os,[x[0]||(x[0]=s("span",{class:"text-[9px] text-rose-500 font-black uppercase tracking-widest"},"Node Disconnected",-1)),e.onRemove&&!u.isLocal?(g(),h("button",{key:0,class:"h-8 w-8 flex items-center justify-center text-rose-500 hover:text-rose-400 hover:bg-rose-500/10 transition-colors border border-transparent hover:border-rose-500/30 rounded-xl",onClick:P=>e.onRemove(u.id),title:"Sever entry"},[m(l(_t),{class:"w-4 h-4"})],8,Ks)):E("",!0)]))]))),128)),e.players.length===0?(g(),h("p",$s," Scanning for incoming nodes... ")):E("",!0)])]))}}),Ms={class:"min-h-screen bg-background"},Fs={key:0,class:"max-w-7xl mx-auto p-6 space-y-12"},js={class:"text-3xl font-black tracking-tighter uppercase text-white"},Bs={class:"text-gradient"},Js={class:"animate-fade-in-up"},Us={class:"mt-12 max-w-2xl"},Hs={key:1,class:"p-10 text-center text-white/50 uppercase font-black tracking-widest"},Vs="server",ea=ne({__name:"BoardView",setup(e){const t=st(),n=at(),r=C(()=>t.params.gameId),a=C(()=>t.params.boardId),b=C(()=>rt(r.value||"")),w=()=>n.push("/games"),{snapshot:y,send:x,playerInfos:u,connectedPeers:P,pendingSignaling:U,pendingJoinRequests:I,isInitiator:A,isGameStarted:v,onHostAGame:p,isKnownIdentity:S,onApprovePeer:W,onRejectPeer:Q,saveIdentityOnApprove:Ce,updateOffer:Ie,updateAnswer:se,startGame:ge,onFinishGame:he,onAddLedger:ae,onAcceptGuest:Ee,onRejectGuest:Ae,onCancelSignaling:_e,onBackToGames:ye,signalingClient:fe,isServerConnecting:Ne}=jt(),Pe=async B=>{if(console.log("[BoardView] handleSavePlayerIdentity called for:",B.name,"publicKey:",B.publicKey),!B.publicKey){console.warn("[BoardView] Cannot save - no public key");return}const V={id:`identity-${Date.now()}`,name:B.name,publicKey:B.publicKey,addedAt:Date.now()};console.log("[BoardView] Saving identity to DB:",V),await pe.addKnownIdentity(V),console.log("[BoardView] Identity saved successfully"),xe.success("Identity Saved",{description:`${B.name} has been added to your known identities.`})},me=C(()=>P.value),Te=()=>{ye(),w()},be=C(()=>y.value?.matches("finished")||!1),Ge=C(()=>!v.value&&!be.value),ve=B=>{Ge.value&&(B.preventDefault(),B.returnValue="")};return ot(async()=>{if(await pe.cleanupOldHostedSessions(),a.value&&y.value?.matches("idle"))if(await pe.isHosting(a.value)){const V=parseInt(t.query.maxPlayers)||2;console.log("[BOARDVIEW] Initializing HOST state for boardId:",a.value,"maxPlayers:",V),x({type:"HOST",maxPlayers:V,boardId:a.value})}else console.log("[BOARDVIEW] Initializing GUEST state for boardId:",a.value),x({type:"JOIN",boardId:a.value});window.addEventListener("beforeunload",ve)}),it(()=>{window.removeEventListener("beforeunload",ve)}),(B,V)=>(g(),h("div",Ms,[b.value?(g(),h("div",Fs,[s("h1",js,[V[0]||(V[0]=G(" Lobby: ",-1)),s("span",Bs,R(b.value.name),1)]),s("div",Js,[be.value?(g(),z(ws,{key:0,GameComponent:b.value.component,connectedPeers:me.value,playerInfos:l(u),isInitiator:l(A),ledger:l(y)?.context?.ledger||[],onBackToLobby:w},null,8,["GameComponent","connectedPeers","playerInfos","isInitiator","ledger"])):l(v)?(g(),z(ps,{key:1,GameComponent:b.value.component,connectedPeers:me.value,playerInfos:l(u),isInitiator:l(A),ledger:l(y)?.context?.ledger||[],onAddLedger:l(ae),onFinishGame:l(he)},null,8,["GameComponent","connectedPeers","playerInfos","isInitiator","ledger","onAddLedger","onFinishGame"])):(g(),z(cs,{key:2,state:l(y),isInitiator:l(A),signalingMode:Vs,isServerConnecting:l(Ne),signalingClient:l(fe),pendingSignaling:l(U),pendingJoinRequests:l(I),isKnownIdentity:l(S),onStartGame:l(ge),onHostAGame:l(p),onUpdateOffer:l(Ie),onUpdateAnswer:l(se),onCloseSession:Te,onBackToLobby:w,onAcceptGuest:l(Ee),onRejectGuest:l(Ae),onApprovePeer:l(W),onRejectPeer:l(Q),onSaveIdentity:l(Ce),onCancelSignaling:l(_e),onRemovePlayer:ce=>l(x)({type:"REMOVE_PLAYER",playerId:ce}),playerCount:l(u).length,maxPlayers:l(y)?.context?.maxPlayers||2,boardId:a.value,gameId:r.value},null,8,["state","isInitiator","isServerConnecting","signalingClient","pendingSignaling","pendingJoinRequests","isKnownIdentity","onStartGame","onHostAGame","onUpdateOffer","onUpdateAnswer","onAcceptGuest","onRejectGuest","onApprovePeer","onRejectPeer","onSaveIdentity","onCancelSignaling","onRemovePlayer","playerCount","maxPlayers","boardId","gameId"])),s("div",Us,[m(Ds,{players:l(u),onRemove:l(A)?ce=>l(x)({type:"REMOVE_PLAYER",playerId:ce}):void 0,onSaveIdentity:Pe,isKnownIdentity:l(S)},null,8,["players","onRemove","isKnownIdentity"])])])])):(g(),h("div",Hs," Game not found in grid. "))]))}});export{ea as default};
