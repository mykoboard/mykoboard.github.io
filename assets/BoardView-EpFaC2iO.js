import{c as Q,v as ut,x as Ge,y as Y,r as j,m as K,z as et,u as tt,h as w,A as pt,s as gt,d as X,a as h,i as I,f as d,b as s,e as m,j as A,F as q,t as R,l as J,o as p,_ as Z,k as Le,q as N,T as ht,p as ft,B as mt,C as yt,D as nt,E as vt,G as bt,H as xt,n as wt,g as kt}from"./index-ONKj0NaX.js";import{v as Oe,a as st}from"./GameRegistry-DQ9pSSJs.js";import{i as oe}from"./_virtual___federation_fn_import-yRRi-QZS.js";import{S as Te,C as ye,T as Me}from"./sessions-K8GePfrH.js";import{d as $e,_ as Fe,R as je,A as Be,k as Je,O as Ue,V as He,F as Ke,M as Ve,N as Ye,T as ze}from"./db-B-WYgfi2.js";const St=Q("check",[["path",{d:"M20 6 9 17l-5-5",key:"1gmf2c"}]]);const We=Q("clipboard",[["rect",{width:"8",height:"4",x:"8",y:"2",rx:"1",ry:"1",key:"tgr4d6"}],["path",{d:"M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2",key:"116196"}]]);const Ct=Q("copy",[["rect",{width:"14",height:"14",x:"8",y:"8",rx:"2",ry:"2",key:"17jyea"}],["path",{d:"M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2",key:"zix9uf"}]]);const It=Q("link",[["path",{d:"M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71",key:"1cjeqo"}],["path",{d:"M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71",key:"19qd67"}]]);const Et=Q("log-in",[["path",{d:"m10 17 5-5-5-5",key:"1bsop3"}],["path",{d:"M15 12H3",key:"6jk70r"}],["path",{d:"M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4",key:"u53s6r"}]]);const At=Q("user-minus",[["path",{d:"M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2",key:"1yyitq"}],["circle",{cx:"9",cy:"7",r:"4",key:"nufk8"}],["line",{x1:"22",x2:"16",y1:"11",y2:"11",key:"1shjgl"}]]);const ve=Q("user-plus",[["path",{d:"M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2",key:"1yyitq"}],["circle",{cx:"9",cy:"7",r:"4",key:"nufk8"}],["line",{x1:"19",x2:"19",y1:"8",y2:"14",key:"1bvyxn"}],["line",{x1:"22",x2:"16",y1:"11",y2:"11",key:"1shjgl"}]]),{createActor:Xs,toObserver:Zs}=await oe("xstate");function _t(e,t){return e===t}const qe=()=>{};function Tt(e,t,n=_t){const i=ut(e)?e:Ge(e),a=Ge(t(i.value?.getSnapshot())),y=S=>{n(a.value,S)||(a.value=S)};return Y(i,(S,T,x)=>{if(a.value=t(S?.getSnapshot()),!S)return;const g=S.subscribe({next:L=>{y(t(L))},error:qe,complete:qe});x(()=>g.unsubscribe())},{immediate:!0}),a}const ae=!1,Nt=()=>{const e={net:ae,state:ae,info:ae,error:!0,lobby:ae,sig:ae,webrtc:ae};try{const t=localStorage.getItem("debug_config");if(t)return{...e,...JSON.parse(t)}}catch{}return e},Pt=Nt(),l={shouldLog:e=>Pt[e],netIn:(e,t)=>{if(!l.shouldLog("net"))return;let n=t;try{n=JSON.parse(t)}catch{}console.log("%c[NET-IN] %cfrom %s:","color: #22c55e; font-weight: bold;","color: #64748b;",e.slice(0,8),n)},netOut:(e,t)=>{if(!l.shouldLog("net"))return;let n=t;try{n=JSON.parse(t)}catch{}console.log("%c[NET-OUT] %cto %s:","color: #3b82f6; font-weight: bold;","color: #64748b;",e.slice(0,8),n)},state:(e,t,n,i="state")=>{if(!l.shouldLog(i))return;console.log("%c[%s-%s] %c%s",`color: ${e==="EVENT"?"#f59e0b":"#10b981"}; font-weight: bold;`,i.toUpperCase(),e,"color: inherit;",t,n||"")},lobby:(e,t,n)=>{l.state(e,t,n,"lobby")},sig:(e,...t)=>{l.shouldLog("sig")&&console.log("%c[SIG] %c%s","color: #ec4899; font-weight: bold;","color: inherit;",e,...t)},webrtc:(e,...t)=>{l.shouldLog("webrtc")&&console.log("%c[WEBRTC] %c%s","color: #06b6d4; font-weight: bold;","color: inherit;",e,...t)},info:(...e)=>{l.shouldLog("info")&&console.log("%c[INFO]","color: #8b5cf6; font-weight: bold;",...e)},error:(...e)=>{l.shouldLog("error")&&console.error("%c[ERROR]","color: #ef4444; font-weight: bold;",...e)}};var _=(e=>(e.new="new",e.started="started",e.readyToAccept="readyToAccept",e.accepted="accepted",e.answered="answered",e.connected="established",e.closed="closed",e))(_||{});class ce{id;peerConnection;localPlayerName;remotePlayerName;dataChannel;iceCandidates;status;signal;messageListeners=[];onClose;updateView;constructor(t){this.id=Oe(),this.updateView=t,this.peerConnection=new RTCPeerConnection(Rt),this.iceCandidates=[];let n=null;this.peerConnection.onicecandidate=i=>{i.candidate&&(this.iceCandidates.push(i.candidate),(this.status==="started"||this.status==="answered")&&(this.updateSignal(),n&&clearTimeout(n),n=setTimeout(()=>{this.updateView(this),n=null},200)))},this.peerConnection.onconnectionstatechange=i=>{const a=this.peerConnection.connectionState;l.webrtc(this.id+": Connection state changed to "+a),a==="connected"?(this.status="established",this.updateView(this)):(a==="disconnected"||a==="failed"||a==="closed")&&this.close()}}updateSignal(t){this.peerConnection.localDescription&&(this.signal=new de(this.id,this.peerConnection.localDescription,t||this.localPlayerName,this.iceCandidates))}openDataChannel(){this.dataChannel=this.peerConnection.createDataChannel("gameData"),this.dataChannel.onopen=t=>l.webrtc(this.id+" Data channel state is: "+this.dataChannel.readyState),this.dataChannel.onclose=t=>l.webrtc(this.id+" Data channel state is: "+this.dataChannel.readyState),this.dataChannel.onerror=t=>l.error(this.id+" Error ",t),this.dataChannel.onmessage=t=>{l.netIn(this.id,t.data),this.messageListeners.forEach(n=>n(t.data))}}setDataChannelCallback(){this.peerConnection.ondatachannel=t=>{l.webrtc("Receive Channel Callback",t),this.dataChannel=t.channel,this.dataChannel.onmessage=n=>{l.netIn(this.id,n.data),this.messageListeners.forEach(i=>i(n.data))},this.dataChannel.onopen=n=>{const i=this.dataChannel.readyState;l.webrtc(this.id+": Data channel state is: "+i),i=="open"&&(l.webrtc(this.id+": Sending ping"),this.send("Ping"))},this.dataChannel.onclose=n=>{const i=this.dataChannel.readyState;l.webrtc(this.id+": Data channel state is: "+i)}}}async prepareOfferSignal(t){this.localPlayerName=t,this.status="new";try{const n=await this.peerConnection.createOffer();await this.peerConnection.setLocalDescription(n),this.status="started",this.updateSignal(),this.updateView(this)}catch(n){this.onCreateSessionDescriptionError(n)}}async send(t){this.dataChannel&&this.dataChannel.readyState==="open"&&(l.netOut(this.id,t),await this.dataChannel.send(t))}addMessageListener(t){this.messageListeners.push(t)}removeMessageListener(t){this.messageListeners=this.messageListeners.filter(n=>n!==t)}async acceptOffer(t,n){const i=typeof t=="string"?de.fromString(t):t;this.remotePlayerName=i.playerName,this.localPlayerName=n,await this.peerConnection.setRemoteDescription(i.session),i.iceCandidates.forEach(a=>{this.peerConnection.addIceCandidate(a)});try{const a=await this.peerConnection.createAnswer();await this.peerConnection.setLocalDescription(a),this.status="answered",this.updateSignal(),this.updateView(this),this.updateView(this)}catch(a){this.onCreateSessionDescriptionError(a)}}onCreateSessionDescriptionError(t){l.error("Failed to create session description: "+t.toString())}async acceptAnswer(t){const n=typeof t=="string"?de.fromString(t):t;l.webrtc(this.id+": Accepting answer signal from "+n.playerName);try{await this.peerConnection.setRemoteDescription(n.session),this.remotePlayerName=n.playerName,n.iceCandidates&&(l.webrtc(this.id+`: Adding ${n.iceCandidates.length} ICE candidates from answer`),n.iceCandidates.forEach(i=>{this.peerConnection.addIceCandidate(i).catch(a=>l.error("Error adding ICE candidate:",a))})),this.updateView(this)}catch(i){l.error(this.id+": Failed to set remote description from answer",i)}}close(){this.dataChannel&&this.dataChannel.close(),this.peerConnection.close(),this.status="closed",this.onClose?.(),this.updateView(this)}}class de{session;connectionId;playerName;iceCandidates;constructor(t,n,i,a){this.session=n,this.connectionId=t,this.playerName=i,this.iceCandidates=a}toString(){return btoa(JSON.stringify(this))}static fromString(t){const n=JSON.parse(atob(t));return new de(n.connectionId,n.session,n.playerName,n.iceCandidates)}}const Rt={iceServers:[{urls:"stun:stun.l.google.com:19302"}]};class Gt{socket=null;onMessageCallback;gameId;boardId;peerName;publicKey=null;constructor(t,n,i,a){this.gameId=t,this.boardId=n||"",this.peerName=i,this.onMessageCallback=a}updateBoardId(t){l.sig(`Updating signaling boardId from ${this.boardId} to ${t}`),this.boardId=t}async connect(t,n,i){let a="wss://pebsg4v5yk.execute-api.eu-central-1.amazonaws.com/production";const y=new URLSearchParams;y.append("x-api-key",t),n&&(y.append("x-pubkey",n),this.publicKey=n),i&&y.append("x-sig",i);const S=`${a}?${y.toString()}`;return new Promise((T,x)=>{l.sig(`Connecting to signaling server: ${S}`),this.socket=new WebSocket(S),this.socket.onopen=()=>{l.sig("WebSocket Connection Open."),T()},this.socket.onmessage=g=>{l.sig("Raw message from server:",g.data);try{const L=JSON.parse(g.data);this.onMessageCallback(L)}catch(L){l.error("Failed to parse signaling message",L)}},this.socket.onclose=g=>{l.sig("Disconnected from signaling server",g.code,g.reason),this.socket=null},this.socket.onerror=g=>{l.error("Signaling WebSocket error:",g),x(g)}})}hostRegister(t,n,i,a){return l.sig("Registering as host for board:",t),this.send({type:"hostRegister",boardId:t,gameId:n,peerName:i,publicKey:a})}guestJoin(t,n,i,a){return l.sig("Joining as guest for board:",t),this.send({type:"guestJoin",boardId:t,peerName:n,publicKey:i,encryptionPublicKey:a})}hostOffer(t,n,i,a,y){return l.sig("Sending offer to guest:",t),this.send({type:"hostOffer",target:t,guestPublicKey:n,offer:i,peerName:this.peerName,publicKey:this.publicKey||void 0,encryptionPublicKey:a,iv:y,boardId:this.boardId})}guestAnswer(t,n,i,a){return l.sig("Sending answer to host:",t),this.send({type:"guestAnswer",target:t,publicKey:n,answer:i,peerName:this.peerName,iv:a,boardId:this.boardId})}deleteOffer(){if(!this.socket||this.socket.readyState!==WebSocket.OPEN){l.sig("Cannot delete offer: Signaling socket is not open.");return}l.sig("Deleting offer for game:",this.gameId,"board:",this.boardId),this.send({type:"deleteOffer",gameId:this.gameId,...this.boardId?{boardId:this.boardId}:{}})}send(t){if(!this.socket||this.socket.readyState!==WebSocket.OPEN)return l.error("Signaling socket not open. State:",this.socket?.readyState),!1;const n={action:"sendMessage",...t};return l.sig("Sending payload to AWS:",n),this.socket.send(JSON.stringify(n)),!0}disconnect(t=!1){t&&this.isConnected&&this.deleteOffer(),this.socket?.close(),this.socket=null}get isConnected(){return!!this.socket&&this.socket.readyState===WebSocket.OPEN}}const{createMachine:Lt,assign:Ne}=await oe("xstate"),Ot=Lt({types:{},id:"lobby",initial:"selection",context:({input:e})=>({playerName:e.playerName,signalingMode:null,playerCount:2}),states:{selection:{on:{SELECT_MODE:{target:"discovery",actions:Ne({signalingMode:({event:e})=>e.mode})}}},discovery:{on:{GOTO_SELECTION:"selection",SET_PLAYER_COUNT:{actions:Ne({playerCount:({event:e})=>e.count})},SELECT_MODE:{actions:Ne({signalingMode:({event:e})=>e.mode})}}}}}),{createMachine:$t,assign:P}=await oe("xstate"),{createLobbyMessage:me}=await oe("@mykoboard/integration"),Dt=$t({types:{},id:"board",initial:"idle",context:({input:e})=>({connections:new Map,playerStatuses:new Map,isInitiator:e.isInitiator||!1,isGameStarted:!1,isGameFinished:!1,playerName:e.playerName,ledger:[],pendingGuest:null,externalParticipants:[],maxPlayers:e.maxPlayers||2,boardId:e.boardId||""}),states:{idle:{on:{HOST:{target:"hosting",actions:P({isInitiator:!0,maxPlayers:({event:e})=>e.maxPlayers||2,boardId:({event:e})=>e.boardId})},JOIN:{target:"joining",actions:P({isInitiator:!1,boardId:({event:e})=>e.boardId})}}},hosting:{on:{REQUEST_JOIN:{target:"approving",actions:P({pendingGuest:({event:e})=>({id:e.connectionId,name:e.peerName,answer:e.answer,connection:e.connection})})}},always:[{target:"preparation",guard:"hasConnections"}]},joining:{always:[{target:"preparation",guard:"hasConnections"}]},approving:{on:{ACCEPT_GUEST:{target:"preparation",actions:["acceptGuest","clearPendingGuest"]},REJECT_GUEST:{target:"hosting",actions:["rejectGuest","clearPendingGuest"]}}},preparation:{on:{START_GAME:{target:"playing",actions:["setGameStarted","broadcastStartGame"]},GAME_STARTED:{target:"playing",actions:"setGameStarted"},REQUEST_JOIN:{target:"approving",actions:P({pendingGuest:({event:e})=>({id:e.connectionId,name:e.peerName,answer:e.answer,connection:e.connection})})}}},playing:{on:{FINISH_GAME:{target:"finished",actions:P({isGameFinished:!0})}}},finished:{on:{RESET_GAME:{target:"preparation",actions:["resetGameStarted","broadcastResetGame"]}}}},on:{UPDATE_CONNECTION:{actions:["updateConnection","syncConnection"]},PEER_DISCONNECTED:{actions:["updateConnectionStatus","removeConnection"]},SET_PLAYER_STATUS:{actions:"setPlayerStatus"},REMOVE_PLAYER:{actions:"removePlayer"},SYNC_LEDGER:{actions:"syncLedger"},LOAD_LEDGER:{actions:P({ledger:({event:e})=>e.ledger})},SYNC_PARTICIPANTS:{actions:P({externalParticipants:({event:e})=>e.participants})},GAME_STARTED:{actions:"setGameStarted"},GAME_RESET:{actions:"resetGameStarted"},CLOSE_SESSION:{target:".idle",actions:["resetContext","closeAllConnections"]}}},{actions:{setGameStarted:P({isGameStarted:!0,isGameFinished:!1}),resetGameStarted:P({isGameStarted:!1,isGameFinished:!1,ledger:[]}),setPlayerStatus:P(({context:e,event:t})=>{if(t.type!=="SET_PLAYER_STATUS")return e;const n=new Map(e.playerStatuses);return n.set(t.playerId,t.status),{playerStatuses:n}}),updateConnectionStatus:P(({context:e,event:t})=>{if(t.type!=="PEER_DISCONNECTED")return e;const n=new Map(e.connections),i=n.get(t.connectionId);return i&&(i.status=_.closed),{connections:n}}),updateConnection:P(({context:e,event:t})=>{if(t.type!=="UPDATE_CONNECTION")return e;const n=t.connection;if(n.status===_.closed&&!e.connections.has(n.id))return e;const i=e.connections.get(n.id);if(i){const S=i._lastKnownStatus!==n.status,T=i._lastKnownSignal!==(n.signal?.toString()||"");if(!S&&!T)return e}n._lastKnownStatus=n.status,n._lastKnownSignal=n.signal?.toString()||"";const a=new Map(e.connections);a.set(n.id,n);const y=new Map(e.playerStatuses);return y.has(n.id)||y.set(n.id,"lobby"),{connections:a,playerStatuses:y}}),syncConnection:({context:e,event:t})=>{if(t.type!=="UPDATE_CONNECTION")return;const n=t.connection;if(e.isInitiator&&n.status===_.connected){if(n._synced)return;n._synced=!0,l.lobby("STATE",`Syncing new connection: ${n.id}`),n.send(JSON.stringify(me("SYNC_LEDGER",e.ledger))),e.isGameStarted&&n.send(JSON.stringify(me("GAME_STARTED")))}},removeConnection:P(({context:e,event:t})=>{if(t.type!=="PEER_DISCONNECTED")return e;const n=new Map(e.connections);return n.delete(t.connectionId),{connections:n}}),removePlayer:P(({context:e,event:t})=>{if(t.type!=="REMOVE_PLAYER")return e;const n=new Map(e.connections),i=n.get(t.playerId);i&&(i.close(),n.delete(t.playerId));const a=new Map(e.playerStatuses);return a.delete(t.playerId),{connections:n,playerStatuses:a}}),syncLedger:P(({context:e,event:t})=>t.type!=="SYNC_LEDGER"?e:{ledger:t.ledger}),broadcastStartGame:({context:e})=>{e.isInitiator&&e.connections.forEach(t=>{t.status===_.connected&&t.send(JSON.stringify(me("START_GAME")))})},broadcastResetGame:({context:e})=>{e.isInitiator&&e.connections.forEach(t=>{t.status===_.connected&&t.send(JSON.stringify(me("GAME_RESET")))})},closeAllConnections:({context:e})=>{e.connections.forEach(t=>t.close())},acceptGuest:({context:e})=>{e.pendingGuest&&(l.sig("Accepting guest:",e.pendingGuest.name),e.pendingGuest.connection.acceptAnswer(e.pendingGuest.answer))},rejectGuest:({context:e})=>{e.pendingGuest&&(l.sig("Rejecting guest:",e.pendingGuest.name),e.pendingGuest.connection.close())},resetContext:P(({context:e})=>({connections:new Map,playerStatuses:new Map,ledger:[],isGameStarted:!1,isGameFinished:!1,isInitiator:!1,maxPlayers:e.maxPlayers,pendingGuest:null,externalParticipants:[],boardId:""})),clearPendingGuest:P({pendingGuest:null})},guards:{hasConnections:({context:e})=>Array.from(e.connections.values()).some(t=>t.status===_.connected)}}),{createActor:at}=await oe("xstate"),V=j(null),ot=j(!0),Qe=j([]);at(Ot,{input:{playerName:"Anonymous"}}).start();const Pe=new Map;function Re(e,t,n=!1,i=2){if(!Pe.has(e)){l.lobby("STATE",`Creating new board actor for ${e}`);const a=at(Dt,{input:{playerName:t,boardId:e,isInitiator:n,maxPlayers:i}});a.start(),Pe.set(e,a)}return Pe.get(e)}const Mt=async()=>{if(V.value)return;const e=K.getInstance();V.value=await e.getIdentity(),ot.value=!1};Mt();const{Ledger:Ft,createLobbyMessage:le,isLobbyMessage:Xe}=await oe("@mykoboard/integration");function jt(){const e=et(),t=tt(),n=j(null),i=j(!1),a=j(""),y=j(!1),S=j([]),T=j(new Map),x=w(()=>e.params.gameId),g=w(()=>e.params.boardId),L=w(()=>st(x.value||"")),M=w(()=>!!g.value),v=w(()=>!g.value||g.value==="manual"?null:Re(g.value,V.value?.name||"Anonymous",!1)),c=Tt(v,o=>o),b=w(()=>c.value?.context?.isInitiator||!1),B=w(()=>c.value?.context?.isGameStarted||!1),be=w(()=>c.value?.context?.connections||new Map),ie=w(()=>Array.from(be.value.values())),U=w(()=>ie.value.filter(o=>o.status===_.connected)),xe=w(()=>ie.value.filter(o=>o.status!==_.connected&&o.status!==_.closed));w(()=>!!c.value&&c.value.status!=="idle");const we=w(()=>M.value?"game":"lobby"),ee=w(()=>{if(!c.value)return[];const o=c.value.context,r=Qe.value.find(u=>u.boardId===g.value),f=r?.participants||[],C=o.externalParticipants||[],E=f.find(u=>u.isYou),F={id:V.value?.id||"local",name:o.playerName,status:B.value?"game":"lobby",isConnected:!0,isLocal:!0,isHost:E?E.isHost:b.value},k=[],O=new Set;if(b.value)k.push(F),O.add(F.id);else if(C.length>0){const u=C.find(G=>G.isHost);if(u){const G=U.value.find($=>$.status===_.connected);k.push({id:u.id,name:u.name,status:(G?o.playerStatuses.get(G.id):null)||(B.value?"game":"lobby"),isConnected:!!G,isLocal:!1,isHost:!0}),O.add(u.id)}}return b.value?ie.value.forEach(u=>{if(!O.has(u.id)){const G=f.find($=>$.id===u.id);k.push({id:u.id,name:u.remotePlayerName||G?.name||"Anonymous",status:o.playerStatuses.get(u.id)||"lobby",isConnected:u.status===_.connected,isLocal:!1,isHost:!1}),O.add(u.id)}}):C.length>0&&C.forEach(u=>{u.isHost||u.id==="local"||(u.name===F.name&&!O.has(u.id)?(k.push({...F,id:u.id}),O.add(u.id)):(k.push({id:u.id,name:u.name,status:B.value?"game":"lobby",isConnected:!0,isLocal:!1,isHost:!1}),O.add(u.id)))}),f.forEach(u=>{!u.isYou&&!O.has(u.id)&&k.push({id:u.id,name:u.name,status:r?.status==="finished"||B.value?"game":"lobby",isConnected:!1,isLocal:!1,isHost:u.isHost})}),k});pt(()=>{const o=c.value;o?.status==="active"&&g.value&&g.value!=="manual"&&Te.saveSession({gameId:x.value,boardId:g.value,playerName:o.context.playerName,gameName:L.value?.name||"Unknown Game",lastPlayed:Date.now(),status:o.matches("finished")?"finished":"active",ledger:o.context.ledger,participants:ee.value.map(r=>({id:r.id,name:r.name,isYou:r.isLocal,isHost:r.isHost}))})});const ue=new Map,pe=new Map,te=o=>{const r=v.value;if(!r)return;const f=ue.get(o.id),C=o.signal?.toString()||"",E=pe.get(o.id);f===o.status&&E===C||(ue.set(o.id,o.status),pe.set(o.id,C),r.send({type:"UPDATE_CONNECTION",connection:o}),o._hasListener||(o.addMessageListener(F=>{try{const k=JSON.parse(F);if(!Xe(k))return;if(k.type==="START_GAME"&&r.send({type:"START_GAME"}),k.type==="GAME_STARTED"&&r.send({type:"GAME_STARTED"}),k.type==="GAME_RESET"&&r.send({type:"GAME_RESET"}),k.type==="NEW_BOARD"&&t.replace(`/games/${x.value}/${k.payload}`),k.type==="SYNC_PLAYER_STATUS"&&r.send({type:"SET_PLAYER_STATUS",playerId:o.id,status:k.payload}),k.type==="SYNC_PARTICIPANTS"&&r.send({type:"SYNC_PARTICIPANTS",participants:k.payload}),k.type==="SYNC_LEDGER"){const O=k.payload;for(const u of O)u.signature&&u.signerPublicKey&&K.verify(u.action,u.signature,u.signerPublicKey).then(G=>{G||l.error("Invalid signature in ledger entry",u)});r.send({type:"SYNC_LEDGER",ledger:k.payload})}}catch{}}),o._hasListener=!0))},ke=async(o,r)=>{const f=r||o;if(l.sig("setupSignaling called with gameId:",o,"boardId:",r,"resolved currentBoardId:",f),!!f&&(a.value!==f&&n.value?.isConnected&&(l.sig("Switching signaling board assignment from",a.value,"to",f),n.value.updateBoardId(f),a.value=f),(!n.value||!n.value.isConnected)&&!i.value)){i.value=!0;try{const C=K.getInstance(),E=await C.getIdentity();if(E){const F=new Gt(o||"default",f,E.name,u=>{if(u.type==="error"&&(l.error("Signaling error:",u.message||u.code),gt.error(u.message||"Signaling error occurred"),u.code==="DUPLICATE_IDENTITY"&&t.replace(`/games/${o}`)),u.type==="peerJoined"&&(l.sig("Peer joined:",u.peerName,"publicKey:",u.publicKey),S.value.push({connectionId:u.from,peerName:u.peerName||"Guest",publicKey:u.publicKey,encryptionPublicKey:u.encryptionPublicKey,timestamp:Date.now()})),u.type==="offer"){l.sig("Received offer from host:",u.from);const G=u.boardId||a.value;if(!G){l.error("No valid target board UUID for offer message");return}const $=Re(G,E.name,!1),H=new ce(W=>{$.send({type:"UPDATE_CONNECTION",connection:W})});H.addMessageListener(W=>{try{const D=JSON.parse(W);if(!Xe(D))return;if(D.type==="START_GAME"&&$.send({type:"START_GAME"}),D.type==="GAME_STARTED"&&$.send({type:"GAME_STARTED"}),D.type==="GAME_RESET"&&$.send({type:"GAME_RESET"}),D.type==="NEW_BOARD"&&t.replace(`/games/${o.value}/${D.payload}`),D.type==="SYNC_PLAYER_STATUS"&&$.send({type:"SET_PLAYER_STATUS",playerId:H.id,status:D.payload}),D.type==="SYNC_PARTICIPANTS"&&$.send({type:"SYNC_PARTICIPANTS",participants:D.payload}),D.type==="SYNC_LEDGER"){const De=D.payload;for(const se of De)se.signature&&se.signerPublicKey&&K.verify(se.action,se.signature,se.signerPublicKey).then(dt=>{dt||l.error("Invalid signature in ledger entry",se)});$.send({type:"SYNC_LEDGER",ledger:De})}}catch(D){l.error("Failed to parse message:",D)}}),H.onClose=()=>{$.send({type:"PEER_DISCONNECTED",connectionId:H.id})},H.setDataChannelCallback(),H.acceptOffer(u.offer,E.name).then(()=>{const W=setInterval(()=>{H.signal&&n.value&&(clearInterval(W),l.sig("Sending answer to host:",u.from),n.value.guestAnswer(u.from,E.publicKey,H.signal,void 0))},100)}).catch(W=>{l.error("Failed to accept offer and generate answer:",W)})}if(u.type==="answer"){l.sig("Received answer from guest:",u.from,"publicKey:",u.publicKey);const G=T.value.get(u.from);if(G&&u.answer){l.sig("Applying answer to connection:",u.from);try{G.acceptAnswer(u.answer),l.sig("WebRTC connection established with:",u.from),T.value.delete(u.from)}catch($){l.error("Failed to accept answer:",$)}}else l.error("No pending connection found for:",u.from)}}),k=`SIGN_IN:${E.subscriptionToken}`,O=await C.sign(k);await F.connect(E.subscriptionToken,E.publicKey,O),n.value=F,a.value=f}}catch(C){l.error("Failed to connect to signaling server:",C)}finally{i.value=!1}}},Se=async(o=2)=>{if(M.value)v.value&&g.value&&l.sig("Manual onHostAGame called (not used in new flow)");else{const r=Oe();t.push(`/games/${x.value}/${r}?maxPlayers=${o}`)}},Ce=async()=>{if(!g.value||!n.value?.isConnected){l.error("Cannot join as guest: missing boardId or signaling not connected");return}const r=await K.getInstance().getIdentity();r&&(l.sig("Sending guestJoin for boardId:",g.value),n.value.guestJoin(g.value,r.name,r.publicKey,r.publicKey))},Ie=async o=>(await $e.getAllFriends()).some(f=>f.publicKey===o),Ee=async o=>{l.sig("Approving peer:",o.peerName,"publicKey:",o.publicKey),S.value=S.value.filter(C=>C.connectionId!==o.connectionId);const r=new ce(C=>{v.value?.send({type:"UPDATE_CONNECTION",connection:C})});r.onClose=()=>{v.value?.send({type:"PEER_DISCONNECTED",connectionId:r.id}),T.value.delete(o.connectionId)},r.openDataChannel(),await r.prepareOfferSignal(c.value?.context?.playerName||V.value?.name||"Anonymous"),T.value.set(o.connectionId,r);const f=setInterval(()=>{r.signal&&n.value&&(clearInterval(f),K.getInstance().getIdentity().then(E=>{E&&n.value&&n.value.hostOffer(o.connectionId,o.publicKey,r.signal,E.publicKey,void 0)}))},100)},ge=o=>{l.sig("Rejecting peer:",o.peerName),S.value=S.value.filter(r=>r.connectionId!==o.connectionId)},Ae=()=>{n.value&&b.value&&n.value.deleteOffer(),v.value?.send({type:"START_GAME"})},he=()=>{if(!v.value)return;v.value.send({type:"JOIN",boardId:g.value});const o=new ce(te);o.onClose=()=>v.value?.send({type:"PEER_DISCONNECTED",connectionId:o.id}),o.status=_.readyToAccept,o.setDataChannelCallback(),te(o)},_e=async(o,r)=>{if(!(!(o instanceof ce)||!r))try{await o.acceptOffer(r,V.value?.name||"Anonymous")}catch(f){l.error("Failed to accept offer",f)}},fe=(o,r)=>{if(!(!(o instanceof ce)||!r))try{o.acceptAnswer(r),te(o)}catch(f){l.error("Failed to accept answer",f)}},ne=()=>{v.value?.send({type:"FINISH_GAME"}),g.value&&Te.updateStatus(g.value,"finished")},z=async o=>{if(!b.value||!v.value)return;const r=K.getInstance(),f=await r.getIdentity();if(!f)return;const C=await r.sign(o),E=Ft.fromEntries(c.value?.context?.ledger||[]),F=await E.addEntry({...o});F.signature=C,F.signerPublicKey=f.publicKey;const k=E.getEntries();v.value.send({type:"SYNC_LEDGER",ledger:k}),U.value.forEach(O=>{O.send(JSON.stringify(le("SYNC_LEDGER",k)))})},re=()=>{const o=Oe();U.value.forEach(r=>{r.status===_.connected&&r.send(JSON.stringify(le("NEW_BOARD",o)))}),n.value?.deleteOffer(),v.value?.send({type:"CLOSE_SESSION"}),t.push(`/games/${x.value}/${o}`)},rt=()=>{const o=c.value?.context?.pendingGuest;v.value?.send({type:"ACCEPT_GUEST"}),o&&te(o.connection)},ct=()=>v.value?.send({type:"REJECT_GUEST"}),lt=o=>{o.close(),v.value?.send({type:"PEER_DISCONNECTED",connectionId:o.id})};return Y([b,ee],()=>{if(!b.value)return;const o=ee.value.map(r=>({id:r.id,name:r.name,isHost:r.isHost}));U.value.forEach(r=>{if(r.status===_.connected)try{r.send(JSON.stringify(le("SYNC_PARTICIPANTS",o)))}catch(f){l.error("Failed to sync participants to peer",r.id,f)}})},{deep:!0,immediate:!0}),Y([g,M],async()=>{const o=M.value&&g.value;l.sig("[WATCH] Signaling Lifecycle update. shouldConnect:",o,"boardId:",g.value),o&&await ke(x.value,g.value)},{immediate:!0}),Y([n,c,g],async()=>{if(!n.value?.isConnected||!g.value||y.value)return;const r=await K.getInstance().getIdentity();if(!r)return;const f=c.value;if(!f)return;const C=f.matches("hosting")||f.matches("preparation"),E=f.matches("joining");C&&f.context.isInitiator?(l.sig("Auto-registering as HOST for boardId:",g.value,"state:",f.value),n.value.hostRegister(g.value,x.value,r.name,r.publicKey),y.value=!0):(E||!f.context.isInitiator)&&(l.sig("Auto-joining as GUEST for boardId:",g.value,"state:",f.value),n.value.guestJoin(g.value,r.name,r.publicKey,r.publicKey),y.value=!0)}),Y(g,async o=>{if(o&&o!=="manual"&&M.value){const r=await Te.getSession(o),f=Re(o,V.value?.name||"Anonymous",!1),C=f.getSnapshot().context;r&&r.ledger.length>0&&C.ledger.length===0&&(f.send({type:"LOAD_LEDGER",ledger:r.ledger}),f.send({type:"GAME_STARTED"}),r.status==="finished"&&setTimeout(()=>f.send({type:"FINISH_GAME"}),10))}},{immediate:!0}),Y(U,o=>{o.forEach(r=>{r._hasInitialSync||(r.send(JSON.stringify(le("SYNC_PLAYER_STATUS",we.value))),b.value&&g.value&&g.value!=="manual"&&r.send(JSON.stringify(le("NEW_BOARD",g.value))),r._hasInitialSync=!0)})}),{identity:V,isLoading:ot,snapshot:c,send:o=>v.value?.send(o),signalingClient:n,isServerConnecting:i,pendingJoinRequests:S,activeSessions:Qe,playerInfos:ee,connectedPeers:U,pendingSignaling:xe,isInitiator:b,isGameStarted:B,onHostAGame:Se,onJoinAsGuest:Ce,isFriend:Ie,onApprovePeer:Ee,onRejectPeer:ge,startGame:Ae,connectWithOffer:he,updateOffer:_e,updateAnswer:fe,onFinishGame:ne,onAddLedger:z,handlePlayAgain:re,onAcceptGuest:rt,onRejectGuest:ct,onCancelSignaling:lt,onBackToGames:()=>t.push(`/games/${x.value}`),onBackToDiscovery:()=>t.push(`/games/${x.value}`)}}const Bt={class:"space-y-4 animate-fade-in-up"},Jt={key:0,class:"glass-dark p-6 rounded-2xl border border-white/5 shadow-glass-dark flex items-center justify-center space-x-4"},Ut={key:1,class:"glass-dark p-6 rounded-2xl border border-white/5 shadow-glass-dark"},Ht={class:"text-sm font-black text-white uppercase tracking-[0.2em] mb-4 flex items-center gap-3"},Kt={key:2,class:"glass-dark p-6 rounded-2xl border border-white/5 shadow-glass-dark group hover:border-primary/20 transition-all duration-500"},Vt={class:"text-[10px] font-black uppercase tracking-[0.2em] mb-4 flex items-center gap-2 text-primary"},Yt={class:"space-y-4"},zt={class:"p-4 bg-white/5 rounded-xl border border-white/10 relative group min-h-[64px] flex items-center group-hover:neon-border transition-all duration-500"},Wt={class:"text-[10px] font-mono break-all line-clamp-2 text-white/40 pr-8"},qt={key:1,class:"text-[10px] text-white/20 italic tracking-wider"},Qt={key:3,class:"glass-dark p-6 rounded-2xl border border-white/5 shadow-glass-dark group hover:border-primary/20 transition-all duration-500"},Xt={class:"text-[10px] font-black uppercase tracking-[0.2em] mb-4 flex items-center gap-2 text-primary"},Zt={class:"space-y-3"},en={class:"p-4 bg-white/5 rounded-xl border border-white/10 relative group min-h-[64px] flex items-center group-hover:neon-border transition-all duration-500"},tn={class:"text-[10px] font-mono break-all line-clamp-2 text-white/40 pr-8"},nn={key:1,class:"text-[10px] text-white/20 italic tracking-wider"},sn={key:4,class:"flex justify-end"},an=X({__name:"SignalingStep",props:{connection:{},onOfferChange:{type:Function},onAnswerChange:{type:Function},onCancel:{type:Function}},setup(e){const t=j(!1),n=i=>{i&&(navigator.clipboard.writeText(i),t.value=!0,setTimeout(()=>t.value=!1,2e3))};return(i,a)=>(p(),h("div",Bt,[e.connection.status===d(_).new?(p(),h("div",Jt,[...a[5]||(a[5]=[s("div",{class:"animate-spin rounded-full h-5 w-5 border-b-2 border-primary"},null,-1),s("p",{class:"text-sm text-white/50 font-bold uppercase tracking-widest"},"Generating invite signal...",-1)])])):I("",!0),e.connection.status===d(_).readyToAccept?(p(),h("div",Ut,[s("h3",Ht,[m(d(Et),{class:"w-5 h-5 text-primary"}),a[6]||(a[6]=A(" Paste Join Offer ",-1))]),a[7]||(a[7]=s("p",{class:"text-[10px] text-white/30 uppercase tracking-widest mb-4"},"External node signal required for connection.",-1)),m(Fe,{placeholder:"Paste offer string here...",className:"h-12 bg-white/5 border-white/10 rounded-xl focus:ring-primary text-white font-mono text-xs placeholder:text-white/20","onUpdate:modelValue":a[0]||(a[0]=y=>e.onOfferChange(e.connection,y))})])):I("",!0),e.connection.status===d(_).started?(p(),h("div",Kt,[s("h3",Vt,[m(d(ve),{class:"w-4 h-4"}),a[8]||(a[8]=A(" Active Invite Vector ",-1))]),s("div",Yt,[s("div",zt,[e.connection.signal?(p(),h(q,{key:0},[s("div",Wt,R(e.connection.signal.toString()),1),s("button",{class:"absolute top-2 right-2 h-8 w-8 flex items-center justify-center text-primary hover:bg-primary/10 transition-colors rounded-lg",onClick:a[1]||(a[1]=y=>n(e.connection.signal.toString()))},[t.value?(p(),J(d(ye),{key:0,class:"w-4 h-4"})):(p(),J(d(We),{key:1,class:"w-4 h-4"}))])],64)):(p(),h("div",qt,"Gathering node connection details..."))]),a[9]||(a[9]=s("p",{class:"text-[10px] text-white/30 uppercase font-medium leading-relaxed tracking-wider"}," Transmit this vector to a peer node. Their response will be synthesized automatically. ",-1)),m(Fe,{placeholder:"Awaiting peer response vector...",className:"h-10 bg-white/5 border-white/10 rounded-xl focus:ring-primary text-white font-mono text-[10px] placeholder:text-white/20","onUpdate:modelValue":a[2]||(a[2]=y=>e.onAnswerChange(e.connection,y))})])])):I("",!0),e.connection.status===d(_).answered?(p(),h("div",Qt,[s("h3",Xt,[m(d(ye),{class:"w-4 h-4"}),a[10]||(a[10]=A(" Signal Response Synthesized ",-1))]),s("div",Zt,[s("div",en,[e.connection.signal?(p(),h(q,{key:0},[s("div",tn,R(e.connection.signal.toString()),1),s("button",{class:"absolute top-2 right-2 h-8 w-8 flex items-center justify-center text-primary hover:bg-primary/10 transition-colors rounded-lg",onClick:a[3]||(a[3]=y=>n(e.connection.signal.toString()))},[t.value?(p(),J(d(ye),{key:0,class:"w-4 h-4"})):(p(),J(d(We),{key:1,class:"w-4 h-4"}))])],64)):(p(),h("div",nn,"Finalizing response..."))]),a[11]||(a[11]=s("p",{class:"text-[10px] text-primary font-black uppercase tracking-widest"},"Transmit this payload back to peer to complete handshake.",-1))])])):I("",!0),e.onCancel?(p(),h("div",sn,[s("button",{onClick:a[4]||(a[4]=y=>e.onCancel(e.connection)),class:"text-[10px] font-black uppercase tracking-widest text-white/20 hover:text-rose-500 transition-colors p-2"}," De-initialize Link ")])):I("",!0)]))}}),Ze=Z(an,[["__scopeId","data-v-77356793"]]),on={class:"space-y-8"},rn={key:0,class:"fixed inset-0 z-[100] flex items-center justify-center bg-[#0A0A0A]/80 backdrop-blur-xl animate-fade-in p-6"},cn={class:"glass-dark p-10 w-full max-w-md shadow-2xl border border-white/10 rounded-[2.5rem] space-y-8 animate-zoom-in"},ln={class:"flex flex-col items-center text-center space-y-6"},dn={class:"h-20 w-20 bg-primary/10 rounded-[1.5rem] flex items-center justify-center border border-primary/20 shadow-neon"},un={class:"space-y-2"},pn={class:"text-white/40 uppercase tracking-widest text-[10px] font-medium leading-relaxed"},gn={class:"font-black text-primary px-1"},hn={class:"grid grid-cols-2 gap-4"},fn={key:1,class:"glass-dark p-8 border border-primary/20 shadow-glass-dark rounded-[2.5rem] animate-zoom-in space-y-6"},mn={class:"flex items-center gap-4"},yn={class:"w-12 h-12 rounded-2xl bg-primary/10 flex items-center justify-center border border-primary/20"},vn={class:"space-y-1"},bn={class:"text-white/40 uppercase tracking-widest text-[10px] font-medium"},xn={class:"space-y-4"},wn={class:"flex items-start justify-between"},kn={class:"space-y-2"},Sn={class:"flex items-center gap-2"},Cn={class:"text-lg font-black text-white"},In={key:0,class:"px-2 py-0.5 bg-primary/10 text-primary border border-primary/20 rounded-full text-[9px] font-black uppercase tracking-wider"},En={class:"text-xs text-white/40 font-mono"},An={class:"grid grid-cols-2 gap-3"},_n=["onClick"],Tn=["onClick"],Nn={key:2,class:"glass-dark p-10 text-center space-y-8 border border-white/5 shadow-glass-dark rounded-[3rem] animate-zoom-in"},Pn={class:"space-y-4"},Rn={class:"inline-flex items-center gap-2 px-4 py-1.5 bg-primary/10 text-primary border border-primary/20 rounded-full text-[10px] font-black uppercase tracking-[0.2em] shadow-neon transform -translate-y-2"},Gn={class:"text-4xl font-black text-white uppercase tracking-tighter"},Ln={class:"text-xs text-white/30 uppercase font-black tracking-widest leading-relaxed max-w-lg mx-auto"},On={key:0,class:"flex flex-col items-center gap-6"},$n={class:"space-y-4"},Dn={class:"mx-auto h-16 w-16 bg-rose-500/10 rounded-2xl flex items-center justify-center border border-rose-500/20"},Mn={class:"grid grid-cols-2 gap-4 pt-6"},Fn={key:1,class:"flex flex-col items-center gap-8 py-6"},jn={key:0,class:"relative"},Bn={class:"space-y-3"},Jn={class:"text-xl font-black text-white uppercase tracking-tight"},Un={class:"text-[10px] text-white/30 uppercase tracking-[0.2em] max-w-xs mx-auto font-medium leading-relaxed"},Hn={class:"space-y-4"},Kn={class:"mx-auto h-16 w-16 bg-rose-500/10 rounded-2xl flex items-center justify-center border border-rose-500/20"},Vn={class:"grid grid-cols-2 gap-4 pt-6"},Yn={key:2,class:"pt-8 border-t border-white/5 space-y-6"},zn={key:0,class:"glass-dark p-8 rounded-[2rem] border border-white/10 shadow-glass-dark space-y-6 group hover:border-primary/30 transition-all duration-500"},Wn={class:"flex items-center justify-between"},qn={class:"flex items-center gap-3"},Qn={class:"p-2.5 bg-primary/10 rounded-xl border border-primary/20"},Xn={class:"relative flex items-center gap-3"},Zn={class:"flex-grow bg-black/40 border border-white/10 rounded-xl px-4 py-3.5 font-mono text-[11px] text-white/60 truncate transition-all group-hover:bg-black/60 group-hover:border-white/20"},es={key:"check",class:"flex items-center gap-2 animate-bounce-short"},ts={key:"copy",class:"flex items-center gap-2"},ns={key:1,class:"space-y-4 text-left"},ss={class:"grid grid-cols-1 gap-6"},as={key:3,class:"pt-8 border-t border-white/5 text-left"},os={key:3,class:"py-24 flex flex-col items-center justify-center space-y-6 border border-white/5 bg-white/5 rounded-[3rem] backdrop-blur-sm animate-fade-in"},is=X({__name:"PreparationPhase",props:{state:{},isInitiator:{type:Boolean},signalingMode:{},isServerConnecting:{type:Boolean},signalingClient:{},pendingSignaling:{},pendingJoinRequests:{},isFriend:{type:Function},onStartGame:{type:Function},onHostAGame:{type:Function},onUpdateOffer:{type:Function},onUpdateAnswer:{type:Function},onCloseSession:{type:Function},onBackToLobby:{type:Function},onAcceptGuest:{type:Function},onRejectGuest:{type:Function},onApprovePeer:{type:Function},onRejectPeer:{type:Function},onCancelSignaling:{type:Function},onRemovePlayer:{type:Function},playerCount:{},maxPlayers:{},boardId:{},gameId:{}},setup(e){const t=e,n=j({}),i=async v=>{t.isFriend&&(n.value[v]=await t.isFriend(v))},a=v=>v.length<=20?v:`${v.substring(0,10)}...${v.substring(v.length-10)}`,y=j(!1),S=w(()=>`${window.location.origin}${window.location.pathname}#/games/${t.gameId}/${t.boardId}`),T=async()=>{try{await navigator.clipboard.writeText(S.value),y.value=!0,setTimeout(()=>{y.value=!1},2e3)}catch(v){console.error("Failed to copy link:",v)}};Y(()=>t.pendingJoinRequests,v=>{v&&v.forEach(c=>{c.publicKey in n.value||i(c.publicKey)})},{deep:!0,immediate:!0});const x=w(()=>t.state.matches("preparation")),g=w(()=>t.state.matches("hosting")),L=w(()=>t.state.matches("joining")),M=w(()=>t.state.matches("approving"));return(v,c)=>(p(),h("div",on,[M.value&&e.state.context.pendingGuest?(p(),h("div",rn,[s("div",cn,[s("div",ln,[s("div",dn,[m(d(ve),{class:"w-10 h-10 text-primary animate-pulse"})]),s("div",un,[c[6]||(c[6]=s("h2",{class:"text-2xl font-black text-white uppercase tracking-tight"},"Handshake Request",-1)),s("p",pn,[c[4]||(c[4]=A(" Entity ",-1)),s("span",gn,R(e.state.context.pendingGuest.name),1),c[5]||(c[5]=A(" attempts to bridge into session. ",-1))])])]),s("div",hn,[s("button",{onClick:c[0]||(c[0]=(...b)=>e.onRejectGuest&&e.onRejectGuest(...b)),class:"h-14 rounded-2xl border border-white/10 text-white/60 hover:text-rose-500 hover:bg-rose-500/10 hover:border-rose-500/30 font-black uppercase tracking-widest text-xs transition-all"}," De-authorize "),s("button",{onClick:c[1]||(c[1]=(...b)=>e.onAcceptGuest&&e.onAcceptGuest(...b)),class:"h-14 rounded-2xl bg-primary text-primary-foreground shadow-neon hover:shadow-[0_0_30px_rgba(16,185,129,0.4)] font-black uppercase tracking-widest text-xs transition-all"}," Grant Access ")])])])):I("",!0),e.isInitiator&&e.pendingJoinRequests&&e.pendingJoinRequests.length>0?(p(),h("div",fn,[s("div",mn,[s("div",yn,[m(d(ve),{class:"w-6 h-6 text-primary"})]),s("div",vn,[c[7]||(c[7]=s("h2",{class:"text-2xl font-black text-white uppercase tracking-tight"},"Join Requests",-1)),s("p",bn,R(e.pendingJoinRequests.length)+" "+R(e.pendingJoinRequests.length===1?"peer":"peers")+" waiting for approval ",1)])]),s("div",xn,[(p(!0),h(q,null,Le(e.pendingJoinRequests,b=>(p(),h("div",{key:b.connectionId,class:"glass-darker p-6 rounded-2xl border border-white/5 space-y-4"},[s("div",wn,[s("div",kn,[s("div",Sn,[s("span",Cn,R(b.peerName),1),n.value[b.publicKey]?(p(),h("span",In," Friend ")):I("",!0)]),s("p",En,R(a(b.publicKey)),1)])]),s("div",An,[s("button",{onClick:B=>e.onRejectPeer&&e.onRejectPeer(b),class:"h-12 rounded-xl border border-white/10 text-white/60 hover:text-rose-500 hover:bg-rose-500/10 hover:border-rose-500/30 font-black uppercase tracking-widest text-xs transition-all"}," Reject ",8,_n),s("button",{onClick:B=>e.onApprovePeer&&e.onApprovePeer(b),class:"h-12 rounded-xl bg-primary text-primary-foreground shadow-neon hover:shadow-[0_0_30px_rgba(16,185,129,0.4)] font-black uppercase tracking-widest text-xs transition-all"}," Approve ",8,Tn)])]))),128))])])):I("",!0),g.value||L.value||x.value||M.value?(p(),h("div",Nn,[s("div",Pn,[s("div",Rn,R(g.value||M.value?"Broadcasting Session":L.value?"Initializing Node":"Command Lobby Active"),1),s("h2",Gn,R(x.value?"Game Room":g.value?"Link Establishment":"Connecting..."),1),s("p",Ln,[x.value?(p(),h(q,{key:0},[A(R(e.isInitiator?`Authorize peer nodes or launch protocol when ready (${e.playerCount}/${e.maxPlayers}).`:"Waiting for initiator to launch protocol."),1)],64)):(p(),h(q,{key:1},[A("Synthesizing direct P2P mesh link to session nodes.")],64))])]),e.isInitiator?(p(),h("div",On,[x.value?(p(),h("button",{key:0,onClick:c[2]||(c[2]=(...b)=>e.onStartGame&&e.onStartGame(...b)),class:"w-full max-w-sm h-16 text-sm font-black uppercase tracking-[0.5em] rounded-2xl bg-primary text-primary-foreground shadow-[0_0_30px_rgba(16,185,129,0.3)] hover:shadow-[0_0_50px_rgba(16,185,129,0.5)] transition-all active:scale-[0.98]"}," Launch Protocol ")):I("",!0),m(d(ze),null,{default:N(()=>[m(d(je),{asChild:""},{default:N(()=>[...c[8]||(c[8]=[s("button",{class:"px-4 h-12 rounded-xl text-white/20 hover:text-rose-500 font-black uppercase tracking-widest text-[10px] transition-colors"}," Terminate Session ",-1)])]),_:1}),m(d(Be),null,{default:N(()=>[m(d(Je),{class:"bg-black/80 fixed inset-0 z-[100] backdrop-blur-sm"}),m(d(Ue),{class:"glass-dark border border-white/10 rounded-[2rem] p-8 max-w-sm fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 z-[101]"},{default:N(()=>[s("div",$n,[s("div",Dn,[m(d(Me),{class:"w-8 h-8 text-rose-500"})]),m(d(He),{class:"text-xl font-black text-center text-white uppercase tracking-tight"},{default:N(()=>[...c[9]||(c[9]=[A(" Terminate Session? ",-1)])]),_:1}),m(d(Ke),{class:"text-center text-white/40 text-xs font-medium uppercase tracking-widest leading-relaxed"},{default:N(()=>[...c[10]||(c[10]=[A(" Reloading or leaving will cause the game session to be lost. Peers will be disconnected and discovery mesh link terminated. ",-1)])]),_:1})]),s("div",Mn,[m(d(Ve),{class:"h-12 rounded-xl bg-white/5 border border-white/5 text-white/60 hover:bg-white/10 font-bold uppercase tracking-widest text-[10px]"},{default:N(()=>[...c[11]||(c[11]=[A(" Abort ",-1)])]),_:1}),m(d(Ye),{onClick:e.onCloseSession,class:"h-12 rounded-xl bg-rose-500 text-white font-black uppercase tracking-widest text-[10px] hover:bg-rose-600 shadow-neon-sm"},{default:N(()=>[...c[12]||(c[12]=[A(" Confirm ",-1)])]),_:1},8,["onClick"])])]),_:1})]),_:1})]),_:1})])):(p(),h("div",Fn,[x.value?I("",!0):(p(),h("div",jn,[...c[13]||(c[13]=[s("div",{class:"animate-spin rounded-full h-20 w-20 border-4 border-primary/5 border-t-primary shadow-neon"},null,-1),s("div",{class:"absolute inset-0 flex items-center justify-center"},[s("div",{class:"h-3 w-3 bg-primary rounded-full animate-pulse shadow-neon"})],-1)])])),s("div",Bn,[s("h3",Jn,R(x.value?"Node Synced":"Bridging Connections"),1),s("p",Un,R(x.value?"Identity verified. Awaiting initiator's launch command.":"Establishing secure encrypted tunnel to host node."),1)]),m(d(ze),null,{default:N(()=>[m(d(je),{asChild:""},{default:N(()=>[...c[14]||(c[14]=[s("button",{class:"h-10 text-white/20 hover:text-rose-500 font-black uppercase tracking-widest text-[10px] transition-colors"}," Sever Connection ",-1)])]),_:1}),m(d(Be),null,{default:N(()=>[m(d(Je),{class:"bg-black/80 fixed inset-0 z-[100] backdrop-blur-sm"}),m(d(Ue),{class:"glass-dark border border-white/10 rounded-[2rem] p-8 max-w-sm fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 z-[101]"},{default:N(()=>[s("div",Hn,[s("div",Kn,[m(d(Me),{class:"w-8 h-8 text-rose-500"})]),m(d(He),{class:"text-xl font-black text-center text-white uppercase tracking-tight"},{default:N(()=>[...c[15]||(c[15]=[A(" Sever Connection? ",-1)])]),_:1}),m(d(Ke),{class:"text-center text-white/40 text-xs font-medium uppercase tracking-widest leading-relaxed"},{default:N(()=>[...c[16]||(c[16]=[A(" Leaving or reloading will sever your node link. The game session progress will be lost. ",-1)])]),_:1})]),s("div",Vn,[m(d(Ve),{class:"h-12 rounded-xl bg-white/5 border border-white/5 text-white/60 hover:bg-white/10 font-bold uppercase tracking-widest text-[10px]"},{default:N(()=>[...c[17]||(c[17]=[A(" Abort ",-1)])]),_:1}),m(d(Ye),{onClick:e.onBackToLobby,class:"h-12 rounded-xl bg-rose-500 text-white font-black uppercase tracking-widest text-[10px] hover:bg-rose-600 shadow-neon-sm"},{default:N(()=>[...c[18]||(c[18]=[A(" Confirm ",-1)])]),_:1},8,["onClick"])])]),_:1})]),_:1})]),_:1})])),e.isInitiator?(p(),h("div",Yn,[e.signalingMode==="server"?(p(),h("div",zn,[s("div",Wn,[s("div",qn,[s("div",Qn,[m(d(It),{class:"w-5 h-5 text-primary"})]),c[19]||(c[19]=s("div",{class:"text-left"},[s("h3",{class:"text-sm font-black text-white uppercase tracking-wider"},"Share Session Link"),s("p",{class:"text-[10px] text-white/30 uppercase tracking-widest font-medium"},"Link this node to the discovery mesh")],-1))]),c[20]||(c[20]=s("div",{class:"flex items-center gap-2 px-3 py-1 bg-primary/5 border border-primary/20 rounded-full"},[s("div",{class:"w-1.5 h-1.5 bg-primary rounded-full animate-pulse shadow-neon"}),s("span",{class:"text-[9px] font-black text-primary uppercase tracking-widest"},"Live Broadcast")],-1))]),s("div",Xn,[s("div",Zn,R(S.value),1),s("button",{onClick:T,class:"shrink-0 h-12 px-6 rounded-xl bg-primary text-primary-foreground font-black uppercase tracking-widest text-[10px] shadow-neon hover:shadow-[0_0_25px_rgba(16,185,129,0.4)] transition-all active:scale-95 flex items-center gap-2"},[m(ht,{mode:"out-in",name:"fade"},{default:N(()=>[y.value?(p(),h("div",es,[m(d(St),{class:"w-4 h-4"}),c[21]||(c[21]=A(" COPIED ",-1))])):(p(),h("div",ts,[m(d(Ct),{class:"w-4 h-4"}),c[22]||(c[22]=A(" COPY LINK ",-1))]))]),_:1})])])])):I("",!0),e.signalingMode==="manual"&&e.pendingSignaling.length>0?(p(),h("div",ns,[c[23]||(c[23]=s("h3",{class:"text-[11px] font-black text-white/20 uppercase tracking-[0.3em] px-1"},"Pending Link Authentications",-1)),s("div",ss,[(p(!0),h(q,null,Le(e.pendingSignaling,b=>(p(),J(Ze,{key:b.id,connection:b,onOfferChange:e.onUpdateOffer,onAnswerChange:e.onUpdateAnswer,onCancel:e.onCancelSignaling},null,8,["connection","onOfferChange","onAnswerChange","onCancel"]))),128))])])):I("",!0)])):I("",!0),!e.isInitiator&&L.value&&e.signalingMode==="manual"&&e.pendingSignaling.length>0?(p(),h("div",as,[m(Ze,{connection:e.pendingSignaling[0],onOfferChange:e.onUpdateOffer,onAnswerChange:e.onUpdateAnswer,onCancel:e.onCancelSignaling},null,8,["connection","onOfferChange","onAnswerChange","onCancel"])])):I("",!0)])):I("",!0),!g.value&&!L.value&&!x.value&&!M.value?(p(),h("div",os,[c[24]||(c[24]=ft('<div class="relative" data-v-245f7646><div class="h-20 w-20 bg-white/5 rounded-full flex items-center justify-center transition-transform hover:scale-110 duration-500" data-v-245f7646><div class="h-4 w-4 bg-white/10 rounded-full animate-ping" data-v-245f7646></div></div></div><div class="text-center space-y-2" data-v-245f7646><div class="text-xs font-black uppercase tracking-[0.5em] text-white/30" data-v-245f7646>Null Reference: No Active Session</div><p class="text-[10px] text-white/20 uppercase tracking-widest px-10 leading-relaxed font-medium" data-v-245f7646>Session data not found on current node. Return to discovery mesh.</p></div>',2)),s("button",{onClick:c[3]||(c[3]=(...b)=>e.onBackToLobby&&e.onBackToLobby(...b)),class:"h-12 px-8 rounded-xl border border-white/10 text-white/70 hover:text-primary hover:border-primary/40 font-black uppercase tracking-widest text-[10px] transition-all"}," Return to Discovery ")])):I("",!0)]))}}),rs=Z(is,[["__scopeId","data-v-245f7646"]]),cs={class:"react-wrapper-root"},ls={key:1,class:"p-20 text-center text-white/10 uppercase font-black tracking-[0.5em] animate-pulse"},ds=X({__name:"ReactComponentWrapper",props:{component:{},componentProps:{}},setup(e){const t=e,n=Ge(null);return Y(()=>t.component,i=>{if(i)try{const a=mt(i);n.value=yt(a)}catch(a){console.error("[ReactComponentWrapper] Failed to apply React in Vue:",a),n.value=null}else n.value=null},{immediate:!0}),nt(()=>{n.value=null}),(i,a)=>(p(),h("div",cs,[n.value?(p(),J(vt(n.value),bt(xt({key:0},e.componentProps)),null,16)):(p(),h("div",ls," Initialising Game... "))]))}}),it=Z(ds,[["__scopeId","data-v-941e587e"]]),us={class:"animate-zoom-in"},ps=X({__name:"ActivePhase",props:{GameComponent:{},connectedPeers:{},playerInfos:{},isInitiator:{type:Boolean},ledger:{},onAddLedger:{type:Function},onFinishGame:{type:Function}},setup(e){const t=e,n=w(()=>({connections:t.connectedPeers,playerNames:t.playerInfos.map(i=>i.name),playerInfos:t.playerInfos,isInitiator:t.isInitiator,ledger:t.ledger,onAddLedger:t.onAddLedger,onFinishGame:t.onFinishGame}));return(i,a)=>(p(),h("div",us,[m(it,{component:e.GameComponent,componentProps:n.value},null,8,["component","componentProps"])]))}}),gs=Z(ps,[["__scopeId","data-v-ba34ac07"]]),hs={class:"space-y-6"},fs={class:"opacity-80 pointer-events-none grayscale-[0.2]"},ms={class:"glass-dark p-8 border border-white/5 shadow-glass-dark rounded-[2.5rem] animate-fade-in-up"},ys={class:"flex flex-col md:flex-row items-center justify-between gap-6"},vs={class:"flex items-center gap-4"},bs={class:"h-14 w-14 bg-primary/10 rounded-2xl flex items-center justify-center border border-primary/20 shadow-neon"},xs={class:"flex gap-4 w-full md:w-auto"},ws=X({__name:"FinishedPhase",props:{GameComponent:{},connectedPeers:{},playerInfos:{},isInitiator:{type:Boolean},ledger:{},onBackToLobby:{type:Function}},setup(e){const t=e,n=w(()=>({connections:t.connectedPeers,playerNames:t.playerInfos.map(i=>i.name),playerInfos:t.playerInfos,isInitiator:t.isInitiator,ledger:t.ledger,onAddLedger:()=>{},onFinishGame:()=>{}}));return(i,a)=>(p(),h("div",hs,[s("div",fs,[m(it,{component:e.GameComponent,componentProps:n.value},null,8,["component","componentProps"])]),s("div",ms,[s("div",ys,[s("div",vs,[s("div",bs,[m(d(ye),{class:"w-8 h-8 text-primary"})]),a[1]||(a[1]=s("div",{class:"space-y-1"},[s("h3",{class:"text-xl font-black text-white uppercase tracking-tight"},"Match Finalized"),s("p",{class:"text-[10px] text-white/30 uppercase tracking-widest font-black"},"All cycles complete. Handshake terminated.")],-1))]),s("div",xs,[s("button",{onClick:a[0]||(a[0]=(...y)=>e.onBackToLobby&&e.onBackToLobby(...y)),class:"w-full md:w-56 h-14 rounded-2xl bg-primary text-primary-foreground shadow-neon hover:shadow-[0_0_30px_rgba(16,185,129,0.4)] font-black uppercase tracking-[0.3em] text-xs transition-all"}," Return to Discovery ")])])]),a[2]||(a[2]=s("div",{class:"text-center text-white/10 text-[9px] font-black uppercase tracking-[0.4em] italic pt-4"}," Node state captured. Verification record locked inside vault. ",-1))]))}}),ks=Z(ws,[["__scopeId","data-v-5868591e"]]),Ss={class:"glass-dark p-8 rounded-[2rem] border border-white/5 shadow-glass-dark"},Cs={class:"text-xs font-black uppercase tracking-[0.3em] text-white/40 mb-6 flex items-center gap-3"},Is={class:"space-y-4"},Es={class:"relative"},As={key:0,class:"absolute inset-0 h-3 w-3 bg-primary rounded-full animate-ping opacity-50"},_s={class:"flex flex-col"},Ts={class:"text-sm font-black text-white uppercase tracking-tight"},Ns={key:0,class:"text-primary font-black ml-1"},Ps={class:"text-[9px] text-white/30 uppercase tracking-[0.2em] font-bold"},Rs={key:0,class:"ml-auto flex items-center gap-3"},Gs=["onClick"],Ls={key:1,class:"ml-auto"},Os={key:0,class:"text-[10px] text-white/20 uppercase font-black tracking-[0.3em] text-center py-6 animate-pulse"},$s=X({__name:"Players",props:{players:{},onRemove:{type:Function}},setup(e){return(t,n)=>(p(),h("div",Ss,[s("h3",Cs,[m(d(ve),{class:"w-5 h-5 text-primary"}),A(" Dwellers In Lobby ("+R(e.players.length)+") ",1)]),s("div",Is,[(p(!0),h(q,null,Le(e.players,i=>(p(),h("div",{key:i.id,class:"flex items-center gap-4 p-4 rounded-2xl bg-white/5 border border-white/10 group hover:neon-border transition-all duration-500 animate-fade-in-left"},[s("div",Es,[s("div",{class:wt(["h-3 w-3 rounded-full",i.isConnected?"bg-primary shadow-neon":"bg-rose-500 shadow-[0_0_15px_rgba(244,63,94,0.4)]"])},null,2),i.isConnected?(p(),h("div",As)):I("",!0)]),s("div",_s,[s("span",Ts,[A(R(i.name)+" ",1),i.isLocal?(p(),h("span",Ns,"(LOCAL)")):I("",!0)]),s("span",Ps,R(i.status),1)]),i.isConnected?I("",!0):(p(),h("div",Rs,[n[0]||(n[0]=s("span",{class:"text-[9px] text-rose-500 font-black uppercase tracking-widest"},"Node Disconnected",-1)),e.onRemove&&!i.isLocal?(p(),h("button",{key:0,class:"h-8 w-8 flex items-center justify-center text-rose-500 hover:text-rose-400 hover:bg-rose-500/10 transition-colors border border-transparent hover:border-rose-500/30 rounded-xl",onClick:a=>e.onRemove(i.id),title:"Sever entry"},[m(d(At),{class:"w-4 h-4"})],8,Gs)):I("",!0)])),i.isConnected&&i.isLocal?(p(),h("div",Ls,[...n[1]||(n[1]=[s("span",{class:"text-[9px] text-primary font-black uppercase tracking-widest px-2 py-0.5 border border-primary/20 rounded-md"},"Authorized",-1)])])):I("",!0)]))),128)),e.players.length===0?(p(),h("p",Os," Scanning for incoming nodes... ")):I("",!0)])]))}}),Ds=Z($s,[["__scopeId","data-v-de8606a7"]]),Ms={class:"min-h-screen bg-background"},Fs={key:0,class:"max-w-7xl mx-auto p-6 space-y-12"},js={class:"text-3xl font-black tracking-tighter uppercase text-white"},Bs={class:"text-gradient"},Js={class:"animate-fade-in-up"},Us={class:"mt-12 max-w-2xl"},Hs={key:1,class:"p-10 text-center text-white/50 uppercase font-black tracking-widest"},Ks="server",Vs=X({__name:"BoardView",setup(e){const t=et(),n=tt(),i=w(()=>t.params.gameId),a=w(()=>t.params.boardId),y=w(()=>st(i.value||"")),S=()=>n.push("/games"),{snapshot:T,send:x,playerInfos:g,connectedPeers:L,pendingSignaling:M,pendingJoinRequests:v,isInitiator:c,isGameStarted:b,onHostAGame:B,isFriend:be,onApprovePeer:ie,onRejectPeer:U,updateOffer:xe,updateAnswer:we,startGame:ee,onFinishGame:ue,onAddLedger:pe,onAcceptGuest:te,onRejectGuest:ke,onCancelSignaling:Se,onBackToGames:Ce,signalingClient:Ie,isServerConnecting:Ee}=jt(),ge=w(()=>L.value),Ae=()=>{Ce(),S()},he=w(()=>T.value?.matches("finished")||!1),_e=w(()=>!b.value&&!he.value),fe=ne=>{_e.value&&(ne.preventDefault(),ne.returnValue="")};return kt(async()=>{if(await $e.cleanupOldHostedSessions(),a.value&&T.value?.matches("idle"))if(await $e.isHosting(a.value)){const z=parseInt(t.query.maxPlayers)||2;console.log("[BOARDVIEW] Initializing HOST state for boardId:",a.value,"maxPlayers:",z),x({type:"HOST",maxPlayers:z,boardId:a.value})}else console.log("[BOARDVIEW] Initializing GUEST state for boardId:",a.value),x({type:"JOIN",boardId:a.value});window.addEventListener("beforeunload",fe)}),nt(()=>{window.removeEventListener("beforeunload",fe)}),(ne,z)=>(p(),h("div",Ms,[y.value?(p(),h("div",Fs,[s("h1",js,[z[0]||(z[0]=A(" Lobby: ",-1)),s("span",Bs,R(y.value.name),1)]),s("div",Js,[he.value?(p(),J(ks,{key:0,GameComponent:y.value.component,connectedPeers:ge.value,playerInfos:d(g),isInitiator:d(c),ledger:d(T)?.context?.ledger||[],onBackToLobby:S},null,8,["GameComponent","connectedPeers","playerInfos","isInitiator","ledger"])):d(b)?(p(),J(gs,{key:1,GameComponent:y.value.component,connectedPeers:ge.value,playerInfos:d(g),isInitiator:d(c),ledger:d(T)?.context?.ledger||[],onAddLedger:d(pe),onFinishGame:d(ue)},null,8,["GameComponent","connectedPeers","playerInfos","isInitiator","ledger","onAddLedger","onFinishGame"])):(p(),J(rs,{key:2,state:d(T),isInitiator:d(c),signalingMode:Ks,isServerConnecting:d(Ee),signalingClient:d(Ie),pendingSignaling:d(M),pendingJoinRequests:d(v),isFriend:d(be),onStartGame:d(ee),onHostAGame:d(B),onUpdateOffer:d(xe),onUpdateAnswer:d(we),onCloseSession:Ae,onBackToLobby:S,onAcceptGuest:d(te),onRejectGuest:d(ke),onApprovePeer:d(ie),onRejectPeer:d(U),onCancelSignaling:d(Se),onRemovePlayer:re=>d(x)({type:"REMOVE_PLAYER",playerId:re}),playerCount:d(g).length,maxPlayers:d(T)?.context?.maxPlayers||2,boardId:a.value,gameId:i.value},null,8,["state","isInitiator","isServerConnecting","signalingClient","pendingSignaling","pendingJoinRequests","isFriend","onStartGame","onHostAGame","onUpdateOffer","onUpdateAnswer","onAcceptGuest","onRejectGuest","onApprovePeer","onRejectPeer","onCancelSignaling","onRemovePlayer","playerCount","maxPlayers","boardId","gameId"])),s("div",Us,[m(Ds,{players:d(g),onRemove:d(c)?re=>d(x)({type:"REMOVE_PLAYER",playerId:re}):void 0},null,8,["players","onRemove"])])])])):(p(),h("div",Hs," Game not found in grid. "))]))}}),ea=Z(Vs,[["__scopeId","data-v-f1b659f3"]]);export{ea as default};
