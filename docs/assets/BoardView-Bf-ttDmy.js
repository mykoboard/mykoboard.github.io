import{i as x}from"./_virtual___federation_fn_import-CeU1Qn0k.js";import{c as le,b as se,d as Kt,u as Dt,t as De}from"./index-DI_zRWUU.js";import{a as Mt}from"./GameRegistry-CcsrK8Dl.js";import{v as it,_ as Bt}from"./ReactComponentWrapper.vue_vue_type_script_setup_true_lang-Bn1XaSVP.js";import{S as Xe,C as Me,T as lt}from"./sessions-CsSBVdxg.js";import{d as Se}from"./db-DfQP2Aol.js";import{T as dt,R as ut,A as pt,k as gt,O as ht,V as mt,F as yt,M as ft,N as vt}from"./index-Cd93vkEr.js";import{_ as bt}from"./Input.vue_vue_type_script_setup_true_lang-DM5cVAL8.js";const Yt=le("check",[["path",{d:"M20 6 9 17l-5-5",key:"1gmf2c"}]]);const wt=le("clipboard",[["rect",{width:"8",height:"4",x:"8",y:"2",rx:"1",ry:"1",key:"tgr4d6"}],["path",{d:"M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2",key:"116196"}]]);const zt=le("copy",[["rect",{width:"14",height:"14",x:"8",y:"8",rx:"2",ry:"2",key:"17jyea"}],["path",{d:"M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2",key:"zix9uf"}]]);const Wt=le("link",[["path",{d:"M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71",key:"1cjeqo"}],["path",{d:"M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71",key:"19qd67"}]]);const Qt=le("log-in",[["path",{d:"m10 17 5-5-5-5",key:"1bsop3"}],["path",{d:"M15 12H3",key:"6jk70r"}],["path",{d:"M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4",key:"u53s6r"}]]);const Xt=le("user-minus",[["path",{d:"M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2",key:"1yyitq"}],["circle",{cx:"9",cy:"7",r:"4",key:"nufk8"}],["line",{x1:"22",x2:"16",y1:"11",y2:"11",key:"1shjgl"}]]);const Be=le("user-plus",[["path",{d:"M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2",key:"1yyitq"}],["circle",{cx:"9",cy:"7",r:"4",key:"nufk8"}],["line",{x1:"19",x2:"19",y1:"8",y2:"14",key:"1bvyxn"}],["line",{x1:"22",x2:"16",y1:"11",y2:"11",key:"1shjgl"}]]),pe=!1,Zt=()=>{const e={net:pe,state:pe,info:pe,error:!0,lobby:pe,sig:pe,webrtc:pe};try{const t=localStorage.getItem("debug_config");if(t)return{...e,...JSON.parse(t)}}catch{}return e},qt=Zt(),c={shouldLog:e=>qt[e],netIn:(e,t)=>{if(!c.shouldLog("net"))return;let n=t;try{n=JSON.parse(t)}catch{}console.log("%c[NET-IN] %cfrom %s:","color: #22c55e; font-weight: bold;","color: #64748b;",e.slice(0,8),n)},netOut:(e,t)=>{if(!c.shouldLog("net"))return;let n=t;try{n=JSON.parse(t)}catch{}console.log("%c[NET-OUT] %cto %s:","color: #3b82f6; font-weight: bold;","color: #64748b;",e.slice(0,8),n)},state:(e,t,n,i="state")=>{if(!c.shouldLog(i))return;console.log("%c[%s-%s] %c%s",`color: ${e==="EVENT"?"#f59e0b":"#10b981"}; font-weight: bold;`,i.toUpperCase(),e,"color: inherit;",t,n||"")},lobby:(e,t,n)=>{c.state(e,t,n,"lobby")},sig:(e,...t)=>{c.shouldLog("sig")&&console.log("%c[SIG] %c%s","color: #ec4899; font-weight: bold;","color: inherit;",e,...t)},webrtc:(e,...t)=>{c.shouldLog("webrtc")&&console.log("%c[WEBRTC] %c%s","color: #06b6d4; font-weight: bold;","color: inherit;",e,...t)},info:(...e)=>{c.shouldLog("info")&&console.log("%c[INFO]","color: #8b5cf6; font-weight: bold;",...e)},error:(...e)=>{c.shouldLog("error")&&console.error("%c[ERROR]","color: #ef4444; font-weight: bold;",...e)}};var $=(e=>(e.new="new",e.started="started",e.readyToAccept="readyToAccept",e.accepted="accepted",e.answered="answered",e.connected="established",e.closed="closed",e))($||{});class xt{id;peerConnection;localPlayerName;remotePlayerName;remotePublicKey;dataChannel;iceCandidates;status;signal;messageListeners=[];onClose;updateView;constructor(t){this.id=it(),this.updateView=t,this.peerConnection=new RTCPeerConnection(en),this.iceCandidates=[];let n=null;this.peerConnection.onicecandidate=i=>{i.candidate&&(this.iceCandidates.push(i.candidate),(this.status==="started"||this.status==="answered")&&(this.updateSignal(),n&&clearTimeout(n),n=setTimeout(()=>{this.updateView(this),n=null},200)))},this.peerConnection.onconnectionstatechange=i=>{const a=this.peerConnection.connectionState;c.webrtc(this.id+": Connection state changed to "+a),a==="connected"?(this.status="established",this.updateView(this)):(a==="disconnected"||a==="failed"||a==="closed")&&this.close()}}updateSignal(t){this.peerConnection.localDescription&&(this.signal=new ce(this.id,this.peerConnection.localDescription,t||this.localPlayerName,this.iceCandidates))}openDataChannel(){this.dataChannel=this.peerConnection.createDataChannel("gameData"),this.dataChannel.onopen=t=>c.webrtc(this.id+" Data channel state is: "+this.dataChannel.readyState),this.dataChannel.onclose=t=>c.webrtc(this.id+" Data channel state is: "+this.dataChannel.readyState),this.dataChannel.onerror=t=>c.error(this.id+" Error ",t),this.dataChannel.onmessage=t=>{c.netIn(this.id,t.data),this.messageListeners.forEach(n=>n(t.data))}}setDataChannelCallback(){this.peerConnection.ondatachannel=t=>{c.webrtc("Receive Channel Callback",t),this.dataChannel=t.channel,this.dataChannel.onmessage=n=>{c.netIn(this.id,n.data),this.messageListeners.forEach(i=>i(n.data))},this.dataChannel.onopen=n=>{const i=this.dataChannel.readyState;c.webrtc(this.id+": Data channel state is: "+i),i=="open"&&(c.webrtc(this.id+": Sending ping"),this.send("Ping"))},this.dataChannel.onclose=n=>{const i=this.dataChannel.readyState;c.webrtc(this.id+": Data channel state is: "+i)}}}async prepareOfferSignal(t){console.log("[WebRTC] prepareOfferSignal - playerName:",t),this.localPlayerName=t,this.status="new";try{const n=await this.peerConnection.createOffer();await this.peerConnection.setLocalDescription(n),this.status="started",this.updateSignal(),this.updateView(this)}catch(n){this.onCreateSessionDescriptionError(n)}}async send(t){this.dataChannel&&this.dataChannel.readyState==="open"&&(c.netOut(this.id,t),await this.dataChannel.send(t))}addMessageListener(t){this.messageListeners.push(t)}removeMessageListener(t){this.messageListeners=this.messageListeners.filter(n=>n!==t)}async acceptOffer(t,n){const i=typeof t=="string"?ce.fromString(t):t;console.log("[WebRTC] acceptOffer - acceptingPlayerName:",n),this.remotePlayerName=i.playerName,this.localPlayerName=n,await this.peerConnection.setRemoteDescription(i.session),i.iceCandidates.forEach(a=>{this.peerConnection.addIceCandidate(a)});try{const a=await this.peerConnection.createAnswer();await this.peerConnection.setLocalDescription(a),this.status="answered",this.updateSignal(),this.updateView(this),this.updateView(this)}catch(a){this.onCreateSessionDescriptionError(a)}}onCreateSessionDescriptionError(t){c.error("Failed to create session description: "+t.toString())}async acceptAnswer(t){const n=typeof t=="string"?ce.fromString(t):t;c.webrtc(this.id+": Accepting answer signal from "+n.playerName),console.log("[WebRTC] acceptAnswer - Guest name:",n.playerName);try{await this.peerConnection.setRemoteDescription(n.session),this.remotePlayerName=n.playerName,n.iceCandidates&&(c.webrtc(this.id+`: Adding ${n.iceCandidates.length} ICE candidates from answer`),n.iceCandidates.forEach(i=>{this.peerConnection.addIceCandidate(i).catch(a=>c.error("Error adding ICE candidate:",a))})),this.updateView(this)}catch(i){c.error(this.id+": Failed to set remote description from answer",i)}}close(){this.dataChannel&&this.dataChannel.close(),this.peerConnection.close(),this.status="closed",this.onClose?.(),this.updateView(this)}}class ce{connectionId;session;playerName;iceCandidates;constructor(t,n,i,a){this.session=n,this.connectionId=t,this.playerName=i,this.iceCandidates=a}toString(){return btoa(JSON.stringify(this))}static fromString(t){const n=JSON.parse(atob(t));return new ce(n.connectionId,n.session,n.playerName,n.iceCandidates)}}const en={iceServers:[{urls:"stun:stun.l.google.com:19302"}]};class tn{socket=null;onMessageCallback;gameId;boardId;peerName;publicKey=null;pingInterval=null;constructor(t,n,i,a){this.gameId=t,this.boardId=n||"",this.peerName=i,this.onMessageCallback=a}updateBoardId(t){c.sig(`Updating signaling boardId from ${this.boardId} to ${t}`),this.boardId=t}async connect(t,n,i){let a="wss://pebsg4v5yk.execute-api.eu-central-1.amazonaws.com/production";const p=new URLSearchParams;p.append("x-api-key",t),n&&(p.append("x-pubkey",n),this.publicKey=n),i&&p.append("x-sig",i);const C=`${a}?${p.toString()}`;return new Promise((g,v)=>{c.sig(`Connecting to signaling server: ${C}`),this.socket=new WebSocket(C),this.socket.onopen=()=>{c.sig("WebSocket Connection Open."),this.pingInterval=setInterval(()=>{this.socket?.readyState===WebSocket.OPEN&&this.socket.send(JSON.stringify({action:"ping"}))},3e4),g()},this.socket.onmessage=d=>{c.sig("Raw message from server:",d.data);try{const T=JSON.parse(d.data);this.onMessageCallback(T)}catch(T){c.error("Failed to parse signaling message",T)}},this.socket.onclose=d=>{c.sig("Disconnected from signaling server",d.code,d.reason),this.pingInterval&&(clearInterval(this.pingInterval),this.pingInterval=null),this.socket=null},this.socket.onerror=d=>{c.error("Signaling WebSocket error:",d),v(d)}})}hostRegister(t,n,i,a){return c.sig("Registering as host for board:",t),this.send({type:"hostRegister",boardId:t,gameId:n,peerName:i,publicKey:a})}guestJoin(t,n,i,a){return c.sig("Joining as guest for board:",t),this.send({type:"guestJoin",boardId:t,peerName:n,publicKey:i,encryptionPublicKey:a})}hostOffer(t,n,i,a,p){return c.sig("Sending offer to guest:",t),this.send({type:"hostOffer",target:t,guestPublicKey:n,offer:i,peerName:this.peerName,publicKey:this.publicKey||void 0,encryptionPublicKey:a,iv:p,boardId:this.boardId})}guestAnswer(t,n,i,a){return c.sig("Sending answer to host:",t),this.send({type:"guestAnswer",target:t,publicKey:n,answer:i,peerName:this.peerName,iv:a,boardId:this.boardId})}deleteOffer(){if(!this.socket||this.socket.readyState!==WebSocket.OPEN){c.sig("Cannot delete offer: Signaling socket is not open.");return}c.sig("Deleting offer for game:",this.gameId,"board:",this.boardId),this.send({type:"deleteOffer",gameId:this.gameId,...this.boardId?{boardId:this.boardId}:{}})}send(t){if(!this.socket||this.socket.readyState!==WebSocket.OPEN)return c.error("Signaling socket not open. State:",this.socket?.readyState),!1;const n={action:"sendMessage",...t};return c.sig("Sending payload to AWS:",n),this.socket.send(JSON.stringify(n)),!0}disconnect(t=!1){t&&this.isConnected&&this.deleteOffer(),this.pingInterval&&(clearInterval(this.pingInterval),this.pingInterval=null),this.socket?.close(),this.socket=null}get isConnected(){return!!this.socket&&this.socket.readyState===WebSocket.OPEN}}const{createMachine:nn,assign:Ze}=await x("xstate"),an=nn({types:{},id:"lobby",initial:"selection",context:({input:e})=>({playerName:e.playerName,signalingMode:null,playerCount:2}),states:{selection:{on:{SELECT_MODE:{target:"discovery",actions:Ze({signalingMode:({event:e})=>e.mode})}}},discovery:{on:{GOTO_SELECTION:"selection",SET_PLAYER_COUNT:{actions:Ze({playerCount:({event:e})=>e.count})},SELECT_MODE:{actions:Ze({signalingMode:({event:e})=>e.mode})}}}}}),{createMachine:sn,assign:G}=await x("xstate"),{createLobbyMessage:$e}=await x("@mykoboard/integration"),on=sn({types:{},id:"board",initial:"idle",context:({input:e})=>({connections:new Map,playerStatuses:new Map,isInitiator:e.isInitiator||!1,isGameStarted:!1,isGameFinished:!1,playerName:e.playerName,ledger:[],pendingGuest:null,externalParticipants:[],maxPlayers:e.maxPlayers||2,boardId:e.boardId||""}),states:{idle:{on:{HOST:{target:"hosting",actions:G({isInitiator:!0,maxPlayers:({event:e})=>e.maxPlayers||2,boardId:({event:e})=>e.boardId})},JOIN:{target:"joining",actions:G({isInitiator:!1,boardId:({event:e})=>e.boardId})}}},hosting:{on:{REQUEST_JOIN:{target:"approving",actions:G({pendingGuest:({event:e})=>({id:e.connectionId,name:e.peerName,answer:e.answer,connection:e.connection})})}},always:[{target:"preparation",guard:"hasConnections"}]},joining:{always:[{target:"preparation",guard:"hasConnections"}]},approving:{on:{ACCEPT_GUEST:{target:"preparation",actions:["acceptGuest","clearPendingGuest"]},REJECT_GUEST:{target:"hosting",actions:["rejectGuest","clearPendingGuest"]}}},preparation:{on:{START_GAME:{target:"playing",actions:["setGameStarted","broadcastStartGame"]},GAME_STARTED:{target:"playing",actions:"setGameStarted"},REQUEST_JOIN:{target:"approving",actions:G({pendingGuest:({event:e})=>({id:e.connectionId,name:e.peerName,answer:e.answer,connection:e.connection})})}}},playing:{on:{FINISH_GAME:{target:"finished",actions:G({isGameFinished:!0})}}},finished:{on:{RESET_GAME:{target:"preparation",actions:["resetGameStarted","broadcastResetGame"]}}}},on:{UPDATE_CONNECTION:{actions:["updateConnection","syncConnection"]},PEER_DISCONNECTED:{actions:["updateConnectionStatus","removeConnection"]},SET_PLAYER_STATUS:{actions:"setPlayerStatus"},REMOVE_PLAYER:{actions:"removePlayer"},SYNC_LEDGER:{actions:"syncLedger"},LOAD_LEDGER:{actions:G({ledger:({event:e})=>e.ledger})},SYNC_PARTICIPANTS:{actions:G({externalParticipants:({event:e})=>e.participants})},GAME_STARTED:{actions:"setGameStarted"},GAME_RESET:{actions:"resetGameStarted"},CLOSE_SESSION:{target:".idle",actions:["resetContext","closeAllConnections"]}}},{actions:{setGameStarted:G({isGameStarted:!0,isGameFinished:!1}),resetGameStarted:G({isGameStarted:!1,isGameFinished:!1,ledger:[]}),setPlayerStatus:G(({context:e,event:t})=>{if(t.type!=="SET_PLAYER_STATUS")return e;const n=new Map(e.playerStatuses);return n.set(t.playerId,t.status),{playerStatuses:n}}),updateConnectionStatus:G(({context:e,event:t})=>{if(t.type!=="PEER_DISCONNECTED")return e;const n=new Map(e.connections),i=n.get(t.connectionId);return i&&(i.status=$.closed),{connections:n}}),updateConnection:G(({context:e,event:t})=>{if(t.type!=="UPDATE_CONNECTION")return e;const n=t.connection;if(n.status===$.closed&&!e.connections.has(n.id))return e;const i=e.connections.get(n.id);if(i){const C=i._lastKnownStatus!==n.status,g=i._lastKnownSignal!==(n.signal?.toString()||"");if(!C&&!g)return e}n._lastKnownStatus=n.status,n._lastKnownSignal=n.signal?.toString()||"";const a=new Map(e.connections);a.set(n.id,n);const p=new Map(e.playerStatuses);return p.has(n.id)||p.set(n.id,"lobby"),{connections:a,playerStatuses:p}}),syncConnection:({context:e,event:t})=>{if(t.type!=="UPDATE_CONNECTION")return;const n=t.connection;if(e.isInitiator&&n.status===$.connected){if(n._synced)return;n._synced=!0,c.lobby("STATE",`Syncing new connection: ${n.id}`),n.send(JSON.stringify($e("SYNC_LEDGER",e.ledger))),e.isGameStarted&&n.send(JSON.stringify($e("GAME_STARTED")))}},removeConnection:G(({context:e,event:t})=>{if(t.type!=="PEER_DISCONNECTED")return e;const n=new Map(e.connections);return n.delete(t.connectionId),{connections:n}}),removePlayer:G(({context:e,event:t})=>{if(t.type!=="REMOVE_PLAYER")return e;const n=new Map(e.connections),i=n.get(t.playerId);i&&(i.close(),n.delete(t.playerId));const a=new Map(e.playerStatuses);return a.delete(t.playerId),{connections:n,playerStatuses:a}}),syncLedger:G(({context:e,event:t})=>t.type!=="SYNC_LEDGER"?e:{ledger:t.ledger}),broadcastStartGame:({context:e})=>{e.isInitiator&&e.connections.forEach(t=>{t.status===$.connected&&t.send(JSON.stringify($e("START_GAME")))})},broadcastResetGame:({context:e})=>{e.isInitiator&&e.connections.forEach(t=>{t.status===$.connected&&t.send(JSON.stringify($e("GAME_RESET")))})},closeAllConnections:({context:e})=>{e.connections.forEach(t=>t.close())},acceptGuest:({context:e})=>{e.pendingGuest&&(c.sig("Accepting guest:",e.pendingGuest.name),e.pendingGuest.connection.acceptAnswer(e.pendingGuest.answer))},rejectGuest:({context:e})=>{e.pendingGuest&&(c.sig("Rejecting guest:",e.pendingGuest.name),e.pendingGuest.connection.close())},resetContext:G(({context:e})=>({connections:new Map,playerStatuses:new Map,ledger:[],isGameStarted:!1,isGameFinished:!1,isInitiator:!1,maxPlayers:e.maxPlayers,pendingGuest:null,externalParticipants:[],boardId:""})),clearPendingGuest:G({pendingGuest:null})},guards:{hasConnections:({context:e})=>Array.from(e.connections.values()).some(t=>t.status===$.connected)}}),{ref:rt}=await x("vue"),{createActor:Vt}=await x("xstate"),H=rt(null),Ft=rt(!0),kt=rt([]);Vt(an,{input:{playerName:"Anonymous"}}).start();const qe=new Map;function et(e,t,n=!1,i=2){if(!qe.has(e)){c.lobby("STATE",`Creating new board actor for ${e}`);const a=Vt(on,{input:{playerName:t,boardId:e,isInitiator:n,maxPlayers:i}});a.start(),qe.set(e,a)}return qe.get(e)}const rn=async()=>{if(H.value)return;const e=se.getInstance();H.value=await e.getIdentity(),Ft.value=!1};rn();const{ref:ie,computed:B,watch:fe,watchEffect:cn,onMounted:ln,onUnmounted:dn}=await x("vue"),{useSelector:un}=await x("@xstate/vue"),{Ledger:pn,createLobbyMessage:ve,isLobbyMessage:St}=await x("@mykoboard/integration");function gn(){const e=Kt(),t=Dt(),n=ie(null),i=ie(!1),a=ie(""),p=ie(!1),C=ie([]),g=ie(new Map),v=B(()=>e.params.gameId),d=B(()=>e.params.boardId),T=B(()=>Mt(v.value||"")),U=B(()=>!!d.value),E=B(()=>!d.value||d.value==="manual"?null:et(d.value,H.value?.name||"Anonymous",!1)),S=un(E,o=>o),m=B(()=>S.value?.context?.isInitiator||!1),l=B(()=>S.value?.context?.isGameStarted||!1),f=B(()=>S.value?.context?.connections||new Map),ae=B(()=>Array.from(f.value.values())),ne=B(()=>ae.value.filter(o=>o.status===$.connected)),Ve=B(()=>ae.value.filter(o=>o.status!==$.connected&&o.status!==$.closed));B(()=>!!S.value&&S.value.status!=="idle");const Fe=B(()=>U.value?"game":"lobby"),de=B(()=>{if(!S.value)return[];const o=S.value.context,r=kt.value.find(s=>s.boardId===d.value),h=r?.participants||[],N=o.externalParticipants||[],A=h.find(s=>s.id===H.value?.id||s.publicKey===H.value?.publicKey||s.isYou),J={id:H.value?.id||"local",name:o.playerName||H.value?.name||"Anonymous",status:l.value?"game":"lobby",isConnected:!0,isLocal:!0,isHost:A?A.isHost:m.value,publicKey:H.value?.publicKey},w=[],K=new Set;if(m.value)w.push(J),K.add(J.id);else if(N.length>0){const s=N.find(P=>P.isHost);if(s){const P=ne.value.find(O=>O.status===$.connected);w.push({id:s.id,name:s.name,status:(P?o.playerStatuses.get(P.id):null)||(l.value?"game":"lobby"),isConnected:!!P,isLocal:!1,isHost:!0,publicKey:P?.remotePublicKey||s.publicKey}),K.add(s.id)}w.push(J),K.add(J.id)}return m.value?ae.value.forEach(s=>{if(!K.has(s.id)){const P=h.find(D=>D.id===s.id),O=s.remotePublicKey||P?.publicKey;w.push({id:s.id,name:s.remotePlayerName||P?.name||"Anonymous",status:o.playerStatuses.get(s.id)||"lobby",isConnected:s.status===$.connected,isLocal:!1,isHost:!1,publicKey:O}),K.add(s.id)}}):N.length>0&&N.forEach(s=>{s.isHost||K.has(s.id)||s.id===J.id||s.id===H.value?.id||s.publicKey===H.value?.publicKey||(w.push({id:s.id,name:s.name,status:l.value?"game":"lobby",isConnected:!0,isLocal:!1,isHost:!1,publicKey:s.publicKey}),K.add(s.id))}),h.forEach(s=>{!s.isYou&&!K.has(s.id)&&w.push({id:s.id,name:s.name,status:r?.status==="finished"||l.value?"game":"lobby",isConnected:!1,isLocal:!1,isHost:s.isHost,publicKey:s.publicKey})}),w});cn(()=>{const o=S.value;(o?.status==="approving"||o?.status==="hosting"||o?.status==="preparation"||o?.status==="playing"||o?.status==="finished")&&d.value&&d.value!=="manual"&&Xe.saveSession({gameId:v.value,boardId:d.value,playerName:o.context.playerName,gameName:T.value?.name||"Unknown Game",lastPlayed:Date.now(),status:o.matches("finished")?"finished":"active",ledger:o.context.ledger,participants:de.value.map(r=>({id:r.id,name:r.name,isYou:r.isLocal,isHost:r.isHost,publicKey:r.publicKey}))})});const Ce=new Map,Ie=new Map,Ue=o=>{const r=E.value;if(!r)return;const h=Ce.get(o.id),N=o.signal?.toString()||"",A=Ie.get(o.id);h===o.status&&A===N||(Ce.set(o.id,o.status),Ie.set(o.id,N),r.send({type:"UPDATE_CONNECTION",connection:o}),o._hasListener||(o.addMessageListener(J=>{try{const w=JSON.parse(J);if(!St(w))return;if(w.type==="START_GAME"&&r.send({type:"START_GAME"}),w.type==="GAME_STARTED"&&r.send({type:"GAME_STARTED"}),w.type==="GAME_RESET"&&r.send({type:"GAME_RESET"}),w.type==="NEW_BOARD"&&t.replace(`/games/${v.value}/${w.payload}`),w.type==="SYNC_PLAYER_STATUS"&&r.send({type:"SET_PLAYER_STATUS",playerId:o.id,status:w.payload}),w.type==="SYNC_PARTICIPANTS"&&r.send({type:"SYNC_PARTICIPANTS",participants:w.payload}),w.type==="SYNC_LEDGER"){const K=w.payload;for(const s of K)s.signature&&s.signerPublicKey&&se.verify(s.action,s.signature,s.signerPublicKey).then(P=>{P||c.error("Invalid signature in ledger entry",s)});r.send({type:"SYNC_LEDGER",ledger:w.payload})}}catch{}}),o._hasListener=!0))},_e=async(o,r)=>{const h=r||o;if(c.sig("setupSignaling called with gameId:",o,"boardId:",r,"resolved currentBoardId:",h),!!h&&(a.value!==h&&n.value?.isConnected&&(c.sig("Switching signaling board assignment from",a.value,"to",h),n.value.updateBoardId(h),a.value=h),(!n.value||!n.value.isConnected)&&!i.value)){i.value=!0;try{const N=se.getInstance(),A=await N.getIdentity();if(A){const J=new tn(o||"default",h,A.name,async s=>{if(s.type==="error"){if(c.error("Signaling error:",s.message||s.code),(s.code==="SESSION_NOT_FOUND"||s.code==="HOST_UNREACHABLE")&&!m.value){if(l.value){c.sig(`${s.code} received after game started, ignoring.`);return}c.sig(`${s.code}, retrying in 3s...`),setTimeout(()=>{p.value=!1},3e3);return}De.error(s.message||"Signaling error occurred"),s.code==="DUPLICATE_IDENTITY"&&t.replace(`/games/${o}`)}if(s.type==="peerJoined"&&(c.sig("Peer joined:",s.peerName,"publicKey:",s.publicKey),await He(s.publicKey)?(c.sig("Auto-approving known identity:",s.peerName),await Ee({connectionId:s.from,peerName:s.peerName||"Guest",publicKey:s.publicKey,encryptionPublicKey:s.encryptionPublicKey,timestamp:Date.now()})):C.value.push({connectionId:s.from,peerName:s.peerName||"Guest",publicKey:s.publicKey,encryptionPublicKey:s.encryptionPublicKey,timestamp:Date.now()})),s.type==="offer"){c.sig("Received offer from host:",s.from);const P=s.boardId||a.value;if(!P){c.error("No valid target board UUID for offer message");return}const O=et(P,A.name,!1),D=new xt(oe=>{O.send({type:"UPDATE_CONNECTION",connection:oe})});D.addMessageListener(oe=>{try{const M=JSON.parse(oe);if(!St(M))return;if(M.type==="START_GAME"&&O.send({type:"START_GAME"}),M.type==="GAME_STARTED"&&O.send({type:"GAME_STARTED"}),M.type==="GAME_RESET"&&O.send({type:"GAME_RESET"}),M.type==="NEW_BOARD"&&t.replace(`/games/${o}/${M.payload}`),M.type==="SYNC_PLAYER_STATUS"&&O.send({type:"SET_PLAYER_STATUS",playerId:D.id,status:M.payload}),M.type==="SYNC_PARTICIPANTS"&&O.send({type:"SYNC_PARTICIPANTS",participants:M.payload}),M.type==="SYNC_LEDGER"){const ct=M.payload;for(const ue of ct)ue.signature&&ue.signerPublicKey&&se.verify(ue.action,ue.signature,ue.signerPublicKey).then(Ht=>{Ht||c.error("Invalid signature in ledger entry",ue)});O.send({type:"SYNC_LEDGER",ledger:ct})}}catch(M){c.error("Failed to parse message:",M)}}),D.onClose=()=>{O.send({type:"PEER_DISCONNECTED",connectionId:D.id})},D.setDataChannelCallback(),s.publicKey&&(D.remotePublicKey=s.publicKey),s.peerName&&(D.remotePlayerName=s.peerName),D.acceptOffer(s.offer,A.name).then(()=>{const oe=setInterval(()=>{D.signal&&n.value&&(clearInterval(oe),n.value.guestAnswer(s.from,A.publicKey,D.signal))},100)}).catch(oe=>{c.error("Failed to accept offer:",oe)})}if(s.type==="answer"){c.sig("Received answer from guest:",s.from);const P=g.value.get(s.from);if(P&&s.answer){s.publicKey&&(P.remotePublicKey=s.publicKey),s.peerName&&(P.remotePlayerName=s.peerName);let O=s.answer;!(s.answer instanceof ce)&&typeof s.answer=="object"&&(O=new ce(s.answer.connectionId,s.answer.session,s.answer.playerName,s.answer.iceCandidates||[]));try{P.acceptAnswer(O),g.value.delete(s.from)}catch(D){c.error("Failed to accept answer:",D)}}}}),w=`SIGN_IN:${A.subscriptionToken}`,K=await N.sign(w);await J.connect(A.subscriptionToken,A.publicKey,K),n.value=J,a.value=h}}catch(N){c.error("Failed to connect to signaling server:",N)}finally{i.value=!1}}},je=async(o=2)=>{if(!U.value){const r=it();t.push(`/games/${v.value}/${r}?maxPlayers=${o}`)}},Je=async()=>{if(!d.value||!n.value?.isConnected){c.error("Cannot join as guest: missing boardId or signaling not connected");return}const r=await se.getInstance().getIdentity();r&&(c.sig("Sending guestJoin for boardId:",d.value),n.value.guestJoin(d.value,r.name,r.publicKey,r.publicKey))},He=async o=>(await Se.getAllKnownIdentities()).some(h=>h.publicKey===o),Ee=async o=>{c.sig("Approving peer:",o.peerName,"publicKey:",o.publicKey);const r=new xt(N=>{E.value?.send({type:"UPDATE_CONNECTION",connection:N})});r.onClose=()=>{E.value?.send({type:"PEER_DISCONNECTED",connectionId:r.id}),g.value.delete(o.connectionId)},r.remotePublicKey=o.publicKey,r.openDataChannel(),await r.prepareOfferSignal(S.value?.context?.playerName||H.value?.name||"Anonymous"),g.value.set(o.connectionId,r);const h=setInterval(()=>{r.signal&&n.value&&(clearInterval(h),se.getInstance().getIdentity().then(A=>{A&&n.value&&n.value.hostOffer(o.connectionId,o.publicKey,r.signal,A.publicKey)}))},100)},Ye=async o=>{C.value=C.value.filter(r=>r.connectionId!==o.connectionId),await Ee(o)},ze=o=>{C.value=C.value.filter(r=>r.connectionId!==o.connectionId)},Ne=async o=>{try{const r={id:`identity-${Date.now()}`,name:o.peerName,publicKey:o.publicKey,addedAt:Date.now()};await Se.addKnownIdentity(r),De.success("Identity Saved")}catch{De.error("Failed to save identity")}},We=()=>{n.value&&m.value&&n.value.deleteOffer(),E.value?.send({type:"START_GAME"})},Ae=()=>{E.value?.send({type:"FINISH_GAME"}),d.value&&Xe.updateStatus(d.value,"finished")},Qe=async o=>{if(!m.value||!E.value)return;const r=se.getInstance(),h=await r.getIdentity();if(!h)return;const N=await r.sign(o),A=pn.fromEntries(S.value?.context?.ledger||[]),J=await A.addEntry({...o});J.signature=N,J.signerPublicKey=h.publicKey;const w=A.getEntries();E.value.send({type:"SYNC_LEDGER",ledger:w}),ne.value.forEach(K=>{K.send(JSON.stringify(ve("SYNC_LEDGER",w)))})},Pe=()=>{const o=it();ne.value.forEach(r=>{r.status===$.connected&&r.send(JSON.stringify(ve("NEW_BOARD",o)))}),n.value?.deleteOffer(),E.value?.send({type:"CLOSE_SESSION"}),t.push(`/games/${v.value}/${o}`)},j=()=>{const o=S.value?.context?.pendingGuest;E.value?.send({type:"ACCEPT_GUEST"}),o&&Ue(o.connection)},Z=()=>E.value?.send({type:"REJECT_GUEST"}),me=o=>{o.close(),E.value?.send({type:"PEER_DISCONNECTED",connectionId:o.id})},Ut=()=>{n.value?.deleteOffer(),E.value?.send({type:"CLOSE_SESSION"}),t.push(`/games/${v.value}`)},jt=()=>{t.push(`/games/${v.value}`)},ye=ie(null),Jt=async()=>{if("wakeLock"in navigator)try{ye.value=await navigator.wakeLock.request("screen"),c.sig("Wake Lock acquired successfully"),ye.value.addEventListener("release",()=>{c.sig("Wake Lock released")})}catch(o){c.error(`Wake Lock failed: ${o.name}, ${o.message}`)}},Te=async()=>{if(document.visibilityState==="visible"){c.sig("App became visible, checking signaling status...");const o=ne.value.length>0;n.value&&!n.value.isConnected?(!l.value||!o)&&(p.value=!1,await _e(v.value,d.value)):n.value?.isConnected&&(!l.value||!o)&&(p.value=!1)}};return ln(()=>{document.addEventListener("visibilitychange",Te),window.addEventListener("focus",Te),U.value&&Jt()}),dn(()=>{document.removeEventListener("visibilitychange",Te),window.removeEventListener("focus",Te),ye.value&&(ye.value.release(),ye.value=null)}),fe([m,de],()=>{if(!m.value)return;const o=de.value.map(r=>({id:r.id,name:r.name,isHost:r.isHost,publicKey:r.publicKey}));ne.value.forEach(r=>{if(r.status===$.connected)try{r.send(JSON.stringify(ve("SYNC_PARTICIPANTS",o)))}catch(h){c.error("Failed to sync participants",h)}})},{deep:!0,immediate:!0}),fe([d,U],async()=>{U.value&&d.value&&await _e(v.value,d.value)},{immediate:!0}),fe([n,S,d],async()=>{if(!n.value?.isConnected||!d.value||p.value)return;const r=await se.getInstance().getIdentity();if(!r)return;const h=S.value;if(!h)return;const N=h.matches("hosting")||h.matches("preparation"),A=h.matches("joining");N&&h.context.isInitiator?(n.value.hostRegister(d.value,v.value,r.name,r.publicKey),p.value=!0):(A||!h.context.isInitiator)&&(n.value.guestJoin(d.value,r.name,r.publicKey,r.publicKey),p.value=!0)}),fe(d,async o=>{if(o&&o!=="manual"&&U.value){const r=await Xe.getSession(o),h=et(o,H.value?.name||"Anonymous",!1),N=h.getSnapshot().context;r&&r.ledger.length>0&&N.ledger.length===0&&(h.send({type:"LOAD_LEDGER",ledger:r.ledger}),h.send({type:"GAME_STARTED"}),r.status==="finished"&&setTimeout(()=>h.send({type:"FINISH_GAME"}),10))}},{immediate:!0}),fe(ne,o=>{o.forEach(r=>{r._hasInitialSync||(r.send(JSON.stringify(ve("SYNC_PLAYER_STATUS",Fe.value))),m.value&&d.value&&d.value!=="manual"&&r.send(JSON.stringify(ve("NEW_BOARD",d.value))),r._hasInitialSync=!0)})}),{identity:H,isLoading:Ft,snapshot:S,send:o=>E.value?.send(o),signalingClient:n,isServerConnecting:i,pendingJoinRequests:C,activeSessions:kt,playerInfos:de,connectedPeers:ne,pendingSignaling:Ve,isInitiator:m,isGameStarted:l,onHostAGame:je,onJoinAsGuest:Je,onApprovePeer:Ye,onRejectPeer:ze,saveIdentityOnApprove:Ne,startGame:We,onFinishGame:Ae,onAddLedger:Qe,handlePlayAgain:Pe,onAcceptGuest:j,onRejectGuest:Z,onCancelSignaling:me,onBackToGames:Ut,onBackToDiscovery:jt}}const{defineComponent:hn}=await x("vue"),{unref:W,createElementVNode:R,openBlock:V,createElementBlock:q,createCommentVNode:be,createVNode:we,createTextVNode:tt,toDisplayString:Ct,createBlock:Ge,Fragment:It}=await x("vue"),mn={class:"space-y-4 animate-fade-in-up"},yn={key:0,class:"glass-dark p-6 rounded-2xl border border-white/5 shadow-glass-dark flex items-center justify-center space-x-4"},fn={key:1,class:"glass-dark p-6 rounded-2xl border border-white/5 shadow-glass-dark"},vn={class:"text-sm font-black text-white uppercase tracking-[0.2em] mb-4 flex items-center gap-3"},bn={key:2,class:"glass-dark p-6 rounded-2xl border border-white/5 shadow-glass-dark group hover:border-primary/20 transition-all duration-500"},wn={class:"text-[10px] font-black uppercase tracking-[0.2em] mb-4 flex items-center gap-2 text-primary"},xn={class:"space-y-4"},kn={class:"p-4 bg-white/5 rounded-xl border border-white/10 relative group min-h-[64px] flex items-center group-hover:neon-border transition-all duration-500"},Sn={class:"text-[10px] font-mono break-all line-clamp-2 text-white/40 pr-8"},Cn={key:1,class:"text-[10px] text-white/20 italic tracking-wider"},In={key:3,class:"glass-dark p-6 rounded-2xl border border-white/5 shadow-glass-dark group hover:border-primary/20 transition-all duration-500"},_n={class:"text-[10px] font-black uppercase tracking-[0.2em] mb-4 flex items-center gap-2 text-primary"},En={class:"space-y-3"},Nn={class:"p-4 bg-white/5 rounded-xl border border-white/10 relative group min-h-[64px] flex items-center group-hover:neon-border transition-all duration-500"},An={class:"text-[10px] font-mono break-all line-clamp-2 text-white/40 pr-8"},Pn={key:1,class:"text-[10px] text-white/20 italic tracking-wider"},Tn={key:4,class:"flex justify-end"},{ref:$n}=await x("vue"),_t=hn({__name:"SignalingStep",props:{connection:{},onOfferChange:{type:Function},onAnswerChange:{type:Function},onCancel:{type:Function}},setup(e){const t=$n(!1),n=i=>{i&&(navigator.clipboard.writeText(i),t.value=!0,setTimeout(()=>t.value=!1,2e3))};return(i,a)=>(V(),q("div",mn,[e.connection.status===W($).new?(V(),q("div",yn,[...a[5]||(a[5]=[R("div",{class:"animate-spin rounded-full h-5 w-5 border-b-2 border-primary"},null,-1),R("p",{class:"text-sm text-white/50 font-bold uppercase tracking-widest"},"Generating invite signal...",-1)])])):be("",!0),e.connection.status===W($).readyToAccept?(V(),q("div",fn,[R("h3",vn,[we(W(Qt),{class:"w-5 h-5 text-primary"}),a[6]||(a[6]=tt(" Paste Join Offer ",-1))]),a[7]||(a[7]=R("p",{class:"text-[10px] text-white/30 uppercase tracking-widest mb-4"},"External node signal required for connection.",-1)),we(bt,{placeholder:"Paste offer string here...",className:"h-12 bg-white/5 border-white/10 rounded-xl focus:ring-primary text-white font-mono text-xs placeholder:text-white/20","onUpdate:modelValue":a[0]||(a[0]=p=>e.onOfferChange(e.connection,p))})])):be("",!0),e.connection.status===W($).started?(V(),q("div",bn,[R("h3",wn,[we(W(Be),{class:"w-4 h-4"}),a[8]||(a[8]=tt(" Active Invite Vector ",-1))]),R("div",xn,[R("div",kn,[e.connection.signal?(V(),q(It,{key:0},[R("div",Sn,Ct(e.connection.signal.toString()),1),R("button",{class:"absolute top-2 right-2 h-8 w-8 flex items-center justify-center text-primary hover:bg-primary/10 transition-colors rounded-lg",onClick:a[1]||(a[1]=p=>n(e.connection.signal.toString()))},[t.value?(V(),Ge(W(Me),{key:0,class:"w-4 h-4"})):(V(),Ge(W(wt),{key:1,class:"w-4 h-4"}))])],64)):(V(),q("div",Cn,"Gathering node connection details..."))]),a[9]||(a[9]=R("p",{class:"text-[10px] text-white/30 uppercase font-medium leading-relaxed tracking-wider"}," Transmit this vector to a peer node. Their response will be synthesized automatically. ",-1)),we(bt,{placeholder:"Awaiting peer response vector...",className:"h-10 bg-white/5 border-white/10 rounded-xl focus:ring-primary text-white font-mono text-[10px] placeholder:text-white/20","onUpdate:modelValue":a[2]||(a[2]=p=>e.onAnswerChange(e.connection,p))})])])):be("",!0),e.connection.status===W($).answered?(V(),q("div",In,[R("h3",_n,[we(W(Me),{class:"w-4 h-4"}),a[10]||(a[10]=tt(" Signal Response Synthesized ",-1))]),R("div",En,[R("div",Nn,[e.connection.signal?(V(),q(It,{key:0},[R("div",An,Ct(e.connection.signal.toString()),1),R("button",{class:"absolute top-2 right-2 h-8 w-8 flex items-center justify-center text-primary hover:bg-primary/10 transition-colors rounded-lg",onClick:a[3]||(a[3]=p=>n(e.connection.signal.toString()))},[t.value?(V(),Ge(W(Me),{key:0,class:"w-4 h-4"})):(V(),Ge(W(wt),{key:1,class:"w-4 h-4"}))])],64)):(V(),q("div",Pn,"Finalizing response..."))]),a[11]||(a[11]=R("p",{class:"text-[10px] text-primary font-black uppercase tracking-widest"},"Transmit this payload back to peer to complete handshake.",-1))])])):be("",!0),e.onCancel?(V(),q("div",Tn,[R("button",{onClick:a[4]||(a[4]=p=>e.onCancel(e.connection)),class:"text-[10px] font-black uppercase tracking-widest text-white/20 hover:text-rose-500 transition-colors p-2"}," De-initialize Link ")])):be("",!0)]))}}),{defineComponent:Gn}=await x("vue"),{unref:k,createVNode:b,createElementVNode:u,toDisplayString:Q,createTextVNode:F,openBlock:I,createElementBlock:_,createCommentVNode:Y,renderList:Et,Fragment:Re,normalizeClass:Nt,withCtx:L,Transition:Rn,createBlock:Ln,createStaticVNode:On}=await x("vue"),Kn={class:"space-y-8"},Dn={key:0,class:"fixed inset-0 z-[100] flex items-center justify-center bg-[#0A0A0A]/80 backdrop-blur-xl animate-fade-in p-6"},Mn={class:"glass-dark p-10 w-full max-w-md shadow-2xl border border-white/10 rounded-[2.5rem] space-y-8 animate-zoom-in"},Bn={class:"flex flex-col items-center text-center space-y-6"},Vn={class:"h-20 w-20 bg-primary/10 rounded-[1.5rem] flex items-center justify-center border border-primary/20 shadow-neon"},Fn={class:"space-y-2"},Un={class:"text-white/40 uppercase tracking-widest text-[10px] font-medium leading-relaxed"},jn={class:"font-black text-primary px-1"},Jn={class:"grid grid-cols-2 gap-4"},Hn={key:1,class:"glass-dark p-8 border border-primary/20 shadow-glass-dark rounded-[2.5rem] animate-zoom-in space-y-6"},Yn={class:"flex items-center gap-4"},zn={class:"w-12 h-12 rounded-2xl bg-primary/10 flex items-center justify-center border border-primary/20"},Wn={class:"space-y-1"},Qn={class:"text-white/40 uppercase tracking-widest text-[10px] font-medium"},Xn={class:"space-y-4"},Zn={class:"flex items-start justify-between"},qn={class:"space-y-2"},ea={class:"flex items-center gap-2"},ta={class:"text-lg font-black text-white"},na={key:0,class:"px-2 py-0.5 bg-primary/10 text-primary border border-primary/20 rounded-full text-[9px] font-black uppercase tracking-wider"},aa={class:"text-xs text-white/40 font-mono"},sa={key:0,class:"flex items-center justify-end gap-2 px-1 pb-2"},oa=["onClick","aria-checked"],ia={class:"grid grid-cols-2 gap-3"},ra=["onClick"],ca=["onClick"],la={key:2,class:"glass-dark p-10 text-center space-y-8 border border-white/5 shadow-glass-dark rounded-[3rem] animate-zoom-in"},da={class:"space-y-4"},ua={class:"inline-flex items-center gap-2 px-4 py-1.5 bg-primary/10 text-primary border border-primary/20 rounded-full text-[10px] font-black uppercase tracking-[0.2em] shadow-neon transform -translate-y-2"},pa={class:"text-4xl font-black text-white uppercase tracking-tighter"},ga={class:"text-xs text-white/30 uppercase font-black tracking-widest leading-relaxed max-w-lg mx-auto"},ha={key:0,class:"flex flex-col items-center gap-6"},ma={class:"space-y-4"},ya={class:"mx-auto h-16 w-16 bg-rose-500/10 rounded-2xl flex items-center justify-center border border-rose-500/20"},fa={class:"grid grid-cols-2 gap-4 pt-6"},va={key:1,class:"flex flex-col items-center gap-8 py-6"},ba={key:0,class:"relative"},wa={class:"space-y-3"},xa={class:"text-xl font-black text-white uppercase tracking-tight"},ka={class:"text-[10px] text-white/30 uppercase tracking-[0.2em] max-w-xs mx-auto font-medium leading-relaxed"},Sa={class:"space-y-4"},Ca={class:"mx-auto h-16 w-16 bg-rose-500/10 rounded-2xl flex items-center justify-center border border-rose-500/20"},Ia={class:"grid grid-cols-2 gap-4 pt-6"},_a={key:2,class:"pt-8 border-t border-white/5 space-y-6"},Ea={key:0,class:"glass-dark p-8 rounded-[2rem] border border-white/10 shadow-glass-dark space-y-6 group hover:border-primary/30 transition-all duration-500"},Na={class:"flex items-center justify-between"},Aa={class:"flex items-center gap-3"},Pa={class:"p-2.5 bg-primary/10 rounded-xl border border-primary/20"},Ta={class:"relative flex items-center gap-3"},$a={class:"flex-grow bg-black/40 border border-white/10 rounded-xl px-4 py-3.5 font-mono text-[11px] text-white/60 truncate transition-all group-hover:bg-black/60 group-hover:border-white/20"},Ga={key:"check",class:"flex items-center gap-2 animate-bounce-short"},Ra={key:"copy",class:"flex items-center gap-2"},La={key:1,class:"space-y-4 text-left"},Oa={class:"grid grid-cols-1 gap-6"},Ka={key:3,class:"pt-8 border-t border-white/5 text-left"},Da={key:3,class:"py-24 flex flex-col items-center justify-center space-y-6 border border-white/5 bg-white/5 rounded-[3rem] backdrop-blur-sm animate-fade-in"},{ref:nt,computed:xe,watch:Ma}=await x("vue"),Ba=Gn({__name:"PreparationPhase",props:{state:{},isInitiator:{type:Boolean},signalingMode:{},isServerConnecting:{type:Boolean},signalingClient:{},pendingSignaling:{},pendingJoinRequests:{},isKnownIdentity:{type:Function},onStartGame:{type:Function},onHostAGame:{type:Function},onUpdateOffer:{type:Function},onUpdateAnswer:{type:Function},onCloseSession:{type:Function},onBackToLobby:{type:Function},onAcceptGuest:{type:Function},onRejectGuest:{type:Function},onApprovePeer:{type:Function},onRejectPeer:{type:Function},onSaveIdentity:{type:Function},onCancelSignaling:{type:Function},onRemovePlayer:{type:Function},playerCount:{},maxPlayers:{},boardId:{},gameId:{}},setup(e){const t=e,n=nt({}),i=nt({}),a=async m=>{t.isKnownIdentity&&(n.value[m]=await t.isKnownIdentity(m))},p=m=>m.length<=20?m:`${m.substring(0,10)}...${m.substring(m.length-10)}`,C=nt(!1),g=xe(()=>`${window.location.origin}${window.location.pathname}#/games/${t.gameId}/${t.boardId}`),v=async()=>{try{await navigator.clipboard.writeText(g.value),C.value=!0,setTimeout(()=>{C.value=!1},2e3)}catch(m){console.error("Failed to copy link:",m)}};Ma(()=>t.pendingJoinRequests,m=>{m&&m.forEach(l=>{l.publicKey in n.value||a(l.publicKey)})},{deep:!0,immediate:!0});const d=async m=>{i.value[m.connectionId]&&t.onSaveIdentity&&await t.onSaveIdentity(m),t.onApprovePeer&&t.onApprovePeer(m),delete i.value[m.connectionId]},T=xe(()=>t.state.matches("preparation")),U=xe(()=>t.state.matches("hosting")),E=xe(()=>t.state.matches("joining")),S=xe(()=>t.state.matches("approving"));return(m,l)=>(I(),_("div",Kn,[S.value&&e.state.context.pendingGuest?(I(),_("div",Dn,[u("div",Mn,[u("div",Bn,[u("div",Vn,[b(k(Be),{class:"w-10 h-10 text-primary animate-pulse"})]),u("div",Fn,[l[6]||(l[6]=u("h2",{class:"text-2xl font-black text-white uppercase tracking-tight"},"Handshake Request",-1)),u("p",Un,[l[4]||(l[4]=F(" Entity ",-1)),u("span",jn,Q(e.state.context.pendingGuest.name),1),l[5]||(l[5]=F(" attempts to bridge into session. ",-1))])])]),u("div",Jn,[u("button",{onClick:l[0]||(l[0]=(...f)=>e.onRejectGuest&&e.onRejectGuest(...f)),class:"h-14 rounded-2xl border border-white/10 text-white/60 hover:text-rose-500 hover:bg-rose-500/10 hover:border-rose-500/30 font-black uppercase tracking-widest text-xs transition-all"}," De-authorize "),u("button",{onClick:l[1]||(l[1]=(...f)=>e.onAcceptGuest&&e.onAcceptGuest(...f)),class:"h-14 rounded-2xl bg-primary text-primary-foreground shadow-neon hover:shadow-[0_0_30px_rgba(16,185,129,0.4)] font-black uppercase tracking-widest text-xs transition-all"}," Grant Access ")])])])):Y("",!0),e.isInitiator&&e.pendingJoinRequests&&e.pendingJoinRequests.length>0?(I(),_("div",Hn,[u("div",Yn,[u("div",zn,[b(k(Be),{class:"w-6 h-6 text-primary"})]),u("div",Wn,[l[7]||(l[7]=u("h2",{class:"text-2xl font-black text-white uppercase tracking-tight"},"Join Requests",-1)),u("p",Qn,Q(e.pendingJoinRequests.length)+" "+Q(e.pendingJoinRequests.length===1?"peer":"peers")+" waiting for approval ",1)])]),u("div",Xn,[(I(!0),_(Re,null,Et(e.pendingJoinRequests,f=>(I(),_("div",{key:f.connectionId,class:"glass-darker p-6 rounded-2xl border border-white/5 space-y-4"},[u("div",Zn,[u("div",qn,[u("div",ea,[u("span",ta,Q(f.peerName),1),n.value[f.publicKey]?(I(),_("span",na," Known Identity ")):Y("",!0)]),u("p",aa,Q(p(f.publicKey)),1)])]),n.value[f.publicKey]?Y("",!0):(I(),_("div",sa,[l[8]||(l[8]=u("span",{class:"text-xs text-white/50 uppercase tracking-wider font-medium"},"Auto-approve next time",-1)),u("button",{onClick:ae=>i.value[f.connectionId]=!i.value[f.connectionId],class:Nt(["relative inline-flex h-6 w-11 items-center rounded-full transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2 focus:ring-offset-gray-900",i.value[f.connectionId]?"bg-primary":"bg-white/10"]),role:"switch","aria-checked":i.value[f.connectionId]},[u("span",{class:Nt(["inline-block h-4 w-4 transform rounded-full bg-white transition-transform duration-200",i.value[f.connectionId]?"translate-x-6":"translate-x-1"])},null,2)],10,oa)])),u("div",ia,[u("button",{onClick:ae=>e.onRejectPeer&&e.onRejectPeer(f),class:"h-12 rounded-xl border border-white/10 text-white/60 hover:text-rose-500 hover:bg-rose-500/10 hover:border-rose-500/30 font-black uppercase tracking-widest text-xs transition-all"}," Reject ",8,ra),u("button",{onClick:ae=>d(f),class:"h-12 rounded-xl bg-primary text-primary-foreground shadow-neon hover:shadow-[0_0_30px_rgba(16,185,129,0.4)] font-black uppercase tracking-widest text-xs transition-all"}," Approve ",8,ca)])]))),128))])])):Y("",!0),U.value||E.value||T.value||S.value?(I(),_("div",la,[u("div",da,[u("div",ua,Q(U.value||S.value?"Broadcasting Session":E.value?"Initializing Node":"Command Lobby Active"),1),u("h2",pa,Q(T.value?"Game Room":U.value?"Link Establishment":"Connecting..."),1),u("p",ga,[T.value?(I(),_(Re,{key:0},[F(Q(e.isInitiator?`Authorize peer nodes or launch protocol when ready (${e.playerCount}/${e.maxPlayers}).`:"Waiting for initiator to launch protocol."),1)],64)):(I(),_(Re,{key:1},[F("Synthesizing direct P2P mesh link to session nodes.")],64))])]),e.isInitiator?(I(),_("div",ha,[T.value?(I(),_("button",{key:0,onClick:l[2]||(l[2]=(...f)=>e.onStartGame&&e.onStartGame(...f)),class:"w-full max-w-sm h-16 text-sm font-black uppercase tracking-[0.5em] rounded-2xl bg-primary text-primary-foreground shadow-[0_0_30px_rgba(16,185,129,0.3)] hover:shadow-[0_0_50px_rgba(16,185,129,0.5)] transition-all active:scale-[0.98]"}," Launch Protocol ")):Y("",!0),b(k(dt),null,{default:L(()=>[b(k(ut),{asChild:""},{default:L(()=>[...l[9]||(l[9]=[u("button",{class:"px-4 h-12 rounded-xl text-white/20 hover:text-rose-500 font-black uppercase tracking-widest text-[10px] transition-colors"}," Terminate Session ",-1)])]),_:1}),b(k(pt),null,{default:L(()=>[b(k(gt),{class:"bg-black/80 fixed inset-0 z-[100] backdrop-blur-sm"}),b(k(ht),{class:"glass-dark border border-white/10 rounded-[2rem] p-8 max-w-sm fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 z-[101]"},{default:L(()=>[u("div",ma,[u("div",ya,[b(k(lt),{class:"w-8 h-8 text-rose-500"})]),b(k(mt),{class:"text-xl font-black text-center text-white uppercase tracking-tight"},{default:L(()=>[...l[10]||(l[10]=[F(" Terminate Session? ",-1)])]),_:1}),b(k(yt),{class:"text-center text-white/40 text-xs font-medium uppercase tracking-widest leading-relaxed"},{default:L(()=>[...l[11]||(l[11]=[F(" Reloading or leaving will cause the game session to be lost. Peers will be disconnected and discovery mesh link terminated. ",-1)])]),_:1})]),u("div",fa,[b(k(ft),{class:"h-12 rounded-xl bg-white/5 border border-white/5 text-white/60 hover:bg-white/10 font-bold uppercase tracking-widest text-[10px]"},{default:L(()=>[...l[12]||(l[12]=[F(" Abort ",-1)])]),_:1}),b(k(vt),{onClick:e.onCloseSession,class:"h-12 rounded-xl bg-rose-500 text-white font-black uppercase tracking-widest text-[10px] hover:bg-rose-600 shadow-neon-sm"},{default:L(()=>[...l[13]||(l[13]=[F(" Confirm ",-1)])]),_:1},8,["onClick"])])]),_:1})]),_:1})]),_:1})])):(I(),_("div",va,[T.value?Y("",!0):(I(),_("div",ba,[...l[14]||(l[14]=[u("div",{class:"animate-spin rounded-full h-20 w-20 border-4 border-primary/5 border-t-primary shadow-neon"},null,-1),u("div",{class:"absolute inset-0 flex items-center justify-center"},[u("div",{class:"h-3 w-3 bg-primary rounded-full animate-pulse shadow-neon"})],-1)])])),u("div",wa,[u("h3",xa,Q(T.value?"Node Synced":"Bridging Connections"),1),u("p",ka,Q(T.value?"Identity verified. Awaiting initiator's launch command.":"Establishing secure encrypted tunnel to host node."),1)]),b(k(dt),null,{default:L(()=>[b(k(ut),{asChild:""},{default:L(()=>[...l[15]||(l[15]=[u("button",{class:"h-10 text-white/20 hover:text-rose-500 font-black uppercase tracking-widest text-[10px] transition-colors"}," Sever Connection ",-1)])]),_:1}),b(k(pt),null,{default:L(()=>[b(k(gt),{class:"bg-black/80 fixed inset-0 z-[100] backdrop-blur-sm"}),b(k(ht),{class:"glass-dark border border-white/10 rounded-[2rem] p-8 max-w-sm fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 z-[101]"},{default:L(()=>[u("div",Sa,[u("div",Ca,[b(k(lt),{class:"w-8 h-8 text-rose-500"})]),b(k(mt),{class:"text-xl font-black text-center text-white uppercase tracking-tight"},{default:L(()=>[...l[16]||(l[16]=[F(" Sever Connection? ",-1)])]),_:1}),b(k(yt),{class:"text-center text-white/40 text-xs font-medium uppercase tracking-widest leading-relaxed"},{default:L(()=>[...l[17]||(l[17]=[F(" Leaving or reloading will sever your node link. The game session progress will be lost. ",-1)])]),_:1})]),u("div",Ia,[b(k(ft),{class:"h-12 rounded-xl bg-white/5 border border-white/5 text-white/60 hover:bg-white/10 font-bold uppercase tracking-widest text-[10px]"},{default:L(()=>[...l[18]||(l[18]=[F(" Abort ",-1)])]),_:1}),b(k(vt),{onClick:e.onBackToLobby,class:"h-12 rounded-xl bg-rose-500 text-white font-black uppercase tracking-widest text-[10px] hover:bg-rose-600 shadow-neon-sm"},{default:L(()=>[...l[19]||(l[19]=[F(" Confirm ",-1)])]),_:1},8,["onClick"])])]),_:1})]),_:1})]),_:1})])),e.isInitiator?(I(),_("div",_a,[e.signalingMode==="server"?(I(),_("div",Ea,[u("div",Na,[u("div",Aa,[u("div",Pa,[b(k(Wt),{class:"w-5 h-5 text-primary"})]),l[20]||(l[20]=u("div",{class:"text-left"},[u("h3",{class:"text-sm font-black text-white uppercase tracking-wider"},"Share Session Link"),u("p",{class:"text-[10px] text-white/30 uppercase tracking-widest font-medium"},"Link this node to the discovery mesh")],-1))]),l[21]||(l[21]=u("div",{class:"flex items-center gap-2 px-3 py-1 bg-primary/5 border border-primary/20 rounded-full"},[u("div",{class:"w-1.5 h-1.5 bg-primary rounded-full animate-pulse shadow-neon"}),u("span",{class:"text-[9px] font-black text-primary uppercase tracking-widest"},"Live Broadcast")],-1))]),u("div",Ta,[u("div",$a,Q(g.value),1),u("button",{onClick:v,class:"shrink-0 h-12 px-6 rounded-xl bg-primary text-primary-foreground font-black uppercase tracking-widest text-[10px] shadow-neon hover:shadow-[0_0_25px_rgba(16,185,129,0.4)] transition-all active:scale-95 flex items-center gap-2"},[b(Rn,{mode:"out-in",name:"fade"},{default:L(()=>[C.value?(I(),_("div",Ga,[b(k(Yt),{class:"w-4 h-4"}),l[22]||(l[22]=F(" COPIED ",-1))])):(I(),_("div",Ra,[b(k(zt),{class:"w-4 h-4"}),l[23]||(l[23]=F(" COPY LINK ",-1))]))]),_:1})])])])):Y("",!0),e.signalingMode==="manual"&&e.pendingSignaling.length>0?(I(),_("div",La,[l[24]||(l[24]=u("h3",{class:"text-[11px] font-black text-white/20 uppercase tracking-[0.3em] px-1"},"Pending Link Authentications",-1)),u("div",Oa,[(I(!0),_(Re,null,Et(e.pendingSignaling,f=>(I(),Ln(_t,{key:f.id,connection:f,onOfferChange:e.onUpdateOffer,onAnswerChange:e.onUpdateAnswer,onCancel:e.onCancelSignaling},null,8,["connection","onOfferChange","onAnswerChange","onCancel"]))),128))])])):Y("",!0)])):Y("",!0),!e.isInitiator&&E.value&&e.signalingMode==="manual"&&e.pendingSignaling.length>0?(I(),_("div",Ka,[b(_t,{connection:e.pendingSignaling[0],onOfferChange:e.onUpdateOffer,onAnswerChange:e.onUpdateAnswer,onCancel:e.onCancelSignaling},null,8,["connection","onOfferChange","onAnswerChange","onCancel"])])):Y("",!0)])):Y("",!0),!U.value&&!E.value&&!T.value&&!S.value?(I(),_("div",Da,[l[25]||(l[25]=On('<div class="relative"><div class="h-20 w-20 bg-white/5 rounded-full flex items-center justify-center transition-transform hover:scale-110 duration-500"><div class="h-4 w-4 bg-white/10 rounded-full animate-ping"></div></div></div><div class="text-center space-y-2"><div class="text-xs font-black uppercase tracking-[0.5em] text-white/30">Null Reference: No Active Session</div><p class="text-[10px] text-white/20 uppercase tracking-widest px-10 leading-relaxed font-medium">Session data not found on current node. Return to discovery mesh.</p></div>',2)),u("button",{onClick:l[3]||(l[3]=(...f)=>e.onBackToLobby&&e.onBackToLobby(...f)),class:"h-12 px-8 rounded-xl border border-white/10 text-white/70 hover:text-primary hover:border-primary/40 font-black uppercase tracking-widest text-[10px] transition-all"}," Return to Discovery ")])):Y("",!0)]))}}),{defineComponent:Va}=await x("vue"),{resolveDynamicComponent:Fa,normalizeProps:Ua,openBlock:Le,createBlock:At,mergeProps:ja,createCommentVNode:Ja,Fragment:Ha,createElementBlock:Pt}=await x("vue"),Ya={class:"animate-zoom-in"},{computed:za,shallowRef:Wa,watch:Qa}=await x("vue"),Xa=Va({__name:"ActivePhase",props:{GameComponent:{},connectedPeers:{},playerInfos:{},isInitiator:{type:Boolean},ledger:{},onAddLedger:{type:Function},onFinishGame:{type:Function},framework:{}},setup(e){const t=e,n=Wa(null);Qa(()=>t.GameComponent,async a=>{if(n.value=null,a)if(t.framework==="vue"){const p=await(typeof a=="function"?a():a);n.value=p.default||p}else n.value=a},{immediate:!0});const i=za(()=>({connections:t.connectedPeers,playerNames:t.playerInfos.map(a=>a.name),playerInfos:t.playerInfos,isInitiator:t.isInitiator,ledger:t.ledger,onAddLedger:t.onAddLedger,onFinishGame:t.onFinishGame}));return(a,p)=>(Le(),Pt("div",Ya,[e.framework==="vue"?(Le(),Pt(Ha,{key:0},[n.value?(Le(),At(Fa(n.value),Ua(ja({key:0},i.value)),null,16)):Ja("",!0)],64)):(Le(),At(Bt,{key:1,component:e.GameComponent,componentProps:i.value},null,8,["component","componentProps"]))]))}}),{defineComponent:Za}=await x("vue"),{resolveDynamicComponent:qa,normalizeProps:es,openBlock:Oe,createBlock:Tt,mergeProps:ts,createCommentVNode:ns,Fragment:as,createElementBlock:$t,createElementVNode:X,unref:ss,createVNode:os}=await x("vue"),is={class:"space-y-6"},rs={class:"opacity-80 pointer-events-none grayscale-[0.2]"},cs={class:"glass-dark p-8 border border-white/5 shadow-glass-dark rounded-[2.5rem] animate-fade-in-up"},ls={class:"flex flex-col md:flex-row items-center justify-between gap-6"},ds={class:"flex items-center gap-4"},us={class:"h-14 w-14 bg-primary/10 rounded-2xl flex items-center justify-center border border-primary/20 shadow-neon"},ps={class:"flex gap-4 w-full md:w-auto"},{computed:gs,shallowRef:hs,watch:ms}=await x("vue"),ys=Za({__name:"FinishedPhase",props:{GameComponent:{},connectedPeers:{},playerInfos:{},isInitiator:{type:Boolean},ledger:{},onBackToLobby:{type:Function},framework:{}},setup(e){const t=e,n=hs(null);ms(()=>t.GameComponent,async a=>{if(n.value=null,a)if(t.framework==="vue"){const p=await(typeof a=="function"?a():a);n.value=p.default||p}else n.value=a},{immediate:!0});const i=gs(()=>({connections:t.connectedPeers,playerNames:t.playerInfos.map(a=>a.name),playerInfos:t.playerInfos,isInitiator:t.isInitiator,ledger:t.ledger,onAddLedger:()=>{},onFinishGame:()=>{}}));return(a,p)=>(Oe(),$t("div",is,[X("div",rs,[e.framework==="vue"?(Oe(),$t(as,{key:0},[n.value?(Oe(),Tt(qa(n.value),es(ts({key:0},i.value)),null,16)):ns("",!0)],64)):(Oe(),Tt(Bt,{key:1,component:e.GameComponent,componentProps:i.value},null,8,["component","componentProps"]))]),X("div",cs,[X("div",ls,[X("div",ds,[X("div",us,[os(ss(Me),{class:"w-8 h-8 text-primary"})]),p[1]||(p[1]=X("div",{class:"space-y-1"},[X("h3",{class:"text-xl font-black text-white uppercase tracking-tight"},"Match Finalized"),X("p",{class:"text-[10px] text-white/30 uppercase tracking-widest font-black"},"All cycles complete. Handshake terminated.")],-1))]),X("div",ps,[X("button",{onClick:p[0]||(p[0]=(...C)=>e.onBackToLobby&&e.onBackToLobby(...C)),class:"w-full md:w-56 h-14 rounded-2xl bg-primary text-primary-foreground shadow-neon hover:shadow-[0_0_30px_rgba(16,185,129,0.4)] font-black uppercase tracking-[0.3em] text-xs transition-all"}," Return to Discovery ")])])]),p[2]||(p[2]=X("div",{class:"text-center text-white/10 text-[9px] font-black uppercase tracking-[0.4em] italic pt-4"}," Node state captured. Verification record locked inside vault. ",-1))]))}}),{defineComponent:fs}=await x("vue"),{unref:Gt,createVNode:Rt,toDisplayString:ke,createTextVNode:Lt,createElementVNode:z,renderList:vs,Fragment:bs,openBlock:ee,createElementBlock:te,normalizeClass:at,createCommentVNode:re}=await x("vue"),ws={class:"glass-dark p-8 rounded-[2rem] border border-white/5 shadow-glass-dark"},xs={class:"text-xs font-black uppercase tracking-[0.3em] text-white/40 mb-6 flex items-center gap-3"},ks={class:"space-y-4"},Ss={class:"relative"},Cs={key:0,class:"absolute inset-0 h-3 w-3 bg-primary rounded-full animate-ping opacity-50"},Is={class:"flex flex-col flex-1"},_s={class:"flex items-center gap-2"},Es={class:"text-sm font-black text-white uppercase tracking-tight"},Ns={key:0,class:"text-primary font-black ml-1"},As={key:0,class:"px-2 py-0.5 bg-primary/10 text-primary border border-primary/20 rounded-full text-[9px] font-black uppercase tracking-wider"},Ps={key:0,class:"flex items-center gap-2 mt-2"},Ts=["onClick","aria-checked"],$s={class:"text-[9px] text-white/40 uppercase tracking-wider font-medium"},Gs={class:"text-[8px] text-white/30"},Rs={key:0,class:"ml-auto flex items-center gap-3"},Ls=["onClick"],Os={key:0,class:"text-[10px] text-white/20 uppercase font-black tracking-[0.3em] text-center py-6 animate-pulse"},{ref:Ot,onMounted:Ks,watch:Ds}=await x("vue"),Ms=fs({__name:"Players",props:{players:{},onRemove:{type:Function},onSaveIdentity:{type:Function},isKnownIdentity:{type:Function}},setup(e){const t=e,n=Ot({}),i=Ot({}),a=async()=>{for(const g of t.players)g.publicKey&&!g.isLocal&&t.isKnownIdentity&&(n.value[g.id]=await t.isKnownIdentity(g.publicKey))},p=async g=>{const v=i.value[g.id],d=!v;console.log("[Players] Toggle save for:",g.name,"from",v,"to",d),d?await C(g):i.value[g.id]=!1},C=async g=>{if(console.log("[Players] Attempting to save identity for:",g.name,"publicKey:",g.publicKey,"isLocal:",g.isLocal),!g.publicKey){console.warn("[Players] Cannot save identity - no public key for:",g.name);return}if(!t.onSaveIdentity){console.warn("[Players] Cannot save identity - onSaveIdentity prop not provided");return}try{i.value[g.id]=!0,await t.onSaveIdentity(g),n.value[g.id]=!0,console.log("[Players] Successfully saved identity for:",g.name)}catch(v){console.error("[Players] Error saving identity:",v),i.value[g.id]=!1}};return Ks(()=>{a()}),Ds(()=>t.players,()=>{a()},{deep:!0}),(g,v)=>(ee(),te("div",ws,[z("h3",xs,[Rt(Gt(Be),{class:"w-5 h-5 text-primary"}),Lt(" Dwellers In Lobby ("+ke(e.players.length)+") ",1)]),z("div",ks,[(ee(!0),te(bs,null,vs(e.players,d=>(ee(),te("div",{key:d.id,class:"flex items-center gap-4 p-4 rounded-2xl bg-white/5 border border-white/10 group hover:neon-border transition-all duration-500 animate-fade-in-left"},[z("div",Ss,[z("div",{class:at(["h-3 w-3 rounded-full",d.isConnected?"bg-primary shadow-neon":"bg-rose-500 shadow-[0_0_15px_rgba(244,63,94,0.4)]"])},null,2),d.isConnected?(ee(),te("div",Cs)):re("",!0)]),z("div",Is,[z("div",_s,[z("span",Es,[Lt(ke(d.name)+" ",1),d.isLocal?(ee(),te("span",Ns,"(LOCAL)")):re("",!0)]),!d.isLocal&&n.value[d.id]?(ee(),te("span",As," Known Identity ")):re("",!0)]),!d.isLocal&&d.isConnected&&!n.value[d.id]?(ee(),te("div",Ps,[z("button",{onClick:T=>p(d),class:at(["relative inline-flex h-5 w-9 items-center rounded-full transition-colors duration-200",i.value[d.id]?"bg-primary":"bg-white/10"]),role:"switch","aria-checked":i.value[d.id]},[z("span",{class:at(["inline-block h-3 w-3 transform rounded-full bg-white transition-transform duration-200",i.value[d.id]?"translate-x-5":"translate-x-1"])},null,2)],10,Ts),z("span",$s,ke(i.value[d.id]?"Saved for auto-approve":"Auto-approve next time"),1),z("span",Gs,ke(d.isLocal?"(Local)":"(Remote)")+" "+ke(d.publicKey?"PK":"PK"),1)])):re("",!0)]),d.isConnected?re("",!0):(ee(),te("div",Rs,[v[0]||(v[0]=z("span",{class:"text-[9px] text-rose-500 font-black uppercase tracking-widest"},"Node Disconnected",-1)),e.onRemove&&!d.isLocal?(ee(),te("button",{key:0,class:"h-8 w-8 flex items-center justify-center text-rose-500 hover:text-rose-400 hover:bg-rose-500/10 transition-colors border border-transparent hover:border-rose-500/30 rounded-xl",onClick:T=>e.onRemove(d.id),title:"Sever entry"},[Rt(Gt(Xt),{class:"w-4 h-4"})],8,Ls)):re("",!0)]))]))),128)),e.players.length===0?(ee(),te("p",Os," Scanning for incoming nodes... ")):re("",!0)])]))}}),{defineComponent:Bs}=await x("vue"),{toDisplayString:Vs,createElementVNode:Ke,createTextVNode:Fs,unref:y,openBlock:ge,createBlock:st,createVNode:Us,createElementBlock:ot}=await x("vue"),js={class:"min-h-screen bg-background"},Js={key:0,class:"max-w-7xl mx-auto p-6 space-y-12"},Hs={class:"text-3xl font-black tracking-tighter uppercase text-white"},Ys={class:"text-gradient"},zs={class:"animate-fade-in-up"},Ws={class:"mt-12 max-w-2xl"},Qs={key:1,class:"p-10 text-center text-white/50 uppercase font-black tracking-widest"},{computed:he,onMounted:Xs,onUnmounted:Zs}=await x("vue"),qs="server",co=Bs({__name:"BoardView",setup(e){const t=Kt(),n=Dt(),i=he(()=>t.params.gameId),a=he(()=>t.params.boardId),p=he(()=>Mt(i.value||"")),C=()=>n.push("/games"),{snapshot:g,send:v,playerInfos:d,connectedPeers:T,pendingSignaling:U,pendingJoinRequests:E,isInitiator:S,isGameStarted:m,onHostAGame:l,isKnownIdentity:f,onApprovePeer:ae,onRejectPeer:ne,saveIdentityOnApprove:Ve,updateOffer:Fe,updateAnswer:de,startGame:Ce,onFinishGame:Ie,onAddLedger:Ue,onAcceptGuest:_e,onRejectGuest:je,onCancelSignaling:Je,onBackToGames:He,signalingClient:Ee,isServerConnecting:Ye}=gn(),ze=async j=>{if(console.log("[BoardView] handleSavePlayerIdentity called for:",j.name,"publicKey:",j.publicKey),!j.publicKey){console.warn("[BoardView] Cannot save - no public key");return}const Z={id:`identity-${Date.now()}`,name:j.name,publicKey:j.publicKey,addedAt:Date.now()};console.log("[BoardView] Saving identity to DB:",Z),await Se.addKnownIdentity(Z),console.log("[BoardView] Identity saved successfully"),De.success("Identity Saved",{description:`${j.name} has been added to your known identities.`})},Ne=he(()=>T.value),We=()=>{He(),C()},Ae=he(()=>g.value?.matches("finished")||!1),Qe=he(()=>!m.value&&!Ae.value),Pe=j=>{Qe.value&&(j.preventDefault(),j.returnValue="")};return Xs(async()=>{if(await Se.cleanupOldHostedSessions(),a.value&&g.value?.matches("idle"))if(await Se.isHosting(a.value)){const Z=parseInt(t.query.maxPlayers)||2;console.log("[BOARDVIEW] Initializing HOST state for boardId:",a.value,"maxPlayers:",Z),v({type:"HOST",maxPlayers:Z,boardId:a.value})}else console.log("[BOARDVIEW] Initializing GUEST state for boardId:",a.value),v({type:"JOIN",boardId:a.value});window.addEventListener("beforeunload",Pe)}),Zs(()=>{window.removeEventListener("beforeunload",Pe)}),(j,Z)=>(ge(),ot("div",js,[p.value?(ge(),ot("div",Js,[Ke("h1",Hs,[Z[0]||(Z[0]=Fs(" Lobby: ",-1)),Ke("span",Ys,Vs(p.value.name),1)]),Ke("div",zs,[Ae.value?(ge(),st(ys,{key:0,GameComponent:p.value.component,connectedPeers:Ne.value,playerInfos:y(d),isInitiator:y(S),ledger:y(g)?.context?.ledger||[],onBackToLobby:C,framework:p.value.framework},null,8,["GameComponent","connectedPeers","playerInfos","isInitiator","ledger","framework"])):y(m)?(ge(),st(Xa,{key:1,GameComponent:p.value.component,connectedPeers:Ne.value,playerInfos:y(d),isInitiator:y(S),ledger:y(g)?.context?.ledger||[],onAddLedger:y(Ue),onFinishGame:y(Ie),framework:p.value.framework},null,8,["GameComponent","connectedPeers","playerInfos","isInitiator","ledger","onAddLedger","onFinishGame","framework"])):(ge(),st(Ba,{key:2,state:y(g),isInitiator:y(S),signalingMode:qs,isServerConnecting:y(Ye),signalingClient:y(Ee),pendingSignaling:y(U),pendingJoinRequests:y(E),isKnownIdentity:y(f),onStartGame:y(Ce),onHostAGame:y(l),onUpdateOffer:y(Fe),onUpdateAnswer:y(de),onCloseSession:We,onBackToLobby:C,onAcceptGuest:y(_e),onRejectGuest:y(je),onApprovePeer:y(ae),onRejectPeer:y(ne),onSaveIdentity:y(Ve),onCancelSignaling:y(Je),onRemovePlayer:me=>y(v)({type:"REMOVE_PLAYER",playerId:me}),playerCount:y(d).length,maxPlayers:y(g)?.context?.maxPlayers||2,boardId:a.value,gameId:i.value},null,8,["state","isInitiator","isServerConnecting","signalingClient","pendingSignaling","pendingJoinRequests","isKnownIdentity","onStartGame","onHostAGame","onUpdateOffer","onUpdateAnswer","onAcceptGuest","onRejectGuest","onApprovePeer","onRejectPeer","onSaveIdentity","onCancelSignaling","onRemovePlayer","playerCount","maxPlayers","boardId","gameId"])),Ke("div",Ws,[Us(Ms,{players:y(d),onRemove:y(S)?me=>y(v)({type:"REMOVE_PLAYER",playerId:me}):void 0,onSaveIdentity:ze,isKnownIdentity:y(f)},null,8,["players","onRemove","isKnownIdentity"])])])])):(ge(),ot("div",Qs," Game not found in grid. "))]))}});export{co as default};
