const g="MykoboardDB",c="games";class y{db=null;async getDB(){return this.db?this.db:new Promise((e,t)=>{const r=indexedDB.open(g,1);r.onupgradeneeded=o=>{const l=o.target.result;l.objectStoreNames.contains(c)||l.createObjectStore(c,{keyPath:"boardId"})},r.onsuccess=o=>{this.db=o.target.result,e(this.db)},r.onerror=o=>{t(o.target.error)}})}async saveGame(e){const t=await this.getDB();return new Promise((r,o)=>{const a=t.transaction(c,"readwrite").objectStore(c).put(e);a.onsuccess=()=>r(),a.onerror=()=>o(a.error)})}async getGame(e){const t=await this.getDB();return new Promise((r,o)=>{const a=t.transaction(c,"readonly").objectStore(c).get(e);a.onsuccess=()=>r(a.result||null),a.onerror=()=>o(a.error)})}async getAllGames(){const e=await this.getDB();return new Promise((t,r)=>{const n=e.transaction(c,"readonly").objectStore(c).getAll();n.onsuccess=()=>{const a=n.result;t(a.sort((u,d)=>d.lastPlayed-u.lastPlayed))},n.onerror=()=>r(n.error)})}async deleteGame(e){const t=await this.getDB();return new Promise((r,o)=>{const a=t.transaction(c,"readwrite").objectStore(c).delete(e);a.onsuccess=()=>r(),a.onerror=()=>o(a.error)})}async clearAllGames(){const e=await this.getDB();return new Promise((t,r)=>{const n=e.transaction(c,"readwrite").objectStore(c).clear();n.onsuccess=()=>t(),n.onerror=()=>r(n.error)})}}const i=new y,m={async getSessions(){try{return await i.getAllGames()}catch(s){return console.error("Failed to load sessions",s),[]}},async getSession(s){try{return await i.getGame(s)}catch(e){return console.error("Failed to load session",e),null}},async saveSession(s){try{const e=await i.getGame(s.boardId),t=s.status||e?.status||"active",r=s.ledger||e?.ledger||[],o=s.participants||[],l=e?.participants||[],n=new Map;l.forEach(d=>n.set(d.id,d)),o.forEach(d=>n.set(d.id,d));const a=Array.from(n.values()),u={...s,status:t,ledger:r,participants:a,lastPlayed:Date.now()};await i.saveGame(u)}catch(e){console.error("Failed to save session",e)}},async updateStatus(s,e){try{const t=await i.getGame(s);t&&(t.status=e,await i.saveGame(t))}catch(t){console.error("Failed to update status",t)}},async updateLedger(s,e){try{const t=await i.getGame(s);t&&(t.ledger=e,t.lastPlayed=Date.now(),await i.saveGame(t))}catch(t){console.error("Failed to update ledger",t)}},async removeSession(s){try{await i.deleteGame(s)}catch(e){console.error("Failed to remove session",e)}},async clearAllSessions(){try{await i.clearAllGames()}catch(s){console.error("Failed to clear all sessions",s)}}};export{m as S};
